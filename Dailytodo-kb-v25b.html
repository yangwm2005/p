<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 3px solid transparent;
        }

        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            background: white;
        }

        .quick-action-btn i {
            font-size: 1.2rem;
        }

        /* Active states for quick action buttons */
        .quick-action-btn.active-filter {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }

        .quick-action-btn.today-active {
            background: #2196F3;
            color: white;
            border-color: #1976D2;
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
        }

        .quick-action-btn.week-active {
            background: #FF9800;
            color: white;
            border-color: #F57C00;
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.3);
        }

        .quick-action-btn.overdue-active {
            background: #ff4757;
            color: white;
            border-color: #ff3742;
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.3);
        }

        .quick-action-btn.due-day-active {
            background: #9C27B0;
            color: white;
            border-color: #7B1FA2;
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.3);
        }

        .quick-action-btn.search-active {
            background: #9C27B0;
            color: white;
            border-color: #7B1FA2;
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.3);
        }

        .filter-indicator {
            font-size: 12px;
            margin-left: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .quick-action-btn.active-filter .filter-indicator {
            opacity: 1;
        }

        /* Controls Panel */
        .controls-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .control-groups-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .control-group:hover {
            border-color: #bbbbbb;
        }

        .control-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            padding: 5px;
        }

        .control-group-title {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .control-group.collapsed .control-group-content {
            display: none;
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-btn {
            background: #f5f5f5;
            border: 2px solid #ddd;
            padding: 10px 15px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-align: center;
        }

        .control-btn:hover {
            background: #e9e9e9;
            border-color: #ccc;
        }

        .control-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #45a049;
        }

        .search-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .clear-search {
            background: #ff4757;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            transition: all 0.3s ease;
        }

        .clear-search:hover {
            background: #ff3742;
            transform: scale(1.1);
        }

        /* Floating Controls */
        .floating-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .floating-btn {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #333;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        /* Kanban Board */
        .kanban-board {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .kanban-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .kanban-column {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .kanban-column:hover {
            border-color: #ced4da;
            transform: translateY(-2px);
        }

        .kanban-column.drag-over {
            border-color: #4CAF50;
            background-color: #f0fff0;
            transform: scale(1.02);
            transition: all 0.2s ease;
        }

        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .column-header div {
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        .task-count {
            background: #4CAF50;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .tasks-container {
            min-height: 100px;
        }

        .kanban-task {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            cursor: grab;
            transition: all 0.3s ease;
            position: relative;
        }

        .kanban-task:hover {
            border-color: #4CAF50;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .kanban-task.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }

        .kanban-task:active {
            cursor: grabbing;
        }

        .kanban-task.completed {
            opacity: 0.7;
            background: #f8f9fa;
        }

        .kanban-task.completed .task-text {
            text-decoration: line-through;
        }

        .kanban-task.overdue {
            border-color: #ff4757;
            background: #fff5f5;
        }

        .kanban-task.due-today {
            border-color: #ffa502;
            background: #fff9f2;
        }

        .task-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 10px;
        }

        .task-checkbox {
            margin-top: 3px;
            transform: scale(1.2);
        }

        .task-text {
            flex: 1;
            font-weight: 500;
            line-height: 1.4;
        }

        .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .task-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .task-priority, .task-date, .task-category {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .task-priority.high {
            background: #ffcccc;
            color: #d63031;
        }

        .task-priority.medium {
            background: #fff4cc;
            color: #e1b12c;
        }

        .task-priority.low {
            background: #ccffcc;
            color: #00b894;
        }

        .task-date.overdue {
            background: #ffcccc;
            color: #d63031;
        }

        .task-date.today {
            background: #fff4cc;
            color: #e1b12c;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .task-action-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8rem;
            position: relative;
        }

        .task-action-btn:hover {
            background: #e9ecef;
            transform: scale(1.1);
        }

        .task-action-btn:hover::after {
            content: attr(title);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1000;
        }

        .notes-indicator {
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
        }

        .task-action-btn.has-notes {
            background: #e8f5e8;
            border-color: #4CAF50;
        }

        .empty-column {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .hidden {
            display: none !important;
        }

        /* Edit Mode */
        .edit-mode {
            padding: 10px;
        }

        .edit-textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
            font-family: inherit;
        }

        .edit-select, .edit-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .edit-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .edit-today-btn, .edit-tomorrow-btn, .edit-confirm, .edit-cancel {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .edit-today-btn, .edit-tomorrow-btn {
            background: #2196F3;
            color: white;
        }

        .edit-today-btn:hover, .edit-tomorrow-btn:hover {
            background: #1976D2;
        }

        .edit-confirm {
            background: #4CAF50;
            color: white;
        }

        .edit-confirm:hover {
            background: #45a049;
        }

        .edit-cancel {
            background: #6c757d;
            color: white;
        }

        .edit-cancel:hover {
            background: #5a6268;
        }

        .edit-hint {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Quick Date Options */
        .quick-date-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .quick-date-options .btn {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        /* Enhanced Notes Styling */
        .quick-note-actions {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .quick-note-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .quick-note-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .notes-preview {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }

        .notes-preview-content {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .note-content {
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            border-left: 3px solid #4CAF50;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .quick-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .quick-action-btn {
                width: 100%;
                max-width: 300px;
                justify-content: center;
            }
            
            .kanban-container {
                grid-template-columns: 1fr;
            }
            
            .floating-controls {
                position: static;
                justify-content: center;
                margin-bottom: 20px;
            }
            
            .control-groups-row {
                flex-direction: column;
            }
            
            .control-group {
                min-width: 100%;
            }
            
            .quick-date-options {
                flex-direction: column;
            }
            
            .quick-note-actions {
                flex-direction: column;
            }
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #888;
            font-size: 14px;
            border-top: 1px solid #eee;
        }

/* Add to your CSS */
.quick-date-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.quick-date-btn {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.quick-date-btn:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.quick-date-btn.today {
    background: #2196F3;
    color: white;
    border-color: #1976D2;
}

.quick-date-btn.tomorrow {
    background: #FF9800;
    color: white;
    border-color: #F57C00;
}

.quick-date-btn.clear {
    background: #6c757d;
    color: white;
    border-color: #5a6268;
}

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📝 Task Manager</h1>
            <p>Organize your tasks efficiently with drag & drop</p>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button id="quickAdd" class="quick-action-btn">
                <i class="fas fa-plus-circle"></i>
                <span>Add New Task</span>
            </button>
            <button id="quickToday" class="quick-action-btn">
                <i class="fas fa-calendar-day"></i>
                <span>Today</span>
                <span class="filter-indicator">●</span>
            </button>
            <button id="quickThisWeek" class="quick-action-btn">
                <i class="fas fa-calendar-week"></i>
                <span>This Week</span>
                <span class="filter-indicator">●</span>
            </button>
            <button id="quickOverdue" class="quick-action-btn">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Overdue</span>
                <span class="filter-indicator">●</span>
            </button>
            <button id="quickDueDay" class="quick-action-btn">
                <i class="fas fa-calendar-alt"></i>
                <span>Due Day</span>
                <span class="filter-indicator">●</span>
            </button>
            <button id="quickSearch" class="quick-action-btn">
                <i class="fas fa-filter"></i>
                <span>Search Filter</span>
                <span class="filter-indicator">●</span>
            </button>
        </div>

        <!-- Floating Controls -->
        <div class="floating-controls">
            <button id="toggleControlsBtn" class="floating-btn" title="Show Controls">
                <i class="fas fa-eye"></i>
            </button>
            <button id="toggleSearchBtn" class="floating-btn" title="Show Search">
                <i class="fas fa-eye-slash"></i>
            </button>
            <button id="toggleFiltersBtn" class="floating-btn" title="Show Filters">
                <i class="fas fa-eye-slash"></i>
            </button>
            <button id="toggleFileBtn" class="floating-btn" title="Show File Options">
                <i class="fas fa-eye-slash"></i>
            </button>
        </div>

        <!-- Controls Panel -->
        <div id="controlsPanel" class="controls-panel hidden">
            <!-- Search Group -->
            <div id="searchGroup" class="search-group">
                <input type="text" id="searchInput" class="search-input" placeholder="Search tasks and notes...">
                <button id="clearSearch" class="clear-search" title="Clear search">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Control Groups Row -->
            <div class="control-groups-row">
                <!-- View Options -->
                <div class="control-group">
                    <div class="control-group-header">
                        <div class="control-group-title">
                            <i class="fas fa-eye"></i> View
                        </div>
                    </div>
                    <div class="control-group-content">
                        <div class="control-buttons">
                            <button id="viewAll" class="control-btn active">All Tasks</button>
                            <button id="viewActive" class="control-btn">Active Only</button>
                            <button id="showTasksOnly" class="control-btn active">Tasks Only</button>
                            <button id="showAllCategories" class="control-btn">All Categories</button>
                        </div>
                    </div>
                </div>

                <!-- Sort Options -->
                <div class="control-group">
                    <div class="control-group-header">
                        <div class="control-group-title">
                            <i class="fas fa-sort"></i> Sort
                        </div>
                    </div>
                    <div class="control-group-content">
                        <div class="control-buttons">
                            <button id="sortDefault" class="control-btn active">Default</button>
                            <button id="sortDeadline" class="control-btn">Deadline</button>
                            <button id="sortPriority" class="control-btn">Priority</button>
                        </div>
                    </div>
                </div>

                <!-- Time Filter -->
                <div class="control-group">
                    <div class="control-group-header">
                        <div class="control-group-title">
                            <i class="fas fa-clock"></i> Time
                        </div>
                    </div>
                    <div class="control-group-content">
                        <div class="control-buttons">
                            <button id="showAllTime" class="control-btn active">All Time</button>
                            <button id="showToday" class="control-btn">Today</button>
                            <button id="showThisWeek" class="control-btn">This Week</button>
                        </div>
                    </div>
                </div>

                <!-- Status Filter -->
                <div class="control-group">
                    <div class="control-group-header">
                        <div class="control-group-title">
                            <i class="fas fa-filter"></i> Status
                        </div>
                    </div>
                    <div class="control-group-content">
                        <div class="control-buttons">
                            <button id="showOverdue" class="control-btn">Overdue</button>
                            <button id="showNoDate" class="control-btn">No Date</button>
                        </div>
                    </div>
                </div>

                <!-- Data Management -->
                <div id="dataGroup" class="control-group data-group">
                    <div class="control-group-header">
                        <div class="control-group-title">
                            <i class="fas fa-database"></i> Data
                        </div>
                    </div>
                    <div class="control-group-content">
                        <div class="control-buttons">
                            <button id="saveFileBtn" class="control-btn">
                                <i class="fas fa-download"></i> Save
                            </button>
                            <button id="loadFileBtn" class="control-btn">
                                <i class="fas fa-upload"></i> Load
                            </button>
                            <input type="file" id="fileInput" accept=".json" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kanban Board -->
        <div class="kanban-board">
            <div id="kanbanContainer" class="kanban-container">
                <!-- Tasks will be rendered here -->
            </div>
        </div>
        
        <div class="footer">
            <p>© 2025 Dr. Wen-Ming Yang lab • v2.5b Edit sytle b</p>
        </div>
        
    </div>

    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Task</h2>
                <button id="closeAddTaskModal" class="close-modal">&times;</button>
            </div>
            <form id="addTaskForm">
                <div class="form-group">
                    <label for="taskText">Task Description</label>
                    <input type="text" id="taskText" class="form-control" required placeholder="What needs to be done?">
                </div>
                <div class="form-group">
                    <label for="taskCategory">Category</label>
                    <select id="taskCategory" class="form-control">
                        <option value="mit">MIT</option>
                        <option value="work">Work</option>
                        <option value="project">Project</option>
                        <option value="social">Social</option>
                        <option value="lab">Lab</option>
                        <option value="family">Family</option>
                        <option value="personal">Personal</option>
                        <option value="health">Health</option>
                        <option value="shopping">Shopping</option>
                        <option value="learning">Learning</option>
                        <option value="other">Other</option>
                        <option value="weekGoals">Week Goals</option>
                        <option value="monthGoals">Month Goals</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskPriority">Priority</label>
                    <select id="taskPriority" class="form-control">
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
<!-- WITH this enhanced version -->
<div class="form-group">
    <label for="taskDueDate">Due Date (optional)</label>
    
    <div class="quick-date-buttons">
        <button type="button" id="quickTodayBtn" class="quick-date-btn today">
            <i class="fas fa-calendar-day"></i> Today
        </button>
        <button type="button" id="quickTomorrowBtn" class="quick-date-btn tomorrow">
            <i class="fas fa-forward"></i> Tomorrow
        </button>
        <button type="button" id="clearDateBtn" class="quick-date-btn clear">
            <i class="fas fa-times"></i> Clear
        </button>
    </div>
    
    <input type="date" id="taskDueDate" class="form-control">
</div>
                <div class="form-group">
                    <label for="taskNotes">Notes (optional)</label>
                    <textarea id="taskNotes" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancelAddTask" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Enhanced Notes Modal -->
    <div id="notesModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">Task Notes & Progress</h2>
                <button id="closeNotesModal" class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="notesTextarea">Progress Notes & Ideas</label>
                <textarea id="notesTextarea" class="form-control" rows="10" 
                          placeholder="Track your progress, ideas, and updates here..."></textarea>
            </div>
            
            <!-- Quick Action Buttons for Notes -->
            <div class="quick-note-actions">
                <button type="button" class="quick-note-btn" data-template="progress">📈 Progress Update</button>
                <button type="button" class="quick-note-btn" data-template="idea">💡 New Idea</button>
                <button type="button" class="quick-note-btn" data-template="issue">⚠️ Issue/Block</button>
                <button type="button" class="quick-note-btn" data-template="question">❓ Question</button>
            </div>
            
            <!-- Notes History/Preview -->
            <div class="notes-preview">
                <h4>Recent Notes Preview</h4>
                <div id="notesPreview" class="notes-preview-content"></div>
            </div>
            
            <div class="form-actions">
                <button type="button" id="cancelNotes" class="btn btn-secondary">Cancel</button>
                <button type="button" id="saveNotes" class="btn btn-primary">Save Notes</button>
            </div>
        </div>
    </div>

    <!-- Due Day Modal -->
    <div id="dueDayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Select Due Day</h2>
                <button id="closeDueDayModal" class="close-modal">&times;</button>
            </div>
            <div class="form-group">
                <label for="dueDayDate">Select Date</label>
                <input type="date" id="dueDayDate" class="form-control">
            </div>
            <div class="form-group">
                <div class="quick-date-options">
                    <button type="button" id="dueDayToday" class="btn btn-secondary">Today</button>
                    <button type="button" id="dueDayTomorrow" class="btn btn-secondary">Tomorrow</button>
                    <button type="button" id="dueDayNextWeek" class="btn btn-secondary">Next Monday</button>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" id="cancelDueDay" class="btn btn-secondary">Cancel</button>
                <button type="button" id="applyDueDay" class="btn btn-primary">Apply Filter</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Category names mapping
            const categoryNames = {
                mit: 'MIT',
                work: 'Work',
                project: 'Project',
                social: 'Social',
                lab: 'Lab',
                family: 'Family',
                personal: 'Personal',
                health: 'Health',
                shopping: 'Shopping',
                learning: 'Learning',
                other: 'Other',
                weekGoals: 'Week Goals',
                monthGoals: 'Month Goals',
            };
            
            // Category icons mapping
            const categoryIcons = {
                mit: 'fa-university',
                work: 'fa-briefcase',
                project: 'fa-project-diagram',
                social: 'fa-users',
                lab: 'fa-flask',
                family: 'fa-home',
                personal: 'fa-user',
                health: 'fa-heartbeat',
                shopping: 'fa-shopping-cart',
                learning: 'fa-graduation-cap',
                other: 'fa-star',
                weekGoals: 'fa-bullseye',
                monthGoals: 'fa-calendar-alt'
            };
            
            // Priority names mapping
            const priorityNames = {
                high: 'High',
                medium: 'Medium',
                low: 'Low'
            };
            
            // Priority values for sorting
            const priorityValues = {
                high: 0,
                medium: 1,
                low: 2
            };
            
            // Priority icons mapping
            const priorityIcons = {
                high: 'fa-arrow-up',
                medium: 'fa-minus',
                low: 'fa-arrow-down'
            };
            
            // Note templates
            const noteTemplates = {
                progress: "📈 Progress Update: ",
                idea: "💡 New Idea: ",
                issue: "⚠️ Issue/Block: ",
                question: "❓ Question: "
            };
            
            // ======================
            // FLOATING BUTTONS DEFAULT SETTINGS
            // ======================
            let controlsVisible = false;
            let searchVisible = false;
            let filtersVisible = true;
            let fileOptionsVisible = true;
            
            // State variables
            let currentSort = 'default';
            let showCompleted = true;
            let showEmptyCategories = false;
            let timeFilter = 'all';
            let statusFilter = 'all';
            let searchTerm = '';
            let currentEditingTaskId = null;
            let dueDayFilter = null;
            
            // DOM Elements
            const addTaskModal = document.getElementById('addTaskModal');
            const closeAddTaskModal = document.getElementById('closeAddTaskModal');
            const cancelAddTask = document.getElementById('cancelAddTask');
            const addTaskForm = document.getElementById('addTaskForm');
            const taskDueDate = document.getElementById('taskDueDate');
            const saveFileBtn = document.getElementById('saveFileBtn');
            const loadFileBtn = document.getElementById('loadFileBtn');
            const fileInput = document.getElementById('fileInput');
            const searchInput = document.getElementById('searchInput');
            const clearSearch = document.getElementById('clearSearch');
            const notesModal = document.getElementById('notesModal');
            const closeNotesModal = document.getElementById('closeNotesModal');
            const cancelNotes = document.getElementById('cancelNotes');
            const saveNotes = document.getElementById('saveNotes');
            const notesTextarea = document.getElementById('notesTextarea');
            
            // Due Day Modal Elements
            const dueDayModal = document.getElementById('dueDayModal');
            const closeDueDayModal = document.getElementById('closeDueDayModal');
            const cancelDueDay = document.getElementById('cancelDueDay');
            const applyDueDay = document.getElementById('applyDueDay');
            const dueDayDate = document.getElementById('dueDayDate');
            const dueDayToday = document.getElementById('dueDayToday');
            const dueDayTomorrow = document.getElementById('dueDayTomorrow');
            const dueDayNextWeek = document.getElementById('dueDayNextWeek');
            
            // Control panel elements
            const controlsPanel = document.getElementById('controlsPanel');
            const searchGroup = document.getElementById('searchGroup');
            const dataGroup = document.getElementById('dataGroup');
            
            // Floating control buttons
            const toggleControlsBtn = document.getElementById('toggleControlsBtn');
            const toggleSearchBtn = document.getElementById('toggleSearchBtn');
            const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
            const toggleFileBtn = document.getElementById('toggleFileBtn');
            
            // Get all filter groups
            const filterGroups = document.querySelectorAll('.control-group');
            
            // Quick action buttons
            const quickAddBtn = document.getElementById('quickAdd');
            const quickTodayBtn = document.getElementById('quickToday');
            const quickThisWeekBtn = document.getElementById('quickThisWeek');
            const quickOverdueBtn = document.getElementById('quickOverdue');
            const quickDueDayBtn = document.getElementById('quickDueDay');
            const quickSearchBtn = document.getElementById('quickSearch');
            
            // Quick date buttons in the add task modal
            const quickTodayBtnModal = document.getElementById('quickTodayBtn');
            const quickTomorrowBtnModal = document.getElementById('quickTomorrowBtn');
            const clearDateBtn = document.getElementById('clearDateBtn');
            
            // ======================
            // DATE HELPER FUNCTIONS
            // ======================
            function isDueToday(dueDate) {
                if (!dueDate) return false;
                
                const today = new Date();
                const todayString = today.toLocaleDateString('en-CA');
                
                const taskDate = new Date(dueDate);
                const taskDateString = taskDate.toLocaleDateString('en-CA');
                
                return taskDateString === todayString;
            }
            
            function isDueThisWeek(dueDate) {
                if (!dueDate) return false;
                
                const today = new Date();
                const taskDate = new Date(dueDate);
                
                // Start of week (Sunday)
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                
                // End of week (Saturday)
                const endOfWeek = new Date(today);
                endOfWeek.setDate(today.getDate() + (6 - today.getDay()));
                
                return taskDate >= startOfWeek && taskDate <= endOfWeek;
            }
            
            function isOverdue(dueDate) {
                if (!dueDate) return false;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const taskDate = new Date(dueDate);
                taskDate.setHours(0, 0, 0, 0);
                
                return taskDate < today;
            }
            
            function isDueOnSpecificDay(dueDate, targetDate) {
                if (!dueDate || !targetDate) return false;
                
                const due = new Date(dueDate);
                const target = new Date(targetDate);
                
                return due.toDateString() === target.toDateString();
            }
            
            // ======================
            // APPLY DEFAULT VISIBILITY SETTINGS
            // ======================
            function applyDefaultVisibility() {
                console.log('Applying default visibility settings...');
                
                // Controls panel - HIDDEN by default
                controlsPanel.classList.add('hidden');
                toggleControlsBtn.innerHTML = '<i class="fas fa-eye"></i>';
                toggleControlsBtn.title = 'Show Controls';
                
                // Search group - HIDDEN by default
                searchGroup.style.display = 'none';
                toggleSearchBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                toggleSearchBtn.title = 'Show Search';
                
                // Filter groups - VISIBLE by default (in row layout)
                filterGroups.forEach(group => {
                    group.style.display = 'block';
                });
                toggleFiltersBtn.innerHTML = '<i class="fas fa-filter"></i>';
                toggleFiltersBtn.title = 'Hide Filters';
                
                // File options - VISIBLE by default (in row layout)
                dataGroup.style.display = 'block';
                toggleFileBtn.innerHTML = '<i class="fas fa-file"></i>';
                toggleFileBtn.title = 'Hide File Options';
            }
            
            // ======================
            // QUICK ACTION BUTTONS
            // ======================
            quickAddBtn.addEventListener('click', () => {
                addTaskModal.style.display = 'flex';
                document.getElementById('taskText').focus();
            });

            quickTodayBtn.addEventListener('click', () => {
                // Toggle today filter
                if (timeFilter === 'today') {
                    timeFilter = 'all';
                    quickTodayBtn.classList.remove('active-filter', 'today-active');
                    updateActiveButton('showAllTime', ['showToday', 'showThisWeek']);
                } else {
                    timeFilter = 'today';
                    dueDayFilter = null;
                    quickTodayBtn.classList.add('active-filter', 'today-active');
                    quickThisWeekBtn.classList.remove('active-filter', 'week-active');
                    quickOverdueBtn.classList.remove('active-filter', 'overdue-active');
                    quickDueDayBtn.classList.remove('active-filter', 'due-day-active');
                    updateActiveButton('showToday', ['showAllTime', 'showThisWeek']);
                }
                renderTasks();
            });

            quickThisWeekBtn.addEventListener('click', () => {
                // Toggle this week filter
                if (timeFilter === 'thisWeek') {
                    timeFilter = 'all';
                    quickThisWeekBtn.classList.remove('active-filter', 'week-active');
                    updateActiveButton('showAllTime', ['showToday', 'showThisWeek']);
                } else {
                    timeFilter = 'thisWeek';
                    dueDayFilter = null;
                    quickThisWeekBtn.classList.add('active-filter', 'week-active');
                    quickTodayBtn.classList.remove('active-filter', 'today-active');
                    quickOverdueBtn.classList.remove('active-filter', 'overdue-active');
                    quickDueDayBtn.classList.remove('active-filter', 'due-day-active');
                    updateActiveButton('showThisWeek', ['showAllTime', 'showToday']);
                }
                renderTasks();
            });

            quickOverdueBtn.addEventListener('click', () => {
                // Toggle overdue filter
                if (statusFilter === 'overdue') {
                    statusFilter = 'all';
                    quickOverdueBtn.classList.remove('active-filter', 'overdue-active');
                    updateActiveButton('showOverdue', [], false);
                } else {
                    statusFilter = 'overdue';
                    dueDayFilter = null;
                    timeFilter = 'all';
                    quickOverdueBtn.classList.add('active-filter', 'overdue-active');
                    quickTodayBtn.classList.remove('active-filter', 'today-active');
                    quickThisWeekBtn.classList.remove('active-filter', 'week-active');
                    quickDueDayBtn.classList.remove('active-filter', 'due-day-active');
                    updateActiveButton('showOverdue', [], true);
                    updateActiveButton('showAllTime', ['showToday', 'showThisWeek']);
                }
                renderTasks();
            });

            quickDueDayBtn.addEventListener('click', () => {
                if (dueDayFilter) {
                    // If filter is already active, clear it
                    dueDayFilter = null;
                    quickDueDayBtn.classList.remove('active-filter', 'due-day-active');
                    quickDueDayBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> <span>Due Day</span><span class="filter-indicator">●</span>';
                    renderTasks();
                } else {
                    // Open modal to select date
                    dueDayModal.style.display = 'flex';
                    
                    // Set default date to today
                    dueDayDate.value = new Date().toLocaleDateString('en-CA');
                }
            });

            quickSearchBtn.addEventListener('click', () => {
                if (searchTerm === '') {
                    // Show search panel
                    if (searchGroup.style.display === 'none') {
                        searchVisible = true;
                        searchGroup.style.display = 'flex';
                        toggleSearchBtn.innerHTML = '<i class="fas fa-search"></i>';
                        toggleSearchBtn.title = 'Hide Search';
                    }
                    document.getElementById('searchInput').focus();
                } else {
                    // Clear search
                    searchInput.value = '';
                    searchTerm = '';
                    clearSearch.style.display = 'none';
                    quickSearchBtn.classList.remove('active-filter', 'search-active');
                    renderTasks();
                }
            });
            
            // ======================
            // FLOATING BUTTONS FUNCTIONALITY
            // ======================
            toggleControlsBtn.addEventListener('click', () => {
                controlsVisible = !controlsVisible;
                if (controlsVisible) {
                    controlsPanel.classList.remove('hidden');
                    toggleControlsBtn.innerHTML = '<i class="fas fa-sliders-h"></i>';
                    toggleControlsBtn.title = 'Hide Controls';
                } else {
                    controlsPanel.classList.add('hidden');
                    toggleControlsBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    toggleControlsBtn.title = 'Show Controls';
                }
            });

            toggleSearchBtn.addEventListener('click', () => {
                searchVisible = !searchVisible;
                if (searchVisible) {
                    searchGroup.style.display = 'flex';
                    toggleSearchBtn.innerHTML = '<i class="fas fa-search"></i>';
                    toggleSearchBtn.title = 'Hide Search';
                    setTimeout(() => {
                        document.getElementById('searchInput').focus();
                    }, 100);
                } else {
                    searchGroup.style.display = 'none';
                    toggleSearchBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    toggleSearchBtn.title = 'Show Search';
                }
            });

            toggleFiltersBtn.addEventListener('click', () => {
                filtersVisible = !filtersVisible;
                filterGroups.forEach(group => {
                    if (filtersVisible) {
                        group.style.display = 'block';
                        toggleFiltersBtn.innerHTML = '<i class="fas fa-filter"></i>';
                        toggleFiltersBtn.title = 'Hide Filters';
                    } else {
                        group.style.display = 'none';
                        toggleFiltersBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                        toggleFiltersBtn.title = 'Show Filters';
                    }
                });
            });

            toggleFileBtn.addEventListener('click', () => {
                fileOptionsVisible = !fileOptionsVisible;
                if (fileOptionsVisible) {
                    dataGroup.style.display = 'block';
                    toggleFileBtn.innerHTML = '<i class="fas fa-file"></i>';
                    toggleFileBtn.title = 'Hide File Options';
                } else {
                    dataGroup.style.display = 'none';
                    toggleFileBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                    toggleFileBtn.title = 'Show File Options';
                }
            });
            
            // ======================
            // TASK MANAGEMENT FUNCTIONS
            // ======================
            
            // Load tasks from localStorage
            function loadTasks() {
                const tasksJSON = localStorage.getItem('tasks');
                return tasksJSON ? JSON.parse(tasksJSON) : [];
            }
            
            // Save tasks to localStorage
            function saveTasks(tasks) {
                localStorage.setItem('tasks', JSON.stringify(tasks));
            }
            
            // Initialize tasks with sample data if empty
            function initTasks() {
                let tasks = loadTasks();
                
                if (tasks.length === 0) {
                    const today = new Date();
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    tasks = [
                        {
                            id: 1,
                            text: 'Complete project proposal',
                            category: 'work',
                            priority: 'high',
                            dueDate: today.toLocaleDateString('en-CA'),
                            completed: false,
                            notes: 'Remember to include budget section and timeline'
                        },
                        {
                            id: 2,
                            text: 'Buy groceries for the week',
                            category: 'shopping',
                            priority: 'medium',
                            dueDate: tomorrow.toLocaleDateString('en-CA'),
                            completed: false,
                            notes: 'Milk, eggs, bread, vegetables, fruits'
                        },
                        {
                            id: 3,
                            text: 'Prepare for team meeting',
                            category: 'work',
                            priority: 'medium',
                            dueDate: null,
                            completed: false,
                            notes: 'Review agenda and prepare talking points'
                        },
                        {
                            id: 4,
                            text: 'Overdue task example',
                            category: 'personal',
                            priority: 'high',
                            dueDate: new Date(Date.now() - 86400000).toLocaleDateString('en-CA'),
                            completed: false,
                            notes: 'This task is overdue'
                        }
                    ];
                    
                    saveTasks(tasks);
                }
                
                return tasks;
            }
            
            // Generate a unique ID for new tasks
            function generateId(tasks) {
                return tasks.length > 0 ? Math.max(...tasks.map(task => task.id)) + 1 : 1;
            }
            
            // Render tasks in the kanban board
            function renderTasks() {
                const tasks = loadTasks();
                const container = document.getElementById('kanbanContainer');
                container.innerHTML = '';
                
                // Update quick action button states
                quickTodayBtn.classList.remove('active-filter', 'today-active');
                quickThisWeekBtn.classList.remove('active-filter', 'week-active');
                quickOverdueBtn.classList.remove('active-filter', 'overdue-active');
                quickDueDayBtn.classList.remove('active-filter', 'due-day-active');
                quickSearchBtn.classList.remove('active-filter', 'search-active');
                
                if (timeFilter === 'today') {
                    quickTodayBtn.classList.add('active-filter', 'today-active');
                } else if (timeFilter === 'thisWeek') {
                    quickThisWeekBtn.classList.add('active-filter', 'week-active');
                }
                
                if (statusFilter === 'overdue') {
                    quickOverdueBtn.classList.add('active-filter', 'overdue-active');
                }
                
                if (dueDayFilter) {
                    quickDueDayBtn.classList.add('active-filter', 'due-day-active');
                    // Update button text to show the selected date
                    const dateObj = new Date(dueDayFilter);
                    const formattedDate = dateObj.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    quickDueDayBtn.innerHTML = `<i class="fas fa-calendar-alt"></i> <span>${formattedDate}</span><span class="filter-indicator">●</span>`;
                } else {
                    quickDueDayBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> <span>Due Day</span><span class="filter-indicator">●</span>';
                }
                
                if (searchTerm && searchTerm !== '') {
                    quickSearchBtn.classList.add('active-filter', 'search-active');
                    quickSearchBtn.innerHTML = '<i class="fas fa-filter"></i> <span>Clear Filter</span><span class="filter-indicator">●</span>';
                } else {
                    quickSearchBtn.innerHTML = '<i class="fas fa-filter"></i> <span>Search Filter</span><span class="filter-indicator">●</span>';
                }
                
                // Filter tasks based on current filters
                let filteredTasks = tasks.filter(task => {
                    // Filter by completion status
                    if (!showCompleted && task.completed) return false;
                    
                    // Filter by due day (highest priority)
                    if (dueDayFilter) {
                        if (!task.dueDate || !isDueOnSpecificDay(task.dueDate, dueDayFilter)) {
                            return false;
                        }
                    }
                    // Existing time filters (only apply if no due day filter)
                    else if (timeFilter === 'today') {
                        if (!task.dueDate || !isDueToday(task.dueDate)) return false;
                    } else if (timeFilter === 'thisWeek') {
                        if (!task.dueDate || !isDueThisWeek(task.dueDate)) return false;
                    }
                    
                    // Filter by status (only apply if no due day filter)
                    if (!dueDayFilter) {
                        if (statusFilter === 'overdue') {
                            if (!task.dueDate || !isOverdue(task.dueDate)) return false;
                        } else if (statusFilter === 'noDate') {
                            if (task.dueDate) return false;
                        }
                    }
                    
                    // Filter by search term
                    if (searchTerm && !task.text.toLowerCase().includes(searchTerm.toLowerCase()) && 
                        !(task.notes && task.notes.toLowerCase().includes(searchTerm.toLowerCase()))) {
                        return false;
                    }
                    
                    return true;
                });
                
                // Sort tasks
                if (currentSort === 'deadline') {
                    filteredTasks.sort((a, b) => {
                        if (!a.dueDate && !b.dueDate) return 0;
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        return a.dueDate.localeCompare(b.dueDate);
                    });
                } else if (currentSort === 'priority') {
                    filteredTasks.sort((a, b) => {
                        return priorityValues[a.priority] - priorityValues[b.priority];
                    });
                }
                
                // Group tasks by category
                const tasksByCategory = {};
                Object.keys(categoryNames).forEach(category => {
                    tasksByCategory[category] = filteredTasks.filter(task => task.category === category);
                });
                
                // Create columns for each category
                Object.entries(categoryNames).forEach(([categoryKey, categoryName]) => {
                    const categoryTasks = tasksByCategory[categoryKey];
                    
                    if (!showEmptyCategories && categoryTasks.length === 0) return;
                    
                    const column = document.createElement('div');
                    column.className = `kanban-column ${categoryKey}-column`;
                    column.dataset.category = categoryKey;
                    
                    const columnHeader = document.createElement('div');
                    columnHeader.className = 'column-header';
                    
                    const headerContent = document.createElement('div');
                    headerContent.innerHTML = `<i class="fas ${categoryIcons[categoryKey]}"></i> ${categoryName}`;
                    
                    const taskCount = document.createElement('span');
                    taskCount.className = 'task-count';
                    taskCount.textContent = categoryTasks.length;
                    
                    columnHeader.appendChild(headerContent);
                    columnHeader.appendChild(taskCount);
                    column.appendChild(columnHeader);
                    
                    const tasksContainer = document.createElement('div');
                    tasksContainer.className = 'tasks-container';
                    
                    if (categoryTasks.length === 0) {
                        const emptyMessage = document.createElement('div');
                        emptyMessage.className = 'empty-column';
                        emptyMessage.textContent = 'No tasks in this category';
                        tasksContainer.appendChild(emptyMessage);
                    } else {
                        categoryTasks.forEach(task => {
                            const taskElement = createTaskElement(task);
                            tasksContainer.appendChild(taskElement);
                        });
                    }
                    
                    column.appendChild(tasksContainer);
                    container.appendChild(column);
                });
                
                // Make kanban columns droppable after rendering
                setTimeout(() => {
                    document.querySelectorAll('.kanban-column').forEach(column => {
                        column.addEventListener('dragover', allowDrop);
                        column.addEventListener('drop', drop);
                        column.addEventListener('dragleave', (e) => {
                            // Only remove class if leaving the column (not just moving between child elements)
                            if (!column.contains(e.relatedTarget)) {
                                column.classList.remove('drag-over');
                            }
                        });
                    });
                    
                    // Add dragend event to tasks
                    document.querySelectorAll('.kanban-task').forEach(task => {
                        task.addEventListener('dragend', dragEnd);
                    });
                }, 100);
            }
            
            // Create a task element
            function createTaskElement(task) {
                const taskElement = document.createElement('div');
                taskElement.className = `kanban-task ${task.priority}-priority ${task.completed ? 'completed' : ''}`;
                taskElement.dataset.id = task.id;
                
                if (task.dueDate) {
                    const today = new Date().toLocaleDateString('en-CA');
                    const taskDate = new Date(task.dueDate);
                    const todayDate = new Date(today);
                    
                    if (taskDate < todayDate) {
                        taskElement.classList.add('overdue');
                    } else if (task.dueDate === today) {
                        taskElement.classList.add('due-today');
                    }
                }
                
                const taskContent = document.createElement('div');
                taskContent.className = 'task-content';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'task-checkbox';
                checkbox.checked = task.completed;
                checkbox.addEventListener('change', () => toggleTaskCompletion(task.id));
                
                const textSpan = document.createElement('span');
                textSpan.className = 'task-text';
                textSpan.textContent = task.text;
                textSpan.addEventListener('click', () => editTask(task.id));
                
                taskContent.appendChild(checkbox);
                taskContent.appendChild(textSpan);
                
                const taskMeta = document.createElement('div');
                taskMeta.className = 'task-meta';
                
                if (task.priority) {
                    const prioritySpan = document.createElement('span');
                    prioritySpan.className = `task-priority ${task.priority}`;
                    prioritySpan.innerHTML = `<i class="fas ${priorityIcons[task.priority]}"></i> ${priorityNames[task.priority]}`;
                    taskMeta.appendChild(prioritySpan);
                }
                
                if (task.dueDate) {
                    const dateSpan = document.createElement('span');
                    dateSpan.className = 'task-date';
                    
                    const today = new Date().toLocaleDateString('en-CA');
                    const taskDate = new Date(task.dueDate);
                    const todayDate = new Date(today);
                    
                    if (taskDate < todayDate) {
                        dateSpan.classList.add('overdue');
                    } else if (task.dueDate === today) {
                        dateSpan.classList.add('today');
                    }
                    
                    const formattedDate = formatDate(task.dueDate);
                    dateSpan.innerHTML = `<i class="fas fa-calendar"></i> ${formattedDate}`;
                    taskMeta.appendChild(dateSpan);
                }
                
                const categorySpan = document.createElement('span');
                categorySpan.className = 'task-category';
                categorySpan.innerHTML = `<i class="fas ${categoryIcons[task.category]}"></i>`;
                taskMeta.appendChild(categorySpan);
                
                const taskActions = document.createElement('div');
                taskActions.className = 'task-actions';
                
                const notesBtn = document.createElement('button');
                notesBtn.className = 'task-action-btn notes-btn';
                notesBtn.title = 'View/Edit Progress Notes';
                notesBtn.innerHTML = '<i class="fas fa-sticky-note"></i>';

                // Add note indicator if task has notes
                if (task.notes && task.notes.trim() !== '') {
                    const noteCount = task.notes.split('\n').filter(line => line.trim() !== '').length;
                    notesBtn.innerHTML += `<span class="notes-indicator">${noteCount}</span>`;
                    notesBtn.classList.add('has-notes');
                }
                
                notesBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showNotesModal(task.id);
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'task-action-btn delete-btn';
                deleteBtn.title = 'Delete Task';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTask(task.id);
                });
                
                taskActions.appendChild(notesBtn);
                taskActions.appendChild(deleteBtn);
                
                taskElement.appendChild(taskContent);
                taskElement.appendChild(taskMeta);
                taskElement.appendChild(taskActions);
                
                // Make task draggable
                taskElement.draggable = true;
                taskElement.addEventListener('dragstart', dragStart);
                
                return taskElement;
            }
            
            // ======================
            // DRAG AND DROP FUNCTIONS - FIXED VERSION
            // ======================
            function dragStart(e) {
                e.dataTransfer.setData('text/plain', e.target.dataset.id);
                e.dataTransfer.effectAllowed = 'move';
                e.target.classList.add('dragging');
                
                setTimeout(() => {
                    e.target.style.opacity = '0.4';
                }, 0);
            }
            
            function allowDrop(e) {
                e.preventDefault();
                
                // Remove drag-over class from all columns first
                document.querySelectorAll('.kanban-column').forEach(col => {
                    col.classList.remove('drag-over');
                });
                
                // Find the target column
                let targetColumn;
                if (e.target.classList.contains('kanban-column')) {
                    targetColumn = e.target;
                } else {
                    targetColumn = e.target.closest('.kanban-column');
                }
                
                // Add drag-over class to the target column
                if (targetColumn) {
                    targetColumn.classList.add('drag-over');
                }
            }
            
            function drop(e) {
                e.preventDefault();
                
                // Remove drag-over class from all columns
                document.querySelectorAll('.kanban-column').forEach(col => {
                    col.classList.remove('drag-over');
                });
                
                // Get the dragged task ID
                const taskId = parseInt(e.dataTransfer.getData('text/plain'));
                
                // Find the target column
                let targetColumn;
                if (e.target.classList.contains('kanban-column')) {
                    targetColumn = e.target;
                } else {
                    targetColumn = e.target.closest('.kanban-column');
                }
                
                if (!targetColumn) return;
                
                const newCategory = targetColumn.dataset.category;
                
                // Update task category
                const tasks = loadTasks();
                const taskIndex = tasks.findIndex(task => task.id === taskId);
                
                if (taskIndex !== -1) {
                    // Don't allow dropping in the same category
                    if (tasks[taskIndex].category === newCategory) {
                        renderTasks();
                        return;
                    }
                    
                    tasks[taskIndex].category = newCategory;
                    saveTasks(tasks);
                    renderTasks();
                }
            }
            
            function dragEnd(e) {
                // Remove dragging class and reset opacity
                document.querySelectorAll('.kanban-task').forEach(task => {
                    task.classList.remove('dragging');
                    task.style.opacity = '1';
                });
                
                // Remove drag-over class from all columns
                document.querySelectorAll('.kanban-column').forEach(col => {
                    col.classList.remove('drag-over');
                });
            }
            
            // ======================
            // TASK ACTIONS
            // ======================
            function toggleTaskCompletion(taskId) {
                const tasks = loadTasks();
                const taskIndex = tasks.findIndex(task => task.id === taskId);
                
                if (taskIndex !== -1) {
                    tasks[taskIndex].completed = !tasks[taskIndex].completed;
                    saveTasks(tasks);
                    renderTasks();
                }
            }
            
            function editTask(taskId) {
                const tasks = loadTasks();
                const taskIndex = tasks.findIndex(task => task.id === taskId);
                
                if (taskIndex !== -1) {
                    const task = tasks[taskIndex];
                    
                    // Populate the form with task data
                    document.getElementById('taskText').value = task.text;
                    document.getElementById('taskCategory').value = task.category;
                    document.getElementById('taskPriority').value = task.priority;
                    document.getElementById('taskDueDate').value = task.dueDate || '';
                    document.getElementById('taskNotes').value = task.notes || '';
                    
                    // Change the form to edit mode
                    document.querySelector('.modal-title').textContent = 'Edit Task';
                    document.querySelector('.btn-primary').textContent = 'Update Task';
                    
                    // Store the task ID being edited
                    currentEditingTaskId = taskId;
                    
                    // Show the modal
                    addTaskModal.style.display = 'flex';
                    
                    // Auto-focus on the task text field
                    setTimeout(() => {
                        document.getElementById('taskText').focus();
                    }, 100);
                }
            }
            
            function deleteTask(taskId) {
                if (confirm('Are you sure you want to delete this task?')) {
                    const tasks = loadTasks();
                    const updatedTasks = tasks.filter(task => task.id !== taskId);
                    saveTasks(updatedTasks);
                    renderTasks();
                }
            }
            
            // ======================
            // ENHANCED NOTES MANAGEMENT
            // ======================
            function showNotesModal(taskId) {
                const tasks = loadTasks();
                const task = tasks.find(task => task.id === taskId);
                
                if (task) {
                    notesTextarea.value = task.notes || '';
                    currentEditingTaskId = taskId;
                    
                    // Update modal title with task info
                    document.querySelector('#notesModal .modal-title').textContent = 
                        `Notes: ${task.text.substring(0, 50)}${task.text.length > 50 ? '...' : ''}`;
                    
                    // Show notes preview
                    showNotesPreview(task.notes);
                    
                    notesModal.style.display = 'flex';
                    notesTextarea.focus();
                }
            }
            
            function showNotesPreview(notes) {
                const preview = document.getElementById('notesPreview');
                if (!preview) return;
                
                if (!notes || notes.trim() === '') {
                    preview.innerHTML = '<em>No notes yet. Start adding your progress and ideas!</em>';
                    return;
                }
                
                // Simple parsing for preview
                const lines = notes.split('\n').filter(line => line.trim() !== '');
                preview.innerHTML = lines.map(line => `
                    <div class="note-content">
                        <div class="note-text">${line}</div>
                    </div>
                `).join('');
            }
            
            function saveNotesHandler() {
                if (currentEditingTaskId === null) return;
                
                const tasks = loadTasks();
                const taskIndex = tasks.findIndex(task => task.id === currentEditingTaskId);
                
                if (taskIndex !== -1) {
                    tasks[taskIndex].notes = notesTextarea.value;
                    tasks[taskIndex].lastUpdated = new Date().toISOString();
                    saveTasks(tasks);
                    renderTasks();
                }
                
                closeNotesModalHandler();
            }
            
            function closeNotesModalHandler() {
                notesModal.style.display = 'none';
                currentEditingTaskId = null;
            }
            
            // ======================
            // DUE DAY MODAL FUNCTIONS
            // ======================
            dueDayToday.addEventListener('click', () => {
                dueDayDate.value = new Date().toLocaleDateString('en-CA');
            });
            
            dueDayTomorrow.addEventListener('click', () => {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                dueDayDate.value = tomorrow.toLocaleDateString('en-CA');
            });
            
            dueDayNextWeek.addEventListener('click', () => {
                const nextMonday = new Date();
                const daysUntilMonday = (1 - nextMonday.getDay() + 7) % 7;
                if (daysUntilMonday === 0) nextMonday.setDate(nextMonday.getDate() + 7);
                else nextMonday.setDate(nextMonday.getDate() + daysUntilMonday);
                dueDayDate.value = nextMonday.toLocaleDateString('en-CA');
            });
            
            applyDueDay.addEventListener('click', () => {
                if (dueDayDate.value) {
                    dueDayFilter = dueDayDate.value;
                    dueDayModal.style.display = 'none';
                    
                    // Clear other filters
                    timeFilter = 'all';
                    statusFilter = 'all';
                    
                    // Update button states
                    quickTodayBtn.classList.remove('active-filter', 'today-active');
                    quickThisWeekBtn.classList.remove('active-filter', 'week-active');
                    quickOverdueBtn.classList.remove('active-filter', 'overdue-active');
                    
                    updateActiveButton('showAllTime', ['showToday', 'showThisWeek']);
                    updateActiveButton('showOverdue', [], false);
                    
                    renderTasks();
                } else {
                    alert('Please select a date');
                }
            });
            
            // ======================
            // HELPER FUNCTIONS
            // ======================
            function formatDate(dateString) {
                if (!dateString) return '';
                
                const date = new Date(dateString);
                const today = new Date();
                const tomorrow = new Date();
                tomorrow.setDate(today.getDate() + 1);
                
                if (date.toDateString() === today.toDateString()) {
                    return 'Today';
                } else if (date.toDateString() === tomorrow.toDateString()) {
                    return 'Tomorrow';
                } else {
                    return date.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                }
            }
            
            function updateActiveButton(activeId, inactiveIds, active = true) {
                const activeBtn = document.getElementById(activeId);
                if (activeBtn) {
                    if (active) {
                        activeBtn.classList.add('active');
                    } else {
                        activeBtn.classList.remove('active');
                    }
                }
                
                inactiveIds.forEach(id => {
                    const inactiveBtn = document.getElementById(id);
                    if (inactiveBtn) {
                        inactiveBtn.classList.remove('active');
                    }
                });
            }
            
            // ======================
            // EVENT LISTENERS
            // ======================
            // Modal close events
            closeAddTaskModal.addEventListener('click', () => {
                addTaskModal.style.display = 'none';
                resetAddTaskForm();
            });
            
            cancelAddTask.addEventListener('click', () => {
                addTaskModal.style.display = 'none';
                resetAddTaskForm();
            });
            
            closeNotesModal.addEventListener('click', closeNotesModalHandler);
            
            cancelNotes.addEventListener('click', closeNotesModalHandler);
            
            // Due Day Modal close events
            closeDueDayModal.addEventListener('click', () => {
                dueDayModal.style.display = 'none';
            });
            
            cancelDueDay.addEventListener('click', () => {
                dueDayModal.style.display = 'none';
            });
            
            // Click outside modal to close
            window.addEventListener('click', (e) => {
                if (e.target === addTaskModal) {
                    addTaskModal.style.display = 'none';
                    resetAddTaskForm();
                }
                if (e.target === notesModal) {
                    closeNotesModalHandler();
                }
                if (e.target === dueDayModal) {
                    dueDayModal.style.display = 'none';
                }
            });
            
            // Quick note template buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('quick-note-btn')) {
                    const template = e.target.dataset.template;
                    const templateText = noteTemplates[template];
                    
                    if (!templateText) return;
                    
                    const cursorPos = notesTextarea.selectionStart;
                    const currentText = notesTextarea.value;
                    const timestamp = new Date().toLocaleString();
                    
                    const newText = `[${timestamp}] ${templateText}\n`;
                    
                    // Insert template at cursor position
                    notesTextarea.value = currentText.slice(0, cursorPos) + newText + currentText.slice(cursorPos);
                    
                    // Move cursor to end of inserted text
                    const newCursorPos = cursorPos + newText.length;
                    notesTextarea.setSelectionRange(newCursorPos, newCursorPos);
                    notesTextarea.focus();
                    
                    // Update preview
                    showNotesPreview(notesTextarea.value);
                }
            });
            
            // Add/Edit task form submission
            addTaskForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const taskText = document.getElementById('taskText').value.trim();
                const taskCategory = document.getElementById('taskCategory').value;
                const taskPriority = document.getElementById('taskPriority').value;
                const taskDueDate = document.getElementById('taskDueDate').value;
                const taskNotes = document.getElementById('taskNotes').value;
                
                if (!taskText) {
                    alert('Please enter a task description');
                    return;
                }
                
                const tasks = loadTasks();
                
                if (currentEditingTaskId) {
                    // Update existing task
                    const taskIndex = tasks.findIndex(task => task.id === currentEditingTaskId);
                    if (taskIndex !== -1) {
                        tasks[taskIndex].text = taskText;
                        tasks[taskIndex].category = taskCategory;
                        tasks[taskIndex].priority = taskPriority;
                        tasks[taskIndex].dueDate = taskDueDate || null;
                        tasks[taskIndex].notes = taskNotes;
                    }
                } else {
                    // Add new task
                    const newTask = {
                        id: generateId(tasks),
                        text: taskText,
                        category: taskCategory,
                        priority: taskPriority,
                        dueDate: taskDueDate || null,
                        completed: false,
                        notes: taskNotes
                    };
                    
                    tasks.push(newTask);
                }
                
                saveTasks(tasks);
                renderTasks();
                addTaskModal.style.display = 'none';
                resetAddTaskForm();
            });
            
            // Quick date buttons in the add task modal
            quickTodayBtnModal.addEventListener('click', function() {
                const today = new Date().toLocaleDateString('en-CA');
                document.getElementById('taskDueDate').value = today;
            });
            
            quickTomorrowBtnModal.addEventListener('click', function() {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('taskDueDate').value = tomorrow.toLocaleDateString('en-CA');
            });
            
            clearDateBtn.addEventListener('click', function() {
                document.getElementById('taskDueDate').value = '';
            });
            
            // Save notes
            saveNotes.addEventListener('click', saveNotesHandler);
            
            // Save/Load file functionality
            saveFileBtn.addEventListener('click', () => {
                const tasks = loadTasks();
                const dataStr = JSON.stringify(tasks, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'tasks.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            });
            
            loadFileBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const tasks = JSON.parse(event.target.result);
                        if (Array.isArray(tasks)) {
                            saveTasks(tasks);
                            renderTasks();
                            alert('Tasks loaded successfully!');
                        } else {
                            alert('Invalid file format');
                        }
                    } catch (error) {
                        alert('Error loading file: ' + error.message);
                    }
                };
                reader.readAsText(file);
                fileInput.value = '';
            });
            
            // Search functionality
            searchInput.addEventListener('input', (e) => {
                searchTerm = e.target.value;
                clearSearch.style.display = searchTerm ? 'block' : 'none';
                renderTasks();
            });
            
            clearSearch.addEventListener('click', () => {
                searchInput.value = '';
                searchTerm = '';
                clearSearch.style.display = 'none';
                renderTasks();
            });
            
            // Control buttons event listeners
            document.getElementById('viewAll').addEventListener('click', () => {
                showCompleted = true;
                updateActiveButton('viewAll', ['viewActive']);
                renderTasks();
            });
            
            document.getElementById('viewActive').addEventListener('click', () => {
                showCompleted = false;
                updateActiveButton('viewActive', ['viewAll']);
                renderTasks();
            });
            
            document.getElementById('showTasksOnly').addEventListener('click', (e) => {
                showEmptyCategories = !showEmptyCategories;
                e.target.classList.toggle('active');
                renderTasks();
            });
            
            document.getElementById('showAllCategories').addEventListener('click', (e) => {
                showEmptyCategories = !showEmptyCategories;
                e.target.classList.toggle('active');
                renderTasks();
            });
            
            document.getElementById('sortDefault').addEventListener('click', () => {
                currentSort = 'default';
                updateActiveButton('sortDefault', ['sortDeadline', 'sortPriority']);
                renderTasks();
            });
            
            document.getElementById('sortDeadline').addEventListener('click', () => {
                currentSort = 'deadline';
                updateActiveButton('sortDeadline', ['sortDefault', 'sortPriority']);
                renderTasks();
            });
            
            document.getElementById('sortPriority').addEventListener('click', () => {
                currentSort = 'priority';
                updateActiveButton('sortPriority', ['sortDefault', 'sortDeadline']);
                renderTasks();
            });
            
            document.getElementById('showAllTime').addEventListener('click', () => {
                timeFilter = 'all';
                dueDayFilter = null;
                updateActiveButton('showAllTime', ['showToday', 'showThisWeek']);
                quickTodayBtn.classList.remove('active-filter', 'today-active');
                quickThisWeekBtn.classList.remove('active-filter', 'week-active');
                quickDueDayBtn.classList.remove('active-filter', 'due-day-active');
                renderTasks();
            });
            
            document.getElementById('showToday').addEventListener('click', () => {
                timeFilter = 'today';
                dueDayFilter = null;
                updateActiveButton('showToday', ['showAllTime', 'showThisWeek']);
                quickTodayBtn.classList.add('active-filter', 'today-active');
                quickThisWeekBtn.classList.remove('active-filter', 'week-active');
                quickOverdueBtn.classList.remove('active-filter', 'overdue-active');
                quickDueDayBtn.classList.remove('active-filter', 'due-day-active');
                renderTasks();
            });
            
            document.getElementById('showThisWeek').addEventListener('click', () => {
                timeFilter = 'thisWeek';
                dueDayFilter = null;
                updateActiveButton('showThisWeek', ['showAllTime', 'showToday']);
                quickThisWeekBtn.classList.add('active-filter', 'week-active');
                quickTodayBtn.classList.remove('active-filter', 'today-active');
                quickOverdueBtn.classList.remove('active-filter', 'overdue-active');
                quickDueDayBtn.classList.remove('active-filter', 'due-day-active');
                renderTasks();
            });
            
            document.getElementById('showOverdue').addEventListener('click', (e) => {
                if (statusFilter === 'overdue') {
                    statusFilter = 'all';
                    e.target.classList.remove('active');
                    quickOverdueBtn.classList.remove('active-filter', 'overdue-active');
                } else {
                    statusFilter = 'overdue';
                    dueDayFilter = null;
                    timeFilter = 'all';
                    e.target.classList.add('active');
                    quickOverdueBtn.classList.add('active-filter', 'overdue-active');
                    quickTodayBtn.classList.remove('active-filter', 'today-active');
                    quickThisWeekBtn.classList.remove('active-filter', 'week-active');
                    quickDueDayBtn.classList.remove('active-filter', 'due-day-active');
                    updateActiveButton('showAllTime', ['showToday', 'showThisWeek']);
                }
                renderTasks();
            });
            
            document.getElementById('showNoDate').addEventListener('click', (e) => {
                if (statusFilter === 'noDate') {
                    statusFilter = 'all';
                    e.target.classList.remove('active');
                } else {
                    statusFilter = 'noDate';
                    dueDayFilter = null;
                    e.target.classList.add('active');
                    quickTodayBtn.classList.remove('active-filter', 'today-active');
                    quickThisWeekBtn.classList.remove('active-filter', 'week-active');
                    quickOverdueBtn.classList.remove('active-filter', 'overdue-active');
                    quickDueDayBtn.classList.remove('active-filter', 'due-day-active');
                    updateActiveButton('showAllTime', ['showToday', 'showThisWeek']);
                }
                renderTasks();
            });
            
            // Reset add task form
            function resetAddTaskForm() {
                addTaskForm.reset();
                document.querySelector('.modal-title').textContent = 'Add New Task';
                document.querySelector('.btn-primary').textContent = 'Add Task';
                currentEditingTaskId = null;
                taskDueDate.value = ''; // Clear the date field
            }
            
            // ======================
            // INITIALIZATION
            // ======================
            function init() {
                applyDefaultVisibility();
                initTasks();
                renderTasks();
            }
            
            // Start the application
            init();
        });
    </script>
</body>
</html>