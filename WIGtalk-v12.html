<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Meeting Notes | Personal Tracker</title>
    <style>
        :root {
            --primary-color: #2c5aa0;
            --secondary-color: #4a7bc8;
            --light-color: #f8fafc;
            --dark-color: #2d3748;
            --accent-color: #4361ee;
            --progress-color: #4cc9f0;
            --results-color: #7209b7;
            --planning-color: #f72585;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --danger-color: #f56565;
            --gray-light: #e2e8f0;
            --gray-medium: #a0aec0;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            color: var(--dark-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }
        
        header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" fill="white" opacity="0.1"><circle cx="50" cy="50" r="2"/></svg>') repeat;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 25px;
        }
        
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .calendar-section {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .calendar-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .calendar-nav-btn {
            background: var(--light-color);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .calendar-nav-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }
        
        .calendar-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .calendar-views {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .view-btn {
            padding: 10px 18px;
            background-color: var(--light-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        
        .view-btn:hover {
            background-color: var(--gray-light);
            transform: translateY(-1px);
        }
        
        .view-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            box-shadow: var(--shadow);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        
        .calendar-day {
            text-align: center;
            font-weight: 600;
            padding: 8px;
            font-size: 0.85rem;
            color: var(--gray-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .calendar-date {
            text-align: center;
            padding: 12px 6px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            position: relative;
            font-weight: 500;
            border: 2px solid transparent;
        }
        
        .calendar-date:hover {
            background-color: var(--light-color);
            transform: scale(1.05);
        }
        
        .calendar-date.selected {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            box-shadow: var(--shadow);
        }
        
        .calendar-date.today {
            border: 2px solid var(--success-color);
            font-weight: 700;
        }
        
        .calendar-date.has-meetings {
            background-color: var(--success-color);
            color: white;
        }
        
        .meeting-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .meeting-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .meeting-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .progress-section {
            border-top: 4px solid var(--progress-color);
            background: linear-gradient(to bottom right, white, #f0f9ff);
        }
        
        .results-section {
            border-top: 4px solid var(--results-color);
            background: linear-gradient(to bottom right, white, #f8f4ff);
        }
        
        .planning-section {
            border-top: 4px solid var(--planning-color);
            background: linear-gradient(to bottom right, white, #fff0f7);
        }
        
        .meeting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .meeting-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .progress-title {
            color: var(--progress-color);
        }
        
        .results-title {
            color: var(--results-color);
        }
        
        .planning-title {
            color: var(--planning-color);
        }
        
        .meeting-icon {
            font-size: 1.1rem;
        }
        
        .meeting-date {
            font-size: 0.85rem;
            color: var(--gray-medium);
            font-weight: 500;
        }
        
        .meeting-prompt {
            margin-bottom: 12px;
            color: var(--dark-color);
            font-style: italic;
            font-size: 0.9rem;
            padding: 8px 12px;
            background: var(--light-color);
            border-radius: 6px;
            border-left: 3px solid var(--primary-color);
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            resize: vertical;
            font-size: 1rem;
            line-height: 1.6;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        
        .actions-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #38a169);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #38a169, #2f855a);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #dd6b20);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #dd6b20, #c05621);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #e53e3e);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }
        
        .btn-secondary {
            background: var(--light-color);
            color: var(--dark-color);
        }
        
        .btn-secondary:hover {
            background: var(--gray-light);
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            background: var(--light-color);
            color: var(--dark-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            gap: 8px;
        }
        
        .file-label:hover {
            background: var(--gray-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .status-message {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .success {
            background-color: rgba(72, 187, 120, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(72, 187, 120, 0.2);
        }
        
        .error {
            background-color: rgba(245, 101, 101, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(245, 101, 101, 0.2);
        }
        
        .info {
            background-color: rgba(102, 126, 234, 0.1);
            color: var(--accent-color);
            border: 1px solid rgba(102, 126, 234, 0.2);
        }
        
        .empty-date {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray-medium);
            font-style: italic;
        }
        
        .previous-meeting {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(to right, var(--light-color), #f0f4f8);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            transition: all 0.2s;
        }
        
        .previous-meeting:hover {
            transform: translateX(5px);
        }
        
        .previous-meeting h3 {
            margin-bottom: 12px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        
        .previous-meeting-content {
            line-height: 1.7;
        }
        
        .previous-meeting-item {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 6px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .previous-meeting-item:last-child {
            margin-bottom: 0;
        }
        
        .previous-meeting-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        .previous-meeting.progress .previous-meeting-header {
            color: var(--progress-color);
        }
        
        .previous-meeting.results .previous-meeting-header {
            color: var(--results-color);
        }
        
        .previous-meeting.planning .previous-meeting-header {
            color: var(--planning-color);
        }
        
        .previous-meeting-text {
            white-space: pre-wrap;
            text-align: justify;
            hyphens: auto;
            font-size: 0.9rem;
        }
        
        .week-list-view {
            display: none;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .week-list-view.active {
            display: block;
        }
        
        .week-list-view::-webkit-scrollbar {
            width: 6px;
        }
        
        .week-list-view::-webkit-scrollbar-track {
            background: var(--light-color);
            border-radius: 10px;
        }
        
        .week-list-view::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }
        
        .week-list-view::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
        
        .week-list-day {
            margin-bottom: 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .week-list-day:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .week-list-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        
        .week-list-content {
            padding: 15px;
            background-color: white;
        }
        
        .week-meeting-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .week-meeting-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .week-meeting-time {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        
        .week-meeting-time.progress {
            color: var(--progress-color);
        }
        
        .week-meeting-time.results {
            color: var(--results-color);
        }
        
        .week-meeting-time.planning {
            color: var(--planning-color);
        }
        
        .week-meeting-text {
            padding: 12px;
            background-color: var(--light-color);
            border-radius: 6px;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 0.9rem;
        }
        
        .empty-meeting {
            color: var(--gray-medium);
            font-style: italic;
            padding: 12px;
            text-align: center;
        }
        
        .no-meetings-message {
            text-align: center;
            padding: 30px 15px;
            color: var(--gray-medium);
            font-style: italic;
        }
        
        footer {
            background: linear-gradient(135deg, var(--dark-color), #1a202c);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 30px;
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .footer-content p {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 1.1rem;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .autosave-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 8px;
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .autosave-indicator.saving {
            color: var(--warning-color);
        }
        
        .autosave-indicator.saved {
            color: var(--success-color);
        }
        
        .action-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-group-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-medium);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-icon {
            font-size: 1rem;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .user-settings {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark-color);
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .form-help {
            font-size: 0.8rem;
            color: var(--gray-medium);
            margin-top: 5px;
        }
        
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .export-option {
            padding: 15px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .export-option:hover {
            border-color: var(--primary-color);
            background-color: var(--light-color);
        }
        
        .export-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(44, 90, 160, 0.05);
        }
        
        .export-option-title {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .export-option-description {
            font-size: 0.9rem;
            color: var(--gray-medium);
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        /* Dynalist Modal Styles */
        .dynalist-modal .modal {
            max-width: 500px;
        }
        
        .dynalist-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .dynalist-enabled {
            background-color: var(--success-color);
        }
        
        .dynalist-disabled {
            background-color: var(--gray-medium);
        }
        
        /* Enhanced Calendar Views */
        .calendar-view-options {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .view-option-btn {
            padding: 8px 12px;
            background: var(--light-color);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .view-option-btn:hover {
            background: var(--gray-light);
        }
        
        .view-option-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .meeting-section,
            .meeting-section * {
                visibility: visible;
            }
            
            .meeting-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                box-shadow: none;
            }
            
            .actions-section,
            .action-group,
            .status-message,
            .previous-meeting,
            .autosave-indicator,
            .calendar-section,
            header,
            footer {
                display: none !important;
            }
            
            .meeting-card {
                box-shadow: none;
                border: 1px solid #ddd;
                margin-bottom: 20px;
                page-break-inside: avoid;
            }
            
            textarea {
                border: 1px solid #ccc;
                background: white;
            }
            
            .container {
                max-width: none;
                padding: 0;
                margin: 0;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 0;
            }
        }
        
        /* Enhanced View Styles */
        .timeline-view {
            display: none;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .timeline-view.active {
            display: block;
        }
        
        .timeline-item {
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
        }
        
        .timeline-date {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .timeline-content {
            margin-left: 25px;
        }
        
        .progress-timeline {
            border-left-color: var(--progress-color);
        }
        
        .results-timeline {
            border-left-color: var(--results-color);
        }
        
        .planning-timeline {
            border-left-color: var(--planning-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üî¨ Lab Meeting Notes (WIG)</h1>
            <p class="subtitle">Track your one-on-one meetings with the PI - Progress, Results, and Planning</p>
        </header>
        
        <div class="main-content">
            <section class="calendar-section">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" id="prev-period">‚Äπ</button>
                    <h2 class="calendar-title" id="current-period">Month Year</h2>
                    <button class="calendar-nav-btn" id="next-period">‚Ä∫</button>
                </div>
                
                <div class="calendar-views">
                    <button class="view-btn active" id="month-view-btn">
                        <span class="btn-icon">üìÖ</span> Month
                    </button>
                    <button class="view-btn" id="week-view-btn">
                        <span class="btn-icon">üìã</span> Week
                    </button>
                    <button class="view-btn btn-primary" id="history-btn">
                        <span class="btn-icon">üìä</span> History
                    </button>
                </div>
                
                <div class="calendar-view-options">
                    <button class="view-option-btn active" data-period="month">Month</button>
                    <button class="view-option-btn" data-period="week">Week</button>
                    <button class="view-option-btn" data-period="30days">30 Days</button>
                    <button class="view-option-btn" data-period="4months">4 Months</button>
                    <button class="view-option-btn" data-period="year">Year</button>
                </div>
                
                <div class="calendar-container">
                    <div id="month-calendar">
                        <div class="calendar-grid" id="calendar-days">
                            <!-- Calendar days will be generated here -->
                        </div>
                    </div>
                    <div id="week-calendar" class="week-list-view">
                        <!-- Week list will be generated here -->
                    </div>
                    <div id="timeline-calendar" class="timeline-view">
                        <!-- Timeline view will be generated here -->
                    </div>
                </div>
                
                <div class="user-settings">
                    <h3>Your Information</h3>
                    <div class="form-group">
                        <label class="form-label" for="user-name">Your Name</label>
                        <input type="text" id="user-name" class="form-input" placeholder="Enter your name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="user-email">Your Email</label>
                        <input type="email" id="user-email" class="form-input" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="pi-email">PI's Email</label>
                        <input type="email" id="pi-email" class="form-input" placeholder="Enter PI's email">
                    </div>
                    <button class="btn-primary" id="save-settings-btn">
                        <span class="btn-icon">üíæ</span> Save Settings
                    </button>
                </div>
            </section>
            
            <section class="meeting-section">
                <div class="meeting-card progress-section">
                    <div class="meeting-header">
                        <h2 class="meeting-title progress-title">
                            <span class="meeting-icon">üìà</span> Progress Update
                        </h2>
                        <div>
                            <span class="meeting-date" id="current-date"></span>
                            <span id="progress-autosave" class="autosave-indicator"></span>
                        </div>
                    </div>
                    
                    <p class="meeting-prompt">What progress has been made since our last meeting? What experiments are currently running?</p>
                    <textarea id="progress-text" placeholder="Document the progress, current experiments, and any challenges encountered..."></textarea>
                </div>
                
                <div class="meeting-card results-section">
                    <div class="meeting-header">
                        <h2 class="meeting-title results-title">
                            <span class="meeting-icon">üîç</span> Results & Findings
                        </h2>
                        <div>
                            <span class="meeting-date" id="current-date-results"></span>
                            <span id="results-autosave" class="autosave-indicator"></span>
                        </div>
                    </div>
                    <p class="meeting-prompt">What results have been obtained? Any significant findings, data analysis, or observations?</p>
                    <textarea id="results-text" placeholder="Record experimental results, data analysis, key findings, and observations..."></textarea>
                </div>
                
                <div class="meeting-card planning-section">
                    <div class="meeting-header">
                        <h2 class="meeting-title planning-title">
                            <span class="meeting-icon">üéØ</span> Next Steps & Planning
                        </h2>
                        <div>
                            <span class="meeting-date" id="current-date-planning"></span>
                            <span id="planning-autosave" class="autosave-indicator"></span>
                        </div>
                    </div>
                    <p class="meeting-prompt">What are the next steps? Any experiments to design, papers to read, or analyses to perform?</p>
                    <textarea id="planning-text" placeholder="Outline the plan for next steps, experiments, analyses, and deadlines..."></textarea>
                </div>
                
                <div class="action-group">
                    <div class="action-group-title">Meeting Actions</div>
                    <div class="actions-section">
                        <button class="btn-success" id="save-btn">
                            <span class="btn-icon">üíæ</span> Save
                        </button>
                        <input type="file" id="file-input" class="file-input" accept=".json">
                        <label for="file-input" class="file-label">
                            <span class="btn-icon">üìÇ</span> Import
                        </label>
                        <button class="btn-primary" id="export-btn">
                            <span class="btn-icon">üì§</span> Export
                        </button>
                        <!-- NEW: Dynalist Export Button -->
                        <button class="btn-primary" id="dynalist-export-btn">
                            <span class="btn-icon">üìù</span> Export to Dynalist
                        </button>
                    </div>
                </div>

                <div class="action-group">
                    <div class="action-group-title">Share with PI</div>
                    <div class="actions-section">
                        <button class="btn-primary" id="share-gmail-btn">
                            <span class="btn-icon">‚úâÔ∏è</span> Gmail to PI
                        </button>
                        <button class="btn-secondary" id="share-print-btn">
                            <span class="btn-icon">üñ®Ô∏è</span> Print Notes
                        </button>
                        <!-- NEW: Dynalist Settings Button -->
                        <button class="btn-secondary" id="dynalist-settings-btn">
                            <span class="btn-icon">‚öôÔ∏è</span> Dynalist Settings
                        </button>
                        <button class="btn-danger" id="clear-btn">
                            <span class="btn-icon">üóëÔ∏è</span> Clear Today
                        </button>
                    </div>
                </div>
                
                <div id="status-message" class="status-message"></div>
                
                <div id="previous-meeting" class="previous-meeting" style="display: none;">
                    <h3>
                        <span class="btn-icon">üìñ</span> Previous Meeting Notes
                    </h3>
                    <div id="previous-content" class="previous-meeting-content">
                        <!-- Previous meeting content will be generated here -->
                    </div>
                </div>
            </section>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>Lab WIG talk Notes v1.2 Copyright 2025 Dr. Wen-Ming Yang. All Rights Reserved ‚Ä¢ Personal Meeting Tracker for Lab Members</p>
        </div>
    </footer>

    <div class="modal-overlay" id="history-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Meeting History</h2>
                <button class="close-btn" id="close-history-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div id="history-content">
                    <!-- Meeting history will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="export-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Export Meeting Notes</h2>
                <button class="close-btn" id="close-export-modal">√ó</button>
            </div>
            <div class="modal-body">
                <p>Choose how you want to export your meeting notes:</p>
                <div class="export-options">
                    <div class="export-option" data-type="current">
                        <div class="export-option-title">
                            <span class="btn-icon">üìÖ</span> Current Meeting Only
                        </div>
                        <div class="export-option-description">
                            Export only today's meeting notes to share with your PI
                        </div>
                    </div>
                    <div class="export-option" data-type="range">
                        <div class="export-option-title">
                            <span class="btn-icon">üìÜ</span> Date Range
                        </div>
                        <div class="export-option-description">
                            Export meetings from a specific date range
                        </div>
                    </div>
                    <div class="export-option" data-type="all">
                        <div class="export-option-title">
                            <span class="btn-icon">üìÅ</span> All Meetings
                        </div>
                        <div class="export-option-description">
                            Export all your meeting notes as a backup
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="cancel-export">Cancel</button>
                    <button class="btn-primary" id="confirm-export" disabled>Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Gmail Modal -->
    <div class="modal-overlay" id="gmail-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Send via Gmail</h2>
                <button class="close-btn" id="close-gmail-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="gmail-subject">Subject</label>
                    <input type="text" id="gmail-subject" class="form-input" value="Lab Meeting Notes">
                </div>
                <div class="form-group">
                    <label class="form-label" for="gmail-body">Message</label>
                    <textarea id="gmail-body" class="form-input" rows="6" placeholder="Add any additional comments for your PI..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Meeting Notes Preview</label>
                    <div id="gmail-preview" style="padding: 12px; background: var(--light-color); border-radius: 6px; font-size: 0.9rem; max-height: 200px; overflow-y: auto;">
                        <!-- Preview will be generated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="cancel-gmail">Cancel</button>
                    <button class="btn-primary" id="send-gmail">Open Gmail Popout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: Dynalist Settings Modal -->
    <div class="modal-overlay dynalist-modal" id="dynalist-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Dynalist Settings</h2>
                <button class="close-btn" id="close-dynalist-modal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="dynalist-token">API Token</label>
                    <input type="password" id="dynalist-token" class="form-input" placeholder="Enter your Dynalist API token">
                    <div class="form-help">
                        Get your API token from: <a href="https://dynalist.io/developer" target="_blank">https://dynalist.io/developer</a>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="dynalist-doc-id">Document ID (Optional)</label>
                    <input type="text" id="dynalist-doc-id" class="form-input" placeholder="Leave empty to create new document each day">
                    <div class="form-help">
                        If specified, all exports will go to this document. Leave empty to create a new document for each day.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Current Status</label>
                    <div id="dynalist-status-display">
                        <span class="dynalist-status dynalist-disabled" id="dynalist-status-icon"></span>
                        <span id="dynalist-status-text">Not configured</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="test-connection">Test Connection</button>
                <button class="btn btn-primary" id="save-dynalist">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize variables
        let currentDate = new Date();
        let selectedDate = new Date();
        let meetingsData = {};
        let userName = '';
        let userEmail = '';
        let piEmail = '';
        let currentView = 'month';
        let currentPeriod = 'month';
        let autosaveTimeout;
        let autosaveEnabled = true;
        const AUTOSAVE_DELAY = 2000;
        
        // Dynalist configuration
        let dynalistApiKey = localStorage.getItem('dynalistApiKey') || '';
        let dynalistDocId = localStorage.getItem('dynalistDocId') || '';
        
        // DOM Elements
        const currentPeriodElement = document.getElementById('current-period');
        const calendarDaysElement = document.getElementById('calendar-days');
        const currentDateElement = document.getElementById('current-date');
        const currentDateResultsElement = document.getElementById('current-date-results');
        const currentDatePlanningElement = document.getElementById('current-date-planning');
        const progressTextElement = document.getElementById('progress-text');
        const resultsTextElement = document.getElementById('results-text');
        const planningTextElement = document.getElementById('planning-text');
        const saveButton = document.getElementById('save-btn');
        const exportButton = document.getElementById('export-btn');
        const fileInput = document.getElementById('file-input');
        const statusMessage = document.getElementById('status-message');
        const prevPeriodButton = document.getElementById('prev-period');
        const nextPeriodButton = document.getElementById('next-period');
        const monthViewButton = document.getElementById('month-view-btn');
        const weekViewButton = document.getElementById('week-view-btn');
        const historyButton = document.getElementById('history-btn');
        const monthCalendar = document.getElementById('month-calendar');
        const weekCalendar = document.getElementById('week-calendar');
        const timelineCalendar = document.getElementById('timeline-calendar');
        const previousMeetingElement = document.getElementById('previous-meeting');
        const previousContentElement = document.getElementById('previous-content');
        const clearButton = document.getElementById('clear-btn');
        const historyModal = document.getElementById('history-modal');
        const closeHistoryModal = document.getElementById('close-history-modal');
        const historyContent = document.getElementById('history-content');
        const exportModal = document.getElementById('export-modal');
        const closeExportModal = document.getElementById('close-export-modal');
        const cancelExport = document.getElementById('cancel-export');
        const confirmExport = document.getElementById('confirm-export');
        const exportOptions = document.querySelectorAll('.export-option');
        const gmailModal = document.getElementById('gmail-modal');
        const closeGmailModal = document.getElementById('close-gmail-modal');
        const cancelGmail = document.getElementById('cancel-gmail');
        const sendGmail = document.getElementById('send-gmail');
        const shareGmailButton = document.getElementById('share-gmail-btn');
        const sharePrintButton = document.getElementById('share-print-btn');
        const userNameInput = document.getElementById('user-name');
        const userEmailInput = document.getElementById('user-email');
        const piEmailInput = document.getElementById('pi-email');
        const saveSettingsButton = document.getElementById('save-settings-btn');
        const progressAutosave = document.getElementById('progress-autosave');
        const resultsAutosave = document.getElementById('results-autosave');
        const planningAutosave = document.getElementById('planning-autosave');
        const viewOptionButtons = document.querySelectorAll('.view-option-btn');
        const gmailPreview = document.getElementById('gmail-preview');
        const gmailSubject = document.getElementById('gmail-subject');
        const gmailBody = document.getElementById('gmail-body');
        
        // NEW: Dynalist DOM Elements
        const dynalistExportBtn = document.getElementById('dynalist-export-btn');
        const dynalistSettingsBtn = document.getElementById('dynalist-settings-btn');
        const dynalistModal = document.getElementById('dynalist-modal');
        const closeDynalistModalBtn = document.getElementById('close-dynalist-modal');
        const dynalistTokenInput = document.getElementById('dynalist-token');
        const dynalistDocIdInput = document.getElementById('dynalist-doc-id');
        const testConnectionBtn = document.getElementById('test-connection');
        const saveDynalistBtn = document.getElementById('save-dynalist');
        const dynalistStatusIcon = document.getElementById('dynalist-status-icon');
        const dynalistStatusText = document.getElementById('dynalist-status-text');
        
        // Initialize the application
        function init() {
            loadUserData();
            loadMeetingsData();
            renderCalendar();
            updateMeetingDisplay();
            setupEventListeners();
            updateAutosaveIndicators('saved');
            updateDynalistStatusDisplay();
        }
        
        // Load user data from localStorage
        function loadUserData() {
            const savedName = localStorage.getItem('labMeetingUserName');
            const savedEmail = localStorage.getItem('labMeetingUserEmail');
            const savedPiEmail = localStorage.getItem('labMeetingPiEmail');
            
            if (savedName) {
                userName = savedName;
                userNameInput.value = savedName;
            }
            
            if (savedEmail) {
                userEmail = savedEmail;
                userEmailInput.value = savedEmail;
            }
            
            if (savedPiEmail) {
                piEmail = savedPiEmail;
                piEmailInput.value = savedPiEmail;
            }
        }
        
        // Load meetings data from localStorage
        function loadMeetingsData() {
            const savedMeetings = localStorage.getItem('labMeetingData');
            if (savedMeetings) {
                meetingsData = JSON.parse(savedMeetings);
            }
        }
        
        // Save meetings data to localStorage
        function saveMeetingsData() {
            localStorage.setItem('labMeetingData', JSON.stringify(meetingsData));
        }
        
        // Save user data to localStorage
        function saveUserData() {
            localStorage.setItem('labMeetingUserName', userName);
            localStorage.setItem('labMeetingUserEmail', userEmail);
            localStorage.setItem('labMeetingPiEmail', piEmail);
        }
        
        // Render the calendar based on current view and period
        function renderCalendar() {
            switch (currentPeriod) {
                case 'month':
                    renderMonthView();
                    break;
                case 'week':
                    renderWeekView();
                    break;
                case '30days':
                    render30DayView();
                    break;
                case '4months':
                    render4MonthView();
                    break;
                case 'year':
                    renderYearView();
                    break;
            }
        }
        
        // Render month view
        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            currentPeriodElement.textContent = currentDate.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });
            
            calendarDaysElement.innerHTML = '';
            
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            daysOfWeek.forEach(day => {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.textContent = day;
                calendarDaysElement.appendChild(dayElement);
            });
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            for (let i = 0; i < startingDay; i++) {
                const emptyElement = document.createElement('div');
                emptyElement.classList.add('calendar-date', 'empty');
                calendarDaysElement.appendChild(emptyElement);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateElement = document.createElement('div');
                dateElement.classList.add('calendar-date');
                dateElement.textContent = day;
                
                const date = new Date(year, month, day);
                const dateString = formatDate(date);
                
                if (isToday(date)) {
                    dateElement.classList.add('today');
                }
                
                if (isSameDate(date, selectedDate)) {
                    dateElement.classList.add('selected');
                }
                
                if (meetingsData[dateString] && hasMeetingData(dateString)) {
                    dateElement.classList.add('has-meetings');
                }
                
                dateElement.addEventListener('click', () => {
                    selectDate(date);
                });
                
                calendarDaysElement.appendChild(dateElement);
            }
            
            showView('month');
        }
        
        // Render week view
        function renderWeekView() {
            weekCalendar.innerHTML = '';
            
            const weekStart = new Date(currentDate);
            weekStart.setDate(currentDate.getDate() - currentDate.getDay());
            
            for (let i = 0; i < 7; i++) {
                const currentDay = new Date(weekStart);
                currentDay.setDate(weekStart.getDate() + i);
                const dateString = formatDate(currentDay);
                
                const dayElement = document.createElement('div');
                dayElement.classList.add('week-list-day');
                
                const dayHeader = document.createElement('div');
                dayHeader.classList.add('week-list-header');
                
                const dayName = currentDay.toLocaleDateString('en-US', { weekday: 'long' });
                const dayDate = currentDay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                dayHeader.innerHTML = `
                    <span>${dayName}</span>
                    <span>${dayDate}</span>
                `;
                
                dayElement.appendChild(dayHeader);
                
                const dayContent = document.createElement('div');
                dayContent.classList.add('week-list-content');
                
                if (meetingsData[dateString] && hasMeetingData(dateString)) {
                    const meeting = meetingsData[dateString];
                    
                    if (meeting.progress) {
                        const progressItem = document.createElement('div');
                        progressItem.classList.add('week-meeting-item');
                        progressItem.innerHTML = `
                            <div class="week-meeting-time progress">
                                <span class="btn-icon">üìà</span> Progress Update
                            </div>
                            <div class="week-meeting-text">${meeting.progress}</div>
                        `;
                        dayContent.appendChild(progressItem);
                    }
                    
                    if (meeting.results) {
                        const resultsItem = document.createElement('div');
                        resultsItem.classList.add('week-meeting-item');
                        resultsItem.innerHTML = `
                            <div class="week-meeting-time results">
                                <span class="btn-icon">üîç</span> Results & Findings
                            </div>
                            <div class="week-meeting-text">${meeting.results}</div>
                        `;
                        dayContent.appendChild(resultsItem);
                    }
                    
                    if (meeting.planning) {
                        const planningItem = document.createElement('div');
                        planningItem.classList.add('week-meeting-item');
                        planningItem.innerHTML = `
                            <div class="week-meeting-time planning">
                                <span class="btn-icon">üéØ</span> Next Steps & Planning
                            </div>
                            <div class="week-meeting-text">${meeting.planning}</div>
                        `;
                        dayContent.appendChild(planningItem);
                    }
                } else {
                    const emptyElement = document.createElement('div');
                    emptyElement.classList.add('empty-meeting');
                    emptyElement.textContent = 'No meeting notes for this day';
                    dayContent.appendChild(emptyElement);
                }
                
                dayElement.appendChild(dayContent);
                weekCalendar.appendChild(dayElement);
            }
            
            currentPeriodElement.textContent = `Week of ${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            showView('week');
        }
        
        // Render 30-day view
        function render30DayView() {
            timelineCalendar.innerHTML = '';
            const startDate = new Date(currentDate);
            startDate.setDate(currentDate.getDate() - 14); // Show 15 days before and after
            
            let hasMeetings = false;
            
            for (let i = 0; i < 30; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);
                const dateString = formatDate(currentDay);
                
                if (meetingsData[dateString] && hasMeetingData(dateString)) {
                    hasMeetings = true;
                    const meeting = meetingsData[dateString];
                    const dateDisplay = currentDay.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    
                    const timelineItem = document.createElement('div');
                    timelineItem.classList.add('timeline-item');
                    timelineItem.innerHTML = `
                        <div class="timeline-date">
                            <span class="btn-icon">üìÖ</span> ${dateDisplay}
                        </div>
                        ${meeting.progress ? `
                            <div class="timeline-item progress-timeline">
                                <div class="timeline-date">
                                    <span class="btn-icon">üìà</span> Progress Update
                                </div>
                                <div class="timeline-content">${meeting.progress}</div>
                            </div>
                        ` : ''}
                        ${meeting.results ? `
                            <div class="timeline-item results-timeline">
                                <div class="timeline-date">
                                    <span class="btn-icon">üîç</span> Results & Findings
                                </div>
                                <div class="timeline-content">${meeting.results}</div>
                            </div>
                        ` : ''}
                        ${meeting.planning ? `
                            <div class="timeline-item planning-timeline">
                                <div class="timeline-date">
                                    <span class="btn-icon">üéØ</span> Next Steps & Planning
                                </div>
                                <div class="timeline-content">${meeting.planning}</div>
                            </div>
                        ` : ''}
                    `;
                    
                    timelineCalendar.appendChild(timelineItem);
                }
            }
            
            if (!hasMeetings) {
                timelineCalendar.innerHTML = '<div class="empty-meeting">No meetings in the last 30 days</div>';
            }
            
            currentPeriodElement.textContent = 'Last 30 Days';
            showView('timeline');
        }
        
        // Render 4-month view
        function render4MonthView() {
            timelineCalendar.innerHTML = '';
            const startDate = new Date(currentDate);
            startDate.setMonth(currentDate.getMonth() - 2); // Show 2 months before and after
            
            let hasMeetings = false;
            
            for (let i = 0; i < 120; i++) { // Approximately 4 months
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);
                const dateString = formatDate(currentDay);
                
                if (meetingsData[dateString] && hasMeetingData(dateString)) {
                    hasMeetings = true;
                    const meeting = meetingsData[dateString];
                    const dateDisplay = currentDay.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    
                    const timelineItem = document.createElement('div');
                    timelineItem.classList.add('timeline-item');
                    timelineItem.innerHTML = `
                        <div class="timeline-date">
                            <span class="btn-icon">üìÖ</span> ${dateDisplay}
                        </div>
                        ${meeting.progress ? `
                            <div class="timeline-content">
                                <strong>Progress:</strong> ${meeting.progress.substring(0, 100)}${meeting.progress.length > 100 ? '...' : ''}
                            </div>
                        ` : ''}
                    `;
                    
                    timelineCalendar.appendChild(timelineItem);
                }
            }
            
            if (!hasMeetings) {
                timelineCalendar.innerHTML = '<div class="empty-meeting">No meetings in the last 4 months</div>';
            }
            
            currentPeriodElement.textContent = '4-Month Overview';
            showView('timeline');
        }
        
        // Render year view
        function renderYearView() {
            timelineCalendar.innerHTML = '';
            const year = currentDate.getFullYear();
            const months = [];
            
            for (let month = 0; month < 12; month++) {
                const monthDate = new Date(year, month, 1);
                const monthName = monthDate.toLocaleDateString('en-US', { month: 'long' });
                let monthMeetings = 0;
                
                // Count meetings in this month
                const lastDay = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= lastDay; day++) {
                    const dateString = formatDate(new Date(year, month, day));
                    if (meetingsData[dateString] && hasMeetingData(dateString)) {
                        monthMeetings++;
                    }
                }
                
                months.push({ name: monthName, meetings: monthMeetings });
            }
            
            months.forEach(monthData => {
                const monthElement = document.createElement('div');
                monthElement.classList.add('timeline-item');
                monthElement.innerHTML = `
                    <div class="timeline-date">
                        <span class="btn-icon">üìÖ</span> ${monthData.name} ${year}
                    </div>
                    <div class="timeline-content">
                        <strong>Meetings:</strong> ${monthData.meetings}
                    </div>
                `;
                timelineCalendar.appendChild(monthElement);
            });
            
            currentPeriodElement.textContent = `Year ${year}`;
            showView('timeline');
        }
        
        // Show appropriate view
        function showView(view) {
            monthCalendar.style.display = 'none';
            weekCalendar.style.display = 'none';
            timelineCalendar.style.display = 'none';
            
            if (view === 'month') {
                monthCalendar.style.display = 'block';
            } else if (view === 'week') {
                weekCalendar.style.display = 'block';
                weekCalendar.classList.add('active');
            } else if (view === 'timeline') {
                timelineCalendar.style.display = 'block';
                timelineCalendar.classList.add('active');
            }
        }
        
        // Select a date
        function selectDate(date) {
            selectedDate = new Date(date);
            updateMeetingDisplay();
            renderCalendar();
        }
        
        // Update the meeting display for the selected date
        function updateMeetingDisplay() {
            const dateString = formatDate(selectedDate);
            const meeting = meetingsData[dateString] || {};
            
            const dateDisplay = selectedDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            currentDateElement.textContent = dateDisplay;
            currentDateResultsElement.textContent = dateDisplay;
            currentDatePlanningElement.textContent = dateDisplay;
            
            progressTextElement.value = meeting.progress || '';
            resultsTextElement.value = meeting.results || '';
            planningTextElement.value = meeting.planning || '';
            
            const previousMeeting = getPreviousMeeting();
            if (previousMeeting) {
                previousMeetingElement.style.display = 'block';
                displayPreviousMeeting(previousMeeting);
            } else {
                previousMeetingElement.style.display = 'none';
            }
        }
        
        // Get the previous meeting data
        function getPreviousMeeting() {
            const dates = Object.keys(meetingsData).sort();
            const currentDateString = formatDate(selectedDate);
            
            let previousDateString = null;
            for (let i = dates.length - 1; i >= 0; i--) {
                if (dates[i] < currentDateString) {
                    previousDateString = dates[i];
                    break;
                }
            }
            
            if (previousDateString) {
                return {
                    date: new Date(previousDateString),
                    data: meetingsData[previousDateString]
                };
            }
            
            return null;
        }
        
        // Display the previous meeting data
        function displayPreviousMeeting(previousMeeting) {
            const dateDisplay = previousMeeting.date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let contentHTML = `
                <div class="previous-meeting-item">
                    <div class="previous-meeting-header">
                        <span class="btn-icon">üìÖ</span> Meeting Date: ${dateDisplay}
                    </div>
            `;
            
            if (previousMeeting.data.progress) {
                contentHTML += `
                    <div class="previous-meeting-item progress">
                        <div class="previous-meeting-header">
                            <span class="btn-icon">üìà</span> Progress Update
                        </div>
                        <div class="previous-meeting-text">${previousMeeting.data.progress}</div>
                    </div>
                `;
            }
            
            if (previousMeeting.data.results) {
                contentHTML += `
                    <div class="previous-meeting-item results">
                        <div class="previous-meeting-header">
                            <span class="btn-icon">üîç</span> Results & Findings
                        </div>
                        <div class="previous-meeting-text">${previousMeeting.data.results}</div>
                    </div>
                `;
            }
            
            if (previousMeeting.data.planning) {
                contentHTML += `
                    <div class="previous-meeting-item planning">
                        <div class="previous-meeting-header">
                            <span class="btn-icon">üéØ</span> Next Steps & Planning
                        </div>
                        <div class="previous-meeting-text">${previousMeeting.data.planning}</div>
                    </div>
                `;
            }
            
            contentHTML += `</div>`;
            previousContentElement.innerHTML = contentHTML;
        }
        
        // Save the current meeting
        function saveMeeting() {
            const dateString = formatDate(selectedDate);
            
            if (!meetingsData[dateString]) {
                meetingsData[dateString] = {};
            }
            
            meetingsData[dateString].progress = progressTextElement.value;
            meetingsData[dateString].results = resultsTextElement.value;
            meetingsData[dateString].planning = planningTextElement.value;
            meetingsData[dateString].lastModified = new Date().toISOString();
            
            saveMeetingsData();
            renderCalendar();
            showStatus('Meeting notes saved successfully!', 'success');
            updateAutosaveIndicators('saved');
        }
        
        // Autosave meeting data
        function setupAutosave() {
            [progressTextElement, resultsTextElement, planningTextElement].forEach(textarea => {
                textarea.addEventListener('input', () => {
                    clearTimeout(autosaveTimeout);
                    updateAutosaveIndicators('saving');
                    
                    autosaveTimeout = setTimeout(() => {
                        if (autosaveEnabled) {
                            saveMeeting();
                        }
                    }, AUTOSAVE_DELAY);
                });
            });
        }
        
        // Update autosave indicators
        function updateAutosaveIndicators(status) {
            const indicators = [progressAutosave, resultsAutosave, planningAutosave];
            
            indicators.forEach(indicator => {
                indicator.textContent = status === 'saving' ? 'Saving...' : 'Saved';
                indicator.className = `autosave-indicator ${status}`;
            });
        }
        
        // Export meeting data
        function exportMeetings(exportType = 'current') {
            let exportData = {};
            const exportDate = new Date().toISOString();
            
            if (exportType === 'current') {
                const dateString = formatDate(selectedDate);
                if (meetingsData[dateString]) {
                    exportData = {
                        meetings: {
                            [dateString]: {
                                [userName || 'Lab Member']: {
                                    progress: meetingsData[dateString].progress || '',
                                    results: meetingsData[dateString].results || '',
                                    planning: meetingsData[dateString].planning || '',
                                    timestamp: meetingsData[dateString].lastModified || exportDate
                                }
                            }
                        },
                        labMembers: [userName || 'Lab Member'],
                        metadata: {
                            exportDate: exportDate,
                            version: '1.3',
                            recordCount: 1,
                            memberCount: 1,
                            source: 'Lab Meeting Notes (Member Version)'
                        }
                    };
                }
            } else {
                const formattedMeetings = {};
                Object.keys(meetingsData).forEach(dateString => {
                    if (meetingsData[dateString] && hasMeetingData(dateString)) {
                        formattedMeetings[dateString] = {
                            [userName || 'Lab Member']: {
                                progress: meetingsData[dateString].progress || '',
                                results: meetingsData[dateString].results || '',
                                planning: meetingsData[dateString].planning || '',
                                timestamp: meetingsData[dateString].lastModified || exportDate
                            }
                        };
                    }
                });
                
                exportData = {
                    meetings: formattedMeetings,
                    labMembers: [userName || 'Lab Member'],
                    metadata: {
                        exportDate: exportDate,
                        version: '1.3',
                        recordCount: Object.keys(formattedMeetings).length,
                        memberCount: 1,
                        source: 'Lab Meeting Notes (Member Version)'
                    }
                };
            }
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            
            let filename = 'lab_meeting_notes';
            if (exportType === 'current') {
                filename = `meeting_notes_${formatDate(selectedDate)}_${userName || 'member'}`;
            } else if (exportType === 'all') {
                filename = `all_meeting_notes_${userName || 'member'}`;
            } else if (exportType === 'range') {
                filename = `meeting_notes_range_${userName || 'member'}`;
            }
            
            filename = filename.replace(/[^a-zA-Z0-9_-]/g, '_');
            
            link.download = `${filename}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showStatus('Meeting notes exported successfully!', 'success');
        }
        
        // Import meeting data
        function importMeetings(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    let importedMeetings = {};
                    
                    if (importedData.meetings) {
                        Object.keys(importedData.meetings).forEach(dateString => {
                            const dateMeetings = importedData.meetings[dateString];
                            Object.keys(dateMeetings).forEach(memberName => {
                                const meeting = dateMeetings[memberName];
                                if (!userName || memberName === userName) {
                                    importedMeetings[dateString] = {
                                        progress: meeting.progress || '',
                                        results: meeting.results || '',
                                        planning: meeting.planning || '',
                                        lastModified: meeting.timestamp || meeting.lastModified || new Date().toISOString()
                                    };
                                }
                            });
                        });
                    } else {
                        importedMeetings = importedData;
                    }
                    
                    Object.assign(meetingsData, importedMeetings);
                    saveMeetingsData();
                    renderCalendar();
                    updateMeetingDisplay();
                    showStatus('Meeting notes imported successfully!', 'success');
                } catch (error) {
                    showStatus('Error importing file. Please check the file format.', 'error');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
        }
        
        // UPDATED: Gmail integration with popout window
        function sendGmailToPI() {
            if (!userName) {
                showStatus('Please save your name in the settings first.', 'error');
                return;
            }
            
            if (!piEmail) {
                showStatus('Please enter your PI\'s email address in settings.', 'error');
                return;
            }
            
            const dateString = formatDate(selectedDate);
            const meeting = meetingsData[dateString];
            
            if (!meeting || !hasMeetingData(dateString)) {
                showStatus('No meeting notes to send for today.', 'error');
                return;
            }
            
            const dateDisplay = selectedDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Create email content
            const subject = gmailSubject.value;
            let body = gmailBody.value;
            
            // Add meeting notes to email body
            body += `\n\n=== MEETING NOTES ===\n`;
            body += `Date: ${dateDisplay}\n`;
            body += `Researcher: ${userName}\n\n`;
            
            if (meeting.progress) {
                body += `PROGRESS UPDATE:\n${meeting.progress}\n\n`;
            }
            
            if (meeting.results) {
                body += `RESULTS & FINDINGS:\n${meeting.results}\n\n`;
            }
            
            if (meeting.planning) {
                body += `NEXT STEPS & PLANNING:\n${meeting.planning}\n\n`;
            }
            
            // Create popout window with Gmail compose
            const width = 800;
            const height = 600;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            const popoutWindow = window.open('', 'gmailCompose', 
                `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);
            
            if (popoutWindow) {
                popoutWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Send Meeting Notes to PI</title>
                        <style>
                            body { 
                                font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                                margin: 0; 
                                padding: 20px; 
                                background: #f5f5f5;
                            }
                            .email-container {
                                max-width: 700px;
                                margin: 0 auto;
                                background: white;
                                padding: 30px;
                                border-radius: 12px;
                                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                            }
                            .header {
                                text-align: center;
                                margin-bottom: 30px;
                                padding-bottom: 20px;
                                border-bottom: 2px solid #2c5aa0;
                            }
                            .header h1 {
                                color: #2c5aa0;
                                margin-bottom: 10px;
                            }
                            .email-form {
                                display: flex;
                                flex-direction: column;
                                gap: 20px;
                            }
                            .form-group {
                                display: flex;
                                flex-direction: column;
                            }
                            label {
                                font-weight: 600;
                                margin-bottom: 8px;
                                color: #2d3748;
                            }
                            input, textarea {
                                padding: 12px;
                                border: 2px solid #e2e8f0;
                                border-radius: 8px;
                                font-size: 16px;
                                font-family: inherit;
                            }
                            input:focus, textarea:focus {
                                outline: none;
                                border-color: #2c5aa0;
                            }
                            textarea {
                                min-height: 200px;
                                resize: vertical;
                            }
                            .actions {
                                display: flex;
                                gap: 10px;
                                justify-content: flex-end;
                                margin-top: 20px;
                            }
                            button {
                                padding: 12px 24px;
                                border: none;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                                font-size: 16px;
                                transition: all 0.2s;
                            }
                            .btn-primary {
                                background: #2c5aa0;
                                color: white;
                            }
                            .btn-primary:hover {
                                background: #1e3a8a;
                                transform: translateY(-2px);
                            }
                            .btn-secondary {
                                background: #e2e8f0;
                                color: #2d3748;
                            }
                            .btn-secondary:hover {
                                background: #cbd5e0;
                            }
                            .instructions {
                                background: #f0f9ff;
                                padding: 15px;
                                border-radius: 8px;
                                border-left: 4px solid #2c5aa0;
                                margin-bottom: 20px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="email-container">
                            <div class="header">
                                <h1>üìß Send Meeting Notes to PI</h1>
                                <p>Your meeting notes are ready to be sent via Gmail</p>
                            </div>
                            
                            <div class="instructions">
                                <p><strong>Instructions:</strong> Click "Open Gmail" to open Gmail in a new tab with your meeting notes pre-filled. Then copy and paste the content below into your email.</p>
                            </div>
                            
                            <div class="email-form">
                                <div class="form-group">
                                    <label for="popout-to">To:</label>
                                    <input type="email" id="popout-to" value="${piEmail}" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="popout-subject">Subject:</label>
                                    <input type="text" id="popout-subject" value="${subject}">
                                </div>
                                
                                <div class="form-group">
                                    <label for="popout-body">Email Body:</label>
                                    <textarea id="popout-body">${body}</textarea>
                                </div>
                            </div>
                            
                            <div class="actions">
                                <button class="btn-secondary" onclick="window.close()">Cancel</button>
                                <button class="btn-primary" onclick="openGmail()">Open Gmail</button>
                            </div>
                        </div>
                        
                        <script>
                            function openGmail() {
                                const to = document.getElementById('popout-to').value;
                                const subject = document.getElementById('popout-subject').value;
                                const body = document.getElementById('popout-body').value;
                                
                                const gmailLink = 'https://mail.google.com/mail/?view=cm&fs=1&to=' + encodeURIComponent(to) + '&su=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
                                
                                window.open(gmailLink, '_blank');
                                
                                // Close the popout after a short delay
                                setTimeout(() => {
                                    window.close();
                                }, 1000);
                            }
                            
                            // Select all text in the body when clicked for easy copying
                            document.getElementById('popout-body').addEventListener('click', function() {
                                this.select();
                            });
                        <\/script>
                    </body>
                    </html>
                `);
                popoutWindow.document.close();
            }
            
            gmailModal.classList.remove('active');
            showStatus('Gmail popout opened with your meeting notes!', 'success');
        }
        
        // Update Gmail preview
        function updateGmailPreview() {
            const dateString = formatDate(selectedDate);
            const meeting = meetingsData[dateString] || {};
            const dateDisplay = selectedDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            let preview = `Date: ${dateDisplay}\n`;
            preview += `Researcher: ${userName || 'Your Name'}\n\n`;
            
            if (meeting.progress) {
                preview += `PROGRESS: ${meeting.progress.substring(0, 50)}${meeting.progress.length > 50 ? '...' : ''}\n`;
            }
            
            if (meeting.results) {
                preview += `RESULTS: ${meeting.results.substring(0, 50)}${meeting.results.length > 50 ? '...' : ''}\n`;
            }
            
            if (meeting.planning) {
                preview += `PLANNING: ${meeting.planning.substring(0, 50)}${meeting.planning.length > 50 ? '...' : ''}\n`;
            }
            
            if (!hasMeetingData(dateString)) {
                preview = 'No meeting notes for selected date.';
            }
            
            gmailPreview.textContent = preview;
        }
        
        // Show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            
            setTimeout(() => {
                statusMessage.textContent = '';
                statusMessage.className = 'status-message';
            }, 5000);
        }
        
        // Format date as YYYY-MM-DD
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Check if a date is today
        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }
        
        // Check if two dates are the same
        function isSameDate(date1, date2) {
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        }
        
        // Check if a date has meeting data
        function hasMeetingData(dateString) {
            const meeting = meetingsData[dateString];
            return meeting && (meeting.progress || meeting.results || meeting.planning);
        }
        
        // Clear today's meeting
        function clearToday() {
            const dateString = formatDate(selectedDate);
            
            if (meetingsData[dateString]) {
                delete meetingsData[dateString];
                saveMeetingsData();
                updateMeetingDisplay();
                renderCalendar();
                showStatus('Today\'s meeting notes cleared.', 'success');
            } else {
                showStatus('No meeting notes to clear for today.', 'info');
            }
        }
        
        // Show meeting history
        function showHistory() {
            historyContent.innerHTML = '';
            
            const dates = Object.keys(meetingsData).sort().reverse();
            
            if (dates.length === 0) {
                historyContent.innerHTML = '<p class="no-meetings-message">No meeting history found.</p>';
                historyModal.classList.add('active');
                return;
            }
            
            dates.forEach(dateString => {
                const meeting = meetingsData[dateString];
                const date = new Date(dateString);
                const dateDisplay = date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const meetingElement = document.createElement('div');
                meetingElement.classList.add('previous-meeting');
                meetingElement.innerHTML = `
                    <h3>
                        <span class="btn-icon">üìÖ</span> ${dateDisplay}
                    </h3>
                    <div class="previous-meeting-content">
                        ${meeting.progress ? `
                            <div class="previous-meeting-item progress">
                                <div class="previous-meeting-header">
                                    <span class="btn-icon">üìà</span> Progress Update
                                </div>
                                <div class="previous-meeting-text">${meeting.progress}</div>
                            </div>
                        ` : ''}
                        ${meeting.results ? `
                            <div class="previous-meeting-item results">
                                <div class="previous-meeting-header">
                                    <span class="btn-icon">üîç</span> Results & Findings
                                </div>
                                <div class="previous-meeting-text">${meeting.results}</div>
                            </div>
                        ` : ''}
                        ${meeting.planning ? `
                            <div class="previous-meeting-item planning">
                                <div class="previous-meeting-header">
                                    <span class="btn-icon">üéØ</span> Next Steps & Planning
                                </div>
                                <div class="previous-meeting-text">${meeting.planning}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                historyContent.appendChild(meetingElement);
            });
            
            historyModal.classList.add('active');
        }
        
        // ========== DYNALIST FUNCTIONS ==========
        
        function showDynalistSettings() {
            dynalistTokenInput.value = dynalistApiKey;
            dynalistDocIdInput.value = dynalistDocId;
            updateDynalistStatusDisplay();
            dynalistModal.classList.add('active');
        }
        
        function closeDynalistModal() {
            dynalistModal.classList.remove('active');
        }
        
        function updateDynalistStatusDisplay() {
            if (dynalistApiKey) {
                dynalistStatusIcon.className = 'dynalist-status dynalist-enabled';
                dynalistStatusText.textContent = dynalistDocId ? 'Configured (Document ID set)' : 'Configured (New doc per day)';
            } else {
                dynalistStatusIcon.className = 'dynalist-status dynalist-disabled';
                dynalistStatusText.textContent = 'Not configured';
            }
        }
        
        async function testDynalistConnection() {
            const token = dynalistTokenInput.value;
            if (!token) {
                showStatus('Please enter an API token first', 'error');
                return;
            }
            
            try {
                showStatus('Testing connection...', 'info');
                
                const response = await fetch('https://dynalist.io/api/v1/doc/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token
                    })
                });
                
                const data = await response.json();
                
                if (data._code === 'Ok') {
                    showStatus('Connection successful! You can access ' + data.files.length + ' files.', 'success');
                } else {
                    showStatus('Connection failed: ' + (data._msg || 'Unknown error'), 'error');
                }
            } catch (error) {
                showStatus('Connection error: ' + error.message, 'error');
            }
        }
        
        function saveDynalistSettings() {
            const token = dynalistTokenInput.value;
            const docId = dynalistDocIdInput.value;
            
            if (!token) {
                showStatus('API token is required', 'error');
                return;
            }
            
            dynalistApiKey = token;
            dynalistDocId = docId;
            
            localStorage.setItem('dynalistApiKey', token);
            localStorage.setItem('dynalistDocId', docId);
            
            updateDynalistStatusDisplay();
            closeDynalistModal();
            showStatus('Dynalist settings saved!', 'success');
        }
        
        async function exportToDynalist() {
            if (!dynalistApiKey) {
                showStatus('Please configure Dynalist settings first', 'error');
                showDynalistSettings();
                return;
            }
            
            try {
                showStatus('Exporting to Dynalist...', 'info');
                
                let documentId = dynalistDocId;
                if (!documentId) {
                    documentId = await createDynalistDocument();
                    if (!documentId) {
                        throw new Error('Failed to create document');
                    }
                    dynalistDocId = documentId;
                    localStorage.setItem('dynalistDocId', documentId);
                }
                
                await addMeetingToDynalist(documentId);
                showStatus('Successfully exported to Dynalist! Opening document...', 'success');
                
                setTimeout(() => {
                    window.open(
                        `https://dynalist.io/d/${documentId}`,
                        'DynalistPopout',
                        'width=1000,height=800,resizable=yes,scrollbars=yes'
                    );
                }, 1000);
                
            } catch (error) {
                console.error('Dynalist export error:', error);
                showStatus('Error exporting to Dynalist: ' + error.message, 'error');
            }
        }
        
        async function createDynalistDocument() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const weekday = today.toLocaleDateString('en-US', { weekday: 'short' });
            const timeString = today.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            }).toLowerCase();
            
            const documentTitle = `Lab Meetings ${year}${month}${day} (${weekday}) ${timeString}`;
            
            try {
                const response = await fetch('https://dynalist.io/api/v1/doc/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: dynalistApiKey,
                        title: documentTitle,
                        type: 'document'
                    })
                });
                
                const data = await response.json();
                
                if (data._code === 'Ok' && data.id) {
                    return data.id;
                } else {
                    throw new Error(data._msg || 'Failed to create document');
                }
            } catch (error) {
                console.error('Error creating Dynalist document:', error);
                throw error;
            }
        }
        
        async function addMeetingToDynalist(documentId) {
            const readResponse = await fetch('https://dynalist.io/api/v1/doc/read', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: dynalistApiKey, file_id: documentId })
            });
            const readData = await readResponse.json();
            if (readData._code !== 'Ok') {
                throw new Error('Failed to read document: ' + (readData._msg || 'Unknown error'));
            }

            const rootNode = readData.nodes.find(node => node.id === 'root');
            if (!rootNode) throw new Error('Root node not found');

            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const weekday = today.toLocaleDateString('en-US', { weekday: 'short' });
            const timeString = today.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            }).toLowerCase();
            
            const sessionNodeContent = `Lab Meeting ${year}${month}${day} (${weekday}) ${timeString}`;

            const sessionResponse = await fetch('https://dynalist.io/api/v1/doc/edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token: dynalistApiKey,
                    file_id: documentId,
                    changes: [{
                        action: 'insert',
                        parent_id: rootNode.id,
                        content: sessionNodeContent,
                        index: readData.nodes.filter(n => n.parent === rootNode.id).length
                    }]
                })
            });
            const sessionData = await sessionResponse.json();
            if (sessionData._code !== 'Ok') {
                throw new Error('Failed to add session node: ' + (sessionData._msg || 'Unknown error'));
            }
            const sessionNodeId = sessionData.new_node_ids ? sessionData.new_node_ids[0] : null;
            if (!sessionNodeId) throw new Error('Failed to get new session node ID');

            const dateString = formatDate(selectedDate);
            const formattedDate = selectedDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            let index = 0;

            // Add date header
            await fetch('https://dynalist.io/api/v1/doc/edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token: dynalistApiKey,
                    file_id: documentId,
                    changes: [{
                        action: 'insert',
                        parent_id: sessionNodeId,
                        content: `üìÖ ${formattedDate} - Meeting with ${userName || 'Lab Member'}`,
                        index: index++
                    }]
                })
            });

            // Helper function to split content into paragraphs for Dynalist
            function splitIntoParagraphs(content, maxLength = 2000) {
                if (!content) return [];
                
                const paragraphs = [];
                const sentences = content.split(/(?<=[.!?])\s+/);
                let currentParagraph = '';
                
                sentences.forEach(sentence => {
                    if ((currentParagraph + sentence).length > maxLength && currentParagraph.length > 0) {
                        paragraphs.push(currentParagraph.trim());
                        currentParagraph = sentence + ' ';
                    } else {
                        currentParagraph += sentence + ' ';
                    }
                });
                
                if (currentParagraph.trim()) {
                    paragraphs.push(currentParagraph.trim());
                }
                
                return paragraphs;
            }

            // Add progress reflection if exists
            if (progressTextElement.value.trim()) {
                const progressHeaderResponse = await fetch('https://dynalist.io/api/v1/doc/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: dynalistApiKey,
                        file_id: documentId,
                        changes: [{
                            action: 'insert',
                            parent_id: sessionNodeId,
                            content: `üìà Progress Update`,
                            index: index++
                        }]
                    })
                });
                const progressHeaderData = await progressHeaderResponse.json();
                const progressHeaderId = progressHeaderData.new_node_ids ? progressHeaderData.new_node_ids[0] : null;

                if (progressHeaderId) {
                    const progressParagraphs = splitIntoParagraphs(progressTextElement.value);
                    for (let i = 0; i < progressParagraphs.length; i++) {
                        const paragraph = progressParagraphs[i];
                        await fetch('https://dynalist.io/api/v1/doc/edit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                token: dynalistApiKey,
                                file_id: documentId,
                                changes: [{
                                    action: 'insert',
                                    parent_id: progressHeaderId,
                                    content: paragraph,
                                    index: i
                                }]
                            })
                        });
                        
                        if (i < progressParagraphs.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    }
                }
            }

            // Add results reflection if exists
            if (resultsTextElement.value.trim()) {
                const resultsHeaderResponse = await fetch('https://dynalist.io/api/v1/doc/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: dynalistApiKey,
                        file_id: documentId,
                        changes: [{
                            action: 'insert',
                            parent_id: sessionNodeId,
                            content: `üîç Results & Findings`,
                            index: index++
                        }]
                    })
                });
                const resultsHeaderData = await resultsHeaderResponse.json();
                const resultsHeaderId = resultsHeaderData.new_node_ids ? resultsHeaderData.new_node_ids[0] : null;

                if (resultsHeaderId) {
                    const resultsParagraphs = splitIntoParagraphs(resultsTextElement.value);
                    for (let i = 0; i < resultsParagraphs.length; i++) {
                        const paragraph = resultsParagraphs[i];
                        await fetch('https://dynalist.io/api/v1/doc/edit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                token: dynalistApiKey,
                                file_id: documentId,
                                changes: [{
                                    action: 'insert',
                                    parent_id: resultsHeaderId,
                                    content: paragraph,
                                    index: i
                                }]
                            })
                        });
                        
                        if (i < resultsParagraphs.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    }
                }
            }

            // Add planning reflection if exists
            if (planningTextElement.value.trim()) {
                const planningHeaderResponse = await fetch('https://dynalist.io/api/v1/doc/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: dynalistApiKey,
                        file_id: documentId,
                        changes: [{
                            action: 'insert',
                            parent_id: sessionNodeId,
                            content: `üéØ Next Steps & Planning`,
                            index: index++
                        }]
                    })
                });
                const planningHeaderData = await planningHeaderResponse.json();
                const planningHeaderId = planningHeaderData.new_node_ids ? planningHeaderData.new_node_ids[0] : null;

                if (planningHeaderId) {
                    const planningParagraphs = splitIntoParagraphs(planningTextElement.value);
                    for (let i = 0; i < planningParagraphs.length; i++) {
                        const paragraph = planningParagraphs[i];
                        await fetch('https://dynalist.io/api/v1/doc/edit', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                token: dynalistApiKey,
                                file_id: documentId,
                                changes: [{
                                    action: 'insert',
                                    parent_id: planningHeaderId,
                                    content: paragraph,
                                    index: i
                                }]
                            })
                        });
                        
                        if (i < planningParagraphs.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    }
                }
            }

            return true;
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            prevPeriodButton.addEventListener('click', () => {
                navigatePeriod(-1);
            });
            
            nextPeriodButton.addEventListener('click', () => {
                navigatePeriod(1);
            });
            
            // View buttons
            monthViewButton.addEventListener('click', () => {
                monthViewButton.classList.add('active');
                weekViewButton.classList.remove('active');
                currentView = 'month';
                renderCalendar();
            });
            
            weekViewButton.addEventListener('click', () => {
                weekViewButton.classList.add('active');
                monthViewButton.classList.remove('active');
                currentView = 'week';
                renderCalendar();
            });
            
            // View option buttons
            viewOptionButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    viewOptionButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentPeriod = btn.dataset.period;
                    renderCalendar();
                });
            });
            
            // Buttons
            saveButton.addEventListener('click', saveMeeting);
            exportButton.addEventListener('click', () => {
                exportModal.classList.add('active');
            });
            
            clearButton.addEventListener('click', clearToday);
            historyButton.addEventListener('click', showHistory);
            
            // File input
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importMeetings(e.target.files[0]);
                    e.target.value = '';
                }
            });
            
            // Modals
            closeHistoryModal.addEventListener('click', () => {
                historyModal.classList.remove('active');
            });
            
            closeExportModal.addEventListener('click', () => {
                exportModal.classList.remove('active');
            });
            
            cancelExport.addEventListener('click', () => {
                exportModal.classList.remove('active');
            });
            
            closeGmailModal.addEventListener('click', () => {
                gmailModal.classList.remove('active');
            });
            
            cancelGmail.addEventListener('click', () => {
                gmailModal.classList.remove('active');
            });
            
            // Export options
            let selectedExportType = 'current';
            exportOptions.forEach(option => {
                option.addEventListener('click', () => {
                    exportOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedExportType = option.getAttribute('data-type');
                    confirmExport.disabled = false;
                });
            });
            
            confirmExport.addEventListener('click', () => {
                exportModal.classList.remove('active');
                exportMeetings(selectedExportType);
            });
            
            // Gmail functionality - UPDATED to use popout
            shareGmailButton.addEventListener('click', () => {
                if (!userName) {
                    showStatus('Please save your name in the settings first.', 'error');
                    return;
                }
                
                if (!piEmail) {
                    showStatus('Please enter your PI\'s email address in settings.', 'error');
                    return;
                }
                
                const dateString = formatDate(selectedDate);
                const dateDisplay = selectedDate.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                gmailSubject.value = `Lab Meeting Notes - ${dateDisplay}`;
                gmailBody.value = `Dear PI,\n\nPlease find my meeting notes for ${dateDisplay} below:\n\n`;
                updateGmailPreview();
                
                gmailModal.classList.add('active');
            });
            
            sendGmail.addEventListener('click', sendGmailToPI);
            
            // Print functionality
            sharePrintButton.addEventListener('click', () => {
                window.print();
            });
            
            // User settings
            saveSettingsButton.addEventListener('click', () => {
                userName = userNameInput.value.trim();
                userEmail = userEmailInput.value.trim();
                piEmail = piEmailInput.value.trim();
                
                if (userName && userEmail && piEmail) {
                    saveUserData();
                    showStatus('Settings saved successfully!', 'success');
                } else {
                    showStatus('Please enter your name, email, and PI\'s email.', 'error');
                }
            });
            
            // Update Gmail preview when meeting data changes
            [progressTextElement, resultsTextElement, planningTextElement].forEach(textarea => {
                textarea.addEventListener('input', updateGmailPreview);
            });
            
            // NEW: Dynalist event listeners
            dynalistExportBtn.addEventListener('click', exportToDynalist);
            dynalistSettingsBtn.addEventListener('click', showDynalistSettings);
            closeDynalistModalBtn.addEventListener('click', closeDynalistModal);
            testConnectionBtn.addEventListener('click', testDynalistConnection);
            saveDynalistBtn.addEventListener('click', saveDynalistSettings);
            
            // Autosave setup
            setupAutosave();
            
            // Close modals when clicking outside
            [historyModal, exportModal, gmailModal, dynalistModal].forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }
        
        // Navigate between periods
        function navigatePeriod(direction) {
            switch (currentPeriod) {
                case 'month':
                    currentDate.setMonth(currentDate.getMonth() + direction);
                    break;
                case 'week':
                    currentDate.setDate(currentDate.getDate() + (direction * 7));
                    break;
                case '30days':
                    currentDate.setDate(currentDate.getDate() + (direction * 30));
                    break;
                case '4months':
                    currentDate.setMonth(currentDate.getMonth() + (direction * 4));
                    break;
                case 'year':
                    currentDate.setFullYear(currentDate.getFullYear() + direction);
                    break;
            }
            renderCalendar();
        }
        
        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>