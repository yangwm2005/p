<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            position: relative;
        }
        
.container {
    width: 100%;
    max-width: 1200px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    height: 97vh;
    margin-bottom: 10px;
    /* Add these properties for mobile */
    max-height: 100vh;
}

.main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
    /* Add this for mobile */
    min-height: 0; /* This is crucial for proper flexbox behavior */
}

.chat-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    /* Add this for mobile */
    min-height: 0; /* Crucial for proper scrolling on mobile */
}
        
        .workflow-guide {
            width: 300px;
            background: #f8f9ff;
            border-right: 1px solid #e0e6ff;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .workflow-guide.collapsed {
            width: 50px;
            padding: 20px 5px;
        }
        
        .workflow-guide.collapsed .guide-content {
            display: none;
        }
        
        .workflow-guide.collapsed .guide-header h2 {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            text-align: center;
            margin: 0 auto;
            font-size: 1rem;
        }
        
        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .guide-header h2 {
            font-size: 1.2rem;
            color: #6e8efb;
        }
        
        .toggle-guide {
            background: #6e8efb;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .workflow-step {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #6e8efb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .workflow-step.active {
            border-left: 4px solid #4caf50;
            background: #f0f9ff;
        }
        
        .workflow-step.completed {
            border-left: 4px solid #9e9e9e;
            opacity: 0.8;
        }
        
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .step-title {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .step-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            background: #f0f4ff;
        }
        
        .step-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .step-timer {
            font-size: 0.8rem;
            color: #6e8efb;
            font-weight: 500;
        }
        
        .step-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .step-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            background: #6e8efb;
            color: white;
        }
        
        .step-btn.skip {
            background: #9e9e9e;
        }
        
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: #6e8efb;
            color: white;
            padding: 12px 20px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
        }
        
        h1 {
            font-size: 1.7rem;
            margin-bottom: 3px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 50px;
        }
        
        .toggle-text {
            margin-right: 6px;
            font-size: 0.75rem;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 18px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 18px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3a3af4;
        }
        
        input:checked + .slider:before {
            transform: translateX(18px);
        }
        
        .status-indicator {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="rgba(240, 244, 255, 0.6)"/><path d="M0 50 L100 50" stroke="rgba(200, 210, 255, 0.3)" stroke-width="1"/><path d="M50 0 L50 100" stroke="rgba(200, 210, 255, 0.3)" stroke-width="1"/></svg>');
        }
        
        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            position: relative;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: #6e8efb;
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .app-message {
            background: #f0f4ff;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .message-actions {
            position: absolute;
            top: 4px;
            right: 8px;
            display: none;
        }
        
        .message:hover .message-actions {
            display: flex;
            gap: 6px;
        }
        
        .action-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: column;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: scale(1.1);
        }
        
        .edit-textarea {
            width: 100%;
            background: transparent;
            border: 1px dashed rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 8px;
            color: inherit;
            font-family: inherit;
            resize: none;
            min-height: 70px;
        }
        
        .input-area {
            padding: 12px 15px;
            background: white;
            border-top: 1px solid #e0e6ff;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
#user-input {
    flex: 1;
    padding: 12px 18px;
    border: 2px solid #e0e6ff;
    border-radius: 50px; /* Single-line rounded look */
    font-size: 0.95rem;
    outline: none;
    transition: all 0.3s;
    resize: none; /* Disable manual resize */
    height: 46px; /* Single line height */
    max-height: 200px; /* Maximum expansion */
    font-family: inherit;
    line-height: 1.4;
    overflow-y: hidden; /* Hide scrollbar initially */
    /* Mobile optimization */
    font-size: 16px; /* Prevent iOS zoom */
}

#user-input:focus {
    border-color: #6e8efb;
    border-radius: 18px; /* Less rounded when expanded */
}

/* Mobile optimization */
@media (max-width: 768px) {
    #user-input {
        font-size: 16px; /* Prevent zoom and ensure readability */
        min-height: 44px; /* Better touch target */
        padding: 10px 15px;
    }
    
    .input-area {
        padding: 8px 12px;
    }
    
    #send-btn {
        width: 44px; /* Better touch target */
        height: 44px;
        min-width: 44px; /* Ensure proper touch size */
    }
}
        
        #send-btn {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: #6e8efb;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            transition: background 0.3s;
        }
        
        #send-btn:hover {
            background: #5a7ce7;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: #f8f9ff;
            border-top: 1px solid #e0e6ff;
            flex-shrink: 0;
        }
        
        .control-btn {
            background: white;
            border: 2px solid #e0e6ff;
            padding: 6px 12px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .control-btn:hover {
            border-color: #6e8efb;
            color: #6e8efb;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: #f0f4ff;
            border-top: 1px solid #e0e6ff;
            font-size: 0.8rem;
            color: #5c6bc0;
            flex-shrink: 0;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-weight: 700;
            font-size: 1rem;
            margin-top: 2px;
        }
        
        .timestamp {
            font-size: 0.6rem;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .user-timestamp {
            text-align: left;
        }
        
        .app-timestamp {
            text-align: right;
        }
        
        .highlight {
            background-color: #ffeb3b;
            padding: 0 2px;
            border-radius: 3px;
        }
        
        .highlight-controls {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .highlight-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .highlight-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .search-container {
            padding: 8px 15px;
            background: #f8f9ff;
            border-bottom: 1px solid #e0e6ff;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        #search-input {
            flex: 1;
            padding: 7px 12px;
            border: 1px solid #e0e6ff;
            border-radius: 50px;
            font-size: 0.85rem;
            outline: none;
            display: none;
        }
        
        #search-btn {
            background: #6e8efb;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 0 12px;
            cursor: pointer;
            font-size: 0.85rem;
            display: none;
        }
        
        .typing-indicator {
            display: none;
            padding: 8px 15px;
            background: #f0f4ff;
            border-radius: 18px;
            align-self: flex-end;
            margin-bottom: 5px;
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
        }
        
        .typing-indicator i {
            margin-right: 5px;
            color: #6e8efb;
        }
        
        .sidebar-toggle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #6e8efb;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
@media (max-width: 900px) {
    .main-content {
        flex-direction: column;
        /* Ensure proper height calculation */
        min-height: 0;
    }
    
    .workflow-guide {
        width: 100%;
        max-height: 200px;
        border-right: none;
        border-bottom: 1px solid #e0e6ff;
        /* Add this to ensure proper sizing */
        flex-shrink: 0;
    }
    
    .workflow-guide.collapsed {
        width: 100%;
        max-height: 50px;
        padding: 10px;
    }
    
    .workflow-guide.collapsed .guide-header h2 {
        writing-mode: horizontal-tb;
        transform: none;
        margin: 0;
    }
    
    .sidebar-toggle {
        display: flex;
    }
    
    /* Add this to ensure chat section gets proper height */
    .chat-section {
        min-height: 0;
        flex: 1;
    }
}

@media (max-height: 700px) {
    .container {
        height: 95vh;
    }
    
    .controls {
        padding: 8px 12px;
    }
    
    .control-btn {
        padding: 4px 8px;
        font-size: 0.75rem;
    }
    
    .stats {
        padding: 6px 8px;
        font-size: 0.7rem;
    }
}
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                height: 98vh;
                border-radius: 15px;
            }
            
            header {
                flex-direction: column;
                gap: 8px;
                padding: 10px 15px;
            }
            
            .header-left, .header-right {
                width: 100%;
                justify-content: center;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .message {
                max-width: 85%;
                padding: 8px 12px;
            }
            
            .controls {
                flex-wrap: wrap;
                gap: 6px;
                justify-content: center;
            }
            
            .control-btn {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            
            .message-actions {
                display: flex !important;
                opacity: 0.7;
                top: -6px;
                right: 4px;
            }
            
            .search-container {
                padding: 6px 12px;
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #4caf50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.error {
            background: #f44336;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            color: white;
            font-size: 0.8rem;
            margin-top: auto;
            width: 100%;
        }
        
        .file-input {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: #6e8efb;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e6ff;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            border-color: #6e8efb;
            outline: none;
        }
        
        .form-help {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #6e8efb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a7ce7;
        }
        
        .btn-secondary {
            background: #f0f4ff;
            color: #6e8efb;
        }
        
        .btn-secondary:hover {
            background: #e0e6ff;
        }
        
        .dynalist-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .dynalist-enabled {
            background-color: #06D85F;
        }
        
        .dynalist-disabled {
            background-color: #ccc;
        }
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>
    
    <div class="modal" id="dynalist-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dynalist Settings</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="dynalist-token">API Token</label>
                    <input type="password" id="dynalist-token" class="form-input" placeholder="Enter your Dynalist API token">
                    <div class="form-help">
                        Get your API token from: <a href="https://dynalist.io/developer" target="_blank">https://dynalist.io/developer</a>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="dynalist-doc-id">Document ID (Optional)</label>
                    <input type="text" id="dynalist-doc-id" class="form-input" placeholder="Leave empty to create new document each day">
                    <div class="form-help">
                        If specified, all exports will go to this document. Leave empty to create a new document for each day.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Current Status</label>
                    <div id="dynalist-status-display">
                        <span class="dynalist-status dynalist-disabled" id="dynalist-status-icon"></span>
                        <span id="dynalist-status-text">Not configured</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="test-connection">Test Connection</button>
                <button class="btn btn-primary" id="save-dynalist">Save Settings</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <button class="sidebar-toggle" id="mobile-toggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="main-content">
            <div class="workflow-guide" id="workflow-guide">
                <div class="guide-header">
                    <h2>Workflow Guide</h2>
                    <button class="toggle-guide" id="toggle-guide">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <div class="guide-content">
                    <div class="workflow-step active" id="step-1">
                        <div class="step-header">
                            <div class="step-title">1. Set Intentions</div>
                            <div class="step-status">Active</div>
                        </div>
                        <div class="step-description">What do you want to accomplish in this session?</div>
                        <div class="step-timer">Suggested: 5 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(1)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(1)">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-2">
                        <div class="step-header">
                            <div class="step-title">2. Brainstorm Ideas</div>
                            <div class="step-status">Pending</div>
                        </div>
                        <div class="step-description">Jot down all relevant thoughts and ideas</div>
                        <div class="step-timer">Suggested: 10 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(2)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(2)">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-3">
                        <div class="step-header">
                            <div class="step-title">3. Organize Thoughts</div>
                            <div class="step-status">Pending</div>
                        </div>
                        <div class="step-description">Group related ideas and create structure</div>
                        <div class="step-timer">Suggested: 8 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(3)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(3)">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-4">
                        <div class="step-header">
                            <div class="step-title">4. Deep Work</div>
                            <div class="step-status">Pending</div>
                        </div>
                        <div class="step-description">Focus on your most important task</div>
                        <div class="step-timer">Suggested: 25 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(4)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(4)">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-5">
                        <div class="step-header">
                            <div class="step-title">5. Review & Refine</div>
                            <div class="step-status">Pending</div>
                        </div>
                        <div class="step-description">Evaluate your work and make improvements</div>
                        <div class="step-timer">Suggested: 7 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(5)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(5)">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-6">
                        <div class="step-header">
                            <div class="step-title">6. Plan Next Steps</div>
                            <div class="step-status">Pending</div>
                        </div>
                        <div class="step-description">What will you do in your next session?</div>
                        <div class="step-timer">Suggested: 5 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(6)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(6)">Skip</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-section">
                <header>
                    <div class="header-left">
                        <h1>Workflow</h1>
                        <p class="subtitle">Guided workflow for deep focus</p>
                    </div>
                    <div class="header-right">
                        <div class="toggle-container">
                            <span class="toggle-text">Chatbot:</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="chatbot-toggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="status-indicator" id="chatbot-status">ON</div>
                    </div>
                </header>
                
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search messages...">
                    <button id="search-btn"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="chat-container" id="chat-container">
                    <div class="message app-message">
                        <div class="message-actions">
                            <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                        <p>Welcome! I see you're starting with <strong>Step 1: Set Intentions</strong>. What would you like to accomplish in this session?</p>
                        <div class="timestamp app-timestamp">Just now</div>
                    </div>
                    
                    <div class="typing-indicator" id="typing-indicator">
                        <i class="fas fa-circle-notch fa-spin"></i>Assistant is typing...
                    </div>
                </div>
                
<div class="input-area">
    <textarea id="user-input" placeholder="Type your thoughts or tasks here..." autocomplete="off"></textarea>
    <button id="send-btn">
        <i class="fas fa-paper-plane"></i>
    </button>
</div>
                
                <div class="controls">
                    <div class="control-btn" id="theme-btn">
                        <i class="fas fa-moon"></i>
                        <span>Dark Mode</span>
                    </div>
                    <div class="control-btn" id="save-btn">
                        <i class="fas fa-save"></i>
                        <span>Save Session</span>
                    </div>
                    <div class="control-btn" id="load-btn">
                        <i class="fas fa-upload"></i>
                        <span>Load Session</span>
                    </div>
                    <div class="control-btn" id="clear-btn">
                        <i class="fas fa-trash"></i>
                        <span>Clear Chat</span>
                    </div>
                    <div class="control-btn" id="export-btn">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                    </div>
                    <div class="control-btn" id="dynalist-btn">
                        <i class="fas fa-external-link-alt"></i>
                        <span>Export to Dynalist</span>
                    </div>
                    <div class="control-btn" id="dynalist-settings-btn">
                        <i class="fas fa-cog"></i>
                        <span>Dynalist Settings</span>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat-item">
                        <span>Messages</span>
                        <span class="stat-value" id="message-count">1</span>
                    </div>
                    <div class="stat-item">
                        <span>Words</span>
                        <span class="stat-value" id="word-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Focus Time</span>
                        <span class="stat-value" id="time-active">0m</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" class="file-input" accept=".json">

    <footer>
        Copyright 2025 Dr. Wen-Ming Yang Lab. All rights reserved. (v19b multipleline with Dynalist popout open)
    </footer>

    <script>
        // Global variables
        let currentStep = 1;
        const totalSteps = 6;
        let sidebarCollapsed = false;
        let messages = 1;
        let words = 0;
        let activeMinutes = 0;
        let activeSeconds = 0;
        let isDarkMode = false;
        let chatbotEnabled = true;
        let conversationHistory = [];
        
        // Dynalist configuration - FIXED VERSION
        let dynalistApiKey = localStorage.getItem('dynalistApiKey') || '';
        let dynalistDocId = localStorage.getItem('dynalistDocId') || '';
        
        // DOM elements
        let chatContainer, userInput, sendBtn, messageCount, wordCount, timeActive;
        let themeBtn, saveBtn, loadBtn, clearBtn, exportBtn, chatbotToggle, chatbotStatus;
        let searchInput, searchBtn, typingIndicator, fileInput;
        let dynalistBtn, dynalistSettingsBtn, dynalistModal;
        
        // Step-specific guidance messages
        const stepGuidance = {
            1: [
                "Great! You've set your intentions. What specific outcome are you hoping to achieve?",
                "Nice work clarifying your intentions. What would make this session successful for you?",
                "Intentions set! What's the most important thing to focus on first?"
            ],
            2: [
                "Good job brainstorming! Which of these ideas seems most promising to you?",
                "You've generated some great ideas. Which one are you most excited to explore?",
                "Brainstorming complete! Are there any patterns or themes emerging from your ideas?"
            ],
            3: [
                "Well done organizing your thoughts! How does this structure support your goals?",
                "You've created a good structure. What's the logical flow of your work?",
                "Organization complete! Does this structure help clarify your next steps?"
            ],
            4: [
                "Excellent deep work session! What did you accomplish during this focused time?",
                "You maintained good focus! What was the most valuable insight from this session?",
                "Deep work complete! How did this focused time move you toward your goals?"
            ],
            5: [
                "Good review! What improvements will make the biggest impact?",
                "You've identified some good refinements. What's now clearer than before?",
                "Review complete! How has your work evolved through this process?"
            ],
            6: [
                "Great planning! What are you most looking forward to in your next session?",
                "You've set clear next steps. What will you start with next time?",
                "Planning complete! How do these next steps build on today's progress?"
            ]
        };
        
        // Step transition questions
        const transitionQuestions = {
            1: "Now let's move to brainstorming. What ideas come to mind for your project?",
            2: "Ready to organize your thoughts? How might you group these ideas together?",
            3: "Time for deep work! What's the first task you'll focus on?",
            4: "Let's review what you've accomplished. What stands out as most valuable?",
            5: "Finally, let's plan next steps. What will you focus on in your next session?",
            6: "You've completed all steps! Would you like to start a new session or continue working?"
        };

        // Toggle workflow guide
        function toggleSidebar() {
            const guide = document.getElementById('workflow-guide');
            const toggleBtn = document.getElementById('toggle-guide');
            const mobileToggleBtn = document.getElementById('mobile-toggle');
            
            guide.classList.toggle('collapsed');
            sidebarCollapsed = guide.classList.contains('collapsed');
            
            if (sidebarCollapsed) {
                toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                mobileToggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                mobileToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
            }
        }
        
        // Show notification
        function showNotification(message, duration = 3000, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification' + (isError ? ' error' : '');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }
        
        // Complete a workflow step
        function completeStep(stepNumber) {
            document.getElementById(`step-${stepNumber}`).classList.remove('active');
            document.getElementById(`step-${stepNumber}`).classList.add('completed');
            document.querySelector(`#step-${stepNumber} .step-status`).textContent = 'Completed';
            
            typingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            const guidanceMessages = stepGuidance[stepNumber];
            const randomGuidance = guidanceMessages[Math.floor(Math.random() * guidanceMessages.length)];
            
            setTimeout(() => {
                typingIndicator.style.display = 'none';
                
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', 'app-message');
                messageEl.innerHTML = `
                    <div class="message-actions">
                        <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                    <p>${randomGuidance}</p>
                    <div class="timestamp app-timestamp">${getCurrentTime()}</div>
                `;
                chatContainer.appendChild(messageEl);
                addMessageListeners(messageEl);
                messages++;
                messageCount.textContent = messages;
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                if (stepNumber < totalSteps) {
                    setTimeout(() => {
                        showNextStepTransition(stepNumber);
                    }, 1500);
                } else {
                    setTimeout(() => {
                        const messageEl = document.createElement('div');
                        messageEl.classList.add('message', 'app-message');
                        messageEl.innerHTML = `
                            <div class="message-actions">
                                <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                            <p>Congratulations! You've completed all workflow steps. Would you like to start a new session?</p>
                            <div class="timestamp app-timestamp">${getCurrentTime()}</div>
                        `;
                        chatContainer.appendChild(messageEl);
                        addMessageListeners(messageEl);
                        messages++;
                        messageCount.textContent = messages;
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 1500);
                }
            }, 1500);
        }
        
        // Show transition to next step
        function showNextStepTransition(stepNumber) {
            currentStep = stepNumber + 1;
            
            document.getElementById(`step-${currentStep}`).classList.add('active');
            document.querySelector(`#step-${currentStep} .step-status`).textContent = 'Active';
            
            typingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            const transitionQuestion = transitionQuestions[stepNumber];
            
            setTimeout(() => {
                typingIndicator.style.display = 'none';
                
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', 'app-message');
                messageEl.innerHTML = `
                    <div class="message-actions">
                        <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                    <p>${transitionQuestion}</p>
                    <div class="timestamp app-timestamp">${getCurrentTime()}</div>
                `;
                chatContainer.appendChild(messageEl);
                addMessageListeners(messageEl);
                messages++;
                messageCount.textContent = messages;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 1500);
        }
        
        // Skip a workflow step
        function skipStep(stepNumber) {
            document.getElementById(`step-${stepNumber}`).classList.remove('active');
            document.getElementById(`step-${stepNumber}`).classList.add('completed');
            document.querySelector(`#step-${stepNumber} .step-status`).textContent = 'Skipped';
            
            setTimeout(() => {
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', 'app-message');
                messageEl.innerHTML = `
                    <div class="message-actions">
                        <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                    <p>Okay, let's move on to the next step.</p>
                    <div class="timestamp app-timestamp">${getCurrentTime()}</div>
                `;
                chatContainer.appendChild(messageEl);
                addMessageListeners(messageEl);
                messages++;
                messageCount.textContent = messages;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 800);
            
            if (stepNumber < totalSteps) {
                currentStep = stepNumber + 1;
                document.getElementById(`step-${currentStep}`).classList.add('active');
                document.querySelector(`#step-${currentStep} .step-status`).textContent = 'Active';
                
                const nextStepTitle = document.querySelector(`#step-${currentStep} .step-title`).textContent;
                setTimeout(() => {
                    const messageEl = document.createElement('div');
                    messageEl.classList.add('message', 'app-message');
                    messageEl.innerHTML = `
                        <div class="message-actions">
                            <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                        <p>Now let's focus on <strong>${nextStepTitle}</strong>. What would you like to do?</p>
                        <div class="timestamp app-timestamp">${getCurrentTime()}</div>
                    `;
                    chatContainer.appendChild(messageEl);
                    addMessageListeners(messageEl);
                    messages++;
                    messageCount.textContent = messages;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 1500);
            }
        }
        
        // Send a message
// Update the sendMessage function to reset textarea
function sendMessage() {
    const message = userInput.value.trim();
    if (message === '') return;
    
    const messageEl = document.createElement('div');
    messageEl.classList.add('message', 'user-message');
    messageEl.innerHTML = `
        <div class="message-actions">
            <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
            <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
        <p>${message}</p>
        <div class="timestamp user-timestamp">${getCurrentTime()}</div>
    `;
    chatContainer.appendChild(messageEl);
    addMessageListeners(messageEl);
    
    messages++;
    words += message.split(' ').length;
    messageCount.textContent = messages;
    wordCount.textContent = words;
    
    // Clear and reset textarea
    userInput.value = '';
    userInput.style.height = '46px';
    userInput.style.borderRadius = '50px';
    
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    conversationHistory.push({
        type: 'user',
        content: message,
        timestamp: new Date()
    });
    
    if (chatbotEnabled) {
        setTimeout(() => {
            generateResponse(message);
        }, 1000);
    }
}
        
        // Generate chatbot response
        function generateResponse(userMessage) {
            typingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            let response = '';
            const lowerMessage = userMessage.toLowerCase();
            
            switch(currentStep) {
                case 1:
                    if (lowerMessage.includes('goal') || lowerMessage.includes('achieve') || lowerMessage.includes('accomplish')) {
                        response = "That's a clear goal. How will you know when you've achieved it?";
                    } else if (lowerMessage.includes('focus') || lowerMessage.includes('work on')) {
                        response = "Good focus area. What specific outcome are you hoping for?";
                    } else {
                        response = "Thanks for sharing. How does this relate to your main intentions for this session?";
                    }
                    break;
                case 2:
                    if (lowerMessage.includes('idea') || lowerMessage.includes('thought') || lowerMessage.includes('brainstorm')) {
                        response = "That's an interesting idea. How does it connect to your main goal?";
                    } else {
                        response = "I see. Would you like to explore this further or move to organizing your thoughts?";
                    }
                    break;
                case 3:
                    if (lowerMessage.includes('organize') || lowerMessage.includes('group') || lowerMessage.includes('structure')) {
                        response = "That organization makes sense. How does this structure support your goals?";
                    } else {
                        response = "Good thinking. How does this fit into your overall plan?";
                    }
                    break;
                case 4:
                    if (lowerMessage.includes('work') || lowerMessage.includes('focus') || lowerMessage.includes('progress')) {
                        response = "You're making good progress. What's the next action you'll take?";
                    } else {
                        response = "Keep up the focused work! How is this moving you toward your goals?";
                    }
                    break;
                case 5:
                    if (lowerMessage.includes('review') || lowerMessage.includes('improve') || lowerMessage.includes('refine')) {
                        response = "That refinement will help. How does this improve your work?";
                    } else {
                        response = "Good observation. What other improvements come to mind?";
                    }
                    break;
                case 6:
                    if (lowerMessage.includes('next') || lowerMessage.includes('plan') || lowerMessage.includes('future')) {
                        response = "That's a good plan. How will you prepare for your next session?";
                    } else {
                        response = "Thanks for sharing. Is there anything else you'd like to note for next time?";
                    }
                    break;
                default:
                    response = "Thanks for sharing. How's your workflow progressing?";
            }
            
            setTimeout(() => {
                typingIndicator.style.display = 'none';
                
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', 'app-message');
                messageEl.innerHTML = `
                    <div class="message-actions">
                        <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                    <p>${response}</p>
                    <div class="timestamp app-timestamp">${getCurrentTime()}</div>
                `;
                chatContainer.appendChild(messageEl);
                addMessageListeners(messageEl);
                messages++;
                messageCount.textContent = messages;
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                conversationHistory.push({
                    type: 'assistant',
                    content: response,
                    timestamp: new Date()
                });
            }, 1500);
        }
        
        // Get current time for timestamps
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        // Add event listeners to message actions
        function addMessageListeners(messageEl) {
            const editBtn = messageEl.querySelector('.action-btn:first-child');
            const deleteBtn = messageEl.querySelector('.action-btn:last-child');
            const messageText = messageEl.querySelector('p');
            
            editBtn.addEventListener('click', () => {
                const originalText = messageText.textContent;
                messageText.innerHTML = `
                    <textarea class="edit-textarea">${originalText}</textarea>
                    <div class="highlight-controls">
                        <button class="highlight-btn" data-color="#ffeb3b">Yellow</button>
                        <button class="highlight-btn" data-color="#90caf9">Blue</button>
                        <button class="highlight-btn" data-color="#a5d6a7">Green</button>
                        <button class="highlight-btn" data-color="#ef9a9a">Red</button>
                    </div>
                `;
                
                const textarea = messageText.querySelector('.edit-textarea');
                textarea.focus();
                
                textarea.addEventListener('blur', () => {
                    messageText.textContent = textarea.value;
                });
                
                const highlightBtns = messageText.querySelectorAll('.highlight-btn');
                highlightBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
                        if (selectedText) {
                            const color = btn.getAttribute('data-color');
                            const highlightedText = `<span class="highlight" style="background-color: ${color}">${selectedText}</span>`;
                            const newValue = textarea.value.substring(0, textarea.selectionStart) + 
                                            highlightedText + 
                                            textarea.value.substring(textarea.selectionEnd);
                            messageText.innerHTML = newValue;
                        }
                    });
                });
            });
            
            deleteBtn.addEventListener('click', () => {
                messageEl.remove();
                messages--;
                messageCount.textContent = messages;
            });
        }
        
        // Save session to file
        function saveSession() {
            try {
                const chatData = {
                    messages: [],
                    currentStep: currentStep,
                    stats: {
                        messageCount: messages,
                        wordCount: words,
                        focusTime: activeMinutes
                    },
                    savedAt: new Date().toISOString()
                };
                
                document.querySelectorAll('.message').forEach(msg => {
                    if (msg.querySelector('p')) {
                        chatData.messages.push({
                            type: msg.classList.contains('user-message') ? 'user' : 'app',
                            content: msg.querySelector('p').innerHTML,
                            timestamp: msg.querySelector('.timestamp')?.textContent || ''
                        });
                    }
                });
                
                const dataStr = JSON.stringify(chatData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `workflow-${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Session saved to file!', 2000);
                
            } catch (error) {
                console.error('Error saving session:', error);
                showNotification('Error saving session. Please try again.', 5000, true);
            }
        }
        
        // Load session from file
        function loadSession() {
            fileInput.click();
        }
        
        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const chatData = JSON.parse(e.target.result);
                    
                    clearChat(true);
                    
                    chatData.messages.forEach(msg => {
                        const messageEl = document.createElement('div');
                        messageEl.classList.add('message', msg.type === 'user' ? 'user-message' : 'app-message');
                        messageEl.innerHTML = `
                            <div class="message-actions">
                                <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                            <p>${msg.content}</p>
                            <div class="timestamp ${msg.type === 'user' ? 'user-timestamp' : 'app-timestamp'}">${msg.timestamp}</div>
                        `;
                        chatContainer.appendChild(messageEl);
                        addMessageListeners(messageEl);
                    });
                    
                    messages = chatData.stats.messageCount;
                    words = chatData.stats.wordCount;
                    activeMinutes = chatData.stats.focusTime;
                    
                    messageCount.textContent = messages;
                    wordCount.textContent = words;
                    timeActive.textContent = `${activeMinutes}m`;
                    
                    currentStep = chatData.currentStep;
                    
                    document.querySelectorAll('.workflow-step').forEach((step, index) => {
                        const stepNum = index + 1;
                        step.classList.remove('active', 'completed');
                        if (stepNum < currentStep) {
                            step.classList.add('completed');
                            step.querySelector('.step-status').textContent = 'Completed';
                        } else if (stepNum === currentStep) {
                            step.classList.add('active');
                            step.querySelector('.step-status').textContent = 'Active';
                        } else {
                            step.querySelector('.step-status').textContent = 'Pending';
                        }
                    });
                    
                    showNotification('Session loaded successfully!', 2000);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                } catch (error) {
                    console.error('Error loading session:', error);
                    showNotification('Error loading session file. Please try again.', 5000, true);
                }
            };
            reader.readAsText(file);
        }
        
        // Clear chat
        function clearChat(silent = false) {
            if (!silent && !confirm('Are you sure you want to clear the chat? This cannot be undone.')) {
                return;
            }
            
            const messagesToRemove = [];
            for (let i = 0; i < chatContainer.children.length; i++) {
                const child = chatContainer.children[i];
                if (!child.classList.contains('typing-indicator')) {
                    messagesToRemove.push(child);
                }
            }
            
            messagesToRemove.forEach(el => el.remove());
            
            messages = 0;
            words = 0;
            messageCount.textContent = messages;
            wordCount.textContent = words;
            conversationHistory = [];
            
            if (!silent) {
                showNotification('Chat cleared', 2000);
            }
        }
        
        // Export conversation as text
        function exportConversation() {
            try {
                let exportText = "Workflow Export\n";
                exportText += "================\n\n";
                
                document.querySelectorAll('.message').forEach(msg => {
                    if (msg.querySelector('p')) {
                        const type = msg.classList.contains('user-message') ? 'You' : 'Assistant';
                        const content = msg.querySelector('p').textContent;
                        const timestamp = msg.querySelector('.timestamp')?.textContent || '';
                        
                        exportText += `[${timestamp}] ${type}: ${content}\n\n`;
                    }
                });
                
                exportText += `\nStats: ${messages} messages, ${words} words, ${activeMinutes} minutes focused\n`;
                exportText += `Exported on: ${new Date().toLocaleString()}\n`;
                
                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `workflow-export-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showNotification('Chat exported successfully!', 2000);
                
            } catch (error) {
                console.error('Error exporting chat:', error);
                showNotification('Error exporting chat. Please try again.', 5000, true);
            }
        }
        
        // Toggle theme
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.body.style.background = 'linear-gradient(135deg, #2c3e50, #1a1a2e)';
                themeBtn.innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
            } else {
                document.body.style.background = 'linear-gradient(135deg, #6e8efb, #a777e3)';
                themeBtn.innerHTML = '<i class="fas fa-moon"></i><span>Dark Mode</span>';
            }
        }
        
        // Toggle chatbot
        function toggleChatbot() {
            chatbotEnabled = !chatbotEnabled;
            chatbotStatus.textContent = chatbotEnabled ? 'ON' : 'OFF';
            chatbotStatus.style.background = chatbotEnabled ? 
                'rgba(76, 175, 80, 0.3)' : 'rgba(244, 67, 54, 0.3)';
            
            showNotification(`Chatbot ${chatbotEnabled ? 'enabled' : 'disabled'}`, 1500);
        }
        
        // Update timer
        function updateTimer() {
            activeSeconds++;
            if (activeSeconds >= 60) {
                activeMinutes++;
                activeSeconds = 0;
            }
            timeActive.textContent = `${activeMinutes}m`;
        }
        
        // Dynalist Functions - FIXED VERSION
        function showDynalistSettings() {
            document.getElementById('dynalist-token').value = dynalistApiKey;
            document.getElementById('dynalist-doc-id').value = dynalistDocId;
            updateDynalistStatusDisplay();
            dynalistModal.style.display = 'block';
        }
        
        function closeDynalistModal() {
            dynalistModal.style.display = 'none';
        }
        
        function updateDynalistStatusDisplay() {
            const statusIcon = document.getElementById('dynalist-status-icon');
            const statusText = document.getElementById('dynalist-status-text');
            
            if (dynalistApiKey) {
                statusIcon.className = 'dynalist-status dynalist-enabled';
                statusText.textContent = dynalistDocId ? 'Configured (Document ID set)' : 'Configured (New doc per day)';
            } else {
                statusIcon.className = 'dynalist-status dynalist-disabled';
                statusText.textContent = 'Not configured';
            }
        }
        
        async function testDynalistConnection() {
            const token = document.getElementById('dynalist-token').value;
            if (!token) {
                showNotification('Please enter an API token first', 3000, true);
                return;
            }
            
            try {
                showNotification('Testing connection...', 3000);
                
                const response = await fetch('https://dynalist.io/api/v1/doc/list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: token
                    })
                });
                
                const data = await response.json();
                
                if (data._code === 'Ok') {
                    showNotification('Connection successful! You can access ' + data.files.length + ' files.', 4000);
                } else {
                    showNotification('Connection failed: ' + (data._msg || 'Unknown error'), 5000, true);
                }
            } catch (error) {
                showNotification('Connection error: ' + error.message, 5000, true);
            }
        }
        
        function saveDynalistSettings() {
            const token = document.getElementById('dynalist-token').value;
            const docId = document.getElementById('dynalist-doc-id').value;
            
            if (!token) {
                showNotification('API token is required', 3000, true);
                return;
            }
            
            dynalistApiKey = token;
            dynalistDocId = docId;
            
            localStorage.setItem('dynalistApiKey', token);
            localStorage.setItem('dynalistDocId', docId);
            
            updateDynalistStatusDisplay();
            closeDynalistModal();
            showNotification('Dynalist settings saved!', 2000);
        }
        
        async function sendToDynalist() {
            if (!dynalistApiKey) {
                showNotification('Please configure Dynalist settings first', 3000, true);
                showDynalistSettings();
                return;
            }
            
            try {
                showNotification('Exporting to Dynalist...', 3000);
                
                // Get or create document ID
                let documentId = dynalistDocId;
                if (!documentId) {
                    documentId = await createDynalistDocument();
                    if (!documentId) {
                        throw new Error('Failed to create document');
                    }
                    // Save the new document ID
                    dynalistDocId = documentId;
                    localStorage.setItem('dynalistDocId', documentId);
                }
                
                // Add content to Dynalist with conversation as subitems
                await addContentToDynalist(documentId);
                showNotification('Successfully exported to Dynalist! Opening document...', 3000);
                
                // Open Dynalist in new tab
                setTimeout(() => {
                    window.open(
					    `https://dynalist.io/d/${documentId}`,
					    'DynalistPopout',
					    'width=1000,height=800,resizable=yes,scrollbars=yes'
						);

	               }, 1000);
                
            } catch (error) {
                console.error('Dynalist export error:', error);
                showNotification('Error exporting to Dynalist: ' + error.message, 5000, true);
            }
        }
        
async function createDynalistDocument() {
    const today = new Date();
    
    // New date format: YYYYMMDD (Weekday) HH:MM AM/PM
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const weekday = today.toLocaleDateString('en-US', { weekday: 'short' });
    const timeString = today.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    }).toLowerCase();
    
    const documentTitle = `Flowchat ${year}${month}${day} (${weekday}) ${timeString}`;
    
    try {
        const response = await fetch('https://dynalist.io/api/v1/doc/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: dynalistApiKey,
                title: documentTitle,
                type: 'document'
            })
        });
        
        const data = await response.json();
        
        if (data._code === 'Ok' && data.id) {
            return data.id;
        } else {
            throw new Error(data._msg || 'Failed to create document');
        }
    } catch (error) {
        console.error('Error creating Dynalist document:', error);
        throw error;
    }
}
        
        
async function addContentToDynalist(documentId) {
    // Read the document root
    const readResponse = await fetch('https://dynalist.io/api/v1/doc/read', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: dynalistApiKey, file_id: documentId })
    });
    const readData = await readResponse.json();
    if (readData._code !== 'Ok') {
        throw new Error('Failed to read document: ' + (readData._msg || 'Unknown error'));
    }

    // Root node
    const rootNode = readData.nodes.find(node => node.id === 'root');
    if (!rootNode) throw new Error('Root node not found');

    // Create main session node with timestamp
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const weekday = today.toLocaleDateString('en-US', { weekday: 'short' });
    const timeString = today.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    }).toLowerCase();
    
    const sessionNodeContent = `Flowchat ${year}${month}${day} (${weekday}) ${timeString}`;

    const sessionResponse = await fetch('https://dynalist.io/api/v1/doc/edit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            token: dynalistApiKey,
            file_id: documentId,
            changes: [{
                action: 'insert',
                parent_id: rootNode.id,
                content: sessionNodeContent,
                index: readData.nodes.filter(n => n.parent === rootNode.id).length
            }]
        })
    });
    const sessionData = await sessionResponse.json();
    if (sessionData._code !== 'Ok') {
        throw new Error('Failed to add session node: ' + (sessionData._msg || 'Unknown error'));
    }
    const sessionNodeId = sessionData.new_node_ids ? sessionData.new_node_ids[0] : null;
    if (!sessionNodeId) throw new Error('Failed to get new session node ID');

    // Add conversation messages
    const messages = Array.from(document.querySelectorAll('.message')).filter(msg => {
        const contentElement = msg.querySelector('p');
        return contentElement && contentElement.textContent.trim() !== '';
    });
    
    for (let i = 0; i < messages.length; i++) {
        const msg = messages[i];
        const type = msg.classList.contains('user-message') ? '👤' : '🤖';
        
        // Get message content
        const contentElement = msg.querySelector('p');
        const messageContent = contentElement ? contentElement.textContent.trim() : '';
        
        // Skip empty messages
        if (!messageContent) {
            continue;
        }
        
        // Format timestamp
        let timeOnly = '';
        const timestamp = msg.querySelector('.timestamp')?.textContent || '';
        if (timestamp) {
            // Remove "Today, " or other prefixes if present
            timeOnly = timestamp.replace('Today, ', '').replace('Just now', getCurrentTime());
            // Ensure AM/PM format
            if (!timeOnly.toLowerCase().includes('am') && !timeOnly.toLowerCase().includes('pm')) {
                // Convert to AM/PM format if needed
                const timeParts = timeOnly.split(':');
                if (timeParts.length === 2) {
                    let hours = parseInt(timeParts[0]);
                    const minutes = timeParts[1];
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12 || 12;
                    timeOnly = `${hours}:${minutes} ${ampm}`;
                }
            }
        }
        
        const messageNodeContent = `${type}: ${messageContent} (${timeOnly})`;

        try {
            const response = await fetch('https://dynalist.io/api/v1/doc/edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token: dynalistApiKey,
                    file_id: documentId,
                    changes: [{
                        action: 'insert',
                        parent_id: sessionNodeId,
                        content: messageNodeContent,
                        index: i
                    }]
                })
            });
            
            const data = await response.json();
            if (data._code !== 'Ok') {
                console.warn('Failed to add message node:', data._msg);
                continue;
            }
            
            // Add a small delay between requests to avoid rate limiting
            if (i < messages.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
        } catch (error) {
            console.warn('Error adding message node:', error);
            continue;
        }
    }
    
    return true;
}


        // Initialize the app
        function init() {
            // Get DOM elements
            chatContainer = document.getElementById('chat-container');
            userInput = document.getElementById('user-input');
            sendBtn = document.getElementById('send-btn');
            messageCount = document.getElementById('message-count');
            wordCount = document.getElementById('word-count');
            timeActive = document.getElementById('time-active');
            themeBtn = document.getElementById('theme-btn');
            saveBtn = document.getElementById('save-btn');
            loadBtn = document.getElementById('load-btn');
            clearBtn = document.getElementById('clear-btn');
            exportBtn = document.getElementById('export-btn');
            chatbotToggle = document.getElementById('chatbot-toggle');
            chatbotStatus = document.getElementById('chatbot-status');
            searchInput = document.getElementById('search-input');
            searchBtn = document.getElementById('search-btn');
            typingIndicator = document.getElementById('typing-indicator');
            fileInput = document.getElementById('file-input');
            dynalistBtn = document.getElementById('dynalist-btn');
            dynalistSettingsBtn = document.getElementById('dynalist-settings-btn');
            dynalistModal = document.getElementById('dynalist-modal');
            
            // Initialize auto-expand textarea
		    initTextarea();
		    setupMobileKeyboardHandling();
            
            // Add event listeners
            document.getElementById('toggle-guide').addEventListener('click', toggleSidebar);
            document.getElementById('mobile-toggle').addEventListener('click', toggleSidebar);
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            themeBtn.addEventListener('click', toggleTheme);
            saveBtn.addEventListener('click', saveSession);
            loadBtn.addEventListener('click', loadSession);
            clearBtn.addEventListener('click', () => clearChat(false));
            exportBtn.addEventListener('click', exportConversation);
            chatbotToggle.addEventListener('change', toggleChatbot);
            fileInput.addEventListener('change', handleFileSelect);
            
            // Dynalist event listeners
            dynalistBtn.addEventListener('click', sendToDynalist);
            dynalistSettingsBtn.addEventListener('click', showDynalistSettings);
            document.querySelector('.close-modal').addEventListener('click', closeDynalistModal);
            document.getElementById('test-connection').addEventListener('click', testDynalistConnection);
            document.getElementById('save-dynalist').addEventListener('click', saveDynalistSettings);
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === dynalistModal) {
                    closeDynalistModal();
                }
            });
            
            // Add message listeners to initial messages
            document.querySelectorAll('.message').forEach(addMessageListeners);
            
            // Start timer
            setInterval(updateTimer, 1000);
            
            // Initialize Dynalist status
            updateDynalistStatusDisplay();
        }

// Auto-expand textarea function
function autoExpand(textarea) {
    // Reset height to auto to get the correct scrollHeight
    textarea.style.height = 'auto';
    
    // Set the height to scrollHeight to expand
    const newHeight = Math.min(textarea.scrollHeight, 200); // Cap at max-height
    textarea.style.height = newHeight + 'px';
    
    // Change border radius when multi-line
    if (textarea.scrollHeight > 46) {
        textarea.style.borderRadius = '18px';
    } else {
        textarea.style.borderRadius = '50px';
    }
}

// Initialize the textarea
function initTextarea() {
    const userInput = document.getElementById('user-input');
    
    // Auto-expand on input
    userInput.addEventListener('input', function() {
        autoExpand(this);
    });
    
    // Also expand on focus (helps with some mobile browsers)
    userInput.addEventListener('focus', function() {
        setTimeout(() => autoExpand(this), 10);
    });
    
    // Handle Enter key (send on Enter, new line on Shift+Enter)
    userInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault(); // Prevent new line
            sendMessage();
        }
        // Shift+Enter will naturally create a new line
    });
}

// Mobile keyboard handling
function setupMobileKeyboardHandling() {
    if ('visualViewport' in window) {
        const visualViewport = window.visualViewport;
        
        visualViewport.addEventListener('resize', function() {
            // Adjust layout when keyboard appears/disappears
            setTimeout(() => {
                const activeElement = document.activeElement;
                if (activeElement === userInput) {
                    // Scroll input into view when keyboard is open
                    activeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        });
    }
}
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>