<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Research Portal | Dr. Wen-Ming Yang Lab</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #e74c3c;
      --light-gray: #ecf0f1;
      --dark-gray: #7f8c8d;
      --success-color: #27ae60;
    }
    
    /* Base Styles */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f9f9f9;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
.header {
  background-color: var(--primary-color); /* dark background (#2c3e50) */
  color: white;
  padding: 1rem 2rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  text-align: center; /* center child elements */
}

.header h1 {
  margin: 0;
  font-size: 1.5rem;
  display: inline-flex;       /* inline to allow centering */
  align-items: center;        /* vertical alignment */
  gap: 0.5rem;                /* spacing between icon and text */
}

.header h1 i {
  margin: 0;                  /* remove default margin */
  color: var(--secondary-color); /* keep icon accent color */
}

    
    /* Main Content */
.container {
  flex: 1;
  padding: 2rem;
  width: 100%;
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
  box-sizing: border-box;
}
    
    /* Sections */
.section {
  background: #f4f9ff;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  margin-bottom: 1.5rem;
  overflow: hidden;
  transition: all 0.3s ease;
}
    
    .section:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
/* DEFAULT (general) section color */
.section-header {
  padding: 1rem 1.5rem;
  background-color: #4a90e2; /* default blue */
  color: white;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
}

/* Favorites */
.favorites-section .section-header {
  background-color: #f39c12; /* orange/yellow */
}

/* Workspace */
.workspace-section .section-header {
  background-color: #1abc9c; /* teal green */
}

/* Custom sections */
.custom-section .section-header {
  background-color: #9b59b6; /* purple */
}

/* General sections */
.general-section .section-header {
  background-color: #4a90e2; /* default blue (already set) */
}

    
/* Option 2: Add margin to the chevron icon */
.section-header i {
  transition: transform 0.3s ease;
  /* Add this line to create space */
  margin-left: 1rem; /* Adjust this value as needed */
}
    
    .section-header.active i {
      transform: rotate(90deg);
    }
    
    .button-container {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, padding 0.3s ease;
    }
    
    .button-container.open {
      max-height: 500px;
      padding: 1rem 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    /* Buttons */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem 1.25rem;
  border-radius: 6px;
  font-weight: 500;
  font-size: 1.0rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: left;
  border: none;
  position: relative;
}

.btn-primary {
  background-color: #5dade2;
  color: white;
}
    
.btn-primary:hover {
  background-color: #3498db;
  transform: translateY(-2px);
}
    
.btn-danger {
  background-color: #f1948a;
  color: white;
}

.btn-danger:hover {
  background-color: #e74c3c;
}
    
.btn-outline {
  background: #e6f4ff;
  border: 1px solid #cce4f6;
  color: var(--primary-color);
}

.btn-outline:hover {
  background: #d0eaff;
  border-color: #a5d3f5;
}

.btn .action-buttons {
  display: flex;
  gap: 8px;
  margin-left: 8px;
}

.btn .star-container, 
.btn .workspace-container {
  opacity: 0;
  transition: opacity 0.2s ease, transform 0.2s ease;
  pointer-events: none;
  transform: translateX(4px);
  z-index: 2;
}

.btn:hover .star-container,
.btn:hover .workspace-container {
  opacity: 1;
  pointer-events: auto;
  transform: translateX(0);
}

.btn .star {
  color: #7f8c8d;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn .star:hover {
  transform: scale(1.2);
}

.btn .star.favorited {
  color: #ffd700;
}

.btn .workspace {
  color: #7f8c8d;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn .workspace:hover {
  transform: scale(1.2);
}

.btn .workspace.favorited {
  color: #3498db;
}
    
    .btn i {
      margin-right: 8px;
    }
    
    /* Controls */
    .controls {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    /* Login History */
    .login-history {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .login-history h3 {
      margin-top: 0;
      color: var(--primary-color);
      border-bottom: 1px solid var(--light-gray);
      padding-bottom: 0.5rem;
      display: flex;
      align-items: center;
    }
    
    .login-history h3 i {
      margin-right: 10px;
      color: var(--secondary-color);
    }
    
    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .history-item {
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
    }
    
    .history-item:last-child {
      border-bottom: none;
    }
    
    .history-time {
      color: var(--dark-gray);
      font-size: 0.9rem;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 1.5rem;
      background-color: var(--primary-color);
      color: white;
      margin-top: 2rem;
    }
    
    .footer p {
      margin: 0;
      font-size: 0.9rem;
    }
    
    /* Welcome Message */
.welcome-message {
  background: var(--success-color);
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 6px;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  animation: fadeIn 0.5s ease;
  font-size: 1.2rem;
  font-weight: bold;
}

    
    .welcome-message i {
      margin-right: 10px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Password Modal */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    
    .modal h2 {
      margin-top: 0;
      color: var(--primary-color);
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--light-gray);
      border-radius: 4px;
      font-size: 1rem;
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .button-container.open {
        grid-template-columns: 1fr;
      }
      
      .controls {
        flex-direction: column;
      }
    }

/* ======================== */
/* Dropdown Menu Styles */
/* ======================== */

.dropdown-container {
  position: relative;
  width: 100%;
  margin-bottom: 0.5rem;
}

.btn-dropdown {
  background: linear-gradient(135deg, #6e8efb, #a777e3);
  color: white;
  border: none;
  padding: 0.75rem 1.25rem;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: left;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.btn-dropdown:hover {
  background: linear-gradient(135deg, #5d7de8, #9666d6);
  transform: translateY(-2px);
}

.dropdown-content {
  display: none;
  width: 100%;
  background: white;
  border-radius: 0 0 6px 6px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  margin-top: -6px;
  padding: 1rem;
  border: 1px solid #e0e0e0;
  border-top: none;
  max-height: 70vh;
  overflow-y: auto;
  z-index: 10;
}

.dropdown-content.show {
  display: block;
  animation: fadeIn 0.3s ease;
}

/* Embedded content styling */
.dropdown-content .container {
  padding: 0;
  margin: 0;
  width: 100%;
}

.dropdown-content .btn-outline {
  width: 100%;
  margin-bottom: 0.5rem;
  text-align: left;
  justify-content: flex-start;
}

/* Loading and error states */
.dropdown-loading, .dropdown-error {
  padding: 1.5rem;
  text-align: center;
  color: var(--dark-gray);
}

.dropdown-error {
  color: var(--accent-color);
}

.fa-spinner {
  animation: spin 1s linear infinite;
  margin-right: 0.5rem;
}

.fa-caret-down {
  transition: transform 0.3s ease;
}

.fa-caret-down.rotate {
  transform: rotate(180deg);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Notification animations */
@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}

/* Add to your existing CSS */
.section {
  cursor: move; /* Change cursor to indicate draggable */
  user-select: none; /* Prevent text selection while dragging */
}

.section.dragging {
  opacity: 0.5;
  border: 2px dashed var(--secondary-color);
}

.section-placeholder {
  background: rgba(52, 152, 219, 0.1);
  border: 2px dashed var(--secondary-color);
  border-radius: 8px;
  height: 50px; /* Adjust as needed */
  margin-bottom: 1.5rem;
}

/* Update your existing .controls style */
.controls {
  display: flex;
  justify-content: space-between; /* Push left and right groups apart */
  align-items: center; /* Vertically center items */
  margin-bottom: 2rem;
  flex-wrap: wrap;
  gap: 1rem;
}

/* Optional: Make buttons equal width when they wrap */
@media (max-width: 768px) {
  .controls > div {
    width: 100%;
  }
  
  .controls > div:last-child {
    justify-content: flex-end;
  }
}

/* Add these styles to your CSS */
.delete-section {
  cursor: pointer;
  opacity: 0.6;
  transition: all 0.2s ease;
}

.delete-section:hover {
  opacity: 1;
  color: var(--accent-color);
}

.section-header {
  position: relative; /* For absolute positioning of delete icon */
}

/* Add this to your CSS */
.delete-button {
  cursor: pointer;
  opacity: 0;
  transition: all 0.2s ease;
  margin-right: 8px;
  color: var(--accent-color);
}

.btn:hover .delete-button {
  opacity: 1;
}

.delete-button:hover {
  transform: scale(1.2);
}

  </style>
</head>
<body>
  <!-- Password Modal -->
  <div class="modal" id="passwordModal" style="display: none;">
    <div class="modal-content">
      <h2><i class="fas fa-lock"></i> Enter Password</h2>
      <div class="form-group">
        <label for="passwordInput">Please enter the password to access this portal:</label>
        <input type="password" id="passwordInput" placeholder="Enter password" autofocus>
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" id="submitPassword">Submit</button>
      </div>
    </div>
  </div>

  <!-- Authenticated Content -->
  <div id="authenticatedContent" style="display: none;">
    <header class="header">
      <h1><i class="fas fa-flask"></i> Research Portal - Dr. Wen-Ming Yang Lab</h1>
    </header>

    <div class="container">
      <!-- Content will be generated dynamically -->
    </div>

    <footer class="footer">
      <p>¬© 2025 Dr. Wen-Ming Yang Lab. All Rights Reserved. (v16a4 delete button)</p>
    </footer>
  </div>

  <script>
    // === CONFIGURATION ===
    const config = {
      password: "1234",
      version: "v2",
      storageKey: "lab_access_" + "v2",
      historyKey: "login_history_" + "v2",
      copyright: "¬© 2025 Dr. Wen-Ming Yang Lab. All Rights Reserved.",
      portalName: "Office Port"
    };

    // Portal content configuration
    const portalContent = {
      "‚≠ê Favorites": [], // Dynamic favorites section
      "üñ•Ô∏è Workspace": [], // Dynamic workspace section
      "üí∞ Ordering Â∏≥Âãô": [
        {name: "Orderinput", url: "http://orderinput.tiddlyspot.com/", icon: "fa-wallet"},
        {name: "Labbudget", url: "https://labbudget.tiddlyspot.com/", icon: "fa-file-invoice"},
        {name: "NCHU Payment", url: "https://acc95.nchu.edu.tw/apswis_q/login_l_q.asp?", icon: "fa-file-invoice"},
        {name: "NCHU Payroll", url: "https://psf.nchu.edu.tw/income/income.html", icon: "fa-file-invoice"},
        {name: "NCHU-EZcome", url: "https://psf.nchu.edu.tw/EZcome/?", icon: "fa-file-invoice"},
        {name: "Lab-issue", url: "https://www.messenger.com/c/3229726030600586", icon: "fa-chart-line"},
      ],
      "üìö NCHU": [
        {name: "NCHU-portak", url: "https://cportal.nchu.edu.tw/cas_login/", icon: "fa-book"},
        {name: "NCHU-Class", url: "https://cportal.nchu.edu.tw/cofsys/plsql/acad_subframeset1?v_subname=teacher_roster", icon: "fa-graduation-cap"},
        {name: "NCHU-iLearning", url: "https://lms2020.nchu.edu.tw/dashboard", icon: "fa-book"},
        {name: "NCHU-Library", url: "https://www.lib.nchu.edu.tw/", icon: "fa-book"},
        {name: "NCHU-ÂÖ¨ÊñáÁ≥ªÁµ±", url: "https://nchodap21.edoc2.nchu.edu.tw/MS/SSO.HTML", icon: "fa-book"},
        {name: "NCHU-‰∫∫Âì°", url: "https://psf.nchu.edu.tw/PsnWeb/psnqry_input.jsp", icon: "fa-magnifying-glass"},
      ],
	  "ü§ñ AI Resources": [
	    {name: "AI Tools Collection", 
          url: "https://yangwm2005.github.io/p/AIs-q.html", 
         icon: "fa-robot", 
         isDropdown: true,
         staticContent: [
           {name: "ChatGPT", url: "https://chat.openai.com", icon: "fa-brain"},
           {name: "Claude AI", url: "https://claude.ai", icon: "fa-robot"},
           {name: "Google Bard", url: "https://bard.google.com", icon: "fa-google"},
           {name: "Bing Chat", url: "https://www.bing.com/chat", icon: "fa-microsoft"},
           {name: "Perplexity AI", url: "https://www.perplexity.ai", icon: "fa-search"},
           {name: "GitHub Copilot", url: "https://github.com/features/copilot", icon: "fa-code"},
           {name: "Midjourney", url: "https://www.midjourney.com", icon: "fa-image"},
           {name: "Stable Diffusion", url: "https://stablediffusionweb.com", icon: "fa-palette"},
           {name: "Hugging Face", url: "https://huggingface.co", icon: "fa-face-smile"},
           {name: "OpenAI Playground", url: "https://platform.openai.com/playground", icon: "fa-play"}
         ]
         },
        {name: "Perplexity AI", url: "https://www.perplexity.ai", icon: "fa-search"},
        {name: "Felo AI", url: "https://felo.ai/search", icon: "fa-search"},
        {name: "Liner", url: "https://getliner.com/", icon: "fa-search"},
         {name: "ChatGPT", url: "https://chat.openai.com", icon: "fa-brain"},
         {name: "Notebooklm", url: "https://notebooklm.google.com/", icon: "fa-brain"},
	  ],
      "üîç Search Engines": [
        {name: "Google", url: "https://www.google.com", icon: "fa-magnifying-glass"},
        {name: "Bing", url: "https://www.bing.com", icon: "fa-magnifying-glass"},
        {name: "Yahoo", url: "https://www.yahoo.com", icon: "fa-magnifying-glass"},
        {name: "Perplexity AI", url: "https://www.perplexity.ai", icon: "fa-search"},
        {name: "Felo AI", url: "https://felo.ai/search", icon: "fa-search"},
        {name: "Liner", url: "https://getliner.com/", icon: "fa-search"},
      ],
      "üìö Reference Sites": [
        {name: "Pubmed", url: "https://pubmed.ncbi.nlm.nih.gov/", icon: "fa-book"},
        {name: "Semanticscholar", url: "https://www.semanticscholar.org/me/research", icon: "fa-book"},
        {name: "Wikipedia", url: "https://www.wikipedia.org", icon: "fa-book"},
        {name: "Google Scholar", url: "https://scholar.google.com", icon: "fa-graduation-cap"},
        {name: "Perplexity AI", url: "https://www.perplexity.ai", icon: "fa-search"},
        {name: "Felo AI", url: "https://felo.ai/search", icon: "fa-search"},
        {name: "Liner", url: "https://getliner.com/", icon: "fa-search"},
      ],
      "üì∞ News & Journals": [
        {name: "BBC News", url: "https://www.bbc.com", icon: "fa-newspaper"},
        {name: "Nature", url: "https://www.nature.com", icon: "fa-book-open"},
        {name: "Cell", url: "https://www.Cell.com", icon: "fa-book-open"},
        {name: "Science Magazine", url: "https://www.science.org", icon: "fa-book-open"}
      ],
      "üß™ Lab Resources": [
        {name: "Lab Protocols", url: "#", icon: "fa-file-lines"},
        {name: "Equipment Manuals", url: "#", icon: "fa-microscope"},
        {name: "Safety Guidelines", url: "#", icon: "fa-triangle-exclamation"}
      ]
    };

    // === AUTHENTICATION ===
    function checkAuth() {
      if (localStorage.getItem(config.storageKey) === "true") {
        showAuthenticatedContent();
      } else {
        showPasswordModal();
      }
    }

    function showPasswordModal() {
      const modal = document.getElementById('passwordModal');
      modal.style.display = 'flex';
      
      const passwordInput = document.getElementById('passwordInput');
      const submitBtn = document.getElementById('submitPassword');
      
      passwordInput.focus();
      
      submitBtn.onclick = () => {
        if (passwordInput.value === config.password) {
          localStorage.setItem(config.storageKey, "true");
          recordLogin();
          modal.style.display = 'none';
          showAuthenticatedContent();
        } else {
          alert("Incorrect password. Please try again.");
          passwordInput.value = '';
          passwordInput.focus();
        }
      };
      
      passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          submitBtn.click();
        }
      });
    }

    function showAuthenticatedContent() {
      document.getElementById('authenticatedContent').style.display = 'block';
      loadFavorites();
      loadWorkspace();
      generatePortalContent();
    }

    function recordLogin() {
      const now = new Date();
      const loginEntry = {
        date: now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
        time: now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
        timestamp: now.getTime()
      };
      
      let history = JSON.parse(localStorage.getItem(config.historyKey)) || [];
      history.unshift(loginEntry);
      
      // Keep only the last 10 logins
      if (history.length > 10) history = history.slice(0, 10);
      
      localStorage.setItem(config.historyKey, JSON.stringify(history));
    }

    // === FAVORITES MANAGEMENT ===
    function loadFavorites() {
      const favorites = JSON.parse(localStorage.getItem('favorites_' + config.version)) || [];
      portalContent["‚≠ê Favorites"] = favorites;
    }

    function saveFavorites() {
      localStorage.setItem('favorites_' + config.version, JSON.stringify(portalContent["‚≠ê Favorites"]));
    }

    // === WORKSPACE MANAGEMENT ===
    function loadWorkspace() {
      const workspace = JSON.parse(localStorage.getItem('workspace_' + config.version)) || [];
      portalContent["üñ•Ô∏è Workspace"] = workspace;
    }

    function saveWorkspace() {
      localStorage.setItem('workspace_' + config.version, JSON.stringify(portalContent["üñ•Ô∏è Workspace"]));
    }

    // Make functions globally available
    window.addToFavorites = function(item, sectionTitle, event) {
      event.stopPropagation(); // Prevent the button click from triggering
      
      const favorites = portalContent["‚≠ê Favorites"];
      
      // Check if already in favorites
      const exists = favorites.some(fav => fav.url === item.url);
      if (exists) {
        alert(`"${item.name}" is already in your favorites!`);
        return;
      }
      
      // Add to favorites
      favorites.push({...item, sourceSection: sectionTitle});
      saveFavorites();
      
      // Show confirmation
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1001;
        animation: slideIn 0.3s ease;
        font-weight: bold;
      `;
      notification.innerHTML = `
        <i class="fas fa-star"></i> 
        "${item.name}" added to favorites!
      `;
      
      document.body.appendChild(notification);
      
      // Remove notification after 3 seconds
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
      
      // Refresh the favorites section if it's open
      refreshFavoritesSection();
      // Refresh all sections to update star states
      refreshAllSections();
    };

    window.removeFromFavorites = function(item, event) {
      event.stopPropagation(); // Prevent the button click from triggering
      
      if (confirm(`Remove "${item.name}" from favorites?`)) {
        const favorites = portalContent["‚≠ê Favorites"];
        const index = favorites.findIndex(fav => fav.url === item.url);
        if (index > -1) {
          favorites.splice(index, 1);
          saveFavorites();
          refreshFavoritesSection();
          refreshAllSections();
        }
      }
    };

    window.addToWorkspace = function(item, sectionTitle, event) {
      event.stopPropagation(); // Prevent the button click from triggering
      
      const workspace = portalContent["üñ•Ô∏è Workspace"];
      
      // Check if already in workspace
      const exists = workspace.some(ws => ws.url === item.url);
      if (exists) {
        alert(`"${item.name}" is already in your workspace!`);
        return;
      }
      
      // Add to workspace
      workspace.push({...item, sourceSection: sectionTitle});
      saveWorkspace();
      
      // Show confirmation
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--secondary-color);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1001;
        animation: slideIn 0.3s ease;
        font-weight: bold;
      `;
      notification.innerHTML = `
        <i class="fas fa-briefcase"></i> 
        "${item.name}" added to workspace!
      `;
      
      document.body.appendChild(notification);
      
      // Remove notification after 3 seconds
      setTimeout(() => {
        notification.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
      
      // Refresh the workspace section if it's open
      refreshWorkspaceSection();
      // Refresh all sections to update workspace states
      refreshAllSections();
    };

    window.removeFromWorkspace = function(item, event) {
      event.stopPropagation(); // Prevent the button click from triggering
      
      if (confirm(`Remove "${item.name}" from workspace?`)) {
        const workspace = portalContent["üñ•Ô∏è Workspace"];
        const index = workspace.findIndex(ws => ws.url === item.url);
        if (index > -1) {
          workspace.splice(index, 1);
          saveWorkspace();
          refreshWorkspaceSection();
          refreshAllSections();
        }
      }
    };

    function refreshFavoritesSection() {
      const favoritesContainer = document.getElementById('section-0-buttons');
      if (favoritesContainer && favoritesContainer.classList.contains('open')) {
        generateSectionButtons(portalContent["‚≠ê Favorites"], favoritesContainer, "‚≠ê Favorites", true, false);
      }
    }

    function refreshWorkspaceSection() {
      const workspaceContainer = document.getElementById('section-1-buttons');
      if (workspaceContainer && workspaceContainer.classList.contains('open')) {
        generateSectionButtons(portalContent["üñ•Ô∏è Workspace"], workspaceContainer, "üñ•Ô∏è Workspace", false, true);
      }
    }

    function refreshAllSections() {
      Object.entries(portalContent).forEach(([title, items], index) => {
        const sectionId = `section-${index}`;
        const container = document.getElementById(`${sectionId}-buttons`);
        if (container && container.classList.contains('open')) {
          if (title === "‚≠ê Favorites") {
            generateSectionButtons(items, container, title, true, false);
          } else if (title === "üñ•Ô∏è Workspace") {
            generateSectionButtons(items, container, title, false, true);
          } else {
            generateSectionButtons(items, container, title);
          }
        }
      });
    }

function generateSectionButtons(items, container, sectionTitle, isFavoritesSection = false, isWorkspaceSection = false) {
  container.innerHTML = '';
  
  items.forEach(item => {
    if (item.isDropdown) {
      // [Previous dropdown code remains exactly the same]
      // ... (keep all the existing dropdown code)
    } else {
      // Regular button
      const isFavorite = portalContent["‚≠ê Favorites"].some(fav => fav.url === item.url);
      const isInWorkspace = portalContent["üñ•Ô∏è Workspace"].some(ws => ws.url === item.url);
      const isCustomSection = !Object.keys(portalContent).includes(sectionTitle);
      
      const btn = document.createElement('button');
      btn.className = 'btn btn-outline';
      
      btn.innerHTML = `
        <i class="fas ${item.icon}"></i> ${item.name}
        <span class="action-buttons">
          ${isCustomSection ? '<span class="delete-button" title="Delete this button"><i class="fas fa-trash"></i></span>' : ''}
          <span class="star-container">
            <i class="fas ${isFavorite ? 'fa-star favorited' : 'fa-star'}"></i>
          </span>
          <span class="workspace-container">
            <i class="fas ${isInWorkspace ? 'fa-briefcase favorited' : 'fa-briefcase'}"></i>
          </span>
        </span>
      `;

      // Open link only if not clicking action buttons
      btn.onclick = (e) => {
        if (!e.target.closest('.action-buttons')) {
          openResource(item.url);
        }
      };

      // Handle delete button click (only for custom sections)
      if (isCustomSection) {
        btn.querySelector('.delete-button').onclick = (e) => {
          e.stopPropagation();
          // Immediately remove the button from DOM
          btn.style.opacity = '0.5';
          btn.style.transition = 'opacity 0.3s ease';
          setTimeout(() => {
            btn.remove();
            // Then remove from storage
            const customSections = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
            if (customSections[sectionTitle]) {
              customSections[sectionTitle] = customSections[sectionTitle].filter(
                btn => btn.name !== item.name || btn.url !== item.url
              );
              localStorage.setItem(CUSTOM_SECTIONS_KEY, JSON.stringify(customSections));
              showNotification(`"${item.name}" deleted!`, 'fa-trash', 'var(--accent-color)');
            }
          }, 300);
        };
      }

      // Handle favorite star click
      btn.querySelector('.star-container i').onclick = (e) => {
        e.stopPropagation();
        if (isFavorite) {
          removeFromFavorites(item, e);
        } else {
          addToFavorites(item, sectionTitle, e);
        }
      };

      // Handle workspace briefcase click
      btn.querySelector('.workspace-container i').onclick = (e) => {
        e.stopPropagation();
        if (isInWorkspace) {
          removeFromWorkspace(item, e);
        } else {
          addToWorkspace(item, sectionTitle, e);
        }
      };
      
      container.appendChild(btn);
    }
  });

  // Add single "Add Button" option for custom sections
  const customSections = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
  if (customSections[sectionTitle] && !isFavoritesSection && !isWorkspaceSection) {
    const addButton = document.createElement('button');
    addButton.className = 'btn btn-outline'; // Changed from btn-primary to btn-outline
    addButton.style.marginTop = '10px';
    addButton.style.width = '100%';
    addButton.innerHTML = '<i class="fas fa-plus"></i> Add New Button';
    addButton.onclick = (e) => {
      e.stopPropagation();
      addButtonToCustomSection(sectionTitle);
    };
    container.appendChild(addButton);
  }
}

function generatePortalContent() {
  const container = document.querySelector('.container');
  container.innerHTML = '';

  // Add welcome message
  const welcomeMsg = document.createElement('div');
  welcomeMsg.className = 'welcome-message';
  welcomeMsg.innerHTML = `<i class="fas fa-check-circle"></i> Welcome to ${config.portalName}!`;
  container.appendChild(welcomeMsg);

  // Add controls section with all buttons
  const controls = document.createElement('div');
  controls.className = 'controls';
  controls.innerHTML = `
    <div style="flex-grow: 1;">
      <button class="btn btn-primary" id="toggleAllBtn">
        <i class="fas fa-expand"></i> Toggle All
      </button>
      <button class="btn btn-outline" id="addSectionBtn">
        <i class="fas fa-plus"></i> Add Section
      </button>
    </div>
    <div style="display: flex; gap: 0.5rem;">
      <button class="btn btn-outline" id="exportBtn">
        <i class="fas fa-file-export"></i> Export
      </button>
      <button class="btn btn-outline" id="importBtn">
        <i class="fas fa-file-import"></i> Import
      </button>
      <button class="btn btn-outline" id="resetPositionsBtn">
        <i class="fas fa-layer-group"></i> Reset Positions
      </button>
      <button class="btn btn-warning" id="resetAllBtn">
        <i class="fas fa-trash"></i> Reset All
      </button>
      <button class="btn btn-danger" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  `;
  container.appendChild(controls);

  // Load and merge sections
  const customSections = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
  const allContent = {
    ...portalContent,
    ...customSections
  };

  const fragment = document.createDocumentFragment();

  // Generate sections with drag-and-drop attributes
  Object.entries(allContent).forEach(([title, items], index) => {
    const sectionId = `section-${index}`;
    
    const section = document.createElement('div');
    section.className = 'section';

	if (title === "‚≠ê Favorites") {
	  section.classList.add('favorites-section');
		} else if (title === "üñ•Ô∏è Workspace") {
	  section.classList.add('workspace-section');
		} else if (customSections[title]) {
	  section.classList.add('custom-section');
		} else {
	  section.classList.add('general-section');
	}

    section.id = sectionId;
    section.draggable = true; // Enable drag-and-drop
    section.style.cursor = 'move'; // Change cursor on hover

    const header = document.createElement('div');
    header.className = 'section-header';
    header.innerHTML = `
      ${title}
      <i class="fas fa-chevron-right"></i>
    `;

    if (customSections[title]) {
      header.innerHTML += `
        <span class="delete-section" style="margin-left: auto; padding-left: 10px;">
          <i class="fas fa-trash" title="Delete this section"></i>
        </span>
      `;
    }

    header.onclick = () => toggleSection(sectionId);

    const buttonContainer = document.createElement('div');
    buttonContainer.className = 'button-container';
    buttonContainer.id = `${sectionId}-buttons`;

    section.appendChild(header);
    section.appendChild(buttonContainer);
    fragment.appendChild(section);

    if (customSections[title]) {
      const deleteBtn = header.querySelector('.delete-section i');
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        deleteCustomSection(title);
      };
    }
  });

  container.appendChild(fragment);
  container.appendChild(generateLoginHistory());

  // Load saved states
  loadSectionOrder();
  loadSectionStates();

  // Set up event listeners - FIXED: Added missing resetAllBtn listener
  document.getElementById('toggleAllBtn').onclick = toggleAllSections;
  document.getElementById('addSectionBtn').onclick = addNewSection;
  document.getElementById('exportBtn').onclick = exportCustomSections;
  document.getElementById('importBtn').onclick = importCustomSections;
  document.getElementById('resetPositionsBtn').onclick = resetSectionPositions;
  document.getElementById('resetAllBtn').onclick = resetAllSettings; // This was missing
  document.getElementById('logoutBtn').onclick = logout;

  // Reinitialize drag-and-drop - FIXED: Call setupDragAndDrop after sections are created
  setupDragAndDrop();
}

    function openResource(url) {
      if (url === '#') {
        alert('This resource is currently unavailable. Please check back later.');
        return;
      }
      
      const width = 1000;
      const height = 700;
      const left = (screen.width - width) / 2;
      const top = (screen.height - height) / 2;
      
      window.open(url, '_blank', `width=${width},height=${height},left=${left},top=${top}`);
    }

function toggleSection(sectionId) {
  const container = document.getElementById(`${sectionId}-buttons`);
  const header = container.previousElementSibling;
  
  if (container.classList.contains('open')) {
    // Close the section
    container.classList.remove('open');
    header.classList.remove('active');
  } else {
    // Open the section
    container.classList.add('open');
    header.classList.add('active');
    
    // Generate content when section is opened
    const sectionIndex = parseInt(sectionId.split('-')[1]);
    const sectionTitle = Object.keys({
      ...portalContent,
      ...JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {}
    })[sectionIndex];
    
    const items = {
      ...portalContent,
      ...JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {}
    }[sectionTitle];
    
    // Clear existing content
    container.innerHTML = '';
    
    // Generate the section buttons
    generateSectionButtons(items, container, sectionTitle, 
      sectionTitle === "‚≠ê Favorites", 
      sectionTitle === "üñ•Ô∏è Workspace");

/*    
    // Add "Add Button" option for custom sections (not favorites/workspace)
    const customSections = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
    if (customSections[sectionTitle] && sectionTitle !== "‚≠ê Favorites" && sectionTitle !== "üñ•Ô∏è Workspace") {
      const addButton = document.createElement('button');
      addButton.className = 'btn btn-success';
      addButton.style.marginTop = '10px';
      addButton.style.width = '100%';
      addButton.innerHTML = '<i class="fas fa-plus"></i> Add New Button';
      addButton.onclick = (e) => {
        e.stopPropagation();
        addButtonToCustomSection(sectionTitle);
      };
      container.appendChild(addButton);
    }
*/
  }
  
  // Save section state
  saveSectionState(sectionId, container.classList.contains('open'));
}

// Supporting function to add buttons to custom sections
function addButtonToCustomSection(sectionTitle) {
  const buttonName = prompt("Enter button name:");
  if (!buttonName) return;
  
  const buttonUrl = prompt("Enter URL (include https://):");
  if (!buttonUrl) return;
  
  // Validate URL format
  if (!buttonUrl.startsWith('http://') && !buttonUrl.startsWith('https://')) {
    alert("Please enter a valid URL starting with http:// or https://");
    return;
  }
  
  const icon = prompt("Enter Font Awesome icon class (e.g., fa-book, fa-link):", "fa-link");
  
  const customSections = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
  if (!customSections[sectionTitle]) {
    customSections[sectionTitle] = [];
  }
  
  // Check if button already exists
  if (customSections[sectionTitle].some(btn => btn.name === buttonName || btn.url === buttonUrl)) {
    alert("A button with this name or URL already exists in this section!");
    return;
  }
  
  customSections[sectionTitle].push({
    name: buttonName,
    url: buttonUrl,
    icon: icon.startsWith('fa-') ? icon : `fa-${icon}`
  });
  
  localStorage.setItem(CUSTOM_SECTIONS_KEY, JSON.stringify(customSections));
  
  // Show confirmation
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--success-color);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1001;
    animation: slideIn 0.3s ease;
    font-weight: bold;
  `;
  notification.innerHTML = `
    <i class="fas fa-check-circle"></i> 
    Button "${buttonName}" added to "${sectionTitle}"!
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
  
  // Refresh the section
  const sections = document.querySelectorAll('.section');
  sections.forEach((section, index) => {
    const title = Object.keys({
      ...portalContent,
      ...customSections
    })[index];
    
    if (title === sectionTitle) {
      const container = section.querySelector('.button-container');
      if (container.classList.contains('open')) {
        toggleSection(section.id); // Close
        toggleSection(section.id); // Re-open to refresh
      }
    }
  });
}

    function saveSectionState(sectionId, isOpen) {
      let state = JSON.parse(localStorage.getItem('sectionStates')) || {};
      state[sectionId] = isOpen;
      localStorage.setItem('sectionStates', JSON.stringify(state));
    }

    function loadSectionStates() {
      const state = JSON.parse(localStorage.getItem('sectionStates')) || {};
      
      Object.keys(portalContent).forEach((_, index) => {
        const sectionId = `section-${index}`;
        const container = document.getElementById(`${sectionId}-buttons`);
        const header = container?.previousElementSibling;
        
        if (container && state[sectionId]) {
          container.classList.add('open');
          if (header) header.classList.add('active');
          // Generate content for initially open sections
          const sectionTitle = Object.keys(portalContent)[index];
          const items = portalContent[sectionTitle];
          generateSectionButtons(items, container, sectionTitle, 
            sectionTitle === "‚≠ê Favorites", 
            sectionTitle === "üñ•Ô∏è Workspace");
        }
      });
    }

function toggleAllSections() {
  const allContainers = document.querySelectorAll('.button-container');
  const allOpen = Array.from(allContainers).every(c => c.classList.contains('open'));
  
  allContainers.forEach(container => {
    const sectionId = container.id.replace('-buttons', '');
    const header = container.previousElementSibling;
    
    if (allOpen) {
      // Close all sections
      container.classList.remove('open');
      header.classList.remove('active');
    } else {
      // Open all sections
      container.classList.add('open');
      header.classList.add('active');
      
      // Generate content when section is opened
      const sectionIndex = parseInt(sectionId.split('-')[1]);
      const allContent = {
        ...portalContent,
        ...JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {}
      };
      const sectionTitle = Object.keys(allContent)[sectionIndex];
      const items = allContent[sectionTitle];
      
      // Clear existing content
      container.innerHTML = '';
      
      // Generate the section buttons
      generateSectionButtons(items, container, sectionTitle, 
        sectionTitle === "‚≠ê Favorites", 
        sectionTitle === "üñ•Ô∏è Workspace");
    }
    
    saveSectionState(sectionId, !allOpen);
  });
}

    function generateLoginHistory() {
      const history = JSON.parse(localStorage.getItem(config.historyKey)) || [];
      const historySection = document.createElement('div');
      historySection.className = 'login-history';
      
      const heading = document.createElement('h3');
      heading.innerHTML = `<i class="fas fa-clock-rotate-left"></i> Recent Access History`;
      historySection.appendChild(heading);
      
      if (history.length === 0) {
        const emptyMsg = document.createElement('p');
        emptyMsg.textContent = 'No access history available';
        historySection.appendChild(emptyMsg);
      } else {
        const list = document.createElement('ul');
        list.className = 'history-list';
        
        history.forEach(entry => {
          const item = document.createElement('li');
          item.className = 'history-item';
          item.innerHTML = `
            <span>${entry.date}</span>
            <span class="history-time">${entry.time}</span>
          `;
          list.appendChild(item);
        });
        
        historySection.appendChild(list);
      }
      
      return historySection;
    }

    function logout() {
      if (confirm('Are you sure you want to logout? You will need to enter the password again to access this portal.')) {
        localStorage.removeItem(config.storageKey);
        location.reload();
      }
    }

// Add these functions to your existing JavaScript

// === DRAG AND DROP SECTION REORDERING ===
function setupDragAndDrop() {
  const container = document.querySelector('.container');
  const sections = Array.from(document.querySelectorAll('.section'));
  
  sections.forEach(section => {
    section.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', section.id);
      section.classList.add('dragging');
      setTimeout(() => section.style.opacity = '0.4', 0);
    });
    
    section.addEventListener('dragend', () => {
      section.classList.remove('dragging');
      section.style.opacity = '1';
    });
  });

  container.addEventListener('dragover', (e) => {
    e.preventDefault();
    const draggingSection = document.querySelector('.dragging');
    if (!draggingSection) return;
    
    const afterElement = getDragAfterElement(container, e.clientY);
    const placeholder = document.querySelector('.section-placeholder') || createPlaceholder();
    
    if (afterElement) {
      container.insertBefore(placeholder, afterElement);
    } else {
      container.appendChild(placeholder);
    }
  });

  container.addEventListener('drop', (e) => {
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    const draggedSection = document.getElementById(id);
    const placeholder = document.querySelector('.section-placeholder');
    
    if (placeholder && draggedSection) {
      container.insertBefore(draggedSection, placeholder);
      placeholder.remove();
      saveSectionOrder();
    }
  });
}

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('.section:not(.dragging)')];
  
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function createPlaceholder() {
  const placeholder = document.createElement('div');
  placeholder.className = 'section-placeholder';
  return placeholder;
}

function saveSectionOrder() {
  const sections = Array.from(document.querySelectorAll('.section'));
  const sectionOrder = sections.map(section => section.id);
  localStorage.setItem('sectionOrder', JSON.stringify(sectionOrder));
}

// Update the loadSectionOrder function to this version
function loadSectionOrder() {
  const savedOrder = JSON.parse(localStorage.getItem('sectionOrder'));
  if (!savedOrder) return;
  
  const container = document.querySelector('.container');
  const sections = Array.from(container.querySelectorAll('.section'));
  
  // Create a map of existing sections for quick lookup
  const sectionMap = {};
  sections.forEach(section => {
    sectionMap[section.id] = section;
  });
  
  // Reorder sections based on saved order
  savedOrder.forEach(id => {
    const section = sectionMap[id];
    if (section) {
      // Find the login history section (it should stay at the bottom)
      const loginHistory = container.querySelector('.login-history');
      if (loginHistory) {
        container.insertBefore(section, loginHistory);
      } else {
        container.appendChild(section);
      }
    }
  });
}

function resetAllSettings() {
  if (confirm('‚ö†Ô∏è Reset ALL settings to default?\n\nThis will:\n- Clear all custom sections\n- Reset section positions\n- Clear favorites\n- Clear workspace\n- Reset all preferences')) {
    // Clear all storage keys
    localStorage.removeItem('favorites_' + config.version);
    localStorage.removeItem('workspace_' + config.version);
    localStorage.removeItem('sectionOrder');
    localStorage.removeItem('sectionStates');
    localStorage.removeItem(CUSTOM_SECTIONS_KEY);
    localStorage.removeItem(config.historyKey);
    
    // Keep authentication but clear everything else
    localStorage.setItem(config.storageKey, "true");
    
    // Show confirmation
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--accent-color);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1001;
      animation: slideIn 0.3s ease;
      font-weight: bold;
    `;
    notification.innerHTML = `
      <i class="fas fa-check-circle"></i> 
      All settings have been reset!
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
    
    // Refresh to show default state
    setTimeout(() => location.reload(), 1000);
  }
}

function resetSectionPositions() {
  if (confirm('Reset all sections to their original order?\n\nThis will only affect section positions - your favorites and workspace items will be preserved.')) {
    // Clear only the section order storage
    localStorage.removeItem('sectionOrder');
    
    // Show confirmation
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--secondary-color);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1001;
      animation: slideIn 0.3s ease;
      font-weight: bold;
    `;
    notification.innerHTML = `
      <i class="fas fa-check-circle"></i> 
      Section positions have been reset!
    `;
    
    document.body.appendChild(notification);
    
    // Remove notification after 3 seconds
    setTimeout(() => {
      notification.style.animation = 'fadeOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
    
    // Refresh the page to apply changes
    setTimeout(() => location.reload(), 1000);
  }
}

// Storage key for custom sections
const CUSTOM_SECTIONS_KEY = 'custom_sections_' + config.version;

// Function to add a new section
function addNewSection() {
  const sectionName = prompt("Enter section name:");
  if (!sectionName) return;
  
  const customSections = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
  
  if (portalContent[sectionName] || customSections[sectionName]) {
    alert("Section name already exists!");
    return;
  }
  
  // Add new section to custom sections
  customSections[sectionName] = [];
  localStorage.setItem(CUSTOM_SECTIONS_KEY, JSON.stringify(customSections));
  
  // Refresh the portal to show new section
  generatePortalContent();
  
  // Move the new section to the top
  setTimeout(() => {
    const sections = Array.from(document.querySelectorAll('.section'));
    const newSection = sections.find(section => {
      const header = section.querySelector('.section-header');
      return header && header.textContent.includes(sectionName);
    });
    
    if (newSection) {
      const container = document.querySelector('.container');
      const firstSection = container.querySelector('.section');
      const loginHistory = container.querySelector('.login-history');
      
      if (firstSection && newSection !== firstSection) {
        if (loginHistory) {
          container.insertBefore(newSection, firstSection);
        } else {
          container.insertBefore(newSection, firstSection);
        }
        saveSectionOrder();
      }
    }
  }, 100);
}

// Function to add button to custom section
function addButtonToCustomSection(sectionName) {
  const buttonName = prompt("Enter button name:");
  if (!buttonName) return;
  
  const buttonUrl = prompt("Enter URL:");
  if (!buttonUrl) return;
  
  const icon = prompt("Enter icon class (e.g., fa-book):", "fa-link");
  
  const customSections = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
  if (!customSections[sectionName]) customSections[sectionName] = [];
  
  customSections[sectionName].push({
    name: buttonName,
    url: buttonUrl,
    icon: icon
  });
  
  localStorage.setItem(CUSTOM_SECTIONS_KEY, JSON.stringify(customSections));
  generatePortalContent();
}

function deleteCustomSection(sectionTitle) {
  if (confirm(`Delete the entire "${sectionTitle}" section and all its buttons?`)) {
    const customSections = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
    delete customSections[sectionTitle];
    localStorage.setItem(CUSTOM_SECTIONS_KEY, JSON.stringify(customSections));
    generatePortalContent();
    
    // Show confirmation
    showNotification(`Section "${sectionTitle}" deleted!`, 'fa-trash', 'var(--accent-color)');
  }
}

function showNotification(message, icon, color) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${color};
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1001;
    animation: slideIn 0.3s ease;
    font-weight: bold;
  `;
  notification.innerHTML = `
    <i class="fas ${icon}"></i> ${message}
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Export function
function exportCustomSections() {
  const customSections = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
  if (Object.keys(customSections).length === 0) {
    alert("No custom sections to export!");
    return;
  }

  // Prompt for custom filename
  const defaultName = `research_portal_${new Date().toISOString().split('T')[0]}`;
  const fileName = prompt("Enter a name for your export file:", defaultName);
  
  if (!fileName) return; // User cancelled

  // Ensure .elife extension
  const finalFileName = fileName.endsWith('.elife') ? fileName : `${fileName}.elife`;
  
  const dataStr = JSON.stringify(customSections, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', finalFileName);
  linkElement.click();
}

// Import function
function importCustomSections() {
  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = '.elife,.json'; // Accept both extensions but prefer .elife
  
  fileInput.onchange = e => {
    const file = e.target.files[0];
    
    // Verify file extension
    if (!file.name.endsWith('.elife') && !file.name.endsWith('.json')) {
      alert("Please select a .elife or .json file");
      return;
    }
    
    const reader = new FileReader();
    
    reader.onload = event => {
      try {
        const importedData = JSON.parse(event.target.result);
        const currentData = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
        
        // Show import confirmation with file info
        if (confirm(`Import ${file.name} with ${Object.keys(importedData).length} section(s)?`)) {
          const mergedData = {...currentData, ...importedData};
          localStorage.setItem(CUSTOM_SECTIONS_KEY, JSON.stringify(mergedData));
          
          showNotification(
            `Imported ${file.name} successfully!`, 
            'fa-file-import', 
            'var(--secondary-color)'
          );
          generatePortalContent();
        }
      } catch (error) {
        alert("Error importing file: " + error.message);
      }
    };
    
    reader.readAsText(file);
  };
  
  fileInput.click();
}

// Load custom sections when generating portal
function loadCustomSections() {
  const customSections = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
  return customSections;
}

function deleteButtonFromCustomSection(sectionTitle, item) {
  if (confirm(`Delete "${item.name}" from "${sectionTitle}"?`)) {
    const customSections = JSON.parse(localStorage.getItem(CUSTOM_SECTIONS_KEY)) || {};
    
    if (customSections[sectionTitle]) {
      // Find and remove the button
      customSections[sectionTitle] = customSections[sectionTitle].filter(
        btn => btn.name !== item.name || btn.url !== item.url
      );
      
      localStorage.setItem(CUSTOM_SECTIONS_KEY, JSON.stringify(customSections));
      
      // Show confirmation
      showNotification(`"${item.name}" deleted!`, 'fa-trash', 'var(--accent-color)');
      
      // Refresh the section
      const sections = document.querySelectorAll('.section');
      sections.forEach((section, index) => {
        const title = Object.keys({
          ...portalContent,
          ...customSections
        })[index];
        
        if (title === sectionTitle) {
          const container = section.querySelector('.button-container');
          if (container.classList.contains('open')) {
            toggleSection(section.id); // Close
            toggleSection(section.id); // Re-open to refresh
          }
        }
      });
    }
  }
}

    // Initialize
    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>
</body>
</html>