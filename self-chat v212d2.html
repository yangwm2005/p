<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .chat-container {
            width: 100%;
            max-width: 675px;
            min-width: 450px;
            background: white;
            padding: 10px;
            box-shadow: 0px 0px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow-x: auto;
        }
        .editable-title {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #f1f1f1;
            cursor: text;
            margin-bottom: 10px;
        }
        .chat-box {
            height: calc(100vh - 230px);
            max-height: 600px;
            min-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            background: #fafafa;
            display: flex;
            flex-direction: column;
            scroll-behavior: smooth;
            flex-grow: 0;
        }
        .chat-box div {
            margin: 3px 0;
            padding: 6px 10px;
            border-radius: 5px;
            max-width: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: text;
            text-align: left;
            background: #e6e6e6;
            color: black;
            cursor: pointer;
            transition: background 0.2s, opacity 0.2s;
        }
        .user-msg {
            align-self: flex-start;
            cursor: move;
        }
        .user-msg:hover {
            background: #d9d9d9;
        }
        .user-msg.selected {
            background: #cce5ff;
            border: 1px solid #007bff;
        }
        .timestamp {
            font-size: 10px;
            color: #555;
            margin-left: 8px;
        }
        .delete-btn {
            background: none;
            border: none;
            color: red;
            font-size: 9px;
            cursor: pointer;
            margin-left: 1px;
        }
        .delete-btn:hover {
            color: darkred;
        }
        .input-area, .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .controls {
            flex-wrap: nowrap;
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 5px;
        }
        textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: none;
            overflow-y: hidden;
            min-height: 50px;
            max-height: 120px;
            font-size: 14px;
        }
        button, select {
            padding: 5px;
            border: none;
            background: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            min-width: 50px;
            flex-shrink: 0;
        }
        button:hover, select:hover {
            background: #0056b3;
        }
        button[onclick="shareChat()"] {
            background: #00aced;
        }
        button[onclick="copySelectedMessages()"] {
            background: #ff9800; /* Orange for Copy */
        }
        button[onclick="pasteMessages()"] {
            background: #4caf50; /* Green for Paste */
        }
        .chat-box div::selection {
            background: transparent;
            color: black;
        }
        .action-btn {
            background: none;
            border: none;
            color: #007bff;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .action-btn:hover {
            background: #f1f1f1;
        }
        .action-menu {
            display: none;
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0px 0px 6px rgba(0, 0, 0, 0.1);
            z-index: 1;
            right: 0;
            top: 100%;
            min-width: 80px;
        }
        .action-menu button {
            display: block;
            width: 100%;
            padding: 5px 10px;
            text-align: left;
            background: none;
            border: none;
            color: #333;
            cursor: pointer;
            font-size: 12px;
        }
        .action-menu button:hover {
            background: #f1f1f1;
        }
        .highlighted {
            background-color: yellow !important;
        }
        .selected {
            background: #cce5ff !important; /* Light blue for selected messages */
            border: 1px solid #007bff;
        }
.subtitle-dropdown {
    display: none;
    position: fixed;
    background: white;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0px 0px 6px rgba(0, 0, 0, 0.1);
    z-index: 10;
    width: 200px;
    padding: 10px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}
        .subtitle-dropdown input {
            width: 100%;
            padding: 5px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .subtitle-option {
            margin: 5px 0;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }
        .subtitle-option:hover {
            background: #f1f1f1;
        }
        .subtitle-preset-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 3px;
            font-size: 12px;
        }
        .chat-box div.dragging {
            opacity: 0.5;
            background: #d3d3d3;
        }
        .chat-box div.drag-over {
            border: 2px dashed #007bff;
        }
        .subchat {
            margin-left: 30px !important;
            border-left: 2px solid #007bff;
            padding-left: 6px !important;
        }
        .checkbox-wrapper {
            display: inline-flex;
            align-items: center;
            margin-right: 5px;
        }
        .checkbox-wrapper input[type="checkbox"] {
            margin: 0 5px 0 0;
            cursor: pointer;
        }
        .toggle-subchat {
            background: none;
            border: none;
            color: #007bff;
            font-size: 14px;
            cursor: pointer;
            margin-right: 1px;
            padding: 0;
            width: 12px;
            min-width: 12px;
            text-align: center;
            vertical-align: middle;
            line-height: 1;
        }
        .toggle-subchat:hover {
            color: #0056b3;
        }
        .subchat-hidden {
            display: none !important;
        }
        .chat-container.drag-over {
            background: #e0e0e0;
        }
    </style>
</head>
<body>

<div class="chat-container">
    <div id="chatTitle" class="editable-title" contenteditable="true">Title</div>
    <input type="text" id="searchInput" placeholder="üîç Search messages..." oninput="filterMessages()">
    <div class="chat-box" id="chatBox"></div>
    <div class="input-area">
        <textarea id="textInput" placeholder="Type a message..." oninput="autoExpand(this)"></textarea>
        <button onclick="sendMessage()" style="color:white;background-color:green;">Send</button>
    </div>
    <div class="controls">
        <button onclick="copySelectedMessages()" title="Copy selected messages to clipboard">üìã Copy</button>
        <button onclick="pasteMessages()" title="Paste messages from clipboard or app">üì• Paste</button>
        <button id="subtitleBtn" onclick="toggleSubtitleDropdown()" style="color:white;background-color:gray;" title="Insert more subtitles for different sections">‚ûï Sub</button>
        <select id="viewVersion" onchange="handleViewChange()" style="width:85px;color:white;background-color:blue;">
            <option value="">üåê View</option>
            <option value="v1">V1(bullet)</option>
            <option value="v2">V2</option>
            <option value="v3">V3(Single ‚Ä¢)</option>
            <option value="v4">V4(Checkboxes)</option>
        </select>
        <button onclick="saveChatAsFile()" style="color:white;background-color:purple;" title="Save as a txt file on Disk">üíæ Save</button>
        <button onclick="openChatFile()" style="color:white;background-color:orange;" title="Open a saved txt file from Disk">üìÇ Open</button>
        <button onclick="exportToGmail()" style="color:white;background-color:green;" title="Send the contexts to your gmail account">‚úâÔ∏è Gmail</button>
        <button onclick="shareChat()" style="color:white;background-color:#00aced;" title="Share chat to other apps">üì§ Share</button>
    </div>
    <div>
        <footer>
            Copyright ¬© 2025 Dr. Wen-Ming Yang 20250310 v2.12d2 <br>
            20250310: v2.12d1-2: fix the subtile popup widow postion and title re-stored from saved files. <br>
            20250310: v2.12d: Restored internal drag-and-drop of chat messages.<br>
            20250310: v2.12c: Enabled dragging multiple messages to cursor drop position.<br>
            20250310: v2.12b: Enabled dragging multiple selected messages from .txt files.<br>
            20250310: v2.12a: Fixed drag-and-drop of selected text from .txt files.<br>
            20250309: v2.12: Combined source and chat panels into one with drag-and-drop.<br>
            20250309: v2.11: Added drag-and-drop for .txt files into source panel.<br>
            20250309: v2.10: Added source panel for dragging messages between windows.<br>
            20250306: v209T3: Make Voice button hidden for a better usage.<br>
            20250305: v209T2: Add copy/paste function for cross windows.<br>
            (from 204) Resize with window 1.5/double-clicking for subchat + Toggle
        </footer>
    </div>
</div>

<div id="subtitleDropdown" class="subtitle-dropdown">
    <div>Custom Subtitles:</div>
    <input type="text" id="customSubtitle" placeholder="Enter custom subtitle text">
    <button onclick="insertCustomSubtitle()" style="width:100%;margin-bottom:10px;">Insert Custom</button>   
    <button onclick="addNewPreset()" style="width:100%;margin-top:10px;">Add to Presets</button>
    <div class="subtitle-preset-list">
        <div class="subtitle-option" onclick="insertSubtitlePreset('‚ñº‚ñº‚ñº TopicChange ‚ñº‚ñº‚ñº')">‚ñº‚ñº‚ñº Topic Change ‚ñº‚ñº‚ñº</div>
        <div class="subtitle-option" onclick="insertSubtitlePreset('### Chapter ###')">### Chapter ###</div>
        <div class="subtitle-option" onclick="insertSubtitlePreset('<<< NextPart >>>')"><<< Next Part >>></div>
        <div class="subtitle-option" onclick="insertSubtitlePreset('<<< Home hours >>>')"><<< Home hours >>></div>
        <div class="subtitle-option" onclick="insertSubtitlePreset('--- NewSection ---')">--- New Section ---</div>
        <div class="subtitle-option" onclick="insertSubtitlePreset('===== Subtitle =====')">===== Subtitle =====</div>
        <div class="subtitle-option" onclick="insertSubtitlePreset('!!! Review & Relcoate !!!')">!!! Review & Relcoate !!!</div>
        <div class="subtitle-option" onclick="insertSubtitlePreset('!!! What Next? !!!')">!!! What Next? !!!</div>
        <div class="subtitle-option" onclick="insertSubtitlePreset('*** important')">*** Important</div>
        <div class="subtitle-option" onclick="insertSubtitlePreset('!!! Warning')">!!! Warning</div>
    </div>
</div>

<script>
    let selectedMessages = new Set(); // For chat box selections
    let messageClipboard = []; // To store copied messages within the app
    let draggedElement = null;

    function scrollToBottom(element) {
        element.offsetHeight;
        element.scrollTop = element.scrollHeight;
    }

    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("textInput").addEventListener("keydown", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        
        document.addEventListener("click", function(event) {
            const dropdown = document.getElementById("subtitleDropdown");
            const subtitleBtn = document.getElementById("subtitleBtn");
            if (!dropdown.contains(event.target) && event.target !== subtitleBtn) {
                dropdown.style.display = "none";
            }
            if (!event.target.closest(".user-msg") && !(event.ctrlKey || event.metaKey)) {
                selectedMessages.forEach(msg => msg.classList.remove("selected"));
                selectedMessages.clear();
            }
        });

        const chatBox = document.getElementById("chatBox");
        chatBox.addEventListener("dragstart", handleDragStart);
        chatBox.addEventListener("dragover", handleDragOver);
        chatBox.addEventListener("drop", handleDrop);
        chatBox.addEventListener("dragend", handleDragEnd);

        const chatContainer = document.querySelector(".chat-container");
        chatContainer.addEventListener("dragover", (event) => {
            event.preventDefault();
            event.stopPropagation();
            chatContainer.classList.add("drag-over");
        });
        chatContainer.addEventListener("dragleave", (event) => {
            event.preventDefault();
            event.stopPropagation();
            chatContainer.classList.remove("drag-over");
        });
        chatContainer.addEventListener("drop", (event) => {
            event.preventDefault();
            event.stopPropagation();
            chatContainer.classList.remove("drag-over");
            const files = event.dataTransfer.files;
            if (files && files.length > 0) {
                if (files[0].type === "text/plain" || files[0].name.endsWith(".txt")) {
                    loadDroppedFile(files[0]);
                } else {
                    alert("Please drop a valid .txt file.");
                }
            }
        });
    });

    window.addEventListener('resize', function() {
        const container = document.querySelector('.chat-container');
        const windowWidth = window.innerWidth;
        container.style.width = Math.min(Math.max(windowWidth - 40, 450), 675) + 'px';
    });

    window.dispatchEvent(new Event('resize'));

function loadDroppedFile(file) {
    const reader = new FileReader();
    reader.onload = function () {
        const lines = reader.result.split("\n").filter(line => line.trim() !== ""); // Remove empty lines but keep all content
        const chatBox = document.getElementById("chatBox");
        const chatTitleElement = document.getElementById("chatTitle");

        // Check if there‚Äôs at least one line for the title
        if (lines.length > 0) {
            // Assume the first non-empty line is the title
            const potentialTitle = lines[0].trim();
            // Verify it‚Äôs not a message (doesn‚Äôt match the message format)
            if (!potentialTitle.match(/(  ‚Ä¢|‚Ä¢) (\[H\]\s)?(.*?) \((\d+:\d+ [APM]{2})\)/)) {
                chatTitleElement.textContent = potentialTitle; // Set the title
                lines.shift(); // Remove the title line from the array
            } else {
                chatTitleElement.textContent = "Untitled Chat"; // Default title if no valid title found
            }
        } else {
            chatTitleElement.textContent = "Untitled Chat"; // Default title if file is empty
        }

        // Process the remaining lines as messages
        lines.forEach(line => {
            const match = line.match(/(  ‚Ä¢|‚Ä¢) (\[H\]\s)?(.*?) \((\d+:\d+ [APM]{2})\)/);
            if (match) {
                const isSubchat = match[1] === "  ‚Ä¢";
                const isHighlighted = !!match[2];
                let text = match[3];
                const timestamp = match[4];

                text = text.replace(/\[X\]/g, '<span class="checkbox-wrapper"><input type="checkbox" checked></span>')
                           .replace(/\[ \]/g, '<span class="checkbox-wrapper"><input type="checkbox"></span>');

                const newMessage = sendMessage(text, timestamp, true);
                if (isSubchat) newMessage.classList.add("subchat");
                if (isHighlighted) newMessage.classList.add("highlighted");
            }
        });

        requestAnimationFrame(() => {
            scrollToBottom(chatBox);
            updateSubchatToggles();
        });
    };
    reader.readAsText(file);
}

    function autoExpand(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    function sendMessage(message = null, timestamp = null, isFromFile = false) {
        let inputField = document.getElementById("textInput");
        let chatBox = document.getElementById("chatBox");

        let text = message || inputField.value.trim();
        if (text === "") return;

        let time = timestamp || getCurrentTime();
        let userMessage = document.createElement("div");
        userMessage.classList.add("user-msg");
        userMessage.contentEditable = true;
        userMessage.draggable = true;

        let messageText = text.replace(/\[\]/g, '<span class="checkbox-wrapper"><input type="checkbox"> </span>');
        userMessage.innerHTML = `<span class="message-text">${messageText}</span> <span class="timestamp">${time}</span>`;

        let isSubchat = false;
        if (!isFromFile) {
            let lastMessage = chatBox.lastElementChild;
            if (lastMessage && lastMessage.classList.contains("subchat")) {
                userMessage.classList.add("subchat");
                isSubchat = true;
            }
        }

        let actionBtn = document.createElement("button");
        actionBtn.innerHTML = "‚öôÔ∏è";
        actionBtn.classList.add("action-btn");

        let actionMenu = document.createElement("div");
        actionMenu.classList.add("action-menu");
        actionMenu.style.display = "none";

        let highlightOption = document.createElement("button");
        highlightOption.innerHTML = "Highlight";
        highlightOption.onclick = function () {
            userMessage.classList.toggle("highlighted");
        };
        
        let deleteOption = document.createElement("button");
        deleteOption.innerHTML = "Delete";
        deleteOption.onclick = function () {
            chatBox.removeChild(userMessage);
            updateSubchatToggles();
        };

        let subchatOption = document.createElement("button");
        subchatOption.innerHTML = "Shift to Subchat";
        subchatOption.onclick = function () {
            shiftToSubchat(userMessage);
            updateSubchatToggles();
        };

        actionMenu.appendChild(highlightOption);
        actionMenu.appendChild(deleteOption);
        actionMenu.appendChild(subchatOption);
        actionBtn.appendChild(actionMenu);

        actionBtn.onclick = function (event) {
            event.stopPropagation();
            actionMenu.style.display = actionMenu.style.display === "block" ? "none" : "block";
        };

        document.addEventListener("click", function (event) {
            if (!actionBtn.contains(event.target)) {
                actionMenu.style.display = "none";
            }
        });

        userMessage.appendChild(actionBtn);

        if (!isSubchat) {
            let toggleBtn = document.createElement("button");
            toggleBtn.innerHTML = "+";
            toggleBtn.classList.add("toggle-subchat");
            toggleBtn.style.visibility = "hidden";
            toggleBtn.onclick = (event) => {
                event.stopPropagation();
                toggleSubchats(userMessage);
            };
            userMessage.insertBefore(toggleBtn, userMessage.firstChild);
        }

        chatBox.appendChild(userMessage);

        if (isSubchat && !isFromFile) {
            const allMessages = Array.from(chatBox.children);
            const prevMessage = allMessages[allMessages.length - 2];
            if (prevMessage && prevMessage.querySelector(".toggle-subchat")?.innerHTML === "+") {
                userMessage.classList.add("subchat-hidden");
            }
        }

        userMessage.addEventListener("click", function (event) {
            if (event.ctrlKey || event.metaKey) {
                event.preventDefault();
                toggleMessageSelection(userMessage);
            }
        });

        userMessage.addEventListener("dblclick", function (event) {
            if (event.target === actionBtn || actionMenu.contains(event.target)) return;
            shiftToSubchat(userMessage);
            updateSubchatToggles();
            event.preventDefault();
        });

        if (!isFromFile) {
            inputField.value = "";
            autoExpand(inputField);
        }

        if (!isFromFile) {
            requestAnimationFrame(() => {
                scrollToBottom(chatBox);
                updateSubchatToggles();
            });
        }

        return userMessage;
    }

    function getCurrentTime() {
        let now = new Date();
        let hours = now.getHours();
        let minutes = now.getMinutes();
        let ampm = hours >= 12 ? "PM" : "AM";
        hours = hours % 12 || 12;
        minutes = minutes.toString().padStart(2, "0");
        return `${hours}:${minutes} ${ampm}`;
    }

    function shiftToSubchat(messageElement) {
        const chatBox = document.getElementById("chatBox");
        const allMessages = Array.from(chatBox.children);
        const messageIndex = allMessages.indexOf(messageElement);

        if (messageElement.classList.contains("subchat")) {
            messageElement.classList.remove("subchat");
            messageElement.classList.remove("subchat-hidden");

            const existingToggle = messageElement.querySelector(".toggle-subchat");
            if (existingToggle) {
                messageElement.removeChild(existingToggle);
            }

            let hasSubchats = false;
            let subchatGroup = [];
            for (let i = messageIndex + 1; i < allMessages.length; i++) {
                if (allMessages[i].classList.contains("subchat")) {
                    hasSubchats = true;
                    subchatGroup.push(allMessages[i]);
                } else {
                    break;
                }
            }

            if (hasSubchats) {
                let toggleBtn = document.createElement("button");
                toggleBtn.innerHTML = "‚àí";
                toggleBtn.classList.add("toggle-subchat");
                toggleBtn.style.visibility = "visible";
                toggleBtn.onclick = (event) => {
                    event.stopPropagation();
                    toggleSubchats(messageElement);
                };
                messageElement.insertBefore(toggleBtn, messageElement.firstChild);
                subchatGroup.forEach(subchat => subchat.classList.remove("subchat-hidden"));
            }
        } else {
            messageElement.classList.add("subchat");
            messageElement.classList.remove("subchat-hidden");
            const existingToggle = messageElement.querySelector(".toggle-subchat");
            if (existingToggle) {
                messageElement.removeChild(existingToggle);
            }
        }
    }

    function toggleSubchats(message) {
        const chatBox = document.getElementById("chatBox");
        const allMessages = Array.from(chatBox.children);
        const messageIndex = allMessages.indexOf(message);
        const toggleBtn = message.querySelector(".toggle-subchat");

        if (!toggleBtn) return;

        let subchatGroup = [];
        for (let i = messageIndex + 1; i < allMessages.length; i++) {
            if (allMessages[i].classList.contains("subchat")) {
                subchatGroup.push(allMessages[i]);
            } else {
                break;
            }
        }

        if (subchatGroup.length > 0) {
            const isCollapsed = toggleBtn.innerHTML === "+";
            toggleBtn.innerHTML = isCollapsed ? "‚àí" : "+";
            subchatGroup.forEach(subchat => {
                if (isCollapsed) {
                    subchat.classList.remove("subchat-hidden");
                } else {
                    subchat.classList.add("subchat-hidden");
                }
            });
            toggleBtn.style.visibility = "visible";
        }
    }

    function updateSubchatToggles() {
        const chatBox = document.getElementById("chatBox");
        const allMessages = Array.from(chatBox.children);

        allMessages.forEach((message, index) => {
            const toggleBtn = message.querySelector(".toggle-subchat");
            let hasSubchats = false;
            let subchatGroup = [];

            for (let i = index + 1; i < allMessages.length; i++) {
                if (allMessages[i].classList.contains("subchat")) {
                    hasSubchats = true;
                    subchatGroup.push(allMessages[i]);
                } else {
                    break;
                }
            }

            if (message.classList.contains("subchat")) {
                if (toggleBtn) {
                    message.removeChild(toggleBtn);
                }
            } else {
                if (toggleBtn) {
                    if (hasSubchats) {
                        toggleBtn.style.visibility = "visible";
                        const isCollapsed = toggleBtn.innerHTML === "+";
                        subchatGroup.forEach(subchat => {
                            subchat.classList.toggle("subchat-hidden", isCollapsed);
                        });
                    } else {
                        toggleBtn.style.visibility = "hidden";
                        toggleBtn.innerHTML = "+";
                    }
                } else if (hasSubchats) {
                    let newToggleBtn = document.createElement("button");
                    newToggleBtn.innerHTML = "‚àí";
                    newToggleBtn.classList.add("toggle-subchat");
                    newToggleBtn.style.visibility = "visible";
                    newToggleBtn.onclick = (event) => {
                        event.stopPropagation();
                        toggleSubchats(message);
                    };
                    message.insertBefore(newToggleBtn, message.firstChild);
                    subchatGroup.forEach(subchat => subchat.classList.remove("subchat-hidden"));
                }
            }
        });
    }

    function toggleMessageSelection(messageElement) {
        if (selectedMessages.has(messageElement)) {
            selectedMessages.delete(messageElement);
            messageElement.classList.remove("selected");
        } else {
            selectedMessages.add(messageElement);
            messageElement.classList.add("selected");
        }
    }

    function copySelectedMessages() {
        if (selectedMessages.size === 0) {
            alert("No messages selected to copy.");
            return;
        }

        const selectionCount = selectedMessages.size;
        messageClipboard = Array.from(selectedMessages).map(msg => ({
            text: msg.querySelector(".message-text").innerHTML,
            timestamp: msg.querySelector(".timestamp").textContent,
            isSubchat: msg.classList.contains("subchat"),
            isHighlighted: msg.classList.contains("highlighted")
        }));

        const clipboardText = Array.from(selectedMessages).map(msg => {
            let textSpan = msg.querySelector(".message-text");
            let timestamp = msg.querySelector(".timestamp");
            let prefix = msg.classList.contains("subchat") ? "  ‚Ä¢" : "‚Ä¢";
            let highlightMarker = msg.classList.contains("highlighted") ? "[H] " : "";
            let clonedSpan = textSpan.cloneNode(true);
            let checkboxes = clonedSpan.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                let replacement = cb.checked ? '[X]' : '[ ]';
                let span = cb.parentElement;
                span.outerHTML = replacement;
            });
            return `${prefix} ${highlightMarker}${clonedSpan.textContent} (${timestamp.textContent})`;
        }).join("\n");

        navigator.clipboard.writeText(clipboardText)
            .then(() => {
                selectedMessages.forEach(msg => msg.classList.remove("selected"));
                selectedMessages.clear();
                alert(`${selectionCount} message(s) copied to clipboard. You can paste them in another window or app.`);
            })
            .catch(err => {
                console.error('Failed to copy to clipboard: ', err);
                alert('Copy failed. Please try again.');
            });
    }

    function pasteMessages() {
        const chatBox = document.getElementById("chatBox");
        let targetMessage = null;

        if (selectedMessages.size === 1) {
            targetMessage = Array.from(selectedMessages)[0];
            selectedMessages.clear();
            targetMessage.classList.remove("selected");
        }

        if (messageClipboard.length > 0) {
            messageClipboard.forEach(msgData => {
                const newMessage = sendMessage(msgData.text, msgData.timestamp, true);
                if (msgData.isSubchat) newMessage.classList.add("subchat");
                if (msgData.isHighlighted) newMessage.classList.add("highlighted");

                if (targetMessage) {
                    targetMessage.after(newMessage);
                    targetMessage = newMessage;
                } else {
                    chatBox.appendChild(newMessage);
                }
            });

            requestAnimationFrame(() => {
                scrollToBottom(chatBox);
                updateSubchatToggles();
            });

            alert(`${messageClipboard.length} message(s) pasted from app clipboard.`);
            return;
        }

        navigator.clipboard.readText()
            .then(text => {
                if (!text.trim()) {
                    alert("Clipboard is empty or contains no valid text.");
                    return;
                }

                const lines = text.split("\n");
                let pastedCount = 0;

                lines.forEach(line => {
                    const match = line.match(/(  ‚Ä¢|‚Ä¢) (\[H\]\s)?(.*?) \((\d+:\d+ [APM]{2})\)/);
                    if (match) {
                        const isSubchat = match[1] === "  ‚Ä¢";
                        const isHighlighted = !!match[2];
                        let messageText = match[3];
                        const timestamp = match[4];

                        const newMessage = sendMessage(messageText, timestamp, true);
                        if (isSubchat) newMessage.classList.add("subchat");
                        if (isHighlighted) newMessage.classList.add("highlighted");

                        if (targetMessage) {
                            targetMessage.after(newMessage);
                            targetMessage = newMessage;
                        } else {
                            chatBox.appendChild(newMessage);
                        }
                        pastedCount++;
                    }
                });

                if (pastedCount > 0) {
                    requestAnimationFrame(() => {
                        scrollToBottom(chatBox);
                        updateSubchatToggles();
                    });
                    alert(`${pastedCount} message(s) pasted from system clipboard.`);
                } else {
                    alert("No valid chat messages found in clipboard.");
                }
            })
            .catch(err => {
                console.error('Failed to read clipboard: ', err);
                alert('Paste failed. Please ensure clipboard contains valid chat messages.');
            });
    }

    function saveChatAsFile() {
        let chatTitle = document.getElementById("chatTitle").textContent.trim();
        let messages = Array.from(document.getElementById("chatBox").children).map(div => {
            let textSpan = div.querySelector(".message-text");
            let timestamp = div.querySelector(".timestamp");
            let prefix = div.classList.contains("subchat") ? "  ‚Ä¢" : "‚Ä¢";
            let highlightMarker = div.classList.contains("highlighted") ? "[H] " : "";

            if (!textSpan) return "";

            let clonedSpan = textSpan.cloneNode(true);
            let checkboxes = clonedSpan.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                let replacement = cb.checked ? '[X]' : '[ ]';
                let span = cb.parentElement;
                span.outerHTML = replacement;
            });
            let messageText = clonedSpan.textContent;

            return `${prefix} ${highlightMarker}${messageText} (${timestamp.textContent})`;
        });

        if (messages.length === 0) {
            alert("No chat history to save.");
            return;
        }

        let chatText = chatTitle + "\n\n" + messages.join("\n");
        let blob = new Blob([chatText], { type: "text/plain" });
        let fileName = prompt("Enter file name:", chatTitle || "chat_history");
        if (!fileName) return;

        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = fileName + ".txt";
        link.click();
    }

    function openChatFile() {
        let input = document.createElement("input");
        input.type = "file";
        input.accept = ".txt";
        input.onchange = function (event) {
            let file = event.target.files[0];
            if (!file) return;

            loadDroppedFile(file);
        };
        input.click();
    }

    function exportToGmail() {
        let chatTitle = document.getElementById("chatTitle").textContent.trim();
        let messages = Array.from(document.getElementById("chatBox").children).map(div => {
            let textSpan = div.querySelector(".message-text");
            let timestamp = div.querySelector(".timestamp");
            let prefix = div.classList.contains("subchat") ? "  ‚Ä¢" : "‚Ä¢";
            let highlightMarker = div.classList.contains("highlighted") ? "[H] " : "";

            if (!textSpan) return "";

            let clonedSpan = textSpan.cloneNode(true);
            let checkboxes = clonedSpan.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                let replacement = cb.checked ? '[X]' : '[ ]';
                let span = cb.parentElement;
                span.outerHTML = replacement;
            });
            let messageText = clonedSpan.textContent;

            return `${prefix} ${highlightMarker}${messageText} (${timestamp.textContent})`;
        });

        if (messages.length === 0) {
            alert("No chat history to export.");
            return;
        }

        let chatText = chatTitle + "\n\n" + messages.join("\n");
        let subject = encodeURIComponent(`Chat Export: ${chatTitle}`);
        let body = encodeURIComponent(chatText);
        let to = encodeURIComponent('yangwm@email.nchu.edu.tw');
        let gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${to}&su=${subject}&body=${body}`;
        window.open(gmailUrl, "Gmail", "width=600,height=600");
    }

    function filterMessages() {
        let query = document.getElementById("searchInput").value.toLowerCase();
        document.querySelectorAll(".chat-box div").forEach(msg => {
            msg.style.display = msg.textContent.toLowerCase().includes(query) ? "block" : "none";
        });
    }

    function openChatInNewWindow() {
        let chatTitle = document.getElementById("chatTitle").textContent.trim();
        let messages = Array.from(document.getElementById("chatBox").children).map(div => {
            let textSpan = div.querySelector(".message-text");
            let timestamp = div.querySelector(".timestamp");
            let isSubchat = div.classList.contains("subchat");
            let isHighlighted = div.classList.contains("highlighted");
            let classAttr = isHighlighted ? ' class="highlighted' + (isSubchat ? ' subchat' : '') + '"' : (isSubchat ? ' class="subchat"' : '');

            if (!textSpan) return "";

            let messageContent = textSpan.innerHTML;
            return `<p${classAttr}>‚Ä¢ ${messageContent} <small>(${timestamp.textContent})</small></p>`;
        }).join("");

        if (messages === "") {
            alert("No chat history to display.");
            return;
        }

        let newWindow = window.open("", "_blank");
        newWindow.document.write(`
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${chatTitle}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
                    h2 { text-align: center; color: #333; }
                    .chat-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0px 0px 6px rgba(0, 0, 0, 0.1); }
                    p { font-size: 14px; color: #333; background: #e6e6e6; padding: 8px; border-radius: 5px; margin: 5px 0; }
                    p.highlighted { background: yellow; }
                    p.subchat { margin-left: 10px; border-left: 2px solid #007bff; padding-left: 6px; }
                    small { color: #555; font-size: 12px; }
                    .checkbox-wrapper { display: inline-flex; align-items: center; margin-right: 5px; }
                    .checkbox-wrapper input[type="checkbox"] { margin: 0 5px 0 0; cursor: pointer; }
                </style>
            </head>
            <body>
                <h2>${chatTitle}</h2>
                <div class="chat-box">${messages}</div>
            </body>
            </html>
        `);
    }

    function openChatInNewWindow2() {
        let chatTitle = document.getElementById("chatTitle").textContent.trim();
        let messages = Array.from(document.getElementById("chatBox").children).map(div => {
            let textSpan = div.querySelector(".message-text");
            let timestamp = div.querySelector(".timestamp");
            let isSubchat = div.classList.contains("subchat");
            let isHighlighted = div.classList.contains("highlighted");
            let classAttr = isHighlighted ? ' class="highlighted' + (isSubchat ? ' subchat' : '') + '"' : (isSubchat ? ' class="subchat"' : '');

            if (!textSpan) return "";

            let messageContent = textSpan.innerHTML;
            return `<p${classAttr}>${messageContent} <small>(${timestamp.textContent})</small></p>`;
        }).join("");

        if (messages === "") {
            alert("No chat history to display.");
            return;
        }

        let newWindow = window.open("", "_blank");
        newWindow.document.write(`
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${chatTitle}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
                    h2 { text-align: center; color: #333; }
                    .chat-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0px 0px 6px rgba(0, 0, 0, 0.1); }
                    p { font-size: 14px; color: #333; background: #e6e6e6; padding: 8px; border-radius: 5px; margin: 5px 0; }
                    p.highlighted { background: yellow; }
                    p.subchat { margin-left: 10px; border-left: 2px solid #007bff; padding-left: 6px; }
                    small { color: #555; font-size: 12px; }
                    .checkbox-wrapper { display: inline-flex; align-items: center; margin-right: 5px; }
                    .checkbox-wrapper input[type="checkbox"] { margin: 0 5px 0 0; cursor: pointer; }
                </style>
            </head>
            <body>
                <h2>${chatTitle}</h2>
                <div class="chat-box">${messages}</div>
            </body>
            </html>
        `);
    }

    function openChatInNewWindow3() {
        let chatTitle = document.getElementById("chatTitle").textContent.trim();
        let messages = Array.from(document.getElementById("chatBox").children).map(div => {
            let textSpan = div.querySelector(".message-text");
            let timestamp = div.querySelector(".timestamp");
            let prefix = div.classList.contains("subchat") ? "  ‚Ä¢" : "‚Ä¢";
            let highlightMarker = div.classList.contains("highlighted") ? "[H] " : "";

            if (!textSpan) return "";

            let clonedSpan = textSpan.cloneNode(true);
            let checkboxes = clonedSpan.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                let replacement = cb.checked ? '[X]' : '[ ]';
                let span = cb.parentElement;
                span.outerHTML = replacement;
            });
            let messageText = clonedSpan.textContent;

            return `${prefix} ${highlightMarker}${messageText} (${timestamp.textContent})`;
        }).join("\n");

        if (messages === "") {
            alert("No chat history to display.");
            return;
        }

        let newWindow = window.open("", "_blank");
        newWindow.document.write(`
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${chatTitle}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
                    h2 { text-align: center; color: #333; }
                    .chat-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0px 0px 6px rgba(0, 0, 0, 0.1); white-space: pre-wrap; }
                </style>
            </head>
            <body>
                <h2>${chatTitle}</h2>
                <div class="chat-box">${messages}</div>
            </body>
            </html>
        `);
    }

    function openChatInNewWindow4() {
        let chatTitle = document.getElementById("chatTitle").textContent.trim();
        let messages = Array.from(document.getElementById("chatBox").children).map(div => {
            let textSpan = div.querySelector(".message-text");
            let timestamp = div.querySelector(".timestamp");
            let prefix = div.classList.contains("subchat") ? "  ‚Ä¢" : "‚Ä¢";
            let highlightMarker = div.classList.contains("highlighted") ? "[H] " : "";

            if (!textSpan) return "";

            let clonedSpan = textSpan.cloneNode(true);
            let messageText = clonedSpan.innerHTML;

            return `${prefix} ${highlightMarker}${messageText} (${timestamp.textContent})`;
        }).join("\n");

        if (messages === "") {
            alert("No chat history to display.");
            return;
        }

        let newWindow = window.open("", "_blank");
        newWindow.document.write(`
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>${chatTitle}</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
                    h2 { text-align: center; color: #333; }
                    .chat-box { background: white; padding: 15px; border-radius: 8px; box-shadow: 0px 0px 6px rgba(0, 0, 0, 0.1); white-space: pre-wrap; }
                    .checkbox-wrapper { display: inline-flex; align-items: center; margin-right: 5px; }
                    .checkbox-wrapper input[type="checkbox"] { margin: 0 5px 0 0; cursor: pointer; }
                </style>
            </head>
            <body>
                <h2>${chatTitle}</h2>
                <div class="chat-box">${messages}</div>
            </body>
            </html>
        `);
    }

    function handleViewChange() {
        const viewSelect = document.getElementById('viewVersion');
        const selectedValue = viewSelect.value;
        
        if (selectedValue === 'v1') {
            openChatInNewWindow();
        } else if (selectedValue === 'v2') {
            openChatInNewWindow2();
        } else if (selectedValue === 'v3') {
            openChatInNewWindow3();
        } else if (selectedValue === 'v4') {
            openChatInNewWindow4();
        }
        
        viewSelect.selectedIndex = 0;
    }

function toggleSubtitleDropdown() {
    const dropdown = document.getElementById("subtitleDropdown");
    
    if (dropdown.style.display === "block") {
        dropdown.style.display = "none";
    } else {
        dropdown.style.display = "block";
    }
}

    function insertCustomSubtitle() {
        const customText = document.getElementById("customSubtitle").value.trim();
        if (customText) {
            insertTextAtCursor(customText);
            document.getElementById("subtitleDropdown").style.display = "none";
        } else {
            alert("Please enter custom subtitle text.");
        }
    }

    function insertSubtitlePreset(text) {
        insertTextAtCursor(text);
        document.getElementById("subtitleDropdown").style.display = "none";
    }

    function addNewPreset() {
        const customText = document.getElementById("customSubtitle").value.trim();
        if (customText) {
            const presetList = document.querySelector(".subtitle-preset-list");
            const newOption = document.createElement("div");
            newOption.className = "subtitle-option";
            newOption.textContent = customText;
            newOption.onclick = function() {
                insertSubtitlePreset(customText);
            };
            presetList.appendChild(newOption);
            document.getElementById("customSubtitle").value = "";
        } else {
            alert("Please enter text to add as a preset.");
        }
    }

    function insertTextAtCursor(text) {
        let textarea = document.getElementById("textInput");
        let currentText = textarea.value;
        let cursorPosition = textarea.selectionStart;
        let textBeforeCursor = currentText.substring(0, cursorPosition);
        let textAfterCursor = currentText.substring(cursorPosition);

        textarea.value = textBeforeCursor + text + textAfterCursor;
        textarea.selectionStart = textarea.selectionEnd = cursorPosition + text.length;
        textarea.focus();
        autoExpand(textarea);
    }

    function handleDragStart(event) {
        const userMsg = event.target.closest(".user-msg");
        if (!userMsg) return;

        if (!selectedMessages.has(userMsg) && selectedMessages.size > 0) {
            selectedMessages.forEach(msg => msg.classList.remove("selected"));
            selectedMessages.clear();
            selectedMessages.add(userMsg);
            userMsg.classList.add("selected");
        }

        const dragText = Array.from(selectedMessages).map(msg => {
            let textSpan = msg.querySelector(".message-text");
            let timestamp = msg.querySelector(".timestamp");
            let prefix = msg.classList.contains("subchat") ? "  ‚Ä¢" : "‚Ä¢";
            let highlightMarker = msg.classList.contains("highlighted") ? "[H] " : "";
            let clonedSpan = textSpan.cloneNode(true);
            let checkboxes = clonedSpan.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                let replacement = cb.checked ? '[X]' : '[ ]';
                let span = cb.parentElement;
                span.outerHTML = replacement;
            });
            return `${prefix} ${highlightMarker}${clonedSpan.textContent} (${timestamp.textContent})`;
        }).join("\n");

        event.dataTransfer.setData("text/plain", dragText);
        event.dataTransfer.effectAllowed = "copyMove";

        draggedElement = userMsg;
        selectedMessages.forEach(msg => msg.classList.add("dragging"));
        setTimeout(() => {
            selectedMessages.forEach(msg => msg.classList.remove("dragging"));
        }, 0);
    }

    function handleDragOver(event) {
        event.preventDefault();
        event.dataTransfer.dropEffect = "copy"; // Allow copying from external sources
        const target = event.target.closest(".user-msg");
        if (target && target !== draggedElement) {
            target.classList.add("drag-over");
        }
    }

    function handleDrop(event) {
        event.preventDefault();
        const target = event.target.closest(".user-msg");
        const chatBox = document.getElementById("chatBox");

        // Case 1: Internal drag of selected messages within the chat box
        if (draggedElement) {
            const allMessages = Array.from(chatBox.children);
            const draggedIndex = allMessages.indexOf(draggedElement);

            if (target && target !== draggedElement) {
                const targetIndex = allMessages.indexOf(target);
                if (draggedIndex < targetIndex) {
                    target.after(draggedElement);
                } else {
                    target.before(draggedElement);
                }
            } else {
                chatBox.appendChild(draggedElement);
            }

            requestAnimationFrame(() => {
                updateSubchatToggles();
                draggedElement.scrollIntoView({ behavior: "smooth", block: "nearest" });
            });
        } 
        // Case 2: External drag-and-drop of selected text (e.g., multiple lines from a .txt file)
        else if (event.dataTransfer.types.includes("text/plain") && !event.dataTransfer.files.length) {
            const text = event.dataTransfer.getData("text/plain");
            const lines = text.split("\n").filter(line => line.trim() !== "");
            let addedCount = 0;
            let lastParentMessage = target;
            let lastInsertedMessage = target;

            lines.forEach(line => {
                const match = line.match(/^\s*(  ‚Ä¢|‚Ä¢)\s*(\[H\]\s)?(.+?)\s*\((\d+:\d+\s[APM]{2})\)$/);
                if (match) {
                    const isSubchat = match[1] === "  ‚Ä¢";
                    const isHighlighted = !!match[2];
                    let messageText = match[3].trim();
                    const timestamp = match[4];

                    messageText = messageText.replace(/\[X\]/g, '<span class="checkbox-wrapper"><input type="checkbox" checked></span>')
                                            .replace(/\[ \]/g, '<span class="checkbox-wrapper"><input type="checkbox"></span>');

                    const newMessage = sendMessage(messageText, timestamp, true);
                    if (isHighlighted) newMessage.classList.add("highlighted");

                    if (isSubchat && lastParentMessage) {
                        newMessage.classList.add("subchat");
                        lastParentMessage.after(newMessage);
                    } else {
                        if (lastInsertedMessage) {
                            lastInsertedMessage.after(newMessage);
                        } else {
                            chatBox.appendChild(newMessage);
                        }
                        lastParentMessage = newMessage;
                    }
                    lastInsertedMessage = newMessage;
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                requestAnimationFrame(() => {
                    updateSubchatToggles();
                    if (lastInsertedMessage) {
                        lastInsertedMessage.scrollIntoView({ behavior: "smooth", block: "nearest" });
                    } else {
                        scrollToBottom(chatBox);
                    }
                });
                alert(`${addedCount} message(s) added at drop position.`);
            } else {
                alert("No valid messages found in the dragged text. Ensure the format is '‚Ä¢ message (time)' or '  ‚Ä¢ subchat (time)' for each line.");
            }
        }

        cleanupDragStyles();
    }

    function handleDragEnd(event) {
        cleanupDragStyles();
        draggedElement = null;
    }

    function cleanupDragStyles() {
        document.querySelectorAll(".user-msg").forEach(msg => {
            msg.classList.remove("dragging", "drag-over");
        });
    }

    function shareChat() {
        let chatTitle = document.getElementById("chatTitle").textContent.trim();
        let messages = Array.from(document.getElementById("chatBox").children).map(div => {
            let textSpan = div.querySelector(".message-text");
            let timestamp = div.querySelector(".timestamp");
            let prefix = div.classList.contains("subchat") ? "  ‚Ä¢" : "‚Ä¢";
            let highlightMarker = div.classList.contains("highlighted") ? "[H] " : "";

            if (!textSpan) return "";

            let clonedSpan = textSpan.cloneNode(true);
            let checkboxes = clonedSpan.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                let replacement = cb.checked ? '[X]' : '[ ]';
                let span = cb.parentElement;
                span.outerHTML = replacement;
            });
            let messageText = clonedSpan.textContent;

            return `${prefix} ${highlightMarker}${messageText} (${timestamp.textContent})`;
        });

        if (messages.length === 0) {
            alert("No chat history to share.");
            return;
        }

        let chatText = chatTitle + "\n\n" + messages.join("\n");

        if (navigator.share) {
            navigator.share({
                title: chatTitle,
                text: chatText,
                url: window.location.href
            })
            .then(() => console.log('Successful share'))
            .catch((error) => console.log('Error sharing:', error));
        } else {
            let shareText = encodeURIComponent(chatText);
            let shareUrl = `mailto:?subject=${encodeURIComponent(chatTitle)}&body=${shareText}`;
            window.open(shareUrl, '_blank');
            
            navigator.clipboard.writeText(chatText)
                .then(() => {
                    alert('Chat copied to clipboard! You can paste it in any app.');
                })
                .catch(err => {
                    console.error('Could not copy text: ', err);
                    alert('Please manually copy the chat text and share it in your preferred app.');
                });
        }
    }
</script>

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'91df054acefcdd1a',t:'MTc0MTU2OTk1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>