<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart To-Do List</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --section-color: #7209b7;
            --border-color: #dee2e6;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.4;
            color: var(--dark-color);
            background-color: #f5f7fa;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            touch-action: manipulation;
        }
        
        .container {
            background-color: white;
            padding: 1rem;
            min-height: 100vh;
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 600;
            padding-top: 0.5rem;
        }
        
        .input-group {
            display: flex;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        #title {
            width: 100%;
            font-size: 1rem;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
            background-color: white;
            -webkit-appearance: none;
        }
        
        #new-item {
            flex: 1;
            min-width: 0;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s;
            font-size: 1rem;
            background-color: white;
            -webkit-appearance: none;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 1rem;
            white-space: nowrap;
            border-radius: 8px;
            min-width: 44px;
            min-height: 44px;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        button.secondary {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: 1px solid var(--border-color);
        }
        
        button.secondary:hover {
            background-color: #e9ecef;
        }
        
        button.danger {
            background-color: var(--danger-color);
        }
        
        button.danger:hover {
            background-color: #d1145a;
        }
        
        button.section-btn {
            background-color: var(--section-color);
        }
        
        button.section-btn:hover {
            background-color: #5a189a;
        }
        
        .controls {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        
        .controls button {
            flex: 1;
            min-width: calc(50% - 0.5rem);
        }
        
        #todo-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .todo-item {
            display: flex;
            align-items: center;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            touch-action: none;
        }
        
        .todo-item.section-break {
            background-color: rgba(114, 9, 183, 0.1);
            border-left: 4px solid var(--section-color);
            padding: 1rem 0.8rem;
            margin: 0.8rem 0;
        }
        
        .todo-item.section-break .item-text {
            font-weight: bold;
            color: var(--section-color);
        }
        
        .todo-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .todo-item.dragging {
            opacity: 0.6;
            background-color: var(--light-color);
        }
        
        .todo-item.completed {
            background-color: #f8f9fa;
        }
        
        .todo-item.completed .item-text {
            text-decoration: line-through;
            color: #6c757d;
        }
        
        .drag-handle {
            cursor: move;
            margin-right: 0.8rem;
            color: var(--border-color);
            font-size: 1.1rem;
            transition: color 0.2s;
            padding: 0.2rem;
            flex-shrink: 0;
            touch-action: none;
        }
        
        .todo-item:hover .drag-handle {
            color: var(--primary-color);
        }
        
        .todo-item.section-break:hover .drag-handle {
            color: var(--section-color);
        }
        
        .item-checkbox {
            margin-right: 0.8rem;
            width: 1.3rem;
            height: 1.3rem;
            cursor: pointer;
            flex-shrink: 0;
            -webkit-appearance: none;
            appearance: none;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            position: relative;
        }
        
        .item-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .item-checkbox:checked::after {
            content: "✓";
            position: absolute;
            color: white;
            font-size: 1rem;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .item-text {
            flex: 1;
            margin-right: 0.8rem;
            padding: 0.2rem 0;
            cursor: text;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 1rem;
            user-select: none;
        }
        
        .item-edit {
            flex: 1;
            margin-right: 0.8rem;
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1rem;
            display: none;
            min-width: 0;
            background-color: white;
            -webkit-appearance: none;
            width: 100%;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1.5rem;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 0.2rem;
            flex-shrink: 0;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-btn:hover {
            opacity: 1;
        }
        
        .saved-lists {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        .saved-lists h2 {
            color: var(--primary-color);
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
        }
        
        .saved-files-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
        }
        
        .saved-file {
            padding: 0.8rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            font-size: 0.9rem;
            min-height: 80px;
        }
        
        .saved-file:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .saved-file-name {
            font-weight: 500;
            margin-bottom: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 1.5rem;
        }
        
        .saved-file-date {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .delete-saved-btn {
            position: absolute;
            top: 0.3rem;
            right: 0.3rem;
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.7;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-saved-btn:hover {
            opacity: 1;
        }
        
        #status {
            margin: 0.8rem 0;
            padding: 0.8rem;
            border-radius: 8px;
            background-color: #e8f4fd;
            color: var(--primary-color);
            display: none;
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 1.5rem;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        #current-folder {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .footer {
            text-align: center;
            font-size: 0.8rem;
            color: #6c757d;
            padding: 1rem 0;
            background-color: white;
            margin-top: 1.5rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.3rem;
        }
        
        .modal-content {
            margin: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .modal-actions button {
            min-width: 80px;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        #import-content, #export-content {
            width: 100%;
            height: 150px;
            margin: 1rem 0;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            -webkit-appearance: none;
        }
        
        .import-format label, .export-format label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
            padding: 0.3rem 0;
        }
        
        input[type="radio"] {
            width: 1.1rem;
            height: 1.1rem;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0.8rem;
            }
            
            .controls button {
                min-width: 100%;
            }
            
            .saved-files-container {
                grid-template-columns: 1fr;
            }
            
            .modal {
                width: 95%;
                padding: 1rem;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Smart To-Do List</h1>
        
        <input type="text" id="title" placeholder="List title...">
        
        <div class="input-group">
            <input type="text" id="new-item" placeholder="Add new task" enterkeyhint="done">
            <button onclick="addItem()">Add</button>
        </div>
        
        <ul id="todo-list"></ul>
        
        <div id="status"></div>
        
        <div class="controls">
            <button onclick="saveToFile()">💾 Save</button>
            <button onclick="loadFromFile()">📂 Load</button>
            <button onclick="showExportModal()">📤 Export</button>
            <button onclick="showImportModal()">📥 Import</button>
            <button onclick="clearList()">🗑️ Clear</button>
            <button class="section-btn" onclick="addSectionBreak()">⏸️ Add Section</button>
        </div>
        
        <div id="current-folder"></div>
        
        <div class="saved-lists">
            <h2>Saved Lists</h2>
            <div id="saved-files-container" class="saved-files-container"></div>
        </div>
        
        <div class="footer">
            &copy; 2025 Dr. Wen-Ming Yang Lab. All rights reserved.
        </div>
    </div>

    <!-- Export Modal -->
    <div class="overlay" id="export-overlay"></div>
    <div class="modal" id="export-modal">
        <h3>Export To-Do List</h3>
        <div class="modal-content">
            <div class="export-format">
                <label>
                    <input type="radio" name="export-format" value="markdown" checked>
                    Markdown
                </label>
                <label>
                    <input type="radio" name="export-format" value="html">
                    HTML
                </label>
                <label>
                    <input type="radio" name="export-format" value="plaintext">
                    Plain Text
                </label>
            </div>
            <textarea id="export-content" readonly></textarea>
            <div class="modal-actions">
                <button onclick="copyToClipboard('export-content')">Copy</button>
                <button class="secondary" onclick="hideModal('export')">Close</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="overlay" id="import-overlay"></div>
    <div class="modal" id="import-modal">
        <h3>Import To-Do List</h3>
        <div class="modal-content">
            <div class="import-format">
                <label>
                    <input type="radio" name="import-format" value="markdown" checked>
                    Markdown
                </label>
                <label>
                    <input type="radio" name="import-format" value="html">
                    HTML
                </label>
                <label>
                    <input type="radio" name="import-format" value="plaintext">
                    Plain Text
                </label>
            </div>
            <textarea id="import-content" placeholder="Paste your list content here..."></textarea>
            <div class="modal-actions">
                <button onclick="importList()">Import</button>
                <button class="secondary" onclick="hideModal('import')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // File system variables
        let directoryHandle;
        let fileHandles = {};
        let draggedItem = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTitleWithCurrentDate();
            checkForSavedFiles();
            setupDirectEditing();
            setupDragAndDrop();
            setupMobileEvents();
            
            // Add event listeners for format changes
            document.querySelectorAll('input[name="export-format"]').forEach(radio => {
                radio.addEventListener('change', updateExportContent);
            });
            
            // Add click listener for todo items
            document.getElementById('todo-list').addEventListener('click', function(e) {
                if (e.target.classList.contains('item-checkbox')) {
                    toggleComplete(e.target);
                } else if (e.target.classList.contains('delete-btn')) {
                    deleteItem(e.target);
                }
            });
        });

        function setupMobileEvents() {
            // Prevent zooming on double-tap
            let lastTap = 0;
            document.addEventListener('touchend', function(e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTap;
                if (tapLength < 300 && tapLength > 0) {
                    e.preventDefault();
                }
                lastTap = currentTime;
            }, { passive: false });
            
            // Better handling for virtual keyboard
            const inputs = document.querySelectorAll('input[type="text"], textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    setTimeout(() => {
                        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
        }

        function setupDragAndDrop() {
            const list = document.getElementById('todo-list');
            
            // For desktop
            list.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('todo-item')) {
                    draggedItem = e.target;
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', ''); // Required for Firefox
                }
            });
            
            list.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const targetItem = e.target.closest('.todo-item');
                if (targetItem && targetItem !== draggedItem) {
                    const rect = targetItem.getBoundingClientRect();
                    const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                    list.insertBefore(draggedItem, next ? targetItem.nextSibling : targetItem);
                }
            });
            
            list.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('todo-item')) {
                    e.target.classList.remove('dragging');
                    draggedItem = null;
                }
            });
            
            // For touch devices
            let touchStartY = 0;
            let touchMoved = false;
            let touchDraggedItem = null;
            
            list.addEventListener('touchstart', function(e) {
                if (e.target.closest('.todo-item')) {
                    touchDraggedItem = e.target.closest('.todo-item');
                    touchStartY = e.touches[0].clientY;
                    touchMoved = false;
                    touchDraggedItem.classList.add('dragging');
                    e.preventDefault(); // Prevent scrolling
                }
            }, { passive: false });
            
            list.addEventListener('touchmove', function(e) {
                if (touchDraggedItem) {
                    const touchY = e.touches[0].clientY;
                    const deltaY = touchY - touchStartY;
                    
                    if (Math.abs(deltaY) > 10) {
                        touchMoved = true;
                        
                        // Move the dragged item visually
                        touchDraggedItem.style.transform = `translateY(${deltaY}px)`;
                        
                        // Find the item we're hovering over
                        const hoverY = e.touches[0].clientY;
                        const items = Array.from(list.children).filter(item => item !== touchDraggedItem);
                        
                        for (const item of items) {
                            const rect = item.getBoundingClientRect();
                            const middle = rect.top + rect.height / 2;
                            
                            if (hoverY < middle) {
                                list.insertBefore(touchDraggedItem, item);
                                break;
                            } else if (item === items[items.length - 1]) {
                                list.appendChild(touchDraggedItem);
                            }
                        }
                        
                        e.preventDefault(); // Prevent scrolling
                    }
                }
            }, { passive: false });
            
            list.addEventListener('touchend', function(e) {
                if (touchDraggedItem) {
                    touchDraggedItem.classList.remove('dragging');
                    touchDraggedItem.style.transform = '';
                    touchDraggedItem = null;
                    
                    if (touchMoved) {
                        e.preventDefault(); // Prevent click event
                    }
                }
            }, { passive: false });
        }

        /* ========== CORE FUNCTIONALITY ========== */
        function setupDirectEditing() {
            document.getElementById('todo-list').addEventListener('click', function(e) {
                // Don't start editing if we're dragging
                if (document.querySelector('.todo-item.dragging')) return;
                
                const textSpan = e.target.closest('.item-text');
                if (textSpan) {
                    const li = textSpan.closest('.todo-item');
                    const editInput = li.querySelector('.item-edit');
                    
                    textSpan.style.display = 'none';
                    editInput.style.display = 'block';
                    editInput.value = textSpan.textContent;
                    editInput.focus();
                    
                    // Move cursor to end and open keyboard on mobile
                    setTimeout(() => {
                        editInput.setSelectionRange(editInput.value.length, editInput.value.length);
                        editInput.focus();
                    }, 50);
                    
                    function saveEdit() {
                        const newText = editInput.value.trim();
                        if (newText) {
                            textSpan.textContent = newText;
                            showStatus(li.classList.contains('section-break') ? 'Section updated' : 'Task updated', 'success');
                        }
                        textSpan.style.display = 'block';
                        editInput.style.display = 'none';
                        
                        editInput.removeEventListener('blur', saveEdit);
                        editInput.removeEventListener('keyup', handleKeyUp);
                    }
                    
                    function handleKeyUp(e) {
                        if (e.key === 'Enter') saveEdit();
                        if (e.key === 'Escape') {
                            textSpan.style.display = 'block';
                            editInput.style.display = 'none';
                        }
                    }
                    
                    editInput.addEventListener('blur', saveEdit);
                    editInput.addEventListener('keyup', handleKeyUp);
                }
            });
        }

        function updateTitleWithCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = days[today.getDay()];
            document.getElementById('title').value = `Tasks ${year}${month}${day}-${dayName}`;
        }

        function addItem() {
            const input = document.getElementById('new-item');
            const text = input.value.trim();
            if (text === '') {
                showStatus('Please enter a task', 'warning');
                return;
            }
            
            const li = document.createElement('li');
            li.className = 'todo-item';
            li.draggable = true;
            li.innerHTML = `
                <span class="drag-handle">☰</span>
                <input type="checkbox" class="item-checkbox">
                <span class="item-text">${text}</span>
                <input type="text" class="item-edit" value="${text}">
                <button class="delete-btn">×</button>
            `;
            
            // Remove empty state if present
            const todoList = document.getElementById('todo-list');
            if (todoList.querySelector('.empty-state')) {
                todoList.innerHTML = '';
            }
            
            todoList.appendChild(li);
            input.value = '';
            input.focus();
            showStatus('Task added', 'success');
        }

        function addSectionBreak() {
            const li = document.createElement('li');
            li.className = 'todo-item section-break';
            li.draggable = true;
            li.innerHTML = `
                <span class="drag-handle">☰</span>
                <span class="item-text">New Section</span>
                <input type="text" class="item-edit" value="New Section">
                <button class="delete-btn">×</button>
            `;
            
            // Remove empty state if present
            const todoList = document.getElementById('todo-list');
            if (todoList.querySelector('.empty-state')) {
                todoList.innerHTML = '';
            }
            
            todoList.appendChild(li);
            showStatus('Section added', 'success');
        }

        function toggleComplete(checkbox) {
            const li = checkbox.closest('.todo-item');
            li.classList.toggle('completed', checkbox.checked);
        }

        function deleteItem(button) {
            const li = button.closest('.todo-item');
            li.style.transform = 'translateX(-100%)';
            li.style.opacity = '0';
            setTimeout(() => {
                li.remove();
                
                // Show empty state if no items left
                const todoList = document.getElementById('todo-list');
                if (todoList.children.length === 0) {
                    todoList.innerHTML = '<div class="empty-state">No tasks yet</div>';
                }
                
                showStatus(li.classList.contains('section-break') ? 'Section deleted' : 'Task deleted', 'warning');
            }, 200);
        }

        /* ========== IMPORT/EXPORT FUNCTIONALITY ========== */
        function showExportModal() {
            showModal('export');
            updateExportContent();
        }

        function showImportModal() {
            showModal('import');
            document.getElementById('import-content').value = '';
        }

        function showModal(type) {
            document.getElementById(`${type}-overlay`).style.display = 'block';
            document.getElementById(`${type}-modal`).style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideModal(type) {
            document.getElementById(`${type}-overlay`).style.display = 'none';
            document.getElementById(`${type}-modal`).style.display = 'none';
            document.body.style.overflow = '';
        }

        function updateExportContent() {
            const format = document.querySelector('input[name="export-format"]:checked').value;
            const title = document.getElementById('title').value || 'Untitled List';
            let content = '';
            
            if (format === 'markdown') {
                content = `# ${title}\n\n`;
                document.querySelectorAll('#todo-list .todo-item').forEach(item => {
                    const text = item.querySelector('.item-text').textContent;
                    if (item.classList.contains('section-break')) {
                        content += `## ${text}\n\n`;
                    } else {
                        const checked = item.querySelector('.item-checkbox')?.checked ? 'x' : ' ';
                        content += `- [${checked}] ${text}\n`;
                    }
                });
            } 
            else if (format === 'html') {
                content = `<h1>${title}</h1>\n<ul>\n`;
                document.querySelectorAll('#todo-list .todo-item').forEach(item => {
                    const text = item.querySelector('.item-text').textContent;
                    if (item.classList.contains('section-break')) {
                        content += `</ul>\n<h2>${text}</h2>\n<ul>\n`;
                    } else {
                        const checked = item.querySelector('.item-checkbox')?.checked ? ' checked' : '';
                        content += `  <li><input type="checkbox"${checked}> ${text}</li>\n`;
                    }
                });
                content += '</ul>';
            } 
            else { // plaintext
                content = `${title}\n${'='.repeat(title.length)}\n\n`;
                document.querySelectorAll('#todo-list .todo-item').forEach(item => {
                    const text = item.querySelector('.item-text').textContent;
                    if (item.classList.contains('section-break')) {
                        content += `\n${text}\n${'-'.repeat(text.length)}\n\n`;
                    } else {
                        const checked = item.querySelector('.item-checkbox')?.checked ? '[✓]' : '[ ]';
                        content += `${checked} ${text}\n`;
                    }
                });
            }
            
            document.getElementById('export-content').value = content;
        }

        function importList() {
            const content = document.getElementById('import-content').value.trim();
            if (!content) {
                showStatus('No content to import', 'warning');
                return;
            }
            
            const format = document.querySelector('input[name="import-format"]:checked').value;
            
            try {
                let items = [];
                let title = document.getElementById('title').value || "Imported List";
                
                if (format === 'markdown') {
                    // Parse markdown format
                    const lines = content.split('\n');
                    const firstLine = lines[0].trim();
                    if (firstLine.startsWith('# ')) {
                        title = firstLine.substring(2).trim();
                    }
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('## ')) {
                            items.push({
                                text: line.substring(3).trim(),
                                isSection: true
                            });
                        } else if (line.startsWith('- [')) {
                            const match = line.match(/^-\s*\[(.)\]\s*(.*)$/);
                            if (match) {
                                items.push({
                                    text: match[2],
                                    completed: match[1].toLowerCase() === 'x',
                                    isSection: false
                                });
                            }
                        }
                    }
                }
                else if (format === 'html') {
                    // Parse HTML format
                    const titleMatch = content.match(/<h1[^>]*>([^<]*)<\/h1>/i);
                    if (titleMatch) title = titleMatch[1];
                    
                    // Find all sections and items
                    const sections = content.split(/<\/ul>\s*<h2[^>]*>([^<]*)<\/h2>\s*<ul>/gi);
                    for (let i = 0; i < sections.length; i++) {
                        if (i % 2 === 1) {
                            // This is a section title
                            items.push({
                                text: sections[i],
                                isSection: true
                            });
                        }
                        
                        // Find items in this section
                        const itemRegex = /<li[^>]*>\s*<input[^>]*type=["']checkbox["'][^>]*>([^<]*)<\/li>/gi;
                        let match;
                        while ((match = itemRegex.exec(sections[i])) !== null) {
                            const checked = match[0].includes(' checked');
                            items.push({
                                text: match[1].trim(),
                                completed: checked,
                                isSection: false
                            });
                        }
                    }
                }
                else { // plaintext
                    // Parse plain text format
                    const lines = content.split('\n');
                    const firstLine = lines[0].trim();
                    if (!firstLine.startsWith('[') && !firstLine.startsWith('-')) {
                        title = firstLine;
                    }
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line && !line.startsWith('[') && !line.startsWith('-') && 
                            i < lines.length - 1 && lines[i+1].trim().match(/^-+$/)) {
                            // This is likely a section title
                            items.push({
                                text: line,
                                isSection: true
                            });
                            i++; // Skip the underline
                        } else if (line.startsWith('[✓]') || line.startsWith('[ ]')) {
                            items.push({
                                text: line.substring(3).trim(),
                                completed: line.startsWith('[✓]'),
                                isSection: false
                            });
                        } else if (line.startsWith('- [✓]') || line.startsWith('- [ ]')) {
                            items.push({
                                text: line.substring(5).trim(),
                                completed: line.startsWith('- [✓]'),
                                isSection: false
                            });
                        }
                    }
                }
                
                // Update the current list
                document.getElementById('title').value = title;
                const todoList = document.getElementById('todo-list');
                
                // Remove empty state if present
                if (todoList.querySelector('.empty-state')) {
                    todoList.innerHTML = '';
                }
                
                if (items.length === 0) {
                    showStatus('No tasks found in import', 'warning');
                } else {
                    todoList.innerHTML = '';
                    
                    items.forEach(item => {
                        if (item.isSection) {
                            const li = document.createElement('li');
                            li.className = 'todo-item section-break';
                            li.draggable = true;
                            li.innerHTML = `
                                <span class="drag-handle">☰</span>
                                <span class="item-text">${item.text}</span>
                                <input type="text" class="item-edit" value="${item.text}">
                                <button class="delete-btn">×</button>
                            `;
                            todoList.appendChild(li);
                        } else {
                            const li = document.createElement('li');
                            li.className = 'todo-item';
                            li.draggable = true;
                            if (item.completed) li.classList.add('completed');
                            li.innerHTML = `
                                <span class="drag-handle">☰</span>
                                <input type="checkbox" class="item-checkbox" ${item.completed ? 'checked' : ''}>
                                <span class="item-text">${item.text}</span>
                                <input type="text" class="item-edit" value="${item.text}">
                                <button class="delete-btn">×</button>
                            `;
                            todoList.appendChild(li);
                        }
                    });
                    
                    showStatus(`Imported ${items.length} items`, 'success');
                }
                
                hideModal('import');
            } catch (error) {
                showStatus('Error importing list: ' + error.message, 'error');
                console.error(error);
            }
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            
            navigator.clipboard.writeText(element.value).then(() => {
                showStatus('Copied to clipboard!', 'success');
                hideModal('export');
            }).catch(err => {
                showStatus('Failed to copy: ' + err, 'error');
            });
        }

        /* ========== FILE MANAGEMENT ========== */
        async function selectFolder() {
            try {
                if (window.showDirectoryPicker) {
                    directoryHandle = await window.showDirectoryPicker();
                    updateFolderDisplay();
                    checkForSavedFiles();
                    showStatus('Folder selected', 'success');
                } else {
                    // Fallback for mobile devices
                    showStatus('On mobile, please use Export/Import instead', 'info');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    showStatus('Error selecting folder', 'error');
                    console.error(error);
                }
            }
        }

        function updateFolderDisplay() {
            if (directoryHandle && directoryHandle.name) {
                document.getElementById('current-folder').textContent = `Current folder: ${directoryHandle.name}`;
            } else {
                document.getElementById('current-folder').textContent = 'No folder selected (use Export/Import on mobile)';
            }
        }

        async function saveToFile() {
            try {
                const title = document.getElementById('title').value.trim();
                if (!title) {
                    showStatus('Please enter a title for your list', 'warning');
                    return;
                }
                
                // Check if we're on mobile
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile || !window.showDirectoryPicker) {
                    // Mobile fallback - use export instead
                    showExportModal();
                    return;
                }
                
                if (!directoryHandle) {
                    showStatus('Please select a folder first', 'warning');
                    return await selectFolder();
                }
                
                const items = [];
                document.querySelectorAll('#todo-list .todo-item').forEach(li => {
                    items.push({
                        text: li.querySelector('.item-text').textContent,
                        completed: li.classList.contains('completed'),
                        isSection: li.classList.contains('section-break')
                    });
                });
                
                const todoData = {
                    title: title,
                    items: items,
                    timestamp: new Date().toISOString()
                };
                
                const fileName = `${title.replace(/[^a-z0-9]/gi, '_')}.todo`;
                const fileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(todoData, null, 2));
                await writable.close();
                
                fileHandles[fileName] = fileHandle;
                
                showStatus(`Saved as "${fileName}"`, 'success');
                checkForSavedFiles();
            } catch (error) {
                showStatus(`Error saving: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function loadFromFile() {
            try {
                // Check if we're on mobile
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                if (isMobile || !window.showDirectoryPicker) {
                    // Mobile fallback - use import instead
                    showImportModal();
                    return;
                }
                
                if (!directoryHandle) {
                    showStatus('Please select a folder first', 'warning');
                    return await selectFolder();
                }
                
                let fileHandle;
                if (window.showOpenFilePicker) {
                    fileHandle = await window.showOpenFilePicker({
                        types: [{
                            description: 'To-Do Files',
                            accept: { 'application/json': ['.todo', '.json'] }
                        }],
                        excludeAcceptAllOption: true
                    });
                    fileHandle = fileHandle[0];
                } else {
                    showStatus('File picker not supported on this device', 'error');
                    return;
                }
                
                const file = await fileHandle.getFile();
                const contents = await file.text();
                const todoData = JSON.parse(contents);
                
                document.getElementById('title').value = todoData.title;
                
                const todoList = document.getElementById('todo-list');
                todoList.innerHTML = '';
                
                if (todoData.items.length === 0) {
                    todoList.innerHTML = '<div class="empty-state">No tasks yet</div>';
                } else {
                    todoData.items.forEach(item => {
                        if (item.isSection) {
                            const li = document.createElement('li');
                            li.className = 'todo-item section-break';
                            li.draggable = true;
                            li.innerHTML = `
                                <span class="drag-handle">☰</span>
                                <span class="item-text">${item.text}</span>
                                <input type="text" class="item-edit" value="${item.text}">
                                <button class="delete-btn">×</button>
                            `;
                            todoList.appendChild(li);
                        } else {
                            const li = document.createElement('li');
                            li.className = 'todo-item';
                            li.draggable = true;
                            if (item.completed) li.classList.add('completed');
                            li.innerHTML = `
                                <span class="drag-handle">☰</span>
                                <input type="checkbox" class="item-checkbox" ${item.completed ? 'checked' : ''}>
                                <span class="item-text">${item.text}</span>
                                <input type="text" class="item-edit" value="${item.text}">
                                <button class="delete-btn">×</button>
                            `;
                            todoList.appendChild(li);
                        }
                    });
                }
                
                showStatus(`Loaded "${file.name}"`, 'success');
            } catch (error) {
                if (error.name !== 'AbortError') {
                    showStatus(`Error loading: ${error.message}`, 'error');
                    console.error(error);
                }
            }
        }

        async function deleteFile(fileName, event) {
            event.stopPropagation();
            try {
                if (!directoryHandle) {
                    showStatus('Please select a folder first', 'warning');
                    return await selectFolder();
                }
                
                if (confirm(`Delete "${fileName}"?`)) {
                    await directoryHandle.removeEntry(fileName);
                    showStatus(`Deleted "${fileName}"`, 'warning');
                    checkForSavedFiles();
                }
            } catch (error) {
                showStatus(`Error deleting: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function checkForSavedFiles() {
            try {
                const container = document.getElementById('saved-files-container');
                
                if (!directoryHandle) {
                    container.innerHTML = '<div class="empty-state">Select a folder to view saved lists (use Export/Import on mobile)</div>';
                    return;
                }
                
                const files = [];
                for await (const entry of directoryHandle.values()) {
                    if (entry.kind === 'file' && (entry.name.endsWith('.todo') || entry.name.endsWith('.json'))) {
                        const file = await entry.getFile();
                        files.push({
                            name: entry.name,
                            date: new Date(file.lastModified)
                        });
                    }
                }
                
                displaySavedFiles(files.sort((a, b) => b.date - a.date));
            } catch (error) {
                console.error(error);
                document.getElementById('saved-files-container').innerHTML = 
                    '<div class="empty-state">Error loading saved files</div>';
            }
        }

        function displaySavedFiles(files) {
            const container = document.getElementById('saved-files-container');
            
            if (files.length === 0) {
                container.innerHTML = '<div class="empty-state">No saved lists found</div>';
                return;
            }
            
            container.innerHTML = '';
            
            files.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'saved-file';
                fileElement.innerHTML = `
                    <div class="saved-file-name">${file.name.replace('.todo', '').replace('.json', '')}</div>
                    <div class="saved-file-date">${file.date.toLocaleDateString()}</div>
                    <button class="delete-saved-btn" onclick="deleteFile('${file.name.replace(/'/g, "\\'")}', event)">×</button>
                `;
                fileElement.addEventListener('click', () => loadFromFile(file.name));
                container.appendChild(fileElement);
            });
        }

        function clearList() {
            if (confirm('Clear current list?')) {
                document.getElementById('todo-list').innerHTML = 
                    '<div class="empty-state">No tasks yet</div>';
                updateTitleWithCurrentDate();
                showStatus('List cleared', 'warning');
            }
        }

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            statusEl.className = '';
            
            switch(type) {
                case 'success':
                    statusEl.style.backgroundColor = '#e6ffed';
                    statusEl.style.color = '#22863a';
                    break;
                case 'warning':
                    statusEl.style.backgroundColor = '#fff8e6';
                    statusEl.style.color = '#d46b08';
                    break;
                case 'error':
                    statusEl.style.backgroundColor = '#ffe6e6';
                    statusEl.style.color = '#cb2431';
                    break;
                default:
                    statusEl.style.backgroundColor = '#e8f4fd';
                    statusEl.style.color = '#0366d6';
            }
            
            setTimeout(() => {
                statusEl.style.opacity = '0';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                    statusEl.style.opacity = '1';
                }, 200);
            }, 2000);
        }

        // Add keyboard event for mobile
        document.getElementById('new-item').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addItem();
            }
        });
    </script>
</body>
</html>