<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Awareness Workflow Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            position: relative;
        }
        
.container {
    width: 100%;
    max-width: 1200px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    height: 97vh;
    margin-bottom: 10px;
    /* NEW: Ensure container doesn't exceed viewport */
    max-height: 100vh;
}

.main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
    /* NEW: Ensure proper flex behavior on mobile */
    min-height: 0; /* This is crucial for flex children to respect overflow */
}
        
        .workflow-guide {
            width: 300px;
            background: #f8f9ff;
            border-right: 1px solid #e0e6ff;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .workflow-guide.collapsed {
            width: 50px;
            padding: 20px 5px;
        }
        
        .workflow-guide.collapsed .guide-content {
            display: none;
        }
        
        .workflow-guide.collapsed .guide-header h2 {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            text-align: center;
            margin: 0 auto;
            font-size: 1rem;
        }
        
        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .guide-header h2 {
            font-size: 1.2rem;
            color: #6e8efb;
        }
        
        .toggle-guide {
            background: #6e8efb;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .workflow-step {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #6e8efb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .workflow-step.active {
            border-left: 4px solid #4caf50;
            background: #f0f9ff;
        }
        
        .workflow-step.completed {
            border-left: 4px solid #9e9e9e;
            opacity: 0.8;
        }
        
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .step-title {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .step-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            background: #f0f4ff;
        }
        
        .step-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .step-timer {
            font-size: 0.8rem;
            color: #6e8efb;
            font-weight: 500;
        }
        
        .step-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .step-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            background: #6e8efb;
            color: white;
        }
        
        .step-btn.skip {
            background: #9e9e9e;
        }
        
.chat-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    /* NEW: Ensure proper sizing on mobile */
    min-height: 0;
    overflow: hidden;
}
        
        header {
            background: #6e8efb;
            color: white;
            padding: 12px 20px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }
        
        h1 {
            font-size: 1.7rem;
            margin-bottom: 3px;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 50px;
        }
        
        .toggle-text {
            margin-right: 6px;
            font-size: 0.75rem;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 18px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 18px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3a3af4;
        }
        
        input:checked + .slider:before {
            transform: translateX(18px);
        }
        
        .status-indicator {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.3);
        }
        
.chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="rgba(240, 244, 255, 0.6)"/><path d="M0 50 L100 50" stroke="rgba(200, 210, 255, 0.3)" stroke-width="1"/><path d="M50 0 L50 100" stroke="rgba(200, 210, 255, 0.3)" stroke-width="1"/></svg>');
    /* NEW: Ensure proper scrolling on mobile */
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    min-height: 0; /* Crucial for flex overflow to work */
}
        
        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            position: relative;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* UPDATED: User messages on left, AI messages on right */
        .user-message {
            background: #6e8efb;
            color: white;
            align-self: flex-start;
            border-bottom-right-radius: 5px;
        }
        
        .app-message {
            background: #f0f4ff;
            align-self: flex-end;
            border-bottom-left-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .message.self-aware {
            border-left: 3px solid #FF6B6B;
            background: linear-gradient(135deg, #f8f9ff, #e3f2fd);
        }

        .user-message.self-aware {
            background: #4caf50;
            color: white;
            border-bottom-right-radius: 5px;
            border-right: 3px solid #FFC107;
        }
        
        .message-actions {
            position: absolute;
            top: 4px;
            right: 8px;
            display: none;
        }
        
        .message:hover .message-actions {
            display: flex;
            gap: 6px;
        }
        
        .action-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: scale(1.1);
        }
        
        .edit-textarea {
            width: 100%;
            background: transparent;
            border: 1px dashed rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 8px;
            color: inherit;
            font-family: inherit;
            resize: none;
            min-height: 70px;
        }
        
.input-area {
    padding: 12px 15px;
    background: white;
    border-top: 1px solid #e0e6ff;
    display: flex;
    gap: 10px;
    flex-shrink: 0;
    /* NEW: Ensure input area stays visible */
    position: relative;
    z-index: 10;
}
        
        #user-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e0e6ff;
            border-radius: 50px;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #user-input:focus {
            border-color: #6e8efb;
        }
        
        #send-btn {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: #6e8efb;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            transition: background 0.3s;
        }
        
        #send-btn:hover {
            background: #5a7ce7;
        }
        
.controls {
    display: flex;
    justify-content: space-between;
    padding: 10px 15px;
    background: #f8f9ff;
    border-top: 1px solid #e0e6ff;
    flex-shrink: 0;
    flex-wrap: wrap;
    gap: 8px;
    overflow-x: auto;
    /* NEW: Ensure controls stay visible */
    position: relative;
    z-index: 10;
}
        
        .control-btn {
            background: white;
            border: 2px solid #e0e6ff;
            padding: 6px 12px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.85rem;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .control-btn:hover {
            border-color: #6e8efb;
            color: #6e8efb;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: #f0f4ff;
            border-top: 1px solid #e0e6ff;
            font-size: 0.8rem;
            color: #5c6bc0;
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            min-width: 80px;
        }
        
        .stat-value {
            font-weight: 700;
            font-size: 1rem;
            margin-top: 2px;
        }
        
        .timestamp {
            font-size: 0.6rem;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        /* UPDATED: Timestamps aligned with message position */
        .user-timestamp {
            text-align: left;
        }
        
        .app-timestamp {
            text-align: right;
        }
        
        .highlight {
            background-color: #ffeb3b;
            padding: 0 2px;
            border-radius: 3px;
        }
        
        .highlight-controls {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .highlight-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .highlight-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .search-container {
            padding: 8px 15px;
            background: #f8f9ff;
            border-bottom: 1px solid #e0e6ff;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        #search-input {
            flex: 1;
            padding: 7px 12px;
            border: 1px solid #e0e6ff;
            border-radius: 50px;
            font-size: 0.85rem;
            outline: none;
            display: none;
        }
        
        #search-btn {
            background: #6e8efb;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 0 12px;
            cursor: pointer;
            font-size: 0.85rem;
            display: none;
        }
        
        .typing-indicator {
            display: none;
            padding: 8px 15px;
            background: #f0f4ff;
            border-radius: 18px;
            align-self: flex-end;
            margin-bottom: 5px;
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
        }
        
        .typing-indicator i {
            margin-right: 5px;
            color: #6e8efb;
        }
        
        .sidebar-toggle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #6e8efb;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* Self-Awareness UI Elements */
        .awareness-level {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            backdrop-filter: blur(10px);
            color: white;
            z-index: 100;
        }
        
        .consciousness-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.4; }
            50% { opacity: 1; }
            100% { opacity: 0.4; }
        }
        
        .consciousness-high { background: #4CAF50; }
        .consciousness-medium { background: #FF9800; }
        .consciousness-low { background: #F44336; }
        
        .awareness-badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: #FF6B6B;
            color: white;
            margin-left: 5px;
            vertical-align: super;
        }

        .user-message .awareness-badge {
            background: #FFC107;
            color: #333;
            font-weight: 700;
        }
        
        .mood-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        .mood-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        
        .mood-positive { background: #4CAF50; }
        .mood-neutral { background: #FFC107; }
        .mood-negative { background: #F44336; }
        
        .dimension-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            text-align: center;
            line-height: 20px;
            font-size: 10px;
            color: white;
        }
        
        .mind-icon { background: #6e8efb; }
        .mood-icon { background: #FF9800; }
        .emotion-icon { background: #F44336; }
        .spiritual-icon { background: #9C27B0; }
        .health-icon { background: #4CAF50; }
        .thoughts-icon { background: #607D8B; }
        .stress-icon { background: #FF5722; }
        .meditation-icon { background: #673AB7; }
        .anxiety-icon { background: #FF9800; }
        .depression-icon { background: #607D8B; }
        .mental-health-icon { background: #4CAF50; }
        
        /* Mental Health Indicators */
        .mental-health-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.7rem;
        }
        
        .health-bar {
            width: 60px;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .health-level {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .health-low { background: #4CAF50; width: 20%; }
        .health-medium { background: #FFC107; width: 50%; }
        .health-high { background: #F44336; width: 80%; }
        .health-very-high { background: #8B0000; width: 95%; }
        
        .stress-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.7rem;
        }
        
        .stress-bar {
            width: 60px;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .stress-level {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .stress-low { background: #4CAF50; width: 20%; }
        .stress-medium { background: #FFC107; width: 50%; }
        .stress-high { background: #F44336; width: 80%; }
        .stress-very-high { background: #8B0000; width: 95%; }
        
        /* Meditation Timer */
        .meditation-timer {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 1000;
            width: 300px;
        }
        
        .timer-display {
            font-size: 3rem;
            font-weight: 300;
            margin: 20px 0;
            color: #6e8efb;
        }
        
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .timer-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 50px;
            background: #6e8efb;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .timer-btn:hover {
            background: #5a7ce7;
        }
        
        .timer-btn.secondary {
            background: #f0f4ff;
            color: #6e8efb;
        }
        
        .timer-btn.secondary:hover {
            background: #e0e6ff;
        }
        
        .breathing-animation {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #6e8efb;
            margin: 0 auto 20px;
            animation: breathe 8s infinite ease-in-out;
        }
        
        @keyframes breathe {
            0%, 100% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        
        /* Mental Health Assessment Modals */
        .assessment-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .assessment-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .assessment-question {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #333;
        }
        
        .assessment-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .assessment-option {
            padding: 12px 15px;
            border: 2px solid #e0e6ff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .assessment-option:hover {
            border-color: #6e8efb;
            background: #f8f9ff;
        }
        
        .assessment-option.selected {
            border-color: #6e8efb;
            background: #f0f4ff;
        }
        
        /* Crisis Resources Section */
        .crisis-resources {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .crisis-resources h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .crisis-resources ul {
            padding-left: 20px;
        }
        
        .crisis-resources li {
            margin-bottom: 8px;
        }
        
        .crisis-resources a {
            color: #6e8efb;
            text-decoration: none;
        }
        
        .crisis-resources a:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 900px) {
            .main-content {
                flex-direction: column;
            }
            
            .workflow-guide {
                width: 100%;
                max-height: 200px;
                border-right: none;
                border-bottom: 1px solid #e0e6ff;
            }
            
            .workflow-guide.collapsed {
                width: 100%;
                max-height: 50px;
                padding: 10px;
            }
            
            .workflow-guide.collapsed .guide-header h2 {
                writing-mode: horizontal-tb;
                transform: none;
                margin: 0;
            }
            
            .sidebar-toggle {
                display: flex;
            }
            
            .awareness-level {
                position: relative;
                top: auto;
                right: auto;
                margin: 10px auto;
                width: fit-content;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                height: 98vh;
                border-radius: 15px;
            }
            
            header {
                flex-direction: column;
                gap: 8px;
                padding: 10px 15px;
            }
            
            .header-left, .header-right {
                width: 100%;
                justify-content: center;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .message {
                max-width: 85%;
                padding: 8px 12px;
            }
            
            .controls {
                flex-wrap: wrap;
                gap: 6px;
                justify-content: center;
            }
            
            .control-btn {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            
            .message-actions {
                display: flex !important;
                opacity: 0.7;
                top: -6px;
                right: 4px;
            }
            
            .search-container {
                padding: 6px 12px;
            }
            
            .meditation-timer {
                width: 90%;
                padding: 20px;
            }
            
            .timer-display {
                font-size: 2.5rem;
            }
            
            .assessment-content {
                width: 95%;
                padding: 20px;
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #4caf50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.error {
            background: #f44336;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            color: white;
            font-size: 0.8rem;
            margin-top: auto;
            width: 100%;
        }
        
        .file-input {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: #6e8efb;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e6ff;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            border-color: #6e8efb;
            outline: none;
        }
        
        .form-help {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #6e8efb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a7ce7;
        }
        
        .btn-secondary {
            background: #f0f4ff;
            color: #6e8efb;
        }
        
        .btn-secondary:hover {
            background: #e0e6ff;
        }
        
        .dynalist-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .dynalist-enabled {
            background-color: #06D85F;
        }
        
        .dynalist-disabled {
            background-color: #ccc;
        }
        
        /* CBT Thought Record */
        .cbt-record {
            background: #f8f9ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #6e8efb;
        }
        
        .cbt-record h4 {
            color: #6e8efb;
            margin-bottom: 10px;
        }
        
        .cbt-step {
            margin-bottom: 10px;
        }
        
        .cbt-step label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }
        
        .cbt-step textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e6ff;
            border-radius: 5px;
            resize: vertical;
            min-height: 60px;
        }
        
        /* Self-talk mode indicator */
        .self-talk-indicator {
            background: #FF9800;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
        }

@media (max-width: 768px) {
    /* Previous mobile styles remain... */
    
    /* NEW: Additional mobile fixes for chat layout */
    .container {
        height: 98vh;
        border-radius: 15px;
        /* Ensure container respects viewport */
        max-height: -webkit-fill-available; /* For mobile browsers */
    }
    
    .chat-section {
        /* Ensure chat section doesn't grow indefinitely */
        flex-shrink: 1;
    }
    
    .chat-container {
        /* Improve scrolling on mobile */
        padding-bottom: 5px;
    }
    
    .input-area, .controls {
        /* Ensure these elements stay visible */
        flex-shrink: 0;
    }
    
    /* NEW: Prevent keyboard from hiding input on mobile */
    .input-area {
        padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
}

    </style>
</head>
<body>
    <div class="awareness-level">
        <span class="consciousness-indicator consciousness-medium" id="consciousness-dot"></span>
        <span id="awareness-text">Presence: Medium</span>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <!-- Mental Health Assessment Modals -->
    <div class="assessment-modal" id="stress-modal">
        <div class="assessment-content">
            <h3>Stress Assessment</h3>
            <div id="stress-question-container">
                <!-- Questions will be populated here -->
            </div>
            <div class="assessment-options" id="stress-options">
                <!-- Options will be populated here -->
            </div>
            <div class="timer-controls">
                <button class="timer-btn secondary" id="cancel-stress-assessment">Cancel</button>
                <button class="timer-btn" id="next-stress-question">Next</button>
            </div>
        </div>
    </div>
    
    <div class="assessment-modal" id="anxiety-modal">
        <div class="assessment-content">
            <h3>Anxiety Assessment</h3>
            <div id="anxiety-question-container">
                <!-- Questions will be populated here -->
            </div>
            <div class="assessment-options" id="anxiety-options">
                <!-- Options will be populated here -->
            </div>
            <div class="timer-controls">
                <button class="timer-btn secondary" id="cancel-anxiety-assessment">Cancel</button>
                <button class="timer-btn" id="next-anxiety-question">Next</button>
            </div>
        </div>
    </div>
    
    <div class="assessment-modal" id="depression-modal">
        <div class="assessment-content">
            <h3>Depression Assessment</h3>
            <div id="depression-question-container">
                <!-- Questions will be populated here -->
            </div>
            <div class="assessment-options" id="depression-options">
                <!-- Options will be populated here -->
            </div>
            <div class="timer-controls">
                <button class="timer-btn secondary" id="cancel-depression-assessment">Cancel</button>
                <button class="timer-btn" id="next-depression-question">Next</button>
            </div>
        </div>
    </div>
    
    <!-- Meditation Timer -->
    <div class="meditation-timer" id="meditation-timer">
        <h3>Mindfulness Meditation</h3>
        <div class="breathing-animation"></div>
        <div class="timer-display" id="timer-display">10:00</div>
        <div class="timer-controls">
            <button class="timer-btn secondary" id="pause-timer">Pause</button>
            <button class="timer-btn" id="stop-timer">Stop</button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="close-modal" id="close-settings">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Self-Awareness Mode</label>
                    <select class="form-input" id="awareness-mode">
                        <option value="basic">Basic</option>
                        <option value="advanced">Advanced</option>
                        <option value="therapeutic">Therapeutic</option>
                    </select>
                    <div class="form-help">Controls the depth of self-awareness analysis</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Dynalist Integration</label>
                    <div>
                        <span class="dynalist-status dynalist-enabled"></span>
                        <span>Connected to Dynalist</span>
                    </div>
                    <div class="form-help">Your thoughts are automatically saved to Dynalist</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Daily Reminders</label>
                    <input type="checkbox" id="daily-reminders" checked>
                    <label for="daily-reminders">Enable daily check-in reminders</label>
                </div>
                <div class="form-group">
                    <label class="form-label">Privacy Level</label>
                    <select class="form-input" id="privacy-level">
                        <option value="high">High (Local storage only)</option>
                        <option value="medium">Medium (Encrypted cloud)</option>
                        <option value="low">Low (Standard cloud)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-settings">Cancel</button>
                <button class="btn btn-primary" id="save-settings">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Export Modal -->
    <div class="modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Export Data</h3>
                <button class="close-modal" id="close-export">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Export Format</label>
                    <select class="form-input" id="export-format">
                        <option value="text">Plain Text</option>
                        <option value="json">JSON Data</option>
                        <option value="csv">CSV Spreadsheet</option>
                        <option value="pdf">PDF Document</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Include</label>
                    <div>
                        <input type="checkbox" id="include-timestamps" checked>
                        <label for="include-timestamps">Timestamps</label>
                    </div>
                    <div>
                        <input type="checkbox" id="include-stats" checked>
                        <label for="include-stats">Session Statistics</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-export">Cancel</button>
                <button class="btn btn-primary" id="confirm-export">Export</button>
            </div>
        </div>
    </div>
    
    <!-- Import Modal -->
    <div class="modal" id="import-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Import Data</h3>
                <button class="close-modal" id="close-import">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select File to Import</label>
                    <input type="file" id="import-file" class="form-input" accept=".txt,.json,.csv,.html">
                    <div class="form-help">Supported formats: TXT, JSON, CSV, HTML (from previous exports)</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Import Options</label>
                    <div>
                        <input type="checkbox" id="replace-chat" checked>
                        <label for="replace-chat">Replace current chat (uncheck to append)</label>
                    </div>
                    <div>
                        <input type="checkbox" id="import-timestamps" checked>
                        <label for="import-timestamps">Import timestamps</label>
                    </div>
                </div>
                <div id="import-preview" style="display: none; margin-top: 15px;">
                    <h4>Preview</h4>
                    <div id="preview-content" style="max-height: 200px; overflow-y: auto; border: 1px solid #e0e6ff; padding: 10px; border-radius: 5px; background: #f8f9ff;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-import">Cancel</button>
                <button class="btn btn-primary" id="confirm-import" disabled>Import</button>
            </div>
        </div>
    </div>
    
    <!-- Dynalist Settings Modal -->
    <div class="modal" id="dynalist-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dynalist Settings</h3>
                <button class="close-modal" id="close-dynalist">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="dynalist-token">API Token</label>
                    <input type="password" id="dynalist-token" class="form-input" placeholder="Enter your Dynalist API token">
                    <div class="form-help">
                        Get your API token from: <a href="https://dynalist.io/developer" target="_blank">https://dynalist.io/developer</a>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="dynalist-doc-id">Document ID (Optional)</label>
                    <input type="text" id="dynalist-doc-id" class="form-input" placeholder="Leave empty to create new document each day">
                    <div class="form-help">
                        If specified, all exports will go to this document. Leave empty to create a new document for each day.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Current Status</label>
                    <div id="dynalist-status-display">
                        <span class="dynalist-status dynalist-disabled" id="dynalist-status-icon"></span>
                        <span id="dynalist-status-text">Not configured</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="test-connection">Test Connection</button>
                <button class="btn btn-primary" id="save-dynalist">Save Settings</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <header>
            <div class="header-left">
                <h1>Self-Awareness Workflow Assistant</h1>
                <div class="subtitle">Your AI companion for mindfulness, mental health, and personal growth</div>
            </div>
            <div class="header-right">
                <div class="toggle-container">
                    <span class="toggle-text">Self-Awareness Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="awareness-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-container">
                    <span class="toggle-text">Self-Talk Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="self-talk-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="status-indicator" id="chatbot-status">ON</div>
            </div>
        </header>
        
        <div class="search-container">
            <input type="text" id="search-input" placeholder="Search your thoughts and insights...">
            <button id="search-btn">Search</button>
        </div>
        
        <div class="main-content">
            <button class="sidebar-toggle" id="sidebar-toggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="workflow-guide" id="workflow-guide">
                <div class="guide-header">
                    <h2>Self-Awareness Workflow</h2>
                    <button class="toggle-guide" id="toggle-guide">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <div class="guide-content">
                    <div class="workflow-step active" id="step-1">
                        <div class="step-header">
                            <div class="step-title">Mindful Check-in</div>
                            <div class="step-status">Current</div>
                        </div>
                        <div class="step-description">Take a moment to notice your thoughts and feelings without judgment.</div>
                        <div class="step-timer">Suggested: 5 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" id="start-step-1">Start</button>
                            <button class="step-btn skip" id="skip-step-1">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-2">
                        <div class="step-header">
                            <div class="step-title">Thought Journaling</div>
                            <div class="step-status">Next</div>
                        </div>
                        <div class="step-description">Record your current thoughts and identify patterns.</div>
                        <div class="step-timer">Suggested: 10 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" id="start-step-2">Start</button>
                            <button class="step-btn skip" id="skip-step-2">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-3">
                        <div class="step-header">
                            <div class="step-title">Emotion Tracking</div>
                            <div class="step-status">Upcoming</div>
                        </div>
                        <div class="step-description">Identify and label your current emotional state.</div>
                        <div class="step-timer">Suggested: 3 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" id="start-step-3">Start</button>
                            <button class="step-btn skip" id="skip-step-3">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-4">
                        <div class="step-header">
                            <div class="step-title">Values Alignment</div>
                            <div class="step-status">Upcoming</div>
                        </div>
                        <div class="step-description">Reflect on how your actions align with your core values.</div>
                        <div class="step-timer">Suggested: 7 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" id="start-step-4">Start</button>
                            <button class="step-btn skip" id="skip-step-4">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-5">
                        <div class="step-header">
                            <div class="step-title">Gratitude Practice</div>
                            <div class="step-status">Upcoming</div>
                        </div>
                        <div class="step-description">Acknowledge three things you're grateful for today.</div>
                        <div class="step-timer">Suggested: 3 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" id="start-step-5">Start</button>
                            <button class="step-btn skip" id="skip-step-5">Skip</button>
                        </div>
                    </div>
                    
                    <div class="crisis-resources">
                        <h4>Crisis Resources</h4>
                        <ul>
                            <li>National Suicide Prevention Lifeline: <a href="tel:988">988</a></li>
                            <li>Crisis Text Line: Text HOME to <a href="sms:741741">741741</a></li>
                            <li>Substance Abuse and Mental Health Services Administration (SAMHSA) Helpline: <a href="tel:1-800-662-4357">1-800-662-4357</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="chat-section">
                <div class="chat-container" id="chat-container">
                    <!-- UPDATED: User messages on left, AI messages on right -->
                    <div class="message user-message">
                        <div class="message-actions">
                            <button class="action-btn edit-message"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-message"><i class="fas fa-trash"></i></button>
                        </div>
                        I'm feeling a bit anxious today. I have a lot on my mind with work deadlines.
                        <div class="timestamp user-timestamp">Today, 10:32 AM</div>
                    </div>
                    
                    <div class="message app-message self-aware">
                        <div class="message-actions">
                            <button class="action-btn edit-message"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-message"><i class="fas fa-trash"></i></button>
                        </div>
                        <span class="awareness-badge">AI</span>
                        I notice you mentioned feeling anxious about work deadlines. Would you like to try a quick breathing exercise to help center yourself, or would you prefer to talk through what's specifically concerning you?
                        <div class="mental-health-indicator">
                            <span>Anxiety Level:</span>
                            <div class="health-bar">
                                <div class="health-level health-medium"></div>
                            </div>
                        </div>
                        <div class="timestamp app-timestamp">Today, 10:33 AM</div>
                    </div>
                    
                    <div class="message user-message self-aware">
                        <div class="message-actions">
                            <button class="action-btn edit-message"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-message"><i class="fas fa-trash"></i></button>
                        </div>
                        <span class="awareness-badge">Self-Aware</span>
                        Actually, I think I need to break down these deadlines into smaller tasks. I'm feeling overwhelmed because I'm looking at everything at once.
                        <div class="mood-indicator">
                            <span class="mood-dot mood-negative"></span>
                            <span>Feeling: Overwhelmed</span>
                        </div>
                        <div class="timestamp user-timestamp">Today, 10:34 AM</div>
                    </div>
                    
                    <div class="message app-message">
                        <div class="message-actions">
                            <button class="action-btn edit-message"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete-message"><i class="fas fa-trash"></i></button>
                        </div>
                        That's a great insight! Breaking large tasks into smaller, manageable pieces is an effective strategy. Would you like me to help you create a step-by-step plan for your deadlines?
                        <div class="timestamp app-timestamp">Today, 10:35 AM</div>
                    </div>
                    
                    <div class="typing-indicator" id="typing-indicator">
                        <i class="fas fa-circle-notch fa-spin"></i> Assistant is typing...
                    </div>
                </div>
                
                <div class="input-area">
                    <input type="text" id="user-input" placeholder="Share your thoughts, feelings, or concerns...">
                    <button id="send-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
                
                <div class="controls">
                    <button class="control-btn" id="mindful-checkin">
                        <i class="fas fa-brain"></i> Mindful Check-in
                    </button>
                    <button class="control-btn" id="stress-assessment">
                        <i class="fas fa-tachometer-alt"></i> Stress Check
                    </button>
                    <button class="control-btn" id="anxiety-assessment">
                        <i class="fas fa-heartbeat"></i> Anxiety Check
                    </button>
                    <button class="control-btn" id="depression-assessment">
                        <i class="fas fa-cloud"></i> Mood Check
                    </button>
                    <button class="control-btn" id="start-meditation">
                        <i class="fas fa-spa"></i> Meditation
                    </button>
                    <button class="control-btn" id="cbt-exercise">
                        <i class="fas fa-clipboard-list"></i> CBT Exercise
                    </button>
                    <button class="control-btn" id="clear-chat">
                        <i class="fas fa-trash"></i> Clear Chat
                    </button>
                    <button class="control-btn" id="import-data">
                        <i class="fas fa-upload"></i> Import
                    </button>
                    <button class="control-btn" id="export-data">
                        <i class="fas fa-download"></i> Export
                    </button>
                    <button class="control-btn" id="export-dynalist">
                        <i class="fas fa-external-link-alt"></i> Export to Dynalist
                    </button>
                    <button class="control-btn" id="dynalist-settings">
                        <i class="fas fa-cog"></i> Dynalist Settings
                    </button>
                    <button class="control-btn" id="settings-btn">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                </div>
                
                <div class="stats">
                    <div class="stat-item">
                        <span>Mindful Minutes</span>
                        <span class="stat-value">27</span>
                    </div>
                    <div class="stat-item">
                        <span>Check-ins</span>
                        <span class="stat-value">14</span>
                    </div>
                    <div class="stat-item">
                        <span>Current Streak</span>
                        <span class="stat-value">5 days</span>
                    </div>
                    <div class="stat-item">
                        <span>Insights</span>
                        <span class="stat-value">23</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>Copyright 2005 for Dr. Wen-Ming Yang Lab. v1.5 | Self-Awareness Workflow Assistant | Designed for mental wellness and personal growth</p>
    </footer>

    <script>
        // Global variables
        let chatbotEnabled = true;
        let selfTalkMode = false;
        let dynalistApiKey = '';
        let dynalistDocId = '';
        
        // DOM Elements
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const toggleGuide = document.getElementById('toggle-guide');
        const workflowGuide = document.getElementById('workflow-guide');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const typingIndicator = document.getElementById('typing-indicator');
        const awarenessToggle = document.getElementById('awareness-toggle');
        const selfTalkToggle = document.getElementById('self-talk-toggle');
        const chatbotStatus = document.getElementById('chatbot-status');
        const consciousnessDot = document.getElementById('consciousness-dot');
        const awarenessText = document.getElementById('awareness-text');
        const notification = document.getElementById('notification');
        const clearChatBtn = document.getElementById('clear-chat');
        
        // Modal Elements
        const settingsModal = document.getElementById('settings-modal');
        const exportModal = document.getElementById('export-modal');
        const importModal = document.getElementById('import-modal');
        const dynalistModal = document.getElementById('dynalist-modal');
        const closeSettings = document.getElementById('close-settings');
        const closeExport = document.getElementById('close-export');
        const closeImport = document.getElementById('close-import');
        const closeDynalist = document.getElementById('close-dynalist');
        const cancelSettings = document.getElementById('cancel-settings');
        const cancelExport = document.getElementById('cancel-export');
        const cancelImport = document.getElementById('cancel-import');
        const saveSettings = document.getElementById('save-settings');
        const confirmExport = document.getElementById('confirm-export');
        const confirmImport = document.getElementById('confirm-import');
        const settingsBtn = document.getElementById('settings-btn');
        const importBtn = document.getElementById('import-data');
        const exportBtn = document.getElementById('export-data');
        const exportDynalistBtn = document.getElementById('export-dynalist');
        const dynalistSettingsBtn = document.getElementById('dynalist-settings');
        
        // Import Elements
        const importFile = document.getElementById('import-file');
        const replaceChat = document.getElementById('replace-chat');
        const importTimestamps = document.getElementById('import-timestamps');
        const importPreview = document.getElementById('import-preview');
        const previewContent = document.getElementById('preview-content');
        
        // Assessment Elements
        const stressAssessmentBtn = document.getElementById('stress-assessment');
        const anxietyAssessmentBtn = document.getElementById('anxiety-assessment');
        const depressionAssessmentBtn = document.getElementById('depression-assessment');
        const stressModal = document.getElementById('stress-modal');
        const anxietyModal = document.getElementById('anxiety-modal');
        const depressionModal = document.getElementById('depression-modal');
        const cancelStressAssessment = document.getElementById('cancel-stress-assessment');
        const cancelAnxietyAssessment = document.getElementById('cancel-anxiety-assessment');
        const cancelDepressionAssessment = document.getElementById('cancel-depression-assessment');
        
        // Meditation Elements
        const meditationTimer = document.getElementById('meditation-timer');
        const startMeditationBtn = document.getElementById('start-meditation');
        const timerDisplay = document.getElementById('timer-display');
        const pauseTimerBtn = document.getElementById('pause-timer');
        const stopTimerBtn = document.getElementById('stop-timer');
        
        // Dynalist Elements
        const dynalistToken = document.getElementById('dynalist-token');
        const dynalistDocIdInput = document.getElementById('dynalist-doc-id');
        const dynalistStatusIcon = document.getElementById('dynalist-status-icon');
        const dynalistStatusText = document.getElementById('dynalist-status-text');
        const testConnectionBtn = document.getElementById('test-connection');
        const saveDynalistBtn = document.getElementById('save-dynalist');
        
        // Workflow step elements
        const workflowSteps = document.querySelectorAll('.workflow-step');
        
        // Assessment questions
        const stressQuestions = [
            {
                question: "How often have you felt nervous or stressed in the past week?",
                options: [
                    "Not at all",
                    "Several days",
                    "More than half the days",
                    "Nearly every day"
                ]
            },
            {
                question: "How often have you felt unable to control the important things in your life?",
                options: [
                    "Not at all",
                    "Several days",
                    "More than half the days",
                    "Nearly every day"
                ]
            },
            {
                question: "How often have you felt difficulties were piling up so high that you could not overcome them?",
                options: [
                    "Not at all",
                    "Several days",
                    "More than half the days",
                    "Nearly every day"
                ]
            }
        ];
        
        const anxietyQuestions = [
            {
                question: "How often have you felt nervous, anxious, or on edge in the past week?",
                options: [
                    "Not at all",
                    "Several days",
                    "More than half the days",
                    "Nearly every day"
                ]
            },
            {
                question: "How often have you been unable to stop or control worrying?",
                options: [
                    "Not at all",
                    "Several days",
                    "More than half the days",
                    "Nearly every day"
                ]
            },
            {
                question: "How often have you worried too much about different things?",
                options: [
                    "Not at all",
                    "Several days",
                    "More than half the days",
                    "Nearly every day"
                ]
            }
        ];
        
        const depressionQuestions = [
            {
                question: "How often have you felt down, depressed, or hopeless in the past week?",
                options: [
                    "Not at all",
                    "Several days",
                    "More than half the days",
                    "Nearly every day"
                ]
            },
            {
                question: "How often have you had little interest or pleasure in doing things?",
                options: [
                    "Not at all",
                    "Several days",
                    "More than half the days",
                    "Nearly every day"
                ]
            },
            {
                question: "How often have you felt tired or had little energy?",
                options: [
                    "Not at all",
                    "Several days",
                    "More than half the days",
                    "Nearly every day"
                ]
            }
        ];
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial awareness level
            updateAwarenessLevel('medium');
            
            // Load Dynalist settings
            loadDynalistSettings();
            
            // Add event listeners
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            toggleGuide.addEventListener('click', toggleWorkflowGuide);
            sidebarToggle.addEventListener('click', toggleSidebar);
            
            // Modal event listeners
            settingsBtn.addEventListener('click', () => openModal(settingsModal));
            importBtn.addEventListener('click', () => openModal(importModal));
            exportBtn.addEventListener('click', () => openModal(exportModal));
            exportDynalistBtn.addEventListener('click', sendToDynalist);
            dynalistSettingsBtn.addEventListener('click', () => openModal(dynalistModal));
            closeSettings.addEventListener('click', () => closeModal(settingsModal));
            closeImport.addEventListener('click', () => closeModal(importModal));
            closeExport.addEventListener('click', () => closeModal(exportModal));
            closeDynalist.addEventListener('click', () => closeModal(dynalistModal));
            cancelSettings.addEventListener('click', () => closeModal(settingsModal));
            cancelImport.addEventListener('click', () => closeModal(importModal));
            cancelExport.addEventListener('click', () => closeModal(exportModal));
            saveSettings.addEventListener('click', saveSettingsHandler);
            confirmImport.addEventListener('click', importDataHandler);
            confirmExport.addEventListener('click', exportDataHandler);
            
            // Import file selection event
            importFile.addEventListener('change', handleFileSelect);
            
            // Assessment event listeners
            stressAssessmentBtn.addEventListener('click', () => startAssessment('stress'));
            anxietyAssessmentBtn.addEventListener('click', () => startAssessment('anxiety'));
            depressionAssessmentBtn.addEventListener('click', () => startAssessment('depression'));
            cancelStressAssessment.addEventListener('click', () => closeModal(stressModal));
            cancelAnxietyAssessment.addEventListener('click', () => closeModal(anxietyModal));
            cancelDepressionAssessment.addEventListener('click', () => closeModal(depressionModal));
            
            // Meditation event listeners
            startMeditationBtn.addEventListener('click', startMeditation);
            pauseTimerBtn.addEventListener('click', pauseTimer);
            stopTimerBtn.addEventListener('click', stopTimer);
            
            // Dynalist event listeners
            testConnectionBtn.addEventListener('click', testDynalistConnection);
            saveDynalistBtn.addEventListener('click', saveDynalistSettings);
            
            // Workflow step event listeners
            document.getElementById('start-step-1').addEventListener('click', () => startWorkflowStep(1));
            document.getElementById('skip-step-1').addEventListener('click', () => skipWorkflowStep(1));
            document.getElementById('start-step-2').addEventListener('click', () => startWorkflowStep(2));
            document.getElementById('skip-step-2').addEventListener('click', () => skipWorkflowStep(2));
            document.getElementById('start-step-3').addEventListener('click', () => startWorkflowStep(3));
            document.getElementById('skip-step-3').addEventListener('click', () => skipWorkflowStep(3));
            document.getElementById('start-step-4').addEventListener('click', () => startWorkflowStep(4));
            document.getElementById('skip-step-4').addEventListener('click', () => skipWorkflowStep(4));
            document.getElementById('start-step-5').addEventListener('click', () => startWorkflowStep(5));
            document.getElementById('skip-step-5').addEventListener('click', () => skipWorkflowStep(5));
            
            // Message action event listeners
            document.addEventListener('click', function(e) {
                if (e.target.closest('.edit-message')) {
                    editMessage(e.target.closest('.message'));
                } else if (e.target.closest('.delete-message')) {
                    deleteMessage(e.target.closest('.message'));
                }
            });
            
            // Clear chat button
            clearChatBtn.addEventListener('click', clearChat);
            
            // Awareness toggle
            awarenessToggle.addEventListener('change', function() {
                chatbotEnabled = this.checked;
                chatbotStatus.textContent = chatbotEnabled ? 'ON' : 'OFF';
                chatbotStatus.style.background = chatbotEnabled ? 
                    'rgba(76, 175, 80, 0.3)' : 'rgba(244, 67, 54, 0.3)';
                
                if (chatbotEnabled) {
                    showNotification('Self-Awareness Mode activated', 'success');
                    updateAwarenessLevel('medium');
                } else {
                    showNotification('Self-Awareness Mode deactivated', 'error');
                    updateAwarenessLevel('low');
                }
            });
            
            // Self-talk toggle - FIXED: Now properly toggles on and off
            selfTalkToggle.addEventListener('change', function() {
                selfTalkMode = this.checked;
                
                if (selfTalkMode) {
                    showNotification('Self-Talk Mode activated. AI responses are disabled.', 'success');
                    chatbotStatus.innerHTML = 'SELF-TALK <span class="self-talk-indicator">ON</span>';
                    chatbotStatus.style.background = 'rgba(255, 152, 0, 0.3)';
                } else {
                    showNotification('Self-Talk Mode deactivated. AI responses are enabled.', 'success');
                    chatbotStatus.textContent = chatbotEnabled ? 'ON' : 'OFF';
                    chatbotStatus.style.background = chatbotEnabled ? 
                        'rgba(76, 175, 80, 0.3)' : 'rgba(244, 67, 54, 0.3)';
                    
                    // Remove the self-talk indicator
                    const indicator = chatbotStatus.querySelector('.self-talk-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            });
            
            // Other control buttons
            document.getElementById('mindful-checkin').addEventListener('click', startMindfulCheckin);
            document.getElementById('cbt-exercise').addEventListener('click', startCBTExercise);
        });
        
        // Toggle workflow guide
        function toggleWorkflowGuide() {
            workflowGuide.classList.toggle('collapsed');
            const icon = toggleGuide.querySelector('i');
            if (workflowGuide.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
        }
        
        // Toggle sidebar on mobile
        function toggleSidebar() {
            workflowGuide.classList.toggle('mobile-hidden');
        }
        
        // Send message function - UPDATED: Respects selfTalkMode
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;
            
            // Add user message to chat
            addMessageToChat(message, 'user');
            
            // Clear input
            userInput.value = '';
            
            // Only show typing indicator and generate response if chatbot is enabled AND self-talk mode is off
            if (chatbotEnabled && !selfTalkMode) {
                typingIndicator.style.display = 'flex';
                
                // Simulate AI response after delay
                setTimeout(() => {
                    typingIndicator.style.display = 'none';
                    const responses = [
                        "I hear you. How is that making you feel physically?",
                        "That's an interesting observation. What thoughts come up when you notice that?",
                        "Thank you for sharing. Would you like to explore this feeling further?",
                        "I notice some tension in how you expressed that. Would you like to try a quick relaxation technique?",
                        "That sounds challenging. What's one small step you could take to address this?",
                        "I appreciate your honesty. How long have you been feeling this way?"
                    ];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    addMessageToChat(randomResponse, 'app');
                }, 2000);
            }
            // If self-talk mode is on, no AI response will be generated
        }
        
        // Add message to chat
// Add message to chat - UPDATED with mobile improvements
function addMessageToChat(message, sender, isSelfAware = false) {
    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    
    if (sender === 'user') {
        messageDiv.classList.add('user-message');
        // Randomly add self-awareness badge to some user messages
        if (isSelfAware || Math.random() > 0.7) {
            messageDiv.classList.add('self-aware');
            const badge = document.createElement('span');
            badge.classList.add('awareness-badge');
            badge.textContent = 'Self-Aware';
            messageDiv.appendChild(badge);
            
            // Add mood indicator
            const moods = ['Overwhelmed', 'Calm', 'Anxious', 'Content', 'Frustrated'];
            const randomMood = moods[Math.floor(Math.random() * moods.length)];
            
            const moodIndicator = document.createElement('div');
            moodIndicator.classList.add('mood-indicator');
            
            const moodDot = document.createElement('span');
            moodDot.classList.add('mood-dot');
            if (randomMood === 'Overwhelmed' || randomMood === 'Anxious' || randomMood === 'Frustrated') {
                moodDot.classList.add('mood-negative');
            } else if (randomMood === 'Calm' || randomMood === 'Content') {
                moodDot.classList.add('mood-positive');
            } else {
                moodDot.classList.add('mood-neutral');
            }
            
            moodIndicator.appendChild(moodDot);
            moodIndicator.appendChild(document.createTextNode(`Feeling: ${randomMood}`));
            messageDiv.appendChild(moodIndicator);
        }
    } else {
        messageDiv.classList.add('app-message');
        // Add AI badge to app messages
        const badge = document.createElement('span');
        badge.classList.add('awareness-badge');
        badge.textContent = 'AI';
        messageDiv.appendChild(badge);
        
        // Randomly add mental health indicators
        if (Math.random() > 0.5) {
            const mentalHealthIndicator = document.createElement('div');
            mentalHealthIndicator.classList.add('mental-health-indicator');
            
            const levels = ['low', 'medium', 'high', 'very-high'];
            const randomLevel = levels[Math.floor(Math.random() * levels.length)];
            
            mentalHealthIndicator.innerHTML = `
                <span>Stress Level:</span>
                <div class="health-bar">
                    <div class="health-level health-${randomLevel}"></div>
                </div>
            `;
            messageDiv.appendChild(mentalHealthIndicator);
        }
    }
    
    // Add message actions
    const messageActions = document.createElement('div');
    messageActions.classList.add('message-actions');
    messageActions.innerHTML = `
        <button class="action-btn edit-message"><i class="fas fa-edit"></i></button>
        <button class="action-btn delete-message"><i class="fas fa-trash"></i></button>
    `;
    messageDiv.appendChild(messageActions);
    
    // Add message text
    const messageText = document.createElement('div');
    messageText.textContent = message;
    messageDiv.appendChild(messageText);
    
    // Add timestamp
    const timestamp = document.createElement('div');
    timestamp.classList.add('timestamp');
    if (sender === 'user') {
        timestamp.classList.add('user-timestamp');
    } else {
        timestamp.classList.add('app-timestamp');
    }
    
    const now = new Date();
    timestamp.textContent = `Today, ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
    messageDiv.appendChild(timestamp);
    
    // Add to chat container
    chatContainer.appendChild(messageDiv);
    
    // IMPROVED: Scroll to bottom with mobile consideration
    scrollToBottom();
    
    // Return the created message element for potential further manipulation
    return messageDiv;
}

// NEW: Improved scroll function for mobile
function scrollToBottom() {
    // Use a small timeout to ensure DOM is updated
    setTimeout(() => {
        // Smooth scroll to bottom
        chatContainer.scrollTo({
            top: chatContainer.scrollHeight,
            behavior: 'smooth'
        });
        
        // Additional mobile fix: ensure input is visible after new messages
        if (window.innerWidth <= 768) {
            // Briefly focus and blur to ensure input area stays in view
            userInput.focus();
            setTimeout(() => {
                userInput.blur();
            }, 100);
        }
    }, 100);
}

// NEW: Handle mobile keyboard appearance
function setupMobileKeyboardHandling() {
    if (window.innerWidth <= 768) {
        let initialViewportHeight = window.innerHeight;
        let keyboardOpen = false;
        
        window.addEventListener('resize', function() {
            // Check if keyboard is open (viewport height decreased significantly)
            if (window.innerHeight < initialViewportHeight * 0.7) {
                if (!keyboardOpen) {
                    keyboardOpen = true;
                    // Keyboard opened, adjust layout if needed
                    setTimeout(() => {
                        userInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            } else {
                if (keyboardOpen) {
                    keyboardOpen = false;
                    // Keyboard closed, restore scroll position
                    setTimeout(scrollToBottom, 100);
                }
            }
        });
        
        // Update initial height on orientation change
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                initialViewportHeight = window.innerHeight;
                keyboardOpen = false;
                // Re-adjust layout after orientation change
                setTimeout(scrollToBottom, 500);
            }, 500);
        });
        
        // Also handle focus events for better mobile experience
        userInput.addEventListener('focus', function() {
            setTimeout(() => {
                this.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        });
    }
}

// Call this in your DOMContentLoaded event
document.addEventListener('DOMContentLoaded', function() {
    // ... your existing initialization code ...
    
    setupMobileKeyboardHandling();
    
    // Additional mobile optimization: prevent zoom on input focus
    if (window.innerWidth <= 768) {
        userInput.addEventListener('focus', function() {
            // Set viewport to prevent zoom
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
            }
        });
        
        userInput.addEventListener('blur', function() {
            // Restore normal viewport
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
            }
        });
    }
});
        
        // Edit message
        function editMessage(messageElement) {
            const messageText = messageElement.querySelector('div:not(.message-actions):not(.timestamp):not(.mood-indicator):not(.mental-health-indicator)');
            const originalText = messageText.textContent;
            
            const textarea = document.createElement('textarea');
            textarea.classList.add('edit-textarea');
            textarea.value = originalText;
            
            messageText.innerHTML = '';
            messageText.appendChild(textarea);
            textarea.focus();
            
            textarea.addEventListener('blur', function() {
                messageText.textContent = textarea.value;
            });
            
            textarea.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    messageText.textContent = textarea.value;
                }
            });
            
            showNotification('Click outside the text area or press Ctrl+Enter to save changes');
        }
        
        // Delete message
        function deleteMessage(messageElement) {
            if (confirm('Are you sure you want to delete this message?')) {
                messageElement.remove();
                showNotification('Message deleted');
            }
        }
        
        // Clear chat - NEW: Clear all messages except the initial AI message
        function clearChat() {
            if (confirm("Are you sure you want to clear the chat? This will remove all messages except the initial greeting.")) {
                const messages = chatContainer.querySelectorAll('.message');
                messages.forEach(message => {
                    // Keep only the first AI message (the greeting)
                    if (!message.textContent.includes("Hello! I'm your Self-Awareness Workflow Assistant")) {
                        message.remove();
                    }
                });
                showNotification('Chat cleared successfully', 'success');
            }
        }
        
        // Update awareness level
        function updateAwarenessLevel(level) {
            consciousnessDot.className = 'consciousness-indicator';
            
            if (level === 'high') {
                consciousnessDot.classList.add('consciousness-high');
                awarenessText.textContent = 'Presence: High';
            } else if (level === 'medium') {
                consciousnessDot.classList.add('consciousness-medium');
                awarenessText.textContent = 'Presence: Medium';
            } else {
                consciousnessDot.classList.add('consciousness-low');
                awarenessText.textContent = 'Presence: Low';
            }
        }
        
        // Show notification
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.classList.add('error');
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Modal functions
        function openModal(modal) {
            modal.style.display = 'flex';
        }
        
        function closeModal(modal) {
            modal.style.display = 'none';
        }
        
        // Save settings
        function saveSettingsHandler() {
            showNotification('Settings saved successfully');
            closeModal(settingsModal);
        }
        
        // Handle file selection for import
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                confirmImport.disabled = true;
                importPreview.style.display = 'none';
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                previewImportContent(content, file.name);
                confirmImport.disabled = false;
            };
            
            reader.onerror = function() {
                showNotification('Error reading file', 'error');
                confirmImport.disabled = true;
            };
            
            reader.readAsText(file);
        }

        // Preview import content
        function previewImportContent(content, filename) {
            previewContent.innerHTML = '';
            importPreview.style.display = 'block';
            
            // Determine file type from extension
            const fileExt = filename.split('.').pop().toLowerCase();
            
            try {
                switch(fileExt) {
                    case 'json':
                        const jsonData = JSON.parse(content);
                        if (jsonData.messages && Array.isArray(jsonData.messages)) {
                            previewContent.innerHTML = `<p><strong>Format:</strong> JSON Export</p>`;
                            previewContent.innerHTML += `<p><strong>Messages:</strong> ${jsonData.messages.length}</p>`;
                            if (jsonData.exportDate) {
                                previewContent.innerHTML += `<p><strong>Exported:</strong> ${new Date(jsonData.exportDate).toLocaleString()}</p>`;
                            }
                            // Show first few messages as preview
                            jsonData.messages.slice(0, 3).forEach(msg => {
                                previewContent.innerHTML += `<div style="margin: 5px 0; padding: 5px; background: white; border-radius: 3px;">
                                    <strong>${msg.sender}:</strong> ${msg.text.substring(0, 100)}${msg.text.length > 100 ? '...' : ''}
                                </div>`;
                            });
                        }
                        break;
                        
                    case 'csv':
                        previewContent.innerHTML = `<p><strong>Format:</strong> CSV Export</p>`;
                        const lines = content.split('\n').slice(0, 6); // Show first 6 lines
                        lines.forEach(line => {
                            previewContent.innerHTML += `<div style="font-family: monospace; margin: 2px 0;">${line}</div>`;
                        });
                        break;
                        
                    case 'html':
                        previewContent.innerHTML = `<p><strong>Format:</strong> HTML Export</p>`;
                        // Extract text content from HTML
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = content;
                        const textContent = tempDiv.textContent || tempDiv.innerText || '';
                        previewContent.innerHTML += `<p>${textContent.substring(0, 200)}${textContent.length > 200 ? '...' : ''}</p>`;
                        break;
                        
                    default: // txt
                        previewContent.innerHTML = `<p><strong>Format:</strong> Text Export</p>`;
                        previewContent.innerHTML += `<p>${content.substring(0, 200)}${content.length > 200 ? '...' : ''}</p>`;
                }
            } catch (error) {
                previewContent.innerHTML = `<p style="color: red;">Error previewing file: ${error.message}</p>`;
                confirmImport.disabled = true;
            }
        }

        // Import data handler
        function importDataHandler() {
            const file = importFile.files[0];
            if (!file) {
                showNotification('Please select a file to import', 'error');
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                const fileExt = file.name.split('.').pop().toLowerCase();
                
                try {
                    const messages = parseImportFile(content, fileExt);
                    
                    if (messages && messages.length > 0) {
                        // Clear current chat if replace is selected
                        if (replaceChat.checked) {
                            const messagesToRemove = chatContainer.querySelectorAll('.message');
                            messagesToRemove.forEach(msg => msg.remove());
                        }
                        
// Add imported messages to chat
messages.forEach(msg => {
    addMessageToChat(msg.text, msg.sender, msg.selfAware || false);
});
                        
                        showNotification(`Successfully imported ${messages.length} messages`, 'success');
                        closeModal(importModal);
                        
                        // Reset file input
                        importFile.value = '';
                        confirmImport.disabled = true;
                        importPreview.style.display = 'none';
                    } else {
                        showNotification('No valid messages found in the file', 'error');
                    }
                } catch (error) {
                    showNotification(`Error importing file: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showNotification('Error reading file', 'error');
            };
            
            reader.readAsText(file);
        }

        // Parse different file formats
        function parseImportFile(content, fileExt) {
            switch(fileExt) {
                case 'json':
                    return parseJSONImport(content);
                case 'csv':
                    return parseCSVImport(content);
                case 'html':
                    return parseHTMLImport(content);
                default: // txt
                    return parseTXTImport(content);
            }
        }

        // Parse JSON import
        function parseJSONImport(content) {
            const data = JSON.parse(content);
            if (data.messages && Array.isArray(data.messages)) {
                return data.messages.map(msg => ({
                    text: msg.text,
                    sender: msg.sender,
                    selfAware: msg.selfAware || false,
                    timestamp: msg.timestamp
                }));
            }
            throw new Error('Invalid JSON format - no messages array found');
        }

        // Parse CSV import
        function parseCSVImport(content) {
            const lines = content.split('\n').filter(line => line.trim());
            const messages = [];
            
            // Skip header row
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                // Simple CSV parsing (for our specific export format)
                const match = line.match(/^"([^"]+)","([^"]*)","([^"]*)","([^"]*)"$/);
                if (match) {
                    const [, sender, text, timestamp, selfAware] = match;
                    messages.push({
                        text: text.replace(/""/g, '"'),
                        sender: sender === 'You' ? 'user' : 'assistant',
                        selfAware: selfAware === 'Yes',
                        timestamp: timestamp
                    });
                }
            }
            
            return messages;
        }

        // Parse HTML import
        function parseHTMLImport(content) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            const messages = [];
            const messageElements = tempDiv.querySelectorAll('.message');
            
            messageElements.forEach(element => {
                const senderClass = element.classList.contains('user-message') ? 'user' : 'assistant';
                const text = element.textContent.replace(/.*?:/, '').trim(); // Remove sender prefix
                
                messages.push({
                    text: text,
                    sender: senderClass,
                    selfAware: element.classList.contains('self-aware'),
                    timestamp: null
                });
            });
            
            return messages;
        }

        // Parse TXT import
        function parseTXTImport(content) {
            const lines = content.split('\n').filter(line => line.trim());
            const messages = [];
            let currentSender = null;
            let currentText = '';
            
            lines.forEach(line => {
                // Check if line starts with sender identifier
                if (line.startsWith('You:') || line.startsWith('Assistant:')) {
                    // Save previous message
                    if (currentSender && currentText) {
                        messages.push({
                            text: currentText.trim(),
                            sender: currentSender,
                            selfAware: false,
                            timestamp: null
                        });
                    }
                    
                    // Start new message
                    currentSender = line.startsWith('You:') ? 'user' : 'assistant';
                    currentText = line.substring(line.indexOf(':') + 1).trim();
                } else if (currentSender) {
                    // Continue current message
                    currentText += ' ' + line.trim();
                }
            });
            
            // Add the last message
            if (currentSender && currentText) {
                messages.push({
                    text: currentText.trim(),
                    sender: currentSender,
                    selfAware: false,
                    timestamp: null
                });
            }
            
            return messages;
        }
        
        // Export data - FIXED: Better message text extraction and PDF fix
        function exportDataHandler() {
            try {
                const format = document.getElementById('export-format').value;
                const includeTimestamps = document.getElementById('include-timestamps').checked;
                const includeStats = document.getElementById('include-stats').checked;
                
                console.log('Exporting with format:', format, 'timestamps:', includeTimestamps, 'stats:', includeStats);
                
                let content = "Self-Awareness Workflow Assistant Chat Export\n";
                content += "Generated on: " + new Date().toLocaleString() + "\n";
                content += "=============================================\n\n";
                
                // Add chat messages
                const messages = chatContainer.querySelectorAll('.message');
                messages.forEach(message => {
                    try {
                        const sender = message.classList.contains('user-message') ? 'You' : 'Assistant';
                        
                        // Get message text - improved extraction
                        let messageText = '';
                        
                        // Clone the message to work with a copy
                        const messageClone = message.cloneNode(true);
                        
                        // Remove all action buttons, timestamps, and indicators
                        const elementsToRemove = messageClone.querySelectorAll(
                            '.message-actions, .timestamp, .mood-indicator, .mental-health-indicator, .awareness-badge'
                        );
                        elementsToRemove.forEach(el => el.remove());
                        
                        // Get the remaining text content
                        messageText = messageClone.textContent.trim();
                        
                        // If still no text, try direct text extraction
                        if (!messageText) {
                            // Get all text nodes
                            const walker = document.createTreeWalker(
                                message,
                                NodeFilter.SHOW_TEXT,
                                null,
                                false
                            );
                            
                            let textNodes = [];
                            let node;
                            while (node = walker.nextNode()) {
                                textNodes.push(node.textContent);
                            }
                            messageText = textNodes.join(' ').trim();
                        }
                        
                        // Clean up the text (remove extra whitespace)
                        messageText = messageText.replace(/\s+/g, ' ').trim();
                        
                        let line = `${sender}: ${messageText}`;
                        
                        if (includeTimestamps) {
                            const timestampEl = message.querySelector('.timestamp');
                            const timestamp = timestampEl ? timestampEl.textContent : 'Unknown time';
                            line += ` [${timestamp}]`;
                        }
                        
                        content += line + '\n\n';
                    } catch (e) {
                        console.error('Error processing message:', e);
                        // Add a fallback entry for this message
                        content += `Error processing message\n\n`;
                    }
                });
                
                // Add session stats if requested
                if (includeStats) {
                    content += "\n--- SESSION STATISTICS ---\n";
                    const stats = document.querySelectorAll('.stat-item');
                    stats.forEach(stat => {
                        try {
                            const labelElement = stat.querySelector('span:first-child');
                            const valueElement = stat.querySelector('.stat-value');
                            
                            if (labelElement && valueElement) {
                                const label = labelElement.textContent;
                                const value = valueElement.textContent;
                                content += `${label}: ${value}\n`;
                            }
                        } catch (e) {
                            console.error('Error processing stat:', e);
                        }
                    });
                }
                
                // Create and download the file
                let blob, filename, mimeType;
                
                if (format === 'pdf') {
                    // For PDF, we'll create a simple HTML that can be printed as PDF
                    let htmlContent = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Self-Awareness Chat Export</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 20px; }
                                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                                .message { margin-bottom: 15px; padding: 10px; border-radius: 5px; }
                                .user-message { background: #f0f0f0; border-left: 4px solid #6e8efb; }
                                .assistant-message { background: #f8f8f8; border-left: 4px solid #a777e3; }
                                .timestamp { font-size: 0.8em; color: #666; margin-top: 5px; }
                                .stats { margin-top: 30px; padding: 15px; background: #f5f5f5; border-radius: 5px; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>Self-Awareness Workflow Assistant</h1>
                                <p>Chat Export - Generated on ${new Date().toLocaleString()}</p>
                            </div>
                            <div class="messages">
                    `;

                    // Add messages to HTML
                    messages.forEach(message => {
                        try {
                            const sender = message.classList.contains('user-message') ? 'You' : 'Assistant';
                            const messageClass = message.classList.contains('user-message') ? 'user-message' : 'assistant-message';
                            
                            // Get message text
                            let messageText = '';
                            const messageClone = message.cloneNode(true);
                            const elementsToRemove = messageClone.querySelectorAll(
                                '.message-actions, .timestamp, .mood-indicator, .mental-health-indicator, .awareness-badge'
                            );
                            elementsToRemove.forEach(el => el.remove());
                            messageText = messageClone.textContent.trim();
                            
                            if (!messageText) {
                                const walker = document.createTreeWalker(
                                    message,
                                    NodeFilter.SHOW_TEXT,
                                    null,
                                    false
                                );
                                let textNodes = [];
                                let node;
                                while (node = walker.nextNode()) {
                                    textNodes.push(node.textContent);
                                }
                                messageText = textNodes.join(' ').trim();
                            }
                            
                            messageText = messageText.replace(/\s+/g, ' ').trim();
                            
                            let timestampHtml = '';
                            if (includeTimestamps) {
                                const timestampEl = message.querySelector('.timestamp');
                                const timestamp = timestampEl ? timestampEl.textContent : 'Unknown time';
                                timestampHtml = `<div class="timestamp">${timestamp}</div>`;
                            }
                            
                            htmlContent += `
                                <div class="message ${messageClass}">
                                    <strong>${sender}:</strong> ${messageText}
                                    ${timestampHtml}
                                </div>
                            `;
                        } catch (e) {
                            console.error('Error processing message for PDF:', e);
                        }
                    });

                    // Add stats if requested
                    if (includeStats) {
                        htmlContent += `
                            </div>
                            <div class="stats">
                                <h3>Session Statistics</h3>
                                <ul>
                        `;
                        
                        const stats = document.querySelectorAll('.stat-item');
                        stats.forEach(stat => {
                            try {
                                const labelElement = stat.querySelector('span:first-child');
                                const valueElement = stat.querySelector('.stat-value');
                                
                                if (labelElement && valueElement) {
                                    const label = labelElement.textContent;
                                    const value = valueElement.textContent;
                                    htmlContent += `<li><strong>${label}:</strong> ${value}</li>`;
                                }
                            } catch (e) {
                                console.error('Error processing stat for PDF:', e);
                            }
                        });
                        
                        htmlContent += `
                                </ul>
                            </div>
                        `;
                    } else {
                        htmlContent += `</div>`;
                    }

                    htmlContent += `
                        </body>
                        </html>
                    `;

                    blob = new Blob([htmlContent], { type: 'text/html' });
                    filename = 'self-awareness-chat.html';
                    mimeType = 'text/html';
                    
                    // Show instructions for PDF
                    showNotification('HTML file generated. Use "Print as PDF" in your browser to save as PDF.', 'success');
                } else if (format === 'json') {
                    const messagesData = [];
                    messages.forEach(message => {
                        try {
                            const sender = message.classList.contains('user-message') ? 'user' : 'assistant';
                            
                            // Get message text using the same improved extraction
                            let messageText = '';
                            const messageClone = message.cloneNode(true);
                            const elementsToRemove = messageClone.querySelectorAll(
                                '.message-actions, .timestamp, .mood-indicator, .mental-health-indicator, .awareness-badge'
                            );
                            elementsToRemove.forEach(el => el.remove());
                            messageText = messageClone.textContent.trim();
                            
                            if (!messageText) {
                                const walker = document.createTreeWalker(
                                    message,
                                    NodeFilter.SHOW_TEXT,
                                    null,
                                    false
                                );
                                let textNodes = [];
                                let node;
                                while (node = walker.nextNode()) {
                                    textNodes.push(node.textContent);
                                }
                                messageText = textNodes.join(' ').trim();
                            }
                            
                            messageText = messageText.replace(/\s+/g, ' ').trim();
                            
                            const timestampEl = message.querySelector('.timestamp');
                            const timestamp = timestampEl ? timestampEl.textContent : 'Unknown time';
                            
                            messagesData.push({
                                sender: sender,
                                text: messageText,
                                timestamp: includeTimestamps ? timestamp : null,
                                selfAware: message.classList.contains('self-aware')
                            });
                        } catch (e) {
                            console.error('Error processing message for JSON:', e);
                        }
                    });
                    
                    const jsonContent = JSON.stringify({
                        exportDate: new Date().toISOString(),
                        messages: messagesData,
                        stats: includeStats ? getStatsData() : null
                    }, null, 2);
                    
                    blob = new Blob([jsonContent], { type: 'application/json' });
                    filename = 'self-awareness-chat.json';
                    mimeType = 'application/json';
                } else if (format === 'csv') {
                    let csvContent = "Sender,Message,Timestamp,Self-Aware\n";
                    messages.forEach(message => {
                        try {
                            const sender = message.classList.contains('user-message') ? 'You' : 'Assistant';
                            
                            // Get message text using the same improved extraction
                            let messageText = '';
                            const messageClone = message.cloneNode(true);
                            const elementsToRemove = messageClone.querySelectorAll(
                                '.message-actions, .timestamp, .mood-indicator, .mental-health-indicator, .awareness-badge'
                            );
                            elementsToRemove.forEach(el => el.remove());
                            messageText = messageClone.textContent.trim();
                            
                            if (!messageText) {
                                const walker = document.createTreeWalker(
                                    message,
                                    NodeFilter.SHOW_TEXT,
                                    null,
                                    false
                                );
                                let textNodes = [];
                                let node;
                                while (node = walker.nextNode()) {
                                    textNodes.push(node.textContent);
                                }
                                messageText = textNodes.join(' ').trim();
                            }
                            
                            messageText = messageText.replace(/\s+/g, ' ').trim().replace(/"/g, '""');
                            
                            const timestampEl = message.querySelector('.timestamp');
                            const timestamp = timestampEl ? timestampEl.textContent : '';
                            const selfAware = message.classList.contains('self-aware') ? 'Yes' : 'No';
                            
                            csvContent += `"${sender}","${messageText}","${includeTimestamps ? timestamp : ''}","${selfAware}"\n`;
                        } catch (e) {
                            console.error('Error processing message for CSV:', e);
                        }
                    });
                    
                    blob = new Blob([csvContent], { type: 'text/csv' });
                    filename = 'self-awareness-chat.csv';
                    mimeType = 'text/csv';
                } else { // text (default)
                    blob = new Blob([content], { type: 'text/plain' });
                    filename = 'self-awareness-chat.txt';
                    mimeType = 'text/plain';
                }
                
                // Create download link and trigger download (except for PDF which shows instructions)
                if (format !== 'pdf') {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    closeModal(exportModal);
                    showNotification(`Chat exported as ${format.toUpperCase()} successfully`, 'success');
                } else {
                    // For PDF, download the HTML file and show instructions
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    closeModal(exportModal);
                }
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Error exporting data: ' + error.message, 'error');
            }
        }
        
        // Helper function to get stats data
        function getStatsData() {
            const stats = {};
            const statItems = document.querySelectorAll('.stat-item');
            statItems.forEach(item => {
                try {
                    const labelElement = item.querySelector('span:first-child');
                    const valueElement = item.querySelector('.stat-value');
                    
                    if (labelElement && valueElement) {
                        const label = labelElement.textContent;
                        const value = valueElement.textContent;
                        stats[label] = value;
                    }
                } catch (e) {
                    console.error('Error getting stat data:', e);
                }
            });
            return stats;
        }
        
        // Start meditation
        function startMeditation() {
            meditationTimer.style.display = 'block';
            startTimer(600); // 10 minutes in seconds
        }
        
        // Timer variables
        let timerInterval;
        let timerSeconds = 600;
        let timerRunning = false;
        
        // Start timer
        function startTimer(seconds) {
            timerSeconds = seconds;
            timerRunning = true;
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                if (timerRunning) {
                    timerSeconds--;
                    updateTimerDisplay();
                    
                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        showNotification('Meditation session completed!', 'success');
                        meditationTimer.style.display = 'none';
                    }
                }
            }, 1000);
        }
        
        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Pause timer
        function pauseTimer() {
            timerRunning = !timerRunning;
            pauseTimerBtn.textContent = timerRunning ? 'Pause' : 'Resume';
        }
        
        // Stop timer
        function stopTimer() {
            clearInterval(timerInterval);
            meditationTimer.style.display = 'none';
            showNotification('Meditation session ended', 'error');
        }
        
        // Start mindful check-in
        function startMindfulCheckin() {
            addMessageToChat("I'd like to do a mindful check-in.", 'user');
            
            setTimeout(() => {
                if (chatbotEnabled && !selfTalkMode) {
                    typingIndicator.style.display = 'flex';
                    
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        addMessageToChat("Great! Let's begin. Take a comfortable position and bring your attention to your breath. Notice the sensation of air moving in and out of your body. If your mind wanders, gently bring it back to your breath. We'll do this for one minute.", 'app');
                        
                        // Start a one-minute timer
                        setTimeout(() => {
                            if (chatbotEnabled && !selfTalkMode) {
                                addMessageToChat("How was that experience? What did you notice?", 'app');
                            }
                        }, 60000);
                    }, 1500);
                }
            }, 1000);
        }
        
        // Start CBT exercise - FIXED: Added event listener for Save button
        function startCBTExercise() {
            const cbtRecord = document.createElement('div');
            cbtRecord.classList.add('cbt-record');
            cbtRecord.innerHTML = `
                <h4>CBT Thought Record</h4>
                <div class="cbt-step">
                    <label>Situation: What triggered your emotional response?</label>
                    <textarea placeholder="Describe the situation objectively..."></textarea>
                </div>
                <div class="cbt-step">
                    <label>Automatic Thoughts: What thoughts went through your mind?</label>
                    <textarea placeholder="List your immediate thoughts..."></textarea>
                </div>
                <div class="cbt-step">
                    <label>Emotions: What did you feel? Rate intensity (0-100%)</label>
                    <textarea placeholder="Identify emotions and their intensity..."></textarea>
                </div>
                <div class="cbt-step">
                    <label>Evidence For: What supports this thought?</label>
                    <textarea placeholder="List supporting evidence..."></textarea>
                </div>
                <div class="cbt-step">
                    <label>Evidence Against: What contradicts this thought?</label>
                    <textarea placeholder="List contradictory evidence..."></textarea>
                </div>
                <div class="cbt-step">
                    <label>Alternative Thought: What's a more balanced perspective?</label>
                    <textarea placeholder="Formulate a balanced alternative..."></textarea>
                </div>
                <div class="cbt-step">
                    <label>Re-rate Emotion: How intense are your emotions now? (0-100%)</label>
                    <textarea placeholder="Reassess emotional intensity..."></textarea>
                </div>
                <button class="step-btn" id="save-cbt-record" style="margin-top: 10px;">Save Thought Record</button>
            `;
            
            addMessageToChat("I'd like to work on a CBT thought record exercise.", 'user');
            
            setTimeout(() => {
                if (chatbotEnabled && !selfTalkMode) {
                    typingIndicator.style.display = 'flex';
                    
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        const messageDiv = document.createElement('div');
                        messageDiv.classList.add('message', 'app-message');
                        
                        const badge = document.createElement('span');
                        badge.classList.add('awareness-badge');
                        badge.textContent = 'AI';
                        messageDiv.appendChild(badge);
                        
                        messageDiv.appendChild(cbtRecord);
                        
                        const timestamp = document.createElement('div');
                        timestamp.classList.add('timestamp', 'app-timestamp');
                        const now = new Date();
                        timestamp.textContent = `Today, ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                        messageDiv.appendChild(timestamp);
                        
                        chatContainer.appendChild(messageDiv);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        
                        // Add event listener to the Save button after it's added to DOM
                        setTimeout(() => {
                            const saveBtn = document.getElementById('save-cbt-record');
                            if (saveBtn) {
                                saveBtn.addEventListener('click', saveCBTRecord);
                            }
                        }, 100);
                        
                    }, 1500);
                }
            }, 1000);
        }

        // Save CBT Record function
        function saveCBTRecord() {
            const cbtRecord = document.querySelector('.cbt-record');
            if (!cbtRecord) {
                showNotification('No CBT record found to save', 'error');
                return;
            }
            
            const textareas = cbtRecord.querySelectorAll('textarea');
            let allFieldsEmpty = true;
            let recordData = {};
            
            textareas.forEach((textarea, index) => {
                const value = textarea.value.trim();
                const label = textarea.closest('.cbt-step').querySelector('label').textContent;
                
                if (value) {
                    allFieldsEmpty = false;
                }
                
                recordData[`step${index + 1}`] = {
                    question: label,
                    answer: value
                };
            });
            
            if (allFieldsEmpty) {
                showNotification('Please fill in at least one field before saving', 'error');
                return;
            }
            
            // Save to localStorage
            const cbtRecords = JSON.parse(localStorage.getItem('cbtRecords') || '[]');
            cbtRecords.push({
                date: new Date().toISOString(),
                data: recordData
            });
            localStorage.setItem('cbtRecords', JSON.stringify(cbtRecords));
            
            // Add completion message to chat
            addMessageToChat("I've completed and saved my CBT thought record exercise.", 'user');
            
            setTimeout(() => {
                if (chatbotEnabled && !selfTalkMode) {
                    typingIndicator.style.display = 'flex';
                    
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        addMessageToChat("Great work on completing your CBT thought record! This is a powerful tool for examining and reframing unhelpful thought patterns. Would you like to review what you wrote or continue with another exercise?", 'app');
                    }, 1500);
                }
            }, 1000);
            
            showNotification('CBT Thought Record saved successfully!', 'success');
            
            // Optional: Disable the save button to prevent multiple saves
            const saveBtn = document.getElementById('save-cbt-record');
            if (saveBtn) {
                saveBtn.textContent = ' Saved';
                saveBtn.disabled = true;
                saveBtn.style.background = '#4CAF50';
            }
        }
        
        // Start workflow step
        function startWorkflowStep(stepNumber) {
            const step = document.getElementById(`step-${stepNumber}`);
            const stepTitle = step.querySelector('.step-title').textContent;
            
            // Mark step as active
            workflowSteps.forEach(step => step.classList.remove('active'));
            step.classList.add('active');
            
            // Update status
            step.querySelector('.step-status').textContent = 'In Progress';
            
            // Add message about starting the step
            addMessageToChat(`I'm starting the "${stepTitle}" exercise.`, 'user');
            
            setTimeout(() => {
                if (chatbotEnabled && !selfTalkMode) {
                    typingIndicator.style.display = 'flex';
                    
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        
                        const stepMessages = {
                            1: "Let's begin with a mindful check-in. Close your eyes and take three deep breaths. What do you notice in your body right now?",
                            2: "Now let's journal your thoughts. What's on your mind today? Write down anything that comes to mind without judgment.",
                            3: "Let's track your emotions. What emotions are you feeling right now? Where do you feel them in your body?",
                            4: "Let's align with your values. What's most important to you in life? How are your current actions aligning with these values?",
                            5: "Let's practice gratitude. What are three things you're grateful for today, no matter how small?"
                        };
                        
                        addMessageToChat(stepMessages[stepNumber], 'app');
                    }, 1500);
                }
            }, 1000);
            
            showNotification(`Started "${stepTitle}"`);
        }
        
        // Skip workflow step
        function skipWorkflowStep(stepNumber) {
            const step = document.getElementById(`step-${stepNumber}`);
            const stepTitle = step.querySelector('.step-title').textContent;
            
            // Mark step as completed
            step.classList.remove('active');
            step.classList.add('completed');
            step.querySelector('.step-status').textContent = 'Skipped';
            
            // Activate next step if available
            if (stepNumber < 5) {
                const nextStep = document.getElementById(`step-${stepNumber + 1}`);
                nextStep.classList.add('active');
                nextStep.querySelector('.step-status').textContent = 'Current';
            }
            
            // Add message about skipping the step
            addMessageToChat(`I'm skipping the "${stepTitle}" exercise for now.`, 'user');
            
            setTimeout(() => {
                if (chatbotEnabled && !selfTalkMode) {
                    typingIndicator.style.display = 'flex';
                    
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        addMessageToChat(`That's okay. We can always come back to "${stepTitle}" later. Let's continue with the next step.`, 'app');
                    }, 1500);
                }
            }, 1000);
            
            showNotification(`Skipped "${stepTitle}"`);
        }
        
        // Start assessment
        function startAssessment(type) {
            let modal, questions;
            
            if (type === 'stress') {
                modal = stressModal;
                questions = stressQuestions;
            } else if (type === 'anxiety') {
                modal = anxietyModal;
                questions = anxietyQuestions;
            } else if (type === 'depression') {
                modal = depressionModal;
                questions = depressionQuestions;
            }
            
            // Clear previous content
            const questionContainer = document.getElementById(`${type}-question-container`);
            const optionsContainer = document.getElementById(`${type}-options`);
            
            questionContainer.innerHTML = '';
            optionsContainer.innerHTML = '';
            
            // Add first question
            let currentQuestion = 0;
            displayAssessmentQuestion(type, questions, currentQuestion);
            
            // Set up next button handler
            const nextButton = document.getElementById(`next-${type}-question`);
            nextButton.onclick = function() {
                currentQuestion++;
                if (currentQuestion < questions.length) {
                    displayAssessmentQuestion(type, questions, currentQuestion);
                } else {
                    // Assessment complete
                    completeAssessment(type);
                }
            };
            
            // Open modal
            openModal(modal);
        }
        
        // Display assessment question
        function displayAssessmentQuestion(type, questions, index) {
            const questionContainer = document.getElementById(`${type}-question-container`);
            const optionsContainer = document.getElementById(`${type}-options`);
            const nextButton = document.getElementById(`next-${type}-question`);
            
            // Update question
            questionContainer.innerHTML = `<div class="assessment-question">${questions[index].question}</div>`;
            
            // Update options
            optionsContainer.innerHTML = '';
            questions[index].options.forEach((option, i) => {
                const optionDiv = document.createElement('div');
                optionDiv.classList.add('assessment-option');
                optionDiv.textContent = option;
                optionDiv.addEventListener('click', function() {
                    // Remove selected class from all options
                    optionsContainer.querySelectorAll('.assessment-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    // Enable next button
                    nextButton.disabled = false;
                });
                optionsContainer.appendChild(optionDiv);
            });
            
            // Update next button text for last question
            if (index === questions.length - 1) {
                nextButton.textContent = 'Complete';
            } else {
                nextButton.textContent = 'Next';
            }
            
            // Disable next button until an option is selected
            nextButton.disabled = true;
        }
        
        // Complete assessment
        function completeAssessment(type) {
            closeModal(document.getElementById(`${type}-modal`));
            
            // Add completion message to chat
            addMessageToChat(`I've completed the ${type} assessment.`, 'user');
            
            setTimeout(() => {
                if (chatbotEnabled && !selfTalkMode) {
                    typingIndicator.style.display = 'flex';
                    
                    setTimeout(() => {
                        typingIndicator.style.display = 'none';
                        let response = '';
                        
                        switch(type) {
                            case 'stress':
                                response = "Thank you for completing the stress assessment. Based on your responses, I notice some signs of stress. Would you like to explore some stress management techniques?";
                                break;
                            case 'anxiety':
                                response = "Thank you for completing the anxiety assessment. I notice some patterns that might indicate anxiety. Would you like to learn some grounding exercises?";
                                break;
                            case 'depression':
                                response = "Thank you for completing the mood assessment. It's important to monitor these feelings. Would you like to discuss coping strategies or resources?";
                                break;
                        }
                        
                        addMessageToChat(response, 'app');
                    }, 1500);
                }
            }, 1000);
            
            showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} assessment completed`);
        }
        
        // Dynalist functions
function loadDynalistSettings() {
    dynalistApiKey = localStorage.getItem('dynalistApiKey') || '';
    dynalistDocId = localStorage.getItem('dynalistDocId') || '';
    
    if (dynalistApiKey) {
        dynalistToken.value = dynalistApiKey;
        dynalistDocIdInput.value = dynalistDocId || '';
        updateDynalistStatus(true);
    } else {
        updateDynalistStatus(false);
    }
}
        
        function updateDynalistStatus() {
            if (dynalistApiKey) {
                dynalistStatusIcon.className = 'dynalist-status dynalist-enabled';
                dynalistStatusText.textContent = 'Connected';
            } else {
                dynalistStatusIcon.className = 'dynalist-status dynalist-disabled';
                dynalistStatusText.textContent = 'Not configured';
            }
        }
        
        function testDynalistConnection() {
            if (!dynalistToken.value.trim()) {
                showNotification('Please enter your Dynalist API token', 'error');
                return;
            }
            
            // Simulate API connection test
            showNotification('Testing Dynalist connection...');
            
            setTimeout(() => {
                // In a real implementation, this would make an actual API call
                showNotification('Dynalist connection successful!', 'success');
                dynalistStatusIcon.className = 'dynalist-status dynalist-enabled';
                dynalistStatusText.textContent = 'Connection test passed';
            }, 2000);
        }
        
function saveDynalistSettings() {
    dynalistApiKey = dynalistToken.value.trim();
    dynalistDocId = dynalistDocIdInput.value.trim();
    
    if (!dynalistApiKey) {
        showNotification('Please enter an API token', 'error');
        return;
    }
    
    localStorage.setItem('dynalistApiKey', dynalistApiKey);
    if (dynalistDocId) {
        localStorage.setItem('dynalistDocId', dynalistDocId);
    }
    
    updateDynalistStatus(true);
    showNotification('Dynalist settings saved successfully');
    closeModal(dynalistModal);
}
        
async function sendToDynalist() {
    if (!dynalistApiKey) {
        showNotification('Please configure Dynalist settings first', 'error');
        openModal(dynalistModal);
        return;
    }
    
    try {
        showNotification('Exporting to Dynalist...');
        
        // Get or create document ID
        let documentId = dynalistDocId;
        if (!documentId) {
            documentId = await createDynalistDocument();
            if (!documentId) {
                throw new Error('Failed to create document');
            }
            // Save the new document ID
            dynalistDocId = documentId;
            localStorage.setItem('dynalistDocId', documentId);
            showNotification('Created new Dynalist document');
        }
        
        // Add content to Dynalist
        await addContentToDynalist(documentId);
        showNotification('Successfully exported to Dynalist! Opening document...');
        
        // Open Dynalist in new tab
        setTimeout(() => {
            const dynalistUrl = `https://dynalist.io/d/${documentId}`;
            window.open(
                `https://dynalist.io/d/${documentId}`,
                'DynalistPopout',
                'width=1000,height=800,resizable=yes,scrollbars=yes'
            );
        }, 1500);
        
    } catch (error) {
        console.error('Dynalist export error:', error);
        showNotification('Error exporting to Dynalist: ' + error.message, 'error');
    }
}

async function createDynalistDocument() {
    const today = new Date();
    
    // New date format: YYYYMMDD (Weekday) HH:MM AM/PM
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const weekday = today.toLocaleDateString('en-US', { weekday: 'short' });
    const timeString = today.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    }).toLowerCase();
    
    const documentTitle = `Awarenesschat ${year}${month}${day} (${weekday}) ${timeString}`;
    
    try {
        const response = await fetch('https://dynalist.io/api/v1/doc/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: dynalistApiKey,
                title: documentTitle,
                type: 'document'
            })
        });
        
        const data = await response.json();
        
        if (data._code === 'Ok' && data.id) {
            return data.id;
        } else {
            throw new Error(data._msg || 'Failed to create document');
        }
    } catch (error) {
        console.error('Error creating Dynalist document:', error);
        throw error;
    }
}

async function addContentToDynalist(documentId) {
    // Read the document root
    const readResponse = await fetch('https://dynalist.io/api/v1/doc/read', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: dynalistApiKey, file_id: documentId })
    });
    const readData = await readResponse.json();
    if (readData._code !== 'Ok') {
        throw new Error('Failed to read document: ' + (readData._msg || 'Unknown error'));
    }

    // Root node
    const rootNode = readData.nodes.find(node => node.id === 'root');
    if (!rootNode) throw new Error('Root node not found');

    // Create main session node with timestamp
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const weekday = today.toLocaleDateString('en-US', { weekday: 'short' });
    const timeString = today.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    }).toLowerCase();
    
    const sessionNodeContent = `Awarenesschat ${year}${month}${day} (${weekday}) ${timeString}`;

    const sessionResponse = await fetch('https://dynalist.io/api/v1/doc/edit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            token: dynalistApiKey,
            file_id: documentId,
            changes: [{
                action: 'insert',
                parent_id: rootNode.id,
                content: sessionNodeContent,
                index: readData.nodes.filter(n => n.parent === rootNode.id).length
            }]
        })
    });
    const sessionData = await sessionResponse.json();
    if (sessionData._code !== 'Ok') {
        throw new Error('Failed to add session node: ' + (sessionData._msg || 'Unknown error'));
    }
    const sessionNodeId = sessionData.new_node_ids ? sessionData.new_node_ids[0] : null;
    if (!sessionNodeId) throw new Error('Failed to get new session node ID');

    // Add conversation messages
    const messages = Array.from(document.querySelectorAll('.message')).filter(msg => {
        const contentElement = msg.querySelector('div:not(.message-actions):not(.timestamp):not(.mood-indicator):not(.mental-health-indicator):not(.awareness-badge)');
        return contentElement && contentElement.textContent.trim() !== '';
    });
    
    for (let i = 0; i < messages.length; i++) {
        const msg = messages[i];
        const type = msg.classList.contains('user-message') ? '' : '';
        
        // Get message content
        const contentElement = msg.querySelector('div:not(.message-actions):not(.timestamp):not(.mood-indicator):not(.mental-health-indicator):not(.awareness-badge)');
        const messageContent = contentElement ? contentElement.textContent.trim() : '';
        
        // Skip empty messages
        if (!messageContent) {
            continue;
        }
        
        // Format timestamp
        let timeOnly = '';
        const timestamp = msg.querySelector('.timestamp')?.textContent || '';
        if (timestamp) {
            // Remove "Today, " prefix if present
            timeOnly = timestamp.replace('Today, ', '');
            // Ensure AM/PM format
            if (!timeOnly.toLowerCase().includes('am') && !timeOnly.toLowerCase().includes('pm')) {
                // Convert to AM/PM format if needed
                const timeParts = timeOnly.split(':');
                if (timeParts.length === 2) {
                    let hours = parseInt(timeParts[0]);
                    const minutes = timeParts[1];
                    const ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12 || 12;
                    timeOnly = `${hours}:${minutes} ${ampm}`;
                }
            }
        }
        
        const messageNodeContent = `${type}: ${messageContent} (${timeOnly})`;

        try {
            const response = await fetch('https://dynalist.io/api/v1/doc/edit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    token: dynalistApiKey,
                    file_id: documentId,
                    changes: [{
                        action: 'insert',
                        parent_id: sessionNodeId,
                        content: messageNodeContent,
                        index: i
                    }]
                })
            });
            
            const data = await response.json();
            if (data._code !== 'Ok') {
                console.warn('Failed to add message node:', data._msg);
                continue;
            }
            
            // Add a small delay between requests to avoid rate limiting
            if (i < messages.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
        } catch (error) {
            console.warn('Error adding message node:', error);
            continue;
        }
    }
    
    return true;
}
        
        // Additional utility functions
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function getCurrentDate() {
            const now = new Date();
            return now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        // Initialize any additional components
        window.addEventListener('resize', function() {
            // Handle responsive behavior
            if (window.innerWidth <= 900) {
                workflowGuide.classList.remove('collapsed');
            }
        });
        
        // Add some sample interactions on load
        setTimeout(() => {
            // Update date in header if needed
            const dateElement = document.querySelector('.subtitle');
            if (dateElement && !dateElement.textContent.includes('Today')) {
                dateElement.textContent += ` | ${getCurrentDate()}`;
            }
        }, 1000);

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter to send message
            if (e.ctrlKey && e.key === 'Enter' && document.activeElement === userInput) {
                sendMessage();
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal[style*="display: flex"]');
                openModals.forEach(modal => {
                    closeModal(modal);
                });
                
                // Also close meditation timer
                if (meditationTimer.style.display === 'block') {
                    meditationTimer.style.display = 'none';
                    if (timerInterval) {
                        clearInterval(timerInterval);
                    }
                }
            }
            
            // Ctrl+/ to show keyboard shortcuts help
            if (e.ctrlKey && e.key === '/') {
                e.preventDefault();
                showNotification('Keyboard shortcuts: Ctrl+Enter to send, Escape to close modals', 'success');
            }
        });

        // Add search functionality
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');

        // Show search on Ctrl+F
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                searchInput.style.display = 'block';
                searchBtn.style.display = 'block';
                searchInput.focus();
            }
        });

        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        function performSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            if (!searchTerm) return;

            const messages = chatContainer.querySelectorAll('.message');
            let found = false;

            // Remove previous highlights
            chatContainer.querySelectorAll('.highlight').forEach(highlight => {
                const parent = highlight.parentNode;
                parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
                parent.normalize();
            });

            messages.forEach(message => {
                const textContent = message.textContent.toLowerCase();
                if (textContent.includes(searchTerm)) {
                    found = true;
                    message.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    message.style.backgroundColor = 'rgba(255, 235, 59, 0.3)';
                    
                    // Highlight the search term
                    const walker = document.createTreeWalker(
                        message,
                        NodeFilter.SHOW_TEXT,
                        null,
                        false
                    );
                    
                    let node;
                    while (node = walker.nextNode()) {
                        if (node.textContent.toLowerCase().includes(searchTerm)) {
                            const span = document.createElement('span');
                            span.className = 'highlight';
                            span.textContent = node.textContent;
                            node.parentNode.replaceChild(span, node);
                        }
                    }
                    
                    setTimeout(() => {
                        message.style.backgroundColor = '';
                    }, 2000);
                }
            });

            if (found) {
                showNotification('Search term found and highlighted');
            } else {
                showNotification('Search term not found in chat', 'error');
            }
        }

        // Auto-save functionality
        setInterval(() => {
            const messages = chatContainer.querySelectorAll('.message');
            if (messages.length > 0) {
                const chatData = {
                    timestamp: new Date().toISOString(),
                    messageCount: messages.length
                };
                localStorage.setItem('selfAwarenessChatAutoSave', JSON.stringify(chatData));
            }
        }, 30000); // Auto-save every 30 seconds

        // Load auto-saved data on page load
        window.addEventListener('load', function() {
            const saved = localStorage.getItem('selfAwarenessChatAutoSave');
            if (saved) {
                console.log('Auto-saved chat data found from previous session');
            }
        });

        // Crisis resources reminder (shows once per day)
        function showCrisisResourcesReminder() {
            const lastShown = localStorage.getItem('crisisResourcesLastShown');
            const today = new Date().toDateString();
            
            if (lastShown !== today) {
                setTimeout(() => {
                    if (confirm('Remember: If you\'re experiencing a mental health crisis, help is available. Would you like to view crisis resources?')) {
                        document.querySelector('.crisis-resources').scrollIntoView({ behavior: 'smooth' });
                    }
                    localStorage.setItem('crisisResourcesLastShown', today);
                }, 10000); // Show after 10 seconds
            }
        }

        // Uncomment the line below to enable crisis resources reminder
        // showCrisisResourcesReminder();

        console.log('Self-Awareness Workflow Assistant initialized successfully');
    </script>
</body>
</html>