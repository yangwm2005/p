<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynalist Notes</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f5f5f5;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .document-title {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0 15px;
            color: #333;
            transition: opacity 0.3s ease;
        }
        .input-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }
        .input-container textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: none;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            line-height: 1.5;
            transition: border-color 0.3s ease;
        }
        .input-container textarea:focus {
            border-color: #06D85F;
            outline: none;
        }
        .button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .button-container button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
            text-align: center;
        }
        #enterButton {
            flex: 1;
            background-color: #06D85F;
            color: white;
        }
        #enterButton:hover {
            background-color: #059c47;
        }
        .open-dynalist-btn {
            flex: 1;
            background-color: #007bff;
            color: white;
        }
        .open-dynalist-btn:hover {
            background-color: #0056b3;
        }
        .preset-btn {
            width: 30px;
            height: 40px;
            padding: 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preset-btn.hash {
            background-color: #ff9500;
            color: white;
        }
        .preset-btn.hash:hover {
            background-color: #cc7800;
        }
        .preset-btn.at {
            background-color: #800080;
            color: white;
        }
        .preset-btn.at:hover {
            background-color: #660066;
        }
        .filter-btn {
            width: 30px;
            height: 40px;
            padding: 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .filter-btn.hash {
            background-color: #008080;
            color: white;
        }
        .filter-btn.hash:hover {
            background-color: #006666;
        }
        .filter-btn.at {
            background-color: #c71585;
            color: white;
        }
        .filter-btn.at:hover {
            background-color: #9f1167;
        }
        .date-btn {
            width: 30px;
            height: 40px;
            padding: 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ff9500;
            color: white;
        }
        .date-btn:hover {
            background-color: #cc7800;
        }
        .dropdown-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 10;
            overflow: hidden;
            transition: opacity 0.2s ease, transform 0.2s ease;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }
        .dropdown-menu.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        #hashPresetMenu, #atPresetMenu, #hashFilterMenu, #atFilterMenu {
            top: 100%;
            left: 0;
            min-width: 150px;
        }
        #slashMenu {
            top: 110px;
            left: 10px;
            width: 300px;
            display: flex;
            flex-direction: row;
            padding: 5px;
            max-height: 200px;
            overflow-y: auto;
        }
        #slashMenu .column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        #slashMenu .column:not(:last-child) {
            border-right: 1px solid #ddd;
        }
        #tagMenu {
            min-width: 150px;
            max-height: 200px;
            overflow-y: auto;
        }
        .dropdown-item {
            padding: 4px 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            line-height: 1.2;
            margin: 0;
        }
        .dropdown-item:hover {
            background-color: #f0f0f0;
        }
        .dropdown-item.edit {
            border-top: 1px solid #ddd;
            font-style: italic;
            color: #666;
        }
        .status-message {
            padding: 12px;
            margin: 10px 0 0;
            background-color: #f0f0f0;
            text-align: center;
            border-radius: 8px;
            font-size: 14px;
            transition: opacity 0.5s, transform 0.5s;
            transform: scale(1);
            opacity: 1;
        }
        .status-message.hidden {
            opacity: 0;
            transform: scale(0.9);
        }
        .success {
            background-color: #dff8d8;
            color: #3c763d;
        }
        .error {
            background-color: #f8d8d8;
            color: #a94442;
        }
        .api-settings {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            background-color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }
        .api-settings:hover {
            background-color: #f9f9f9;
        }
        .api-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .api-enabled {
            background-color: #06D85F;
        }
        .api-disabled {
            background-color: #ccc;
        }
        .doc-id-settings {
            position: fixed;
            top: 70px;
            right: 20px;
            font-size: 14px;
            color: #666;
            cursor: pointer;
            background-color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease;
        }
        .doc-id-settings:hover {
            background-color: #f9f9f9;
        }
        iframe {
            width: 100%;
            height: calc(100% - 220px);
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .note {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="api-settings" onclick="showApiSettings()">
            <span class="api-status api-disabled"></span>
            API Disabled
        </div>
        <div class="doc-id-settings" onclick="showDocIdSettings()">
            D
        </div>

        <div class="document-title" id="documentTitle">Loading document title...</div>

        <div class="input-container">
            <textarea id="dynalistInput" placeholder="Type your note here..."></textarea>
            <div id="slashMenu" class="dropdown-menu"></div>
            <div id="tagMenu" class="dropdown-menu"></div>
            <div class="button-container">
                <button id="dateButton" class="date-btn">D</button>
                <button id="enterButton">Enter</button>
                <div style="position: relative;">
                    <button id="hashPresetButton" class="preset-btn hash">#</button>
                    <div id="hashPresetMenu" class="dropdown-menu hidden"></div>
                </div>
                <div style="position: relative;">
                    <button id="atPresetButton" class="preset-btn at">@</button>
                    <div id="atPresetMenu" class="dropdown-menu hidden"></div>
                </div>
                <button class="open-dynalist-btn" onclick="openDynalist()">Open Dynalist</button>
                <div style="position: relative;">
                    <button id="hashFilterButton" class="filter-btn hash">üîç#</button>
                    <div id="hashFilterMenu" class="dropdown-menu hidden"></div>
                </div>
                <div style="position: relative;">
                    <button id="atFilterButton" class="filter-btn at">üîç@</button>
                    <div id="atFilterMenu" class="dropdown-menu hidden"></div>
                </div>
            </div>
            <p id="statusMessage" class="status-message hidden"></p>
        </div>

        <iframe id="dynalistFrame" src="https://dynalist.io/d/QBPYSvxs9JO2gYfbf0sPhsoF"></iframe>
        <p class="note">Note: Any 404 errors in the console from dynalist.io are harmless and do not affect the app.</p>
    </div>

    <script>
        let apiKey = null;
        let docId = localStorage.getItem('dynalistDocId') || "QBPYSvxs9JO2gYfbf0sPhsoF";
        let hashPresetTerms = [];
        let atPresetTerms = [];
        let presetTermsNodeId = null;
        let termsNodeId = null;

        // Function to fetch preset terms from Dynalist
        async function fetchPresetTerms() {
            if (!apiKey) {
                console.log("No API key, prompting user");
                showStatus("Please enter API key to sync terms", false);
                return false;
            }
            console.log("Fetching preset terms from Dynalist...");
            try {
                const response = await fetch('https://dynalist.io/api/v1/doc/read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: apiKey, file_id: docId })
                });
                const result = await response.json();
                if (result._code !== "Ok") {
                    console.error("Failed to fetch document:", result._msg);
                    showStatus("Failed to fetch preset terms: " + result._msg, false);
                    return false;
                }
                console.log("Document fetched successfully");
                console.log(`Total nodes: ${result.nodes.length}`);
                const rootNode = result.nodes.find(node => node.id === "root");
                console.log("Root node:", rootNode);
                const rootNodes = result.nodes.filter(node => node.parent === rootNode?.id || node.parent === "root");
                console.log("Root nodes:", rootNodes.map(node => node.content));
                const presetNode = result.nodes.find(node => 
                    node.content?.toLowerCase() === "preset terms" && (node.parent === rootNode?.id || node.parent === "root")
                );
                if (!presetNode) {
                    console.log("No 'Preset Terms' node found");
                    return false;
                }
                presetTermsNodeId = presetNode.id;
                console.log(`Found 'Preset Terms' node with ID: ${presetTermsNodeId}, content: ${presetNode.content}`);
                const termsNodes = result.nodes.filter(node => 
                    node.parent === presetTermsNodeId && node.content?.startsWith("PRESET_TERMS:")
                );
                if (termsNodes.length === 0) {
                    console.log("No PRESET_TERMS child node found");
                    return false;
                }
                const termsNode = termsNodes[termsNodes.length - 1];
                termsNodeId = termsNode.id;
                console.log(`Selected terms node ID: ${termsNodeId}, content: ${termsNode.content}`);
                if (termsNodes.length > 1) {
                    console.log(`Found ${termsNodes.length} PRESET_TERMS nodes, cleaning up duplicates`);
                    const deleteChanges = termsNodes
                        .filter(node => node.id !== termsNodeId)
                        .map(node => ({
                            action: 'delete',
                            node_id: node.id
                        }));
                    const cleanupResponse = await fetch('https://dynalist.io/api/v1/doc/edit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: apiKey, file_id: docId, changes: deleteChanges })
                    });
                    const cleanupResult = await cleanupResponse.json();
                    if (cleanupResult._code === "Ok") {
                        console.log("Duplicate PRESET_TERMS nodes deleted");
                    } else {
                        console.error("Failed to clean up duplicates:", cleanupResult._msg);
                    }
                }
                const content = termsNode.content;
                if (!content.startsWith("PRESET_TERMS:")) {
                    console.log("Invalid PRESET_TERMS format");
                    return false;
                }
                const [hashTermsStr, atTermsStr] = content.replace("PRESET_TERMS:", "").split('|');
                hashPresetTerms = hashTermsStr
                    ? hashTermsStr.split(',').map(term => term.trim()).filter(term => term !== '')
                    : [];
                atPresetTerms = atTermsStr
                    ? atTermsStr.split(',').map(term => term.trim()).filter(term => term !== '')
                    : [];
                console.log(`Parsed hash terms: ${hashPresetTerms}`);
                console.log(`Parsed at terms: ${atPresetTerms}`);
                localStorage.setItem('hashPresetTerms', JSON.stringify(hashPresetTerms));
                localStorage.setItem('atPresetTerms', JSON.stringify(atPresetTerms));
                return true;
            } catch (error) {
                console.error("Error fetching preset terms:", error);
                showStatus("Error connecting to Dynalist API", false);
                return false;
            }
        }

        // Function to update preset terms in Dynalist
        async function updatePresetTermsInDynalist() {
            if (!apiKey) {
                console.log("No API key, cannot update Dynalist");
                return false;
            }
            console.log("Updating preset terms in Dynalist...");
            try {
                let changes = [];
                if (!presetTermsNodeId) {
                    changes.push({
                        action: 'insert',
                        parent_id: 'root',
                        content: "Preset Terms",
                        index: 0
                    });
                    console.log("Creating new 'Preset Terms' node");
                }
                const termsContent = `PRESET_TERMS:${hashPresetTerms.join(',')}|${atPresetTerms.join(',')}`;
                console.log(`New terms content: ${termsContent}`);
                if (presetTermsNodeId && termsNodeId) {
                    changes.push({
                        action: 'edit',
                        node_id: termsNodeId,
                        content: termsContent
                    });
                    console.log(`Editing existing terms node ID: ${termsNodeId}`);
                } else {
                    changes.push({
                        action: 'insert',
                        parent_id: presetTermsNodeId || 'root',
                        content: termsContent,
                        index: presetTermsNodeId ? 0 : 1
                    });
                    console.log(`Inserting new terms node under ${presetTermsNodeId || 'root'}`);
                }
                const updateResponse = await fetch('https://dynalist.io/api/v1/doc/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: apiKey, file_id: docId, changes })
                });
                const updateResult = await updateResponse.json();
                if (updateResult._code === "Ok") {
                    if (!presetTermsNodeId && updateResult.new_node_ids.length > 0) {
                        presetTermsNodeId = updateResult.new_node_ids[0];
                        console.log(`New preset terms parent node ID: ${presetTermsNodeId}`);
                    }
                    if (!termsNodeId && updateResult.new_node_ids.length > (presetTermsNodeId ? 0 : 1)) {
                        termsNodeId = updateResult.new_node_ids[presetTermsNodeId ? 0 : 1];
                        console.log(`New terms node ID: ${termsNodeId}`);
                    }
                    console.log("Preset terms updated successfully");
                    await fetchPresetTerms();
                    return true;
                } else {
                    console.error("Failed to update preset terms:", updateResult._msg);
                    return false;
                }
            } catch (error) {
                console.error("Error updating preset terms:", error);
                return false;
            }
        }

        // Function to render preset dropdown menu (for inserting tags)
        function renderPresetMenu(menuId, terms, prefix, storageKey) {
            const menu = document.getElementById(menuId);
            if (!menu) {
                console.error(`Menu with ID ${menuId} not found`);
                return;
            }
            menu.innerHTML = '';
            terms.forEach(term => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.setAttribute('data-term', `${prefix}${term}`);
                item.textContent = term;
                item.addEventListener('click', () => {
                    console.log(`Clicked preset term: ${prefix}${term}`);
                    const textarea = document.getElementById('dynalistInput');
                    const termWithPrefix = `${prefix}${term}`;
                    if (textarea.value.trim() !== '') {
                        textarea.value += ' ' + termWithPrefix;
                    } else {
                        textarea.value = termWithPrefix;
                    }
                    textarea.focus();
                    menu.classList.remove('show');
                });
                menu.appendChild(item);
            });
            const editItem = document.createElement('div');
            editItem.className = 'dropdown-item edit';
            editItem.textContent = 'Edit Presets';
            editItem.addEventListener('click', () => {
                console.log(`Editing presets for ${prefix}`);
                editPresetTerms(menuId, terms, prefix, storageKey);
            });
            menu.appendChild(editItem);
        }

        // Function to render slash menu
        function renderSlashMenu(show = false) {
            const menu = document.getElementById('slashMenu');
            if (!menu) {
                console.error("Slash menu not found");
                return;
            }
            menu.innerHTML = '';
            const hashColumn = document.createElement('div');
            hashColumn.className = 'column';
            const atColumn = document.createElement('div');
            atColumn.className = 'column';
            hashPresetTerms.forEach(term => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.setAttribute('data-term', `#${term}`);
                item.textContent = `#${term}`;
                item.addEventListener('click', () => {
                    insertTerm(`#${term}`);
                    menu.classList.remove('show');
                });
                hashColumn.appendChild(item);
            });
            atPresetTerms.forEach(term => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.setAttribute('data-term', `@${term}`);
                item.textContent = `@${term}`;
                item.addEventListener('click', () => {
                    insertTerm(`@${term}`);
                    menu.classList.remove('show');
                });
                atColumn.appendChild(item);
            });
            menu.appendChild(hashColumn);
            menu.appendChild(atColumn);
            if (show && (hashPresetTerms.length > 0 || atPresetTerms.length > 0)) {
                menu.classList.add('show');
            } else {
                menu.classList.remove('show');
            }
        }

        // Function to render tag menu
        function renderTagMenu(prefix, show = false) {
            const menu = document.getElementById('tagMenu');
            if (!menu) {
                console.error("Tag menu not found");
                return;
            }
            menu.innerHTML = '';
            const terms = prefix === '#' ? hashPresetTerms : atPresetTerms;
            terms.forEach(term => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.setAttribute('data-term', `${prefix}${term}`);
                item.textContent = `${prefix}${term}`;
                item.addEventListener('click', () => {
                    insertTerm(`${prefix}${term}`);
                    menu.classList.remove('show');
                });
                menu.appendChild(item);
            });
            const textarea = document.getElementById('dynalistInput');
            if (show && terms.length > 0) {
                // Calculate cursor position
                const cursorPos = textarea.selectionStart;
                const textBefore = textarea.value.substring(0, cursorPos);
                const tempSpan = document.createElement('span');
                tempSpan.style.cssText = `
                    position: absolute;
                    visibility: hidden;
                    white-space: pre-wrap;
                    word-wrap: break-word;
                    font-family: Arial, sans-serif;
                    font-size: 16px;
                    line-height: 1.5;
                    padding: 10px;
                    width: ${textarea.offsetWidth}px;
                `;
                tempSpan.textContent = textBefore;
                document.body.appendChild(tempSpan);
                const range = document.createRange();
                range.setStart(tempSpan.firstChild || tempSpan, textBefore.length);
                const rects = range.getClientRects();
                const textareaRect = textarea.getBoundingClientRect();
                let cursorX = rects.length > 0 ? rects[0].left : textareaRect.left;
                let cursorY = rects.length > 0 ? rects[0].bottom : textareaRect.top;
                document.body.removeChild(tempSpan);
                // Adjust menu position
                const menuHeight = Math.min(terms.length * 24 + 10, 200);
                const viewportHeight = window.innerHeight;
                const viewportWidth = window.innerWidth;
                let top = cursorY - textareaRect.top + textarea.scrollTop + 5;
                let left = cursorX - textareaRect.left + textarea.scrollLeft;
                if (cursorY + menuHeight > viewportHeight) {
                    top -= (menuHeight + 20);
                }
                if (left + 150 > viewportWidth) {
                    left = viewportWidth - 160;
                }
                menu.style.top = `${top}px`;
                menu.style.left = `${left}px`;
                menu.classList.add('show');
            } else {
                menu.classList.remove('show');
            }
        }

        // Function to insert term (for slash or tag menu)
        function insertTerm(term) {
            const textarea = document.getElementById('dynalistInput');
            const value = textarea.value;
            const cursorPos = textarea.selectionStart;
            const textBefore = value.substring(0, cursorPos);
            const textAfter = value.substring(cursorPos);
            const newTextBefore = textBefore.replace(/[/#@]$/, '');
            textarea.value = newTextBefore + term + textAfter;
            textarea.focus();
            const newCursorPos = newTextBefore.length + term.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
        }

        // Function to render filter dropdown menu (for opening filtered views)
        function renderFilterMenu(menuId, terms, prefix) {
            const menu = document.getElementById(menuId);
            if (!menu) {
                console.error(`Menu with ID ${menuId} not found`);
                return;
            }
            menu.innerHTML = '';
            terms.forEach(term => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.setAttribute('data-term', term);
                item.textContent = term;
                item.addEventListener('click', () => {
                    const encodedTerm = encodeURIComponent(`${prefix}${term}`);
                    const filterUrl = `https://dynalist.io/d/${docId}#q=${encodedTerm}`;
                    console.log(`Filtering Dynalist with URL: ${filterUrl}`);
                    window.open(filterUrl, '_blank');
                    menu.classList.remove('show');
                });
                menu.appendChild(item);
            });
            const editItem = document.createElement('div');
            editItem.className = 'dropdown-item edit';
            editItem.textContent = 'Edit Presets';
            editItem.addEventListener('click', () => {
                console.log(`Editing presets for ${prefix} from filter menu`);
                editPresetTerms(menuId, terms, prefix, menuId.includes('hash') ? 'hashPresetTerms' : 'atPresetTerms');
            });
            menu.appendChild(editItem);
        }

        // Function to edit preset terms
        function editPresetTerms(menuId, terms, prefix, storageKey) {
            const currentTerms = terms.join(', ');
            const newTermsInput = prompt(
                `Enter preset terms for ${prefix} (comma-separated, no spaces around commas):\n` +
                'Example: Project,Task,Note,Idea\n' +
                'Current terms: ' + currentTerms,
                currentTerms
            );
            if (newTermsInput !== null) {
                const newTerms = newTermsInput.split(',').map(term => term.trim()).filter(term => term !== '');
                if (newTerms.length > 0) {
                    console.log(`Updating terms for ${prefix}: ${newTerms}`);
                    terms.splice(0, terms.length, ...newTerms);
                    localStorage.setItem(storageKey, JSON.stringify(terms));
                    if (prefix === '#') {
                        renderPresetMenu('hashPresetMenu', hashPresetTerms, '#', 'hashPresetTerms');
                        renderFilterMenu('hashFilterMenu', hashPresetTerms, '#');
                    } else {
                        renderPresetMenu('atPresetMenu', atPresetTerms, '@', 'atPresetTerms');
                        renderFilterMenu('atFilterMenu', atPresetTerms, '@');
                    }
                    updatePresetTermsInDynalist().then(success => {
                        showStatus(success ? "Preset terms updated and synced." : "Preset terms updated locally.", success);
                        const textarea = document.getElementById('dynalistInput');
                        const cursorPos = textarea.selectionStart;
                        const textBefore = textarea.value.substring(0, cursorPos);
                        renderSlashMenu(textBefore.endsWith('/'));
                        renderTagMenu(textBefore.endsWith('#') ? '#' : textBefore.endsWith('@') ? '@' : '', textBefore.endsWith('#') || textBefore.endsWith('@'));
                    });
                } else {
                    showStatus("No valid terms entered.", false);
                }
            }
            document.getElementById(menuId).classList.remove('show');
        }

        // Function to fetch the document title
        async function fetchDocumentTitle() {
            const documentTitleElement = document.getElementById('documentTitle');
            if (apiKey) {
                try {
                    const response = await fetch('https://dynalist.io/api/v1/doc/read', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: apiKey, file_id: docId })
                    });
                    const result = await response.json();
                    if (result._code === "Ok" && result.title) {
                        documentTitleElement.textContent = `Working on: ${result.title}`;
                    } else {
                        documentTitleElement.textContent = `Document ID: ${docId}`;
                        showStatus("Invalid document ID or no access. Please verify.", false);
                    }
                } catch (error) {
                    console.error("Error fetching document title:", error);
                    documentTitleElement.textContent = `Document ID: ${docId}`;
                    showStatus("Error fetching document title.", false);
                }
            } else {
                documentTitleElement.textContent = `Document ID: ${docId}`;
            }
        }

        // Function to refresh the iframe and title
        function refreshDynalist() {
            document.getElementById('dynalistFrame').src = `https://dynalist.io/d/${docId}`;
            fetchDocumentTitle();
        }

        // Function to update API status UI
        function updateApiStatus(isEnabled) {
            const apiStatusElement = document.querySelector('.api-status');
            const apiSettingsElement = document.querySelector('.api-settings');
            if (isEnabled) {
                apiStatusElement.className = 'api-status api-enabled';
                apiSettingsElement.innerHTML = '<span class="api-status api-enabled"></span> A';
            } else {
                apiStatusElement.className = 'api-status api-disabled';
                apiSettingsElement.innerHTML = '<span class="api-status api-disabled"></span> API Disabled';
            }
        }

        // Function to show status messages
        function showStatus(message, isSuccess = true) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = isSuccess ? 'status-message success' : 'status-message error';
            statusMessage.classList.remove('hidden');
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 3000);
        }

        // Function to get the current date and day in "YYYYMMDD: Day" format
        function getCurrentDateAndDay() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = days[now.getDay()];
            return `${year}${month}${day}: ${dayName}`;
        }

        // Function to add date to Dynalist using API
        async function addDateToDynalistWithApi() {
            const dateStr = getCurrentDateAndDay();
            showStatus("Adding date via API...");
            try {
                const readResponse = await fetch('https://dynalist.io/api/v1/doc/read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: apiKey, file_id: docId })
                });
                const readResult = await readResponse.json();
                if (readResult._code !== "Ok") {
                    showStatus("API Error: " + readResult._msg, false);
                    return false;
                }
                const rootNodes = readResult.nodes.filter(node => node.parent === "root");
                const lastIndex = rootNodes.length;

                const response = await fetch('https://dynalist.io/api/v1/doc/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: apiKey,
                        file_id: docId,
                        changes: [{
                            action: 'insert',
                            parent_id: 'root',
                            content: dateStr,
                            index: lastIndex
                        }]
                    })
                });
                const result = await response.json();
                if (result._code === "Ok") {
                    showStatus("Date added successfully!");
                    refreshDynalist();
                    return true;
                } else {
                    showStatus("API Error: " + result._msg, false);
                    return false;
                }
            } catch (error) {
                showStatus("Error connecting to Dynalist API", false);
                return false;
            }
        }

        // Fallback method for adding date
        function addDateToDynalistManually() {
            const dateStr = getCurrentDateAndDay();
            showStatus("Ready! Now manually add this date in Dynalist.", true);
            try {
                const searchParam = encodeURIComponent(dateStr);
                const searchUrl = `https://dynalist.io/d/${docId}?q=${searchParam}`;
                window.open(searchUrl, '_blank');
                return true;
            } catch (e) {
                showStatus("Error preparing date", false);
                return false;
            }
        }

        // Main function to add date
        function addDateToDynalist() {
            if (apiKey) {
                return addDateToDynalistWithApi();
            } else {
                return addDateToDynalistManually();
            }
        }

        // Show API settings dialog
        function showApiSettings() {
            console.log("Opening API settings");
            const newApiKey = prompt("Enter your Dynalist API key (copy from your other device if syncing):", apiKey || '');
            if (newApiKey !== null) {
                if (newApiKey.trim() !== '') {
                    apiKey = newApiKey.trim();
                    localStorage.setItem('dynalistApiKey', apiKey);
                    updateApiStatus(true);
                    showStatus("API key updated. Reloading data.", true);
                    fetchDocumentTitle();
                    fetchPresetTerms().then(success => {
                        renderPresetMenu('hashPresetMenu', hashPresetTerms, '#', 'hashPresetTerms');
                        renderPresetMenu('atPresetMenu', atPresetTerms, '@', 'atPresetTerms');
                        renderFilterMenu('hashFilterMenu', hashPresetTerms, '#');
                        renderFilterMenu('atFilterMenu', atPresetTerms, '@');
                        const textarea = document.getElementById('dynalistInput');
                        const cursorPos = textarea.selectionStart;
                        const textBefore = textarea.value.substring(0, cursorPos);
                        renderSlashMenu(textBefore.endsWith('/'));
                        renderTagMenu(textBefore.endsWith('#') ? '#' : textBefore.endsWith('@') ? '@' : '', textBefore.endsWith('#') || textBefore.endsWith('@'));
                        if (success) {
                            showStatus("Preset terms loaded from Dynalist.", true);
                        } else {
                            showStatus("No preset terms found in Dynalist. Add via Edit Presets.", false);
                        }
                    });
                } else {
                    apiKey = null;
                    localStorage.removeItem('dynalistApiKey');
                    localStorage.removeItem('hashPresetTerms');
                    localStorage.removeItem('atPresetTerms');
                    hashPresetTerms = [];
                    atPresetTerms = [];
                    updateApiStatus(false);
                    showStatus("API key cleared. Terms reset.", false);
                    fetchDocumentTitle();
                    renderPresetMenu('hashPresetMenu', hashPresetTerms, '#', 'hashPresetTerms');
                    renderPresetMenu('atPresetMenu', atPresetTerms, '@', 'atPresetTerms');
                    renderFilterMenu('hashFilterMenu', hashPresetTerms, '#');
                    renderFilterMenu('atFilterMenu', atPresetTerms, '@');
                    renderSlashMenu(false);
                    renderTagMenu('', false);
                }
            }
        }

        // Show Document ID settings dialog
        function showDocIdSettings() {
            console.log("Opening Document ID settings");
            const newDocId = prompt("Enter your Dynalist Document ID:", docId);
            if (newDocId !== null) {
                if (newDocId.trim() !== '') {
                    docId = newDocId.trim();
                    localStorage.setItem('dynalistDocId', docId);
                    showStatus("Document ID updated.", true);
                    presetTermsNodeId = null;
                    termsNodeId = null;
                    fetchPresetTerms().then(success => {
                        renderPresetMenu('hashPresetMenu', hashPresetTerms, '#', 'hashPresetTerms');
                        renderPresetMenu('atPresetMenu', atPresetTerms, '@', 'atPresetTerms');
                        renderFilterMenu('hashFilterMenu', hashPresetTerms, '#');
                        renderFilterMenu('atFilterMenu', atPresetTerms, '@');
                        const textarea = document.getElementById('dynalistInput');
                        const cursorPos = textarea.selectionStart;
                        const textBefore = textarea.value.substring(0, cursorPos);
                        renderSlashMenu(textBefore.endsWith('/'));
                        renderTagMenu(textBefore.endsWith('#') ? '#' : textBefore.endsWith('@') ? '@' : '', textBefore.endsWith('#') || textBefore.endsWith('@'));
                        if (success) {
                            showStatus("Preset terms loaded from Dynalist.", true);
                        } else {
                            showStatus("No preset terms found in Dynalist. Add via Edit Presets.", false);
                        }
                    });
                    refreshDynalist();
                } else {
                    docId = "QBPYSvxs9JO2gYfbf0sPhsoF";
                    localStorage.setItem('dynalistDocId', docId);
                    showStatus("Document ID reset to default.", true);
                    presetTermsNodeId = null;
                    termsNodeId = null;
                    fetchPresetTerms().then(success => {
                        renderPresetMenu('hashPresetMenu', hashPresetTerms, '#', 'hashPresetTerms');
                        renderPresetMenu('atPresetMenu', atPresetTerms, '@', 'atPresetTerms');
                        renderFilterMenu('hashFilterMenu', hashPresetTerms, '#');
                        renderFilterMenu('atFilterMenu', atPresetTerms, '@');
                        const textarea = document.getElementById('dynalistInput');
                        const cursorPos = textarea.selectionStart;
                        const textBefore = textarea.value.substring(0, cursorPos);
                        renderSlashMenu(textBefore.endsWith('/'));
                        renderTagMenu(textBefore.endsWith('#') ? '#' : textBefore.endsWith('@') ? '@' : '', textBefore.endsWith('#') || textBefore.endsWith('@'));
                        if (success) {
                            showStatus("Preset terms loaded from Dynalist.", true);
                        } else {
                            showStatus("No preset terms found in Dynalist. Add via Edit Presets.", false);
                        }
                    });
                    refreshDynalist();
                }
            }
        }

        // Function to open Dynalist
        function openDynalist() {
            console.log("Opening Dynalist");
            window.open(`https://dynalist.io/d/${docId}`, '_blank');
        }

        // Function to get the current time in hh:mm format
        function getCurrentTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // Function to add note to Dynalist using API
        async function addNoteToDynalistWithApi(note) {
            showStatus("Adding note via API...");
            try {
                const readResponse = await fetch('https://dynalist.io/api/v1/doc/read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: apiKey, file_id: docId })
                });
                const readResult = await readResponse.json();
                if (readResult._code !== "Ok") {
                    console.error("Failed to read document for note insertion:", readResult._msg);
                    showStatus("API Error: " + readResult._msg, false);
                    return false;
                }
                const rootNodes = readResult.nodes.filter(node => node.parent === "root");
                const lastIndex = rootNodes.length;

                const response = await fetch('https://dynalist.io/api/v1/doc/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: apiKey,
                        file_id: docId,
                        changes: [{
                            action: 'insert',
                            parent_id: 'root',
                            content: `[${getCurrentTime()}] ${note}`,
                            index: lastIndex
                        }]
                    })
                });
                const result = await response.json();
                if (result._code === "Ok") {
                    showStatus("Note added successfully!");
                    refreshDynalist();
                    return true;
                } else {
                    showStatus("API Error: " + result._msg, false);
                    return false;
                }
            } catch (error) {
                console.error("API Error:", error);
                showStatus("Error connecting to Dynalist API", false);
                return false;
            }
        }

        // Fallback method using URL parameters if no API is available
        function addNoteToDynalistManually(note) {
            showStatus("Ready! Now manually add this note in Dynalist.", true);
            try {
                const searchParam = encodeURIComponent(`[${getCurrentTime()}] ${note}`);
                const searchUrl = `https://dynalist.io/d/${docId}?q=${searchParam}`;
                window.open(searchUrl, '_blank');
                return true;
            } catch (e) {
                console.error("Error preparing note:", e);
                showStatus("Error preparing note", false);
                return false;
            }
        }

        // Main function to add a note
        function addNoteToDynalist(note) {
            if (apiKey) {
                return addNoteToDynalistWithApi(note);
            } else {
                return addNoteToDynalistManually(note);
            }
        }

        // Initialize the app
        async function initializeApp() {
            console.log("Initializing app...");
            const storedApiKey = localStorage.getItem('dynalistApiKey');
            if (storedApiKey) {
                apiKey = storedApiKey;
                console.log("API key found in local storage");
                updateApiStatus(true);
            } else {
                console.log("No API key found, prompting user");
                hashPresetTerms = [];
                atPresetTerms = [];
            }

            if (apiKey) {
                const success = await fetchPresetTerms();
                if (success) {
                    console.log("Preset terms loaded successfully");
                    showStatus("Preset terms loaded from Dynalist.", true);
                } else {
                    hashPresetTerms = JSON.parse(localStorage.getItem('hashPresetTerms')) || [];
                    atPresetTerms = JSON.parse(localStorage.getItem('atPresetTerms')) || [];
                    if (hashPresetTerms.length === 0 && atPresetTerms.length === 0) {
                        console.log("No terms in Dynalist or local storage");
                        showStatus("No preset terms found in Dynalist. Add via Edit Presets.", false);
                    } else {
                        console.log("Loaded terms from local storage");
                        showStatus("Failed to load from Dynalist, using local terms.", true);
                    }
                }
            } else {
                hashPresetTerms = JSON.parse(localStorage.getItem('hashPresetTerms')) || [];
                atPresetTerms = JSON.parse(localStorage.getItem('atPresetTerms')) || [];
                if (hashPresetTerms.length === 0 && atPresetTerms.length === 0) {
                    console.log("No API key and no terms in local storage");
                    showStatus("Please set API key to load terms.", false);
                } else {
                    console.log("Loaded terms from local storage");
                    showStatus("No API key, using local terms.", true);
                }
            }

            renderPresetMenu('hashPresetMenu', hashPresetTerms, '#', 'hashPresetTerms');
            renderPresetMenu('atPresetMenu', atPresetTerms, '@', 'atPresetTerms');
            renderFilterMenu('hashFilterMenu', hashPresetTerms, '#');
            renderFilterMenu('atFilterMenu', atPresetTerms, '@');
            renderSlashMenu(false);
            renderTagMenu('', false);
            fetchDocumentTitle();
            refreshDynalist();

            const enterButton = document.getElementById('enterButton');
            if (enterButton) {
                console.log("Enter button initialized");
                enterButton.addEventListener('click', () => {
                    console.log("Enter button clicked");
                    const textarea = document.getElementById('dynalistInput');
                    const note = textarea.value.trim();
                    if (note) {
                        if (addNoteToDynalist(note)) {
                            textarea.value = '';
                        }
                    } else {
                        showStatus("Please enter a note first", false);
                    }
                });
            } else {
                console.error("Enter button not found");
            }

            const dynalistInput = document.getElementById('dynalistInput');
            if (dynalistInput) {
                console.log("Textarea initialized");
                dynalistInput.addEventListener('input', () => {
                    const value = dynalistInput.value;
                    const cursorPos = dynalistInput.selectionStart;
                    const textBefore = value.substring(0, cursorPos);
                    renderSlashMenu(textBefore.endsWith('/'));
                    renderTagMenu(textBefore.endsWith('#') ? '#' : textBefore.endsWith('@') ? '@' : '', textBefore.endsWith('#') || textBefore.endsWith('@'));
                });
                dynalistInput.addEventListener('keydown', (event) => {
                    const slashMenu = document.getElementById('slashMenu');
                    const tagMenu = document.getElementById('tagMenu');
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        console.log("Enter key pressed in textarea");
                        document.getElementById('enterButton').click();
                    } else if (event.key === 'Escape' && (slashMenu.classList.contains('show') || tagMenu.classList.contains('show'))) {
                        event.preventDefault();
                        slashMenu.classList.remove('show');
                        tagMenu.classList.remove('show');
                        dynalistInput.focus();
                    }
                });
            } else {
                console.error("Textarea not found");
            }

            const dateButton = document.getElementById('dateButton');
            if (dateButton) {
                console.log("Date button initialized");
                dateButton.addEventListener('click', () => {
                    console.log("Date button clicked");
                    addDateToDynalist();
                });
            } else {
                console.error("Date button not found");
            }

            const hashPresetButton = document.getElementById('hashPresetButton');
            if (hashPresetButton) {
                console.log("Hash preset button initialized");
                hashPresetButton.addEventListener('click', () => {
                    console.log("Hash preset button clicked");
                    const menu = document.getElementById('hashPresetMenu');
                    if (menu) {
                        menu.classList.toggle('show');
                        document.getElementById('atPresetMenu')?.classList.remove('show');
                        document.getElementById('hashFilterMenu')?.classList.remove('show');
                        document.getElementById('atFilterMenu')?.classList.remove('show');
                        document.getElementById('slashMenu')?.classList.remove('show');
                        document.getElementById('tagMenu')?.classList.remove('show');
                    }
                });
            } else {
                console.error("Hash preset button not found");
            }

            const atPresetButton = document.getElementById('atPresetButton');
            if (atPresetButton) {
                console.log("At preset button initialized");
                atPresetButton.addEventListener('click', () => {
                    console.log("At preset button clicked");
                    const menu = document.getElementById('atPresetMenu');
                    if (menu) {
                        menu.classList.toggle('show');
                        document.getElementById('hashPresetMenu')?.classList.remove('show');
                        document.getElementById('hashFilterMenu')?.classList.remove('show');
                        document.getElementById('atFilterMenu')?.classList.remove('show');
                        document.getElementById('slashMenu')?.classList.remove('show');
                        document.getElementById('tagMenu')?.classList.remove('show');
                    }
                });
            } else {
                console.error("At preset button not found");
            }

            const hashFilterButton = document.getElementById('hashFilterButton');
            if (hashFilterButton) {
                console.log("Hash filter button initialized");
                hashFilterButton.addEventListener('click', () => {
                    console.log("Hash filter button clicked");
                    const menu = document.getElementById('hashFilterMenu');
                    if (menu) {
                        menu.classList.toggle('show');
                        document.getElementById('hashPresetMenu')?.classList.remove('show');
                        document.getElementById('atPresetMenu')?.classList.remove('show');
                        document.getElementById('atFilterMenu')?.classList.remove('show');
                        document.getElementById('slashMenu')?.classList.remove('show');
                        document.getElementById('tagMenu')?.classList.remove('show');
                    }
                });
            } else {
                console.error("Hash filter button not found");
            }

            const atFilterButton = document.getElementById('atFilterButton');
            if (atFilterButton) {
                console.log("At filter button initialized");
                atFilterButton.addEventListener('click', () => {
                    console.log("At filter button clicked");
                    const menu = document.getElementById('atFilterMenu');
                    if (menu) {
                        menu.classList.toggle('show');
                        document.getElementById('hashPresetMenu')?.classList.remove('show');
                        document.getElementById('atPresetMenu')?.classList.remove('show');
                        document.getElementById('hashFilterMenu')?.classList.remove('show');
                        document.getElementById('slashMenu')?.classList.remove('show');
                        document.getElementById('tagMenu')?.classList.remove('show');
                    }
                });
            } else {
                console.error("At filter button not found");
            }

            document.addEventListener('click', (event) => {
                const hashPresetButton = document.getElementById('hashPresetButton');
                const hashPresetMenu = document.getElementById('hashPresetMenu');
                const atPresetButton = document.getElementById('atPresetButton');
                const atPresetMenu = document.getElementById('atPresetMenu');
                const hashFilterButton = document.getElementById('hashFilterButton');
                const hashFilterMenu = document.getElementById('hashFilterMenu');
                const atFilterButton = document.getElementById('atFilterButton');
                const atFilterMenu = document.getElementById('atFilterMenu');
                const slashMenu = document.getElementById('slashMenu');
                const tagMenu = document.getElementById('tagMenu');
                const dynalistInput = document.getElementById('dynalistInput');

                if (hashPresetButton && hashPresetMenu && !hashPresetButton.contains(event.target) && !hashPresetMenu.contains(event.target)) {
                    hashPresetMenu.classList.remove('show');
                }
                if (atPresetButton && atPresetMenu && !atPresetButton.contains(event.target) && !atPresetMenu.contains(event.target)) {
                    atPresetMenu.classList.remove('show');
                }
                if (hashFilterButton && hashFilterMenu && !hashFilterButton.contains(event.target) && !hashFilterMenu.contains(event.target)) {
                    hashFilterMenu.classList.remove('show');
                }
                if (atFilterButton && atFilterMenu && !atFilterButton.contains(event.target) && !atFilterMenu.contains(event.target)) {
                    atFilterMenu.classList.remove('show');
                }
                if (slashMenu && !slashMenu.contains(event.target) && !dynalistInput.contains(event.target)) {
                    slashMenu.classList.remove('show');
                }
                if (tagMenu && !tagMenu.contains(event.target) && !dynalistInput.contains(event.target)) {
                    tagMenu.classList.remove('show');
                }
            });
        }

        // Run initialization
        window.addEventListener('load', () => {
            console.log("Window loaded, starting initialization");
            initializeApp();
        });

        // Handle messages for API key
        window.addEventListener('message', (event) => {
            if (event.data.apiKey) {
                console.log("Received API key via message");
                apiKey = event.data.apiKey;
                localStorage.setItem('dynalistApiKey', apiKey);
                updateApiStatus(true);
                showStatus("API key received. Reloading data.", true);
                fetchDocumentTitle();
                fetchPresetTerms().then(success => {
                    renderPresetMenu('hashPresetMenu', hashPresetTerms, '#', 'hashPresetTerms');
                    renderPresetMenu('atPresetMenu', atPresetTerms, '@', 'atPresetTerms');
                    renderFilterMenu('hashFilterMenu', hashPresetTerms, '#');
                    renderFilterMenu('atFilterMenu', atPresetTerms, '@');
                    const textarea = document.getElementById('dynalistInput');
                    const cursorPos = textarea.selectionStart;
                    const textBefore = textarea.value.substring(0, cursorPos);
                    renderSlashMenu(textBefore.endsWith('/'));
                    renderTagMenu(textBefore.endsWith('#') ? '#' : textBefore.endsWith('@') ? '@' : '', textBefore.endsWith('#') || textBefore.endsWith('@'));
                    if (success) {
                        showStatus("Preset terms loaded from Dynalist.", true);
                    } else {
                        showStatus("No preset terms found in Dynalist. Add via Edit Presets.", false);
                    }
                });
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'92f72c0aad84add7',t:'MTc0NDUwNzU1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>