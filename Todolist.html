<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart To-Do List</title>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --border-color: #dee2e6;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: var(--dark-color);
            background-color: #f5f7fa;
            max-width: 800px;
            min-width: 320px;
            margin: 0 auto;
            padding: 1rem;
            position: relative;
            padding-bottom: 2.5rem;
            overflow-x: hidden;
        }
        
        .container {
            background-color: white;
            border-radius: 6px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            min-width: 320px;
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: clamp(1.25rem, 3vw, 1.5rem);
            font-weight: 600;
        }
        
        .input-group {
            display: flex;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        #title {
            width: 100%;
            font-size: clamp(0.9rem, 2vw, 1rem);
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        #new-item {
            flex: 1;
            min-width: 150px;
            padding: 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            transition: border-color 0.2s;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
            box-sizing: border-box;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem clamp(0.8rem, 2vw, 1rem);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
            white-space: nowrap;
            border-radius: 4px;
        }
        
        button:hover {
            background-color: var(--secondary-color);
        }
        
        button.secondary {
            background-color: var(--light-color);
            color: var(--dark-color);
            border: 1px solid var(--border-color);
        }
        
        button.secondary:hover {
            background-color: #e9ecef;
        }
        
        button.danger {
            background-color: var(--danger-color);
        }
        
        button.danger:hover {
            background-color: #d1145a;
        }
        
        .controls {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        
        #todo-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .todo-item {
            display: flex;
            align-items: center;
            padding: 0.2rem;
            margin-bottom: 0.0rem;
            background-color: white;
            border-radius: 4px;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            cursor: move;
        }
        
        .todo-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .todo-item.dragging {
            opacity: 0.6;
            background-color: var(--light-color);
            margin-bottom: 0.4rem;
        }
        
        .todo-item.completed {
            background-color: #f8f9fa;
        }
        
        .todo-item.completed .item-text {
            text-decoration: line-through;
            color: #6c757d;
        }
        
        .section-item {
            background-color: #e9ecef;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .section-item .item-text {
            font-weight: bold;
        }
        
        .drag-handle {
            cursor: move;
            margin-right: 0.8rem;
            color: var(--border-color);
            font-size: 1.1rem;
            transition: color 0.2s;
            padding: 0.2rem;
            flex-shrink: 0;
        }
        
        .todo-item:hover .drag-handle {
            color: var(--primary-color);
        }
        
        .item-checkbox {
            margin-right: 0.8rem;
            width: 1.1rem;
            height: 1.1rem;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .item-text {
            flex: 1;
            margin-right: 0.8rem;
            padding: 0.2rem 0;
            cursor: text;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .item-edit {
            flex: 1;
            margin-right: 0.8rem;
            padding: 0.4rem;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            font-size: inherit;
            display: none;
            min-width: 0;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1.1rem;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 0.2rem;
            flex-shrink: 0;
        }
        
        .delete-btn:hover {
            opacity: 1;
        }
        
        .saved-lists {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        .saved-lists h2 {
            color: var(--primary-color);
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
        }
        
        .saved-files-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        
        .saved-file {
            padding: 0.8rem;
            background-color: white;
            border-radius: 4px;
            box-shadow: var(--shadow);
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
            font-size: 0.9rem;
        }
        
        .saved-file:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .saved-file-name {
            font-weight: 500;
            margin-bottom: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .saved-file-date {
            font-size: 0.75rem;
            color: #6c757d;
        }
        
        .delete-saved-btn {
            position: absolute;
            top: 0.3rem;
            right: 0.3rem;
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.7;
        }
        
        .delete-saved-btn:hover {
            opacity: 1;
        }
        
        #status {
            margin: 0.8rem 0;
            padding: 0.8rem;
            border-radius: 4px;
            background-color: #e8f4fd;
            color: var(--primary-color);
            display: none;
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        #current-folder {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .footer {
            position: absolute;
            bottom: 0.5rem;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.8rem;
            color: #6c757d;
            padding: 0.5rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            width: 400px;
            max-width: 90%;
        }
        
        .modal h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .modal-content {
            margin: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        #import-content, #export-content {
            width: 100%;
            height: 150px;
            margin: 1rem 0;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: inherit;
        }
        
        .import-format label, .export-format label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }
        
        @media (max-width: 600px) {
            body {
                width: 100%;
                min-width: 320px;
                padding: 0.5rem;
            }
            
            .container {
                width: calc(100% - 1rem);
                padding: 1rem;
            }
            
            #title, #new-item, button {
                font-size: 16px !important;
                padding: 0.8rem !important;
            }
            
            .modal {
                width: 90%;
                padding: 1rem;
            }
            
            .controls {
                gap: 0.3rem;
            }
            
            button {
                padding: 0.8rem !important;
                flex: 1;
                min-width: calc(50% - 0.5rem);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Smart To-Do List</h1>
        
        <input type="text" id="title" placeholder="List title...">
        
        <div class="input-group">
            <input type="text" id="new-item" placeholder="Add new task">
            <button onclick="addItem()">Add Task</button>
            <button onclick="addSection()" class="secondary">Add Section</button>
        </div>
        
        <ul id="todo-list"></ul>
        
        <div id="status"></div>
        
        <div class="controls">
            <button onclick="saveToFile()">üíæ Save</button>
            <button onclick="loadFromFile()">üìÇ Load</button>
            <button onclick="showExportModal()">üì§ Export</button>
            <button onclick="showImportModal()">üì• Import</button>
            <button onclick="clearList()">üóëÔ∏è Clear</button>
            <button onclick="selectFolder()">üìÅ Folder</button>
        </div>
        
        <div id="current-folder"></div>
        
        <div class="saved-lists">
            <h2>Saved Lists</h2>
            <div id="saved-files-container" class="saved-files-container"></div>
        </div>
    </div>

    <div class="footer">
        &copy; 2025 Dr. Wen-Ming Yang Lab. All rights reserved v11.
    </div>

    <!-- Export Modal -->
    <div class="overlay" id="export-overlay"></div>
    <div class="modal" id="export-modal">
        <h3>Export To-Do List</h3>
        <div class="modal-content">
            <div class="export-format">
                <label>
                    <input type="radio" name="export-format" value="markdown" checked>
                    Markdown
                </label>
                <label>
                    <input type="radio" name="export-format" value="html">
                    HTML
                </label>
                <label>
                    <input type="radio" name="export-format" value="plaintext">
                    Plain Text
                </label>
            </div>
            <textarea id="export-content" readonly></textarea>
            <div class="modal-actions">
                <button onclick="copyToClipboard('export-content')">Copy</button>
                <button class="secondary" onclick="hideModal('export')">Close</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="overlay" id="import-overlay"></div>
    <div class="modal" id="import-modal">
        <h3>Import To-Do List</h3>
        <div class="modal-content">
            <div class="import-format">
                <label>
                    <input type="radio" name="import-format" value="markdown" checked>
                    Markdown
                </label>
                <label>
                    <input type="radio" name="import-format" value="html">
                    HTML
                </label>
                <label>
                    <input type="radio" name="import-format" value="plaintext">
                    Plain Text
                </label>
            </div>
            <textarea id="import-content" placeholder="Paste your list content here..."></textarea>
            <div class="modal-actions">
                <button onclick="importList()">Import</button>
                <button class="secondary" onclick="hideModal('import')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // File system variables
        let directoryHandle;
        let fileHandles = {};
        let draggedItem = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTitleWithCurrentDate();
            checkForSavedFiles();
            setupDragAndDrop();
            setupDirectEditing();
            setViewportScale();
            
            // Add event listeners for format changes
            document.querySelectorAll('input[name="export-format"]').forEach(radio => {
                radio.addEventListener('change', updateExportContent);
            });
        });

        function setViewportScale() {
            const viewport = document.querySelector('meta[name="viewport"]');
            if (window.innerWidth <= 600) {
                viewport.setAttribute('content', 'width=600, initial-scale=' + (window.innerWidth / 600));
            } else {
                viewport.setAttribute('content', 'width=device-width, initial-scale=1.0');
            }
        }

        window.addEventListener('resize', setViewportScale);
        window.addEventListener('orientationchange', setViewportScale);

        /* ========== CORE FUNCTIONALITY ========== */
function setupDirectEditing() {
    document.getElementById('todo-list').addEventListener('click', function(e) {
        // Don't start editing if we're dragging
        if (document.querySelector('.todo-item.dragging')) return;
        
        const textSpan = e.target.closest('.item-text');
        if (textSpan) {
            const li = textSpan.closest('.todo-item');
            const editInput = li.querySelector('.item-edit');
            
            textSpan.style.display = 'none';
            editInput.style.display = 'block';
            editInput.value = textSpan.textContent;
            editInput.focus();
            
            // Move cursor to end and open keyboard on mobile
            setTimeout(() => {
                editInput.setSelectionRange(editInput.value.length, editInput.value.length);
                editInput.focus();
            }, 50);
            
            function saveEdit() {
                const newText = editInput.value.trim();
                if (newText) {
                    textSpan.textContent = newText;
                    showStatus(li.classList.contains('section-break') ? 'Section updated' : 'Task updated', 'success');
                } else if (li.classList.contains('blank-item')) {
                    // Remove blank item if empty
                    li.remove();
                    
                    // Show empty state if no items left
                    const todoList = document.getElementById('todo-list');
                    if (todoList.children.length === 0) {
                        todoList.innerHTML = '<div class="empty-state">No tasks yet</div>';
                    }
                }
                textSpan.style.display = 'block';
                editInput.style.display = 'none';
                
                editInput.removeEventListener('blur', saveEdit);
                editInput.removeEventListener('keyup', handleKeyUp);
            }
            
            function handleKeyUp(e) {
                if (e.key === 'Enter') {
                    // Save current item
                    saveEdit();
                    
                    // Create new blank item below
                    if (!li.classList.contains('blank-item')) {
                        createBlankItem(li);
                    }
                }
                if (e.key === 'Escape') {
                    textSpan.style.display = 'block';
                    editInput.style.display = 'none';
                }
            }
            
            editInput.addEventListener('blur', saveEdit);
            editInput.addEventListener('keyup', handleKeyUp);
        }
    });
    
    // Add click listener to document to remove empty blank items
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.todo-item') && !e.target.closest('.input-group')) {
            const blankItems = document.querySelectorAll('.todo-item.blank-item');
            blankItems.forEach(item => {
                if (item.querySelector('.item-edit').value.trim() === '') {
                    item.remove();
                    
                    // Show empty state if no items left
                    const todoList = document.getElementById('todo-list');
                    if (todoList.children.length === 0) {
                        todoList.innerHTML = '<div class="empty-state">No tasks yet</div>';
                    }
                }
            });
        }
    });
}

function createBlankItem(afterItem) {
    const li = document.createElement('li');
    li.className = 'todo-item blank-item';
    li.draggable = true;
    li.innerHTML = `
        <span class="drag-handle">‚ò∞</span>
        <input type="checkbox" class="item-checkbox">
        <span class="item-text">New Item</span>
        <input type="text" class="item-edit" value="">
        <button class="delete-btn">√ó</button>
    `;
    
    afterItem.parentNode.insertBefore(li, afterItem.nextSibling);
    
    // Focus on the new item's edit field
    const editInput = li.querySelector('.item-edit');
    li.querySelector('.item-text').style.display = 'none';
    editInput.style.display = 'block';
    editInput.focus();
    
    // Set up event listeners for this new item
    function saveEdit() {
        const textSpan = li.querySelector('.item-text');
        const newText = editInput.value.trim();
        if (newText) {
            textSpan.textContent = newText;
            li.classList.remove('blank-item');
            showStatus('Task added', 'success');
        } else {
            li.remove();
            
            // Show empty state if no items left
            const todoList = document.getElementById('todo-list');
            if (todoList.children.length === 0) {
                todoList.innerHTML = '<div class="empty-state">No tasks yet</div>';
            }
        }
        textSpan.style.display = 'block';
        editInput.style.display = 'none';
        
        editInput.removeEventListener('blur', saveEdit);
        editInput.removeEventListener('keyup', handleKeyUp);
    }
    
    function handleKeyUp(e) {
        if (e.key === 'Enter') {
            saveEdit();
            if (!li.classList.contains('blank-item')) {
                createBlankItem(li);
            }
        }
        if (e.key === 'Escape') {
            li.querySelector('.item-text').style.display = 'block';
            editInput.style.display = 'none';
            li.remove();
        }
    }
    
    editInput.addEventListener('blur', saveEdit);
    editInput.addEventListener('keyup', handleKeyUp);
}
        function setupDragAndDrop() {
            const list = document.getElementById('todo-list');
            
            list.addEventListener('dragstart', function(e) {
                if (e.target.classList.contains('todo-item')) {
                    draggedItem = e.target;
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                }
            });
            
            list.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const targetItem = e.target.closest('.todo-item');
                if (targetItem && targetItem !== draggedItem) {
                    const rect = targetItem.getBoundingClientRect();
                    const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                    list.insertBefore(draggedItem, next ? targetItem.nextSibling : targetItem);
                }
            });
            
            list.addEventListener('dragend', function(e) {
                if (e.target.classList.contains('todo-item')) {
                    e.target.classList.remove('dragging');
                    draggedItem = null;
                }
            });
        }

        function updateTitleWithCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = days[today.getDay()];
            document.getElementById('title').value = `Tasks ${year}${month}${day}-${dayName}`;
        }

        /* ========== ITEM MANAGEMENT ========== */
        function addItem() {
            const input = document.getElementById('new-item');
            const text = input.value.trim();
            if (text === '') {
                showStatus('Please enter a task', 'warning');
                return;
            }
            
            const li = document.createElement('li');
            li.className = 'todo-item';
            li.draggable = true;
            li.innerHTML = `
                <span class="drag-handle">‚ò∞</span>
                <input type="checkbox" class="item-checkbox" onchange="toggleComplete(this)">
                <span class="item-text">${text}</span>
                <input type="text" class="item-edit" value="${text}">
                <button class="delete-btn" onclick="deleteItem(this)">√ó</button>
            `;
            
            document.getElementById('todo-list').appendChild(li);
            input.value = '';
            showStatus('Task added', 'success');
        }

        function addSection() {
            const input = document.getElementById('new-item');
            const text = input.value.trim();
            if (text === '') {
                showStatus('Please enter a section name', 'warning');
                return;
            }
            
            const li = document.createElement('li');
            li.className = 'todo-item section-item';
            li.draggable = true;
            li.innerHTML = `
                <span class="drag-handle">‚ò∞</span>
                <span class="item-text">${text}</span>
                <input type="text" class="item-edit" value="${text}">
                <button class="delete-btn" onclick="deleteItem(this)">√ó</button>
            `;
            
            document.getElementById('todo-list').appendChild(li);
            input.value = '';
            showStatus('Section added', 'success');
        }

        function toggleComplete(checkbox) {
            const li = checkbox.closest('.todo-item');
            if (!li.classList.contains('section-item')) {
                li.classList.toggle('completed', checkbox.checked);
            }
        }

        function deleteItem(button) {
            const li = button.closest('.todo-item');
            li.style.transform = 'translateX(-100%)';
            li.style.opacity = '0';
            setTimeout(() => {
                li.remove();
                showStatus('Item deleted', 'warning');
            }, 200);
        }

        /* ========== IMPORT/EXPORT FUNCTIONALITY ========== */
        function showExportModal() {
            showModal('export');
            updateExportContent();
        }

        function showImportModal() {
            showModal('import');
            document.getElementById('import-content').value = '';
        }

        function showModal(type) {
            document.getElementById(`${type}-overlay`).style.display = 'block';
            document.getElementById(`${type}-modal`).style.display = 'block';
        }

        function hideModal(type) {
            document.getElementById(`${type}-overlay`).style.display = 'none';
            document.getElementById(`${type}-modal`).style.display = 'none';
        }

        function updateExportContent() {
            const format = document.querySelector('input[name="export-format"]:checked').value;
            const title = document.getElementById('title').value || 'Untitled List';
            let content = '';
            
            if (format === 'markdown') {
                content = `# ${title}\n\n`;
                document.querySelectorAll('#todo-list .todo-item').forEach(item => {
                    const text = item.querySelector('.item-text').textContent;
                    if (item.classList.contains('section-item')) {
                        content += `\n## ${text}\n\n`;
                    } else {
                        const checked = item.querySelector('.item-checkbox').checked ? 'x' : ' ';
                        content += `- [${checked}] ${text}\n`;
                    }
                });
            } 
            else if (format === 'html') {
                content = `<h1>${title}</h1>\n<ul>\n`;
                document.querySelectorAll('#todo-list .todo-item').forEach(item => {
                    const text = item.querySelector('.item-text').textContent;
                    if (item.classList.contains('section-item')) {
                        content += `</ul>\n<h2>${text}</h2>\n<ul>\n`;
                    } else {
                        const checked = item.querySelector('.item-checkbox').checked ? ' checked' : '';
                        content += `  <li><input type="checkbox"${checked}> ${text}</li>\n`;
                    }
                });
                content += '</ul>';
            } 
            else { // plaintext
                content = `${title}\n${'='.repeat(title.length)}\n\n`;
                document.querySelectorAll('#todo-list .todo-item').forEach(item => {
                    const text = item.querySelector('.item-text').textContent;
                    if (item.classList.contains('section-item')) {
                        content += `\n${text}\n${'-'.repeat(text.length)}\n\n`;
                    } else {
                        const checked = item.querySelector('.item-checkbox').checked ? '[‚úì]' : '[ ]';
                        content += `${checked} ${text}\n`;
                    }
                });
            }
            
            document.getElementById('export-content').value = content;
        }

        function importList() {
            const content = document.getElementById('import-content').value.trim();
            if (!content) {
                showStatus('No content to import', 'warning');
                return;
            }
            
            const format = document.querySelector('input[name="import-format"]:checked').value;
            
            try {
                let items = [];
                let title = document.getElementById('title').value || "Imported List";
                
                if (format === 'markdown') {
                    // Parse markdown format
                    const lines = content.split('\n');
                    const firstLine = lines[0].trim();
                    if (firstLine.startsWith('# ')) {
                        title = firstLine.substring(2).trim();
                    }
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('## ')) {
                            items.push({
                                text: line.substring(3).trim(),
                                isSection: true
                            });
                        } else if (line.startsWith('- [')) {
                            const match = line.match(/^-\s*\[(.)\]\s*(.*)$/);
                            if (match) {
                                items.push({
                                    text: match[2],
                                    completed: match[1].toLowerCase() === 'x',
                                    isSection: false
                                });
                            }
                        }
                    }
                }
                else if (format === 'html') {
                    // Parse HTML format
                    const titleMatch = content.match(/<h1[^>]*>([^<]*)<\/h1>/i);
                    if (titleMatch) title = titleMatch[1];
                    
                    // Process sections and items
                    const sections = content.split(/<\/?ul>/i);
                    let currentSection = null;
                    
                    for (const section of sections) {
                        const sectionMatch = section.match(/<h2[^>]*>([^<]*)<\/h2>/i);
                        if (sectionMatch) {
                            currentSection = sectionMatch[1].trim();
                            items.push({
                                text: currentSection,
                                isSection: true
                            });
                        }
                        
                        const itemRegex = /<li[^>]*>\s*<input[^>]*type=["']checkbox["'][^>]*>([^<]*)<\/li>/gi;
                        let match;
                        while ((match = itemRegex.exec(section)) !== null) {
                            const checked = match[0].includes(' checked');
                            items.push({
                                text: match[1].trim(),
                                completed: checked,
                                isSection: false
                            });
                        }
                    }
                }
                else { // plaintext
                    // Parse plain text format
                    const lines = content.split('\n');
                    const firstLine = lines[0].trim();
                    if (!firstLine.startsWith('[') && !firstLine.startsWith('-')) {
                        title = firstLine;
                    }
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line === '') continue;
                        
                        // Check for section (text followed by underline)
                        if (i < lines.length - 1 && lines[i+1].trim().match(/^-+$/)) {
                            items.push({
                                text: line,
                                isSection: true
                            });
                            i++; // Skip the underline line
                        } else if (line.startsWith('[‚úì]') || line.startsWith('[ ]')) {
                            items.push({
                                text: line.substring(3).trim(),
                                completed: line.startsWith('[‚úì]'),
                                isSection: false
                            });
                        } else if (line.startsWith('- [‚úì]') || line.startsWith('- [ ]')) {
                            items.push({
                                text: line.substring(5).trim(),
                                completed: line.startsWith('- [‚úì]'),
                                isSection: false
                            });
                        }
                    }
                }
                
                // Update the current list
                document.getElementById('title').value = title;
                const todoList = document.getElementById('todo-list');
                
                // Remove empty state if present
                if (todoList.querySelector('.empty-state')) {
                    todoList.innerHTML = '';
                }
                
                if (items.length === 0) {
                    showStatus('No tasks found in import', 'warning');
                } else {
                    // Merge with existing items (replace duplicates)
                    const existingItems = {};
                    document.querySelectorAll('#todo-list .todo-item').forEach(item => {
                        const text = item.querySelector('.item-text').textContent;
                        existingItems[text] = item;
                    });
                    
                    items.forEach(item => {
                        // If item already exists, update its status
                        if (existingItems[item.text]) {
                            const existingItem = existingItems[item.text];
                            if (item.isSection) {
                                existingItem.className = 'todo-item section-item';
                            } else {
                                const checkbox = existingItem.querySelector('.item-checkbox');
                                checkbox.checked = item.completed;
                                if (item.completed) {
                                    existingItem.classList.add('completed');
                                } else {
                                    existingItem.classList.remove('completed');
                                }
                            }
                        } 
                        // Otherwise add new item
                        else {
                            const li = document.createElement('li');
                            li.className = item.isSection ? 'todo-item section-item' : 'todo-item';
                            li.draggable = true;
                            
                            if (item.isSection) {
                                li.innerHTML = `
                                    <span class="drag-handle">‚ò∞</span>
                                    <span class="item-text">${item.text}</span>
                                    <input type="text" class="item-edit" value="${item.text}">
                                    <button class="delete-btn" onclick="deleteItem(this)">√ó</button>
                                `;
                            } else {
                                li.innerHTML = `
                                    <span class="drag-handle">‚ò∞</span>
                                    <input type="checkbox" class="item-checkbox" ${item.completed ? 'checked' : ''}>
                                    <span class="item-text">${item.text}</span>
                                    <input type="text" class="item-edit" value="${item.text}">
                                    <button class="delete-btn" onclick="deleteItem(this)">√ó</button>
                                `;
                                if (item.completed) li.classList.add('completed');
                            }
                            todoList.appendChild(li);
                        }
                    });
                    
                    showStatus(`Imported ${items.length} items`, 'success');
                }
                
                hideModal('import');
            } catch (error) {
                showStatus('Error importing list: ' + error.message, 'error');
                console.error(error);
            }
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            
            navigator.clipboard.writeText(element.value).then(() => {
                showStatus('Copied to clipboard!', 'success');
                hideModal('export');
            }).catch(err => {
                showStatus('Failed to copy: ' + err, 'error');
            });
        }

        /* ========== FILE MANAGEMENT ========== */
        async function selectFolder() {
            try {
                directoryHandle = await window.showDirectoryPicker();
                updateFolderDisplay();
                checkForSavedFiles();
                showStatus('Folder selected', 'success');
            } catch (error) {
                if (error.name !== 'AbortError') {
                    showStatus('Error selecting folder', 'error');
                    console.error(error);
                }
            }
        }

        function updateFolderDisplay() {
            if (directoryHandle && directoryHandle.name) {
                document.getElementById('current-folder').textContent = `Current folder: ${directoryHandle.name}`;
            } else {
                document.getElementById('current-folder').textContent = 'No folder selected';
            }
        }

        async function saveToFile() {
            try {
                const title = document.getElementById('title').value.trim();
                if (!title) {
                    showStatus('Please enter a title for your list', 'warning');
                    return;
                }
                
                if (!directoryHandle) {
                    showStatus('Please select a folder first', 'warning');
                    return await selectFolder();
                }
                
                const items = [];
                document.querySelectorAll('#todo-list .todo-item').forEach(li => {
                    const isSection = li.classList.contains('section-item');
                    items.push({
                        text: li.querySelector('.item-text').textContent,
                        completed: isSection ? false : li.classList.contains('completed'),
                        isSection: isSection
                    });
                });
                
                const todoData = {
                    title: title,
                    items: items,
                    timestamp: new Date().toISOString()
                };
                
                const fileName = `${title.replace(/[^a-z0-9]/gi, '_')}.todo`;
                const fileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(todoData, null, 2));
                await writable.close();
                
                fileHandles[fileName] = fileHandle;
                
                showStatus(`Saved as "${fileName}"`, 'success');
                checkForSavedFiles();
            } catch (error) {
                showStatus(`Error saving: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function loadFromFile(fileName) {
            try {
                if (!directoryHandle) {
                    showStatus('Please select a folder first', 'warning');
                    return await selectFolder();
                }
                
                let fileHandle;
                if (fileName) {
                    fileHandle = await directoryHandle.getFileHandle(fileName);
                } else {
                    fileHandle = await window.showOpenFilePicker({
                        types: [{
                            description: 'To-Do Files',
                            accept: { 'application/json': ['.todo'] }
                        }],
                        excludeAcceptAllOption: true
                    });
                    fileHandle = fileHandle[0];
                }
                
                const file = await fileHandle.getFile();
                const contents = await file.text();
                const todoData = JSON.parse(contents);
                
                document.getElementById('title').value = todoData.title;
                
                const todoList = document.getElementById('todo-list');
                todoList.innerHTML = '';
                
                if (todoData.items.length === 0) {
                    todoList.innerHTML = '<div class="empty-state">No tasks yet</div>';
                } else {
                    todoData.items.forEach(item => {
                        const li = document.createElement('li');
                        li.className = item.isSection ? 'todo-item section-item' : 'todo-item';
                        li.draggable = true;
                        
                        if (item.isSection) {
                            li.innerHTML = `
                                <span class="drag-handle">‚ò∞</span>
                                <span class="item-text">${item.text}</span>
                                <input type="text" class="item-edit" value="${item.text}">
                                <button class="delete-btn" onclick="deleteItem(this)">√ó</button>
                            `;
                        } else {
                            li.innerHTML = `
                                <span class="drag-handle">‚ò∞</span>
                                <input type="checkbox" class="item-checkbox" onchange="toggleComplete(this)" ${item.completed ? 'checked' : ''}>
                                <span class="item-text">${item.text}</span>
                                <input type="text" class="item-edit" value="${item.text}">
                                <button class="delete-btn" onclick="deleteItem(this)">√ó</button>
                            `;
                            if (item.completed) li.classList.add('completed');
                        }
                        todoList.appendChild(li);
                    });
                }
                
                showStatus(`Loaded "${file.name}"`, 'success');
            } catch (error) {
                if (error.name !== 'AbortError') {
                    showStatus(`Error loading: ${error.message}`, 'error');
                    console.error(error);
                }
            }
        }

        async function deleteFile(fileName, event) {
            event.stopPropagation();
            try {
                if (!directoryHandle) {
                    showStatus('Please select a folder first', 'warning');
                    return await selectFolder();
                }
                
                if (confirm(`Delete "${fileName}"?`)) {
                    await directoryHandle.removeEntry(fileName);
                    showStatus(`Deleted "${fileName}"`, 'warning');
                    checkForSavedFiles();
                }
            } catch (error) {
                showStatus(`Error deleting: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function checkForSavedFiles() {
            try {
                const container = document.getElementById('saved-files-container');
                
                if (!directoryHandle) {
                    container.innerHTML = '<div class="empty-state">Select a folder to view saved lists</div>';
                    return;
                }
                
                const files = [];
                for await (const entry of directoryHandle.values()) {
                    if (entry.kind === 'file' && (entry.name.endsWith('.todo') || entry.name.endsWith('.json'))) {
                        const file = await entry.getFile();
                        files.push({
                            name: entry.name,
                            date: new Date(file.lastModified)
                        });
                    }
                }
                
                displaySavedFiles(files.sort((a, b) => b.date - a.date));
            } catch (error) {
                console.error(error);
                document.getElementById('saved-files-container').innerHTML = 
                    '<div class="empty-state">Error loading saved files</div>';
            }
        }

        function displaySavedFiles(files) {
            const container = document.getElementById('saved-files-container');
            
            if (files.length === 0) {
                container.innerHTML = '<div class="empty-state">No saved lists found</div>';
                return;
            }
            
            container.innerHTML = '';
            
            files.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'saved-file';
                fileElement.innerHTML = `
                    <div class="saved-file-name">${file.name.replace('.todo', '').replace('.json', '')}</div>
                    <div class="saved-file-date">${file.date.toLocaleDateString()}</div>
                    <button class="delete-saved-btn" onclick="deleteFile('${file.name.replace(/'/g, "\\'")}', event)">√ó</button>
                `;
                fileElement.addEventListener('click', () => loadFromFile(file.name));
                container.appendChild(fileElement);
            });
        }

        function clearList() {
            if (confirm('Clear current list?')) {
                document.getElementById('todo-list').innerHTML = 
                    '<div class="empty-state">No tasks yet</div>';
                updateTitleWithCurrentDate();
                showStatus('List cleared', 'warning');
            }
        }

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            statusEl.className = '';
            
            switch(type) {
                case 'success':
                    statusEl.style.backgroundColor = '#e6ffed';
                    statusEl.style.color = '#22863a';
                    break;
                case 'warning':
                    statusEl.style.backgroundColor = '#fff8e6';
                    statusEl.style.color = '#d46b08';
                    break;
                case 'error':
                    statusEl.style.backgroundColor = '#ffe6e6';
                    statusEl.style.color = '#cb2431';
                    break;
                default:
                    statusEl.style.backgroundColor = '#e8f4fd';
                    statusEl.style.color = '#0366d6';
            }
            
            setTimeout(() => {
                statusEl.style.opacity = '0';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                    statusEl.style.opacity = '1';
                }, 200);
            }, 2000);
        }

        document.getElementById('new-item').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addItem();
            }
        });
    </script>
</body>
</html>