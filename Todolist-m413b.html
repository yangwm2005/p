<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart To-Do List</title>
<style>
    :root {
        --primary-color: #4361ee;
        --secondary-color: #3f37c9;
        --accent-color: #4895ef;
        --light-color: #f8f9fa;
        --dark-color: #212529;
        --success-color: #4cc9f0;
        --danger-color: #f72585;
        --section-color: #7209b7;
        --border-color: #adb5bd;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    * {
        -webkit-tap-highlight-color: transparent;
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        line-height: 1.4;
        color: var(--dark-color);
        background-color: #f5f7fa;
        margin: 0 auto;
        padding: 1rem;
        min-height: 100vh;
        touch-action: manipulation;
        max-width: 800px;
        position: relative;
    }
    
    .container {
        background-color: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: var(--shadow);
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        min-height: calc(100vh - 2rem);
    }
    
    h1 {
        color: var(--primary-color);
        text-align: center;
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
        font-weight: 600;
    }
    
.input-group {
    display: flex;
    margin-bottom: 1rem;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-items: stretch; /* Ensures equal height */
}

#title {
    width: 100%;
    font-size: 1rem;
    padding: 0.8rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 1rem;
    transition: border-color 0.2s;
    background-color: white;
}

#new-item {
    flex: 1 1 300px; /* Reduced from 500px for better mobile behavior */
    padding: 0.8rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    min-width: 0;
    min-height: 50px;
    box-sizing: border-box; /* Ensures padding doesn't affect width */
}

/* Add button styling */
.input-group > button[onclick="addItem()"] {
    flex: 0 0 auto; /* Prevent flex growing/shrinking */
    width: 100px; /* Fixed width */
    min-width: 100px; /* Prevents shrinking below this */
    min-height: 50px; /* Matches input height */
    padding: 0;
    border-radius: 8px;
    font-size: 0.95rem;
    white-space: nowrap;
}

/* Mobile responsiveness */
@media (max-width: 700px) {
    #new-item {
        flex: 1 1 200px; /* More flexible on smaller screens */
    }
    
    .input-group > button[onclick="addItem()"] {
        width: 80px;
        min-width: 80px;
        font-size: 0.9rem;
    }
}

@media (max-width: 500px) {
    #new-item {
        flex: 1 1 100%; /* Full width on very small screens */
        min-height: 45px; /* Slightly reduced height */
    }
    
    .input-group > button[onclick="addItem()"] {
        width: 100%;
        min-width: 100%;
        margin-top: 0.3rem; /* Space between input and button when stacked */
    }
    
    /* Stack vertically on very small screens */
    .input-group {
        flex-direction: column;
        gap: 0.3rem;
    }
}
    
    button {

        background-color: var(--primary-color);
        color: white;
        border: none;
        padding: 0.5rem 0.3rem; 
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        font-size: 0.95rem;
        border-radius: 8px;
        min-width: fit-content;
        white-space: nowrap;
        flex: 1 1 auto;
    }
    
    button:hover {
        background-color: var(--secondary-color);
    }
    
    button.secondary {
        background-color: var(--light-color);
        color: var(--dark-color);
        border: 1px solid var(--border-color);
    }
    
    button.secondary:hover {
        background-color: #e9ecef;
    }
    
    button.danger {
        background-color: var(--danger-color);
    }
    
    button.danger:hover {
        background-color: #d1145a;
    }
    
    button.section-btn {
        background-color: var(--section-color);
    }
    
    button.section-btn:hover {
        background-color: #5a189a;
    }
    
    .controls {
        display: flex;
        gap: 0.3rem;
        margin: 1.0rem 0;
        flex-wrap: wrap;
    }
    
    .controls button {
        flex: 1 1 calc(25% - 0.5rem);
        min-width: 120px;
        max-width: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.2rem;
    }
    
    #todo-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .todo-item {
        display: flex;
        align-items: center;
        padding: 0.1rem;
        margin-bottom: 0.1rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: var(--shadow);
        transition: all 0.2s;
        cursor: pointer;
        position: relative;
    }
    
    .todo-item.section-break {
        background-color: rgba(114, 9, 183, 0.1);
        border-left: 1px solid var(--section-color);
        padding: 0.0rem 0.3rem;
        margin: 0.1rem 0;
    }
    
    .todo-item.section-break .item-text {
        font-weight: bold;
        color: var(--section-color);
    }
    
    .todo-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }
    
    .todo-item.dragging {
        opacity: 0.6;
        background-color: var(--light-color);
    }
    
    .todo-item.completed {
        background-color: #f8f9fa;
    }
    
    .todo-item.completed .item-text {
        text-decoration: line-through;
        color: #6c757d;
    }
    
    .drag-handle {
        cursor: move;
        margin-right: 0.8rem;
        color: var(--border-color);
        font-size: 1.1rem;
        transition: color 0.2s;
        padding: 0.2rem;
        flex-shrink: 0;
    }
    
    .todo-item:hover .drag-handle {
        color: var(--primary-color);
    }
    
    .todo-item.section-break:hover .drag-handle {
        color: var(--section-color);
    }
    
    /* Update the checkbox styles (replace existing .item-checkbox styles) */
    .item-checkbox {
        margin-right: 0.8rem;
        width: 1.3rem;
        height: 1.3rem;
        cursor: pointer;
        flex-shrink: 0;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-color: white;
        border: 2px solid var(--border-color);
        border-radius: 4px;
        position: relative;
        transition: all 0.2s;
    }

    .item-checkbox:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
        background-position: center;
        background-repeat: no-repeat;
        background-size: 80%;
    }

    /* Better contrast on hover */
    .item-checkbox:hover {
        border-color: var(--secondary-color);
    }

@media screen and (-webkit-min-device-pixel-ratio:0) {
    .item-checkbox {
        -webkit-appearance: none;
        appearance: none;
        background-color: white;
    }
}

/* Better contrast on hover */
.item-checkbox:hover {
    border-color: var(--secondary-color);
}

    
    .item-text {
        flex: 1;
        margin-right: 0.8rem;
        padding: 0.2rem 0;
        cursor: text;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 1rem;
    }
    
    .item-edit {
        flex: 1;
        margin-right: 0.8rem;
        padding: 0.6rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
        display: none;
        min-width: 0;
        background-color: white;
        width: 100%;
    }
    
    .delete-btn {
        background: none;
        border: none;
        color: var(--danger-color);
        cursor: pointer;
        font-size: 1.5rem;
        opacity: 0.7;
        transition: opacity 0.2s;
        padding: 0.2rem;
        flex-shrink: 0;
        min-width: 30px;
        max-width: 40px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .delete-btn:hover {
        opacity: 1;
    }
    
    .saved-lists {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--border-color);
    }
    
    .saved-lists h2 {
        color: var(--primary-color);
        margin-bottom: 0.8rem;
        font-size: 1.1rem;
    }
    
    .saved-files-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 0.5rem;
    }
    
    .saved-file {
        padding: 0.8rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: var(--shadow);
        transition: all 0.2s;
        cursor: pointer;
        position: relative;
        min-height: 80px;
    }
    
    .saved-file:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .saved-file-name {
        font-weight: 500;
        margin-bottom: 0.3rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding-right: 1.5rem;
    }
    
    .saved-file-date {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .delete-saved-btn {
        position: absolute;
        top: 0.3rem;
        right: 0.3rem;
        background: none;
        border: none;
        color: var(--danger-color);
        cursor: pointer;
        font-size: 1rem;
        opacity: 0.7;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .delete-saved-btn:hover {
        opacity: 1;
    }
    
    #status {
        margin: 0.8rem 0;
        padding: 0.8rem;
        border-radius: 8px;
        background-color: #e8f4fd;
        color: var(--primary-color);
        display: none;
        font-size: 0.9rem;
    }
    
    .empty-state {
        text-align: center;
        padding: 1.5rem;
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    #current-folder {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.5rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 0.5rem;
        background-color: #f8f9fa;
        border-radius: 8px;
    }
    
    .footer {
        text-align: center;
        font-size: 0.8rem;
        color: #6c757d;
        padding: 1rem 0;
        margin-top: 1.5rem;
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        z-index: 1000;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .modal h3 {
        margin-top: 0;
        color: var(--primary-color);
        font-size: 1.3rem;
    }
    
    .modal-content {
        margin: 1rem 0;
        display: flex;
        flex-direction: column;
        gap: 0.8rem;
    }
    
    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .modal-actions button {
        min-width: 80px;
    }
    
    .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
    }
    
    #import-content, #export-content {
        width: 100%;
        height: 150px;
        margin: 1rem 0;
        padding: 0.8rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-family: inherit;
        font-size: 0.9rem;
    }
    
    .import-format label, .export-format label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
        padding: 0.3rem 0;
    }
    
    input[type="radio"] {
        width: 1.1rem;
        height: 1.1rem;
    }
    

    
    @media (max-width: 500px) {
        .container {
            padding: 1rem;
        }
        
.controls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
    margin: 1rem 0;
}

/* Base button style - 3 per row */
.controls button {
    flex: 1 1 calc(33.333% - 0.4rem);
    min-width: calc(33.333% - 0.4rem);
    max-width: calc(33.333% - 0.4rem);
    padding: 0.6rem 0.3rem; /* More compact padding */
    font-size: 0.85rem; /* Slightly smaller text */
}

/* Tablets - 3 buttons per row */
@media (max-width: 700px) {
    .controls button {
    flex: 1 1 calc(33.333% - 0.4rem);
    min-width: calc(33.333% - 0.4rem);
    max-width: calc(33.333% - 0.4rem);
    padding: 0.6rem 0.3rem; /* More compact padding */
    font-size: 0.85rem; /* Slightly smaller text */
    }
}

/* Small phones - 3 buttons per row (more space) */
@media (max-width: 400px) {
    .controls button {
    flex: 1 1 calc(33.333% - 0.4rem);
    min-width: calc(33.333% - 0.4rem);
    max-width: calc(33.333% - 0.4rem);
    padding: 0.6rem 0.3rem; /* More compact padding */
    font-size: 0.85rem; /* Slightly smaller text */
    }
}       

 
/* Mobile-specific Add button styling */
@media (max-width: 600px) {
    .input-group > button[onclick="addItem()"] {
        height: 50px; /* More reasonable mobile height */
        line-height: 50px; /* Matches height for vertical center */
        width: 70px; /* Slightly wider for better touch */
        min-width: 70px;
        flex: 0 0 auto;
        padding: 0;
        margin-left: 0.3rem; /* Spacing from input */
        font-size: 0.9rem; /* Adjust font size */
    }
    
    /* Make input field fill remaining space */
    #new-item {
        flex: 1 1 auto;
        min-width: 0;
    }
}

/* For very small phones */
@media (max-width: 400px) {
    .input-group > button[onclick="addItem()"] {
        width: 60px;
        min-width: 60px;
        font-size: 0.8rem;
    }
}
        
        .saved-files-container {
            grid-template-columns: 1fr;
        }
        
        .modal {
            width: 95%;
            padding: 1rem;
        }
        
        .modal-actions {
            flex-direction: column;
        }
        
        .modal-actions button {
            width: 100%;
        }
        
        h1 {
            font-size: 1.3rem;
        }
    }

@media print {
    .print-checkbox {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 1px solid #000;
        margin-right: 10px;
        text-align: center;
        line-height: 18px;
        font-size: 16px;
        vertical-align: middle;
    }
    
    .print-item {
        display: flex;
        align-items: center;
        margin: 8px 0;
        page-break-inside: avoid;
    }
    
    .print-item-text {
        flex: 1;
    }
    
    .print-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 15px;
        color: #000;
    }
    
    .print-date {
        font-size: 14px;
        color: #666;
        margin-bottom: 20px;
    }
    
    .print-section {
        font-weight: bold;
        font-size: 18px;
        margin: 15px 0 8px 0;
        padding-bottom: 3px;
        border-bottom: 1px solid #ddd;
    }
}

/* Share modal specific styles */
.share-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.share-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    background-color: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 80px;
    border: none;
    background-color: var(--light-color);
}

.share-option:hover {
    background-color: #e9ecef;
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

.share-option span {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

#share-text {
    width: 100%;
    height: 150px;
    margin: 1rem 0;
    padding: 0.8rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-family: inherit;
    font-size: 0.9rem;
    resize: none;
}

/* Email-specific formatting */
.email-html {
    font-family: Arial, sans-serif;
    line-height: 1.5;
    color: #333;
}

.email-html h2 {
    color: #4361ee;
    border-bottom: 2px solid #4361ee;
    padding-bottom: 5px;
}

.email-html h3 {
    color: #7209b7;
    margin-top: 15px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 3px;
}

.email-html ul {
    padding-left: 20px;
    list-style-type: none;
}

.email-html li {
    margin-bottom: 8px;
    position: relative;
    padding-left: 25px;
}

.email-html li:before {
    content: "•";
    position: absolute;
    left: 0;
    color: #4361ee;
}

.empty-state {
    text-align: center;
    padding: 1.5rem;
    color: #6c757d;
    font-size: 0.9rem;
    background-color: #f8f9fa;
    border-radius: 8px;
    margin: 1rem 0;
}

.import-options {
    margin-bottom: 1rem;
}

.import-options label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.95rem;
    padding: 0.3rem 0;
}

/* Help button specific style */
button.help-btn {
    background-color: #6c757d;
}

button.help-btn:hover {
    background-color: #5a6268;
}

/* Help modal content */
.help-section {
    margin-bottom: 1.5rem;
}

.help-section h4 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.help-section ul {
    padding-left: 1.5rem;
    margin: 0.5rem 0;
}

.help-section li {
    margin-bottom: 0.5rem;
    line-height: 1.5;
}

    /* Hide desktop buttons on mobile */
    @media (max-width: 500px) {
        .desktop-only {
            display: none !important;
        }
    }
    
    /* Hide mobile buttons on desktop */
    @media (min-width: 600px) {
        .mobile-only {
            display: none !important;
        }
    }
    /*  👇 Add drag-and-drop loading support */
#drop-button.dragover {
    background-color: #dbeafe !important;
    border: 2px dashed #4361ee;
}

.note-btn {
    background: none;
    border: none;
    color: var(--accent-color);
    cursor: pointer;
    font-size: 1.2rem;
    opacity: 0.7;
    transition: opacity 0.2s;
    padding: 0.2rem;
    flex-shrink: 0;
    min-width: 30px;
    max-width: 40px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.3rem;
}

.note-btn:hover {
    opacity: 1;
}

.todo-item.section-break .note-btn {
    display: none;
}

/* Floating arrow buttons */
#scroll-down-btn, #scroll-up-btn {
    position: fixed;
    left: 1rem;
    z-index: 9999;
    width: 44px;
    height: 44px;
    font-size: 1.5rem;
    line-height: 44px;
    text-align: center;
    border-radius: 50%;
    border: none;
    background-color: var(--section-color);
    color: white;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    transition: background-color 0.2s ease, opacity 0.3s ease;
}

/* Hover effect */
#scroll-down-btn:hover, #scroll-up-btn:hover {
    background-color: #5a189a;
}

/* Position: top-left for down button */
#scroll-down-btn {
    top: 1rem;
    right: 1rem;
    left: auto;
}

/* Position: bottom-left for up button */
#scroll-up-btn {
    bottom: 1rem;
    right: 1rem;
    left: auto;
}

/* Hide buttons on small screens (max-width: 700px) */
@media (max-width: 700px) {
    #scroll-down-btn, #scroll-up-btn {
        display: none !important;
    }
}

/* Scroll-down button base style */
#scroll-down-btn {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 9999;
    width: 36px;
    height: 36px;
    font-size: 1.2rem;
    font-weight: bold;
    line-height: 36px;
    text-align: center;
    border-radius: 50%;
    border: none;
    background-color: transparent;
    color: var(--section-color);
    cursor: pointer;
    transition: opacity 0.5s ease, background-color 0.2s ease;
    opacity: 1;
}

/* Hover glow effect */
#scroll-down-btn:hover {
    background-color: rgba(114, 9, 183, 0.1);
}

/* Fade-out state */
#scroll-down-btn.fade-out {
    opacity: 0;
    pointer-events: none;
}

/* Hide on small screens */
@media (max-width: 700px) {
    #scroll-down-btn {
        display: none !important;
    }
}

.note-preview {
    position: absolute;
    bottom: 100%;
    left: 0;
    margin-top: -0.5rem;
    background-color: white;
    border: 1px solid var(--border-color);
    padding: 0.5rem;
    border-radius: 8px;
    box-shadow: var(--shadow);
    font-size: 0.85rem;
    color: var(--dark-color);
    white-space: pre-wrap;
    max-width: 300px;
    z-index: 999;
    display: none;
}

.todo-item:hover .note-btn.has-note + .note-preview {
    display: block;
}

.todo-item .note-btn.has-note {
    font-weight: bold;
    color: var(--accent-color);
}

/* Note indicator dot */
.note-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    background-color: var(--accent-color);
    border-radius: 50%;
    margin-right: 8px;
    vertical-align: middle;
    opacity: 0;
    transition: opacity 0.2s;
}

.todo-item:hover .note-indicator {
    opacity: 1;
}

.todo-item .note-btn.has-note ~ .note-indicator {
    opacity: 1;
}

/* For section breaks - hide indicator */
.todo-item.section-break .note-indicator {
    display: none;
}

</style>
</head>
<body>
    <div class="container">
        <h1>Smart To-Do List</h1>
        
        <input type="text" id="title" placeholder="List title...">
        
        <div class="input-group">
            <input type="text" id="new-item" placeholder="Add new task" enterkeyhint="done">
            <button onclick="addItem()">Add</button>
        </div>
        
        <ul id="todo-list"></ul>
        
        <div id="status"></div>
        

<div class="controls">
    <button class="section-btn" onclick="addSectionBreak()">⏸️ Section</button>

    <!-- Desktop buttons -->
    <button class="desktop-only" onclick="saveToFile()">💾 Save</button>
    <button class="desktop-only" onclick="loadFromFile()">📂 Load</button>
<!-- 👇 Add drag-and-drop loading support  -->
    <button id="drop-button" class="desktop-only secondary">📂 Drop File</button>    
    <!-- Mobile buttons (alternative actions)
    <button class="mobile-only" onclick="showExportModal()">💾 Save</button>
    <button class="mobile-only" onclick="showImportModal()">📂 Load</button>  -->
            <button onclick="showExportModal()">📤 Export</button>
            <button onclick="showImportModal()">📥 Import</button>    
    <button onclick="clearList()">🗑️ Clear</button>
    <button onclick="printToPDF()">🖨️ Print/PDF</button>
    <button onclick="popoutPDFWithNotes()">🪟 Popout PDF</button>
    <button onclick="printToPDFWithNotes()">🖨️ PDF+Notes</button>
    <button onclick="popoutListWithNotes()">📋 Popout1</button>
    <button onclick="popoutListWithNotes2()">📋 Popout2</button>
    <button onclick="printVisibleList()">🖨️ Print View</button>
    <button onclick="shareList()">📤 Share</button>
    <button onclick="showHelpModal()" class="help-btn">❓ Help</button>
</div>
        
        <div id="current-folder"></div>
        
        <div class="saved-lists">
            <h2>Saved Lists</h2>
            <div id="saved-files-container" class="saved-files-container"></div>
        </div>

        
        <div class="footer">
            &copy; 2025 Dr. Wen-Ming Yang Lab. All rights reserved. (m413b notepopout+bullet)
        </div>
    </div>

    <!-- Import Modal -->
<div class="import-options">
    <label>
        <input type="checkbox" id="append-import" checked>
        Append to current list
    </label>
</div>

    <!-- Export Modal -->
    <div class="overlay" id="export-overlay"></div>
    <div class="modal" id="export-modal">
        <h3>Export To-Do List</h3>
        <div class="modal-content">
            <div class="export-format">
                <label>
                    <input type="radio" name="export-format" value="markdown" checked>
                    Markdown
                </label>
                <label>
                    <input type="radio" name="export-format" value="html">
                    HTML
                </label>
                <label>
                    <input type="radio" name="export-format" value="plaintext">
                    Plain Text
                </label>
            </div>
            <textarea id="export-content" readonly></textarea>
            <div class="modal-actions">
                <button onclick="copyToClipboard('export-content')">Copy</button>
                <button class="secondary" onclick="hideModal('export')">Close</button>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="overlay" id="import-overlay"></div>
    <div class="modal" id="import-modal">
        <h3>Import To-Do List</h3>
        <div class="modal-content">
            <div class="import-format">
                <label>
                    <input type="radio" name="import-format" value="markdown" checked>
                    Markdown
                </label>
                <label>
                    <input type="radio" name="import-format" value="html">
                    HTML
                </label>
                <label>
                    <input type="radio" name="import-format" value="plaintext">
                    Plain Text
                </label>
            </div>
            <textarea id="import-content" placeholder="Paste your list content here..."></textarea>
            <div class="modal-actions">
                <button onclick="importList()">Import</button>
                <button class="secondary" onclick="hideModal('import')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
    // File system variables
    let directoryHandle;
    let fileHandles = {};
    let draggedItem = null;
    let touchStartY = 0;
    let isDragging = false;
    
    // Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateTitleWithCurrentDate();
    checkForSavedFiles();
    setupDirectEditing();
    setupDragAndDrop();
    setupMobileEvents();

    // Add event listeners for format changes
    document.querySelectorAll('input[name="export-format"]').forEach(radio => {
        radio.addEventListener('change', updateExportContent);
    });

// 👇 Add drag-and-drop loading support
const dropButton = document.getElementById('drop-button');

if (dropButton) {
    // Highlight button on drag over
    dropButton.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropButton.classList.add('dragover');
    });

    dropButton.addEventListener('dragleave', () => {
        dropButton.classList.remove('dragover');
    });

    dropButton.addEventListener('drop', async (e) => {
        e.preventDefault();
        dropButton.classList.remove('dragover');

        const file = e.dataTransfer.files[0];
        if (!file || (!file.name.endsWith('.json') && !file.name.endsWith('.todo'))) {
            showStatus('Invalid file format. Only .json or .todo allowed.', 'error');
            return;
        }

        try {
            const text = await file.text();
            const data = JSON.parse(text);

            document.getElementById('title').value = data.title || 'Imported List';
            const todoList = document.getElementById('todo-list');
            todoList.innerHTML = '';

            if (Array.isArray(data.items)) {
                data.items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'todo-item';
                    li.draggable = true;
                    if (item.isSection) li.classList.add('section-break');
                    if (item.completed) li.classList.add('completed');

                    li.innerHTML = `
                        <span class="drag-handle">☰</span>
                        ${item.isSection ? '' : `<input type="checkbox" class="item-checkbox" ${item.completed ? 'checked' : ''}>`}
                        <span class="item-text">${item.text}</span>
                        <input type="text" class="item-edit" value="${item.text}">
                        <button class="note-btn" onclick="showNoteModal(this)">📝</button>
                        <button class="delete-btn">×</button>
                    `;

                    // Add note data if it exists
                    if (item.note) {
                        li.dataset.note = item.note;
                        const noteBtn = li.querySelector('.note-btn');
                        if (noteBtn && item.note.trim()) {
                            noteBtn.style.fontWeight = 'bold';
                        }
                    }

                    todoList.appendChild(li);
                });

                showStatus(`Loaded "${file.name}" via drag & drop`, 'success');
            } else {
                showStatus('Invalid file structure', 'error');
            }

        } catch (err) {
            console.error(err);
            showStatus('Failed to load file', 'error');
        }
    });
}

});

    function setupMobileEvents() {
        // Prevent zooming on double-tap
        let lastTap = 0;
        document.addEventListener('touchend', function(e) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                e.preventDefault();
            }
            lastTap = currentTime;
        }, { passive: false });
        
        // Better handling for virtual keyboard
        const inputs = document.querySelectorAll('input[type="text"], textarea');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                setTimeout(() => {
                    this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            });
        });
    }

    function setupDragAndDrop() {
        const list = document.getElementById('todo-list');
        
        // For desktop
        list.addEventListener('dragstart', function(e) {
            if (e.target.classList.contains('todo-item')) {
                draggedItem = e.target;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', '');
            }
        });
        
        list.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const targetItem = e.target.closest('.todo-item');
            if (targetItem && targetItem !== draggedItem) {
                const rect = targetItem.getBoundingClientRect();
                const next = (e.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                list.insertBefore(draggedItem, next ? targetItem.nextSibling : targetItem);
            }
        });
        
        list.addEventListener('dragend', function(e) {
            if (e.target.classList.contains('todo-item')) {
                e.target.classList.remove('dragging');
                draggedItem = null;
            }
        });
        
        // For touch devices
        list.addEventListener('touchstart', function(e) {
            const item = e.target.closest('.todo-item');
            if (!item) return;
            
            // Check if we're touching a delete button or checkbox
            if (e.target.closest('.delete-btn') || e.target.closest('.item-checkbox')) {
                return;
            }
            
            // Check if we're touching the drag handle
            if (e.target.closest('.drag-handle')) {
                touchStartY = e.touches[0].clientY;
                isDragging = true;
                item.classList.add('dragging');
                e.preventDefault();
                return;
            }
            
            // Otherwise prepare for possible text edit
            touchStartY = e.touches[0].clientY;
            isDragging = false;
        }, { passive: false });
        
        list.addEventListener('touchmove', function(e) {
            if (!isDragging) return;
            
            const touchY = e.touches[0].clientY;
            const deltaY = touchY - touchStartY;
            
            const item = document.querySelector('.todo-item.dragging');
            if (!item) return;
            
            // Move the dragged item visually
            item.style.transform = `translateY(${deltaY}px)`;
            
            // Find the item we're hovering over
            const hoverY = e.touches[0].clientY;
            const items = Array.from(list.children).filter(i => i !== item);
            
            for (const targetItem of items) {
                const rect = targetItem.getBoundingClientRect();
                const middle = rect.top + rect.height / 2;
                
                if (hoverY < middle) {
                    list.insertBefore(item, targetItem);
                    break;
                } else if (targetItem === items[items.length - 1]) {
                    list.appendChild(item);
                }
            }
            
            e.preventDefault();
        }, { passive: false });
        
        list.addEventListener('touchend', function(e) {
            const item = document.querySelector('.todo-item.dragging');
            if (item) {
                item.classList.remove('dragging');
                item.style.transform = '';
                isDragging = false;
                e.preventDefault();
            }
        }, { passive: false });
    }

    function setupDirectEditing() {
        const todoList = document.getElementById('todo-list');
        
        // Handle clicks and touches
        todoList.addEventListener('click', handleItemClick);
        //todoList.addEventListener('touchend', handleItemTouch, { passive: false });
todoList.addEventListener('touchstart', handleItemTouchStart, { passive: false });
todoList.addEventListener('touchend', handleItemTouchEnd, { passive: false });

let touchTarget = null;

function handleItemTouchStart(e) {
    const touch = e.touches[0];
    touchTarget = document.elementFromPoint(touch.clientX, touch.clientY);
}

function handleItemTouchEnd(e) {
    if (!touchTarget) return;

    const checkbox = touchTarget.closest('.item-checkbox');
    const deleteBtn = touchTarget.closest('.delete-btn');
    const textSpan = touchTarget.closest('.item-text');

    if (checkbox) {
        e.preventDefault();
        checkbox.checked = !checkbox.checked;
        toggleComplete(checkbox);
    } else if (deleteBtn) {
        e.preventDefault();
        deleteItem(deleteBtn);
} else if (textSpan) {
    e.preventDefault();
    e.stopPropagation(); // <-- Add this line
    startEditing(textSpan.closest('.todo-item'));
}


    touchTarget = null;
}


        
        function handleItemClick(e) {
            // Don't edit if dragging
            if (document.querySelector('.todo-item.dragging')) return;
            
            // Handle checkbox clicks
            if (e.target.classList.contains('item-checkbox')) {
                setTimeout(() => {
                    toggleComplete(e.target);
                }, 0);
                return;
            }
            
            // Handle delete button
            if (e.target.classList.contains('delete-btn')) {
                deleteItem(e.target);
                return;
            }
            
            // Handle item text editing
            const textSpan = e.target.closest('.item-text');
            if (textSpan && !isDragging) {
                startEditing(textSpan.closest('.todo-item'));
            }
        }
        
        function handleItemTouch(e) {
            if (isDragging) return;
            
            const touch = e.changedTouches[0];
            const target = document.elementFromPoint(touch.clientX, touch.clientY);
            
            // Handle checkbox
            const checkbox = target.closest('.item-checkbox');
            if (checkbox) {
                e.preventDefault();
                checkbox.checked = !checkbox.checked;
                toggleComplete(checkbox);
                return;
            }
            
            // Handle delete button
            const deleteBtn = target.closest('.delete-btn');
            if (deleteBtn) {
                e.preventDefault();
                deleteItem(deleteBtn);
                return;
            }
            
            // Handle item text editing
            const textSpan = target.closest('.item-text');
            if (textSpan) {
                e.preventDefault();
                startEditing(textSpan.closest('.todo-item'));
            }
        }
        
        function startEditing(li) {
            const textSpan = li.querySelector('.item-text');
            const editInput = li.querySelector('.item-edit');
            
            textSpan.style.display = 'none';
            editInput.style.display = 'block';
            editInput.value = textSpan.textContent;
            
            // Focus and open keyboard
setTimeout(() => {
    editInput.focus();
    editInput.setSelectionRange(editInput.value.length, editInput.value.length);

    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
        const fakeInput = document.createElement('input');
        fakeInput.style.position = 'absolute';
        fakeInput.style.opacity = 0;
        fakeInput.style.height = 0;
        fakeInput.style.zIndex = -1;
        document.body.appendChild(fakeInput);
        fakeInput.focus();
        setTimeout(() => {
            document.body.removeChild(fakeInput);
            editInput.focus();
        }, 100);
    }
}, 200); // longer timeout for iOS
            
            function saveEdit() {
                const newText = editInput.value.trim();
                if (newText) {
                    textSpan.textContent = newText;
                    showStatus(li.classList.contains('section-break') ? 'Section updated' : 'Task updated', 'success');
                } else if (li.classList.contains('blank-item')) {
                    li.remove();
                    if (todoList.children.length === 0) {
                        todoList.innerHTML = '<div class="empty-state">No tasks yet</div>';
                    }
                }
                textSpan.style.display = 'block';
                editInput.style.display = 'none';
                
                // Clean up event listeners
                editInput.removeEventListener('blur', saveEdit);
                editInput.removeEventListener('keyup', handleKeyUp);
            }
            
            function handleKeyUp(e) {
                if (e.key === 'Enter') {
                    saveEdit();
                    if (!li.classList.contains('blank-item')) {
                        createBlankItem(li);
                    }
                }
                if (e.key === 'Escape') {
                    textSpan.style.display = 'block';
                    editInput.style.display = 'none';
                }
            }
            
            // Delay blur listener to avoid instant blur on iOS
setTimeout(() => {
    editInput.addEventListener('blur', saveEdit);
}, 300);
            editInput.addEventListener('keyup', handleKeyUp);
        }
        
        // Keep existing blank item cleanup
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.todo-item') && !e.target.closest('.input-group')) {
                const blankItems = document.querySelectorAll('.todo-item.blank-item');
                blankItems.forEach(item => {
                    if (item.querySelector('.item-edit').value.trim() === '') {
                        item.remove();
                        if (todoList.children.length === 0) {
                            todoList.innerHTML = '<div class="empty-state">No tasks yet</div>';
                        }
                    }
                });
            }
        });
    }

function createBlankItem(afterItem) {
    const li = document.createElement('li');
    li.className = 'todo-item blank-item';
    li.draggable = true;
li.innerHTML = `
    <span class="drag-handle">☰</span>
    <input type="checkbox" class="item-checkbox">
    <span class="item-text">New Item</span>
    <input type="text" class="item-edit" value="">
    <button class="note-btn" onclick="showNoteModal(this)">📝</button>
    <span class="note-preview" style="display: none;"></span>
    <button class="delete-btn">×</button>
`;

    
    afterItem.parentNode.insertBefore(li, afterItem.nextSibling);
    
    // Focus on the new item's edit field
    const editInput = li.querySelector('.item-edit');
    li.querySelector('.item-text').style.display = 'none';
    editInput.style.display = 'block';
    editInput.focus();
    
    // Set up event listeners for this new item
    function saveEdit() {
        const textSpan = li.querySelector('.item-text');
        const newText = editInput.value.trim();
        if (newText) {
            textSpan.textContent = newText;
            li.classList.remove('blank-item');
            showStatus('Task added', 'success');
        } else {
            li.remove();
            
            // Show empty state if no items left
            const todoList = document.getElementById('todo-list');
            if (todoList.children.length === 0) {
                todoList.innerHTML = '<div class="empty-state">No tasks yet</div>';
            }
        }
        textSpan.style.display = 'block';
        editInput.style.display = 'none';
        
        editInput.removeEventListener('blur', saveEdit);
        editInput.removeEventListener('keyup', handleKeyUp);
    }
    
    function handleKeyUp(e) {
        if (e.key === 'Enter') {
            saveEdit();
            if (!li.classList.contains('blank-item')) {
                createBlankItem(li);
            }
        }
        if (e.key === 'Escape') {
            li.querySelector('.item-text').style.display = 'block';
            editInput.style.display = 'none';
            li.remove();
        }
    }
    
    editInput.addEventListener('blur', saveEdit);
    editInput.addEventListener('keyup', handleKeyUp);
}

        function updateTitleWithCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const dayName = days[today.getDay()];
            document.getElementById('title').value = `Tasks ${year}${month}${day}-${dayName}`;
        }

        function addItem() {
            const input = document.getElementById('new-item');
            const text = input.value.trim();
            if (text === '') {
                showStatus('Please enter a task', 'warning');
                return;
            }
            
            const li = document.createElement('li');
            li.className = 'todo-item';
            li.draggable = true;
li.innerHTML = `
    <span class="drag-handle">☰</span>
    <input type="checkbox" class="item-checkbox">
    <span class="note-indicator"></span>
    <span class="item-text">${text}</span>
    <input type="text" class="item-edit" value="${text}">
    <button class="note-btn" onclick="showNoteModal(this)">📝</button>
    <span class="note-preview" style="display: none;"></span>
    <button class="delete-btn">×</button>
`;

            
            // Remove empty state if present
            const todoList = document.getElementById('todo-list');
            if (todoList.querySelector('.empty-state')) {
                todoList.innerHTML = '';
            }
            
            todoList.appendChild(li);
            input.value = '';
            input.focus();
            showStatus('Task added', 'success');
        }

        function addSectionBreak() {
            const li = document.createElement('li');
            li.className = 'todo-item section-break';
            li.draggable = true;
            li.innerHTML = `
                <span class="drag-handle">☰</span>
                <span class="item-text">New Section</span>
                <input type="text" class="item-edit" value="New Section">
                <button class="delete-btn">×</button>
            `;
            
            // Remove empty state if present
            const todoList = document.getElementById('todo-list');
            if (todoList.querySelector('.empty-state')) {
                todoList.innerHTML = '';
            }
            
            todoList.appendChild(li);
            showStatus('Section added', 'success');
        }

        function toggleComplete(checkbox) {
            const li = checkbox.closest('.todo-item');
            li.classList.toggle('completed', checkbox.checked);
        }

        function deleteItem(button) {
            const li = button.closest('.todo-item');
            li.style.transform = 'translateX(-100%)';
            li.style.opacity = '0';
            setTimeout(() => {
                li.remove();
                
                // Show empty state if no items left
                const todoList = document.getElementById('todo-list');
                if (todoList.children.length === 0) {
                    todoList.innerHTML = '<div class="empty-state">No tasks yet</div>';
                }
                
                showStatus(li.classList.contains('section-break') ? 'Section deleted' : 'Task deleted', 'warning');
            }, 200);
        }

        /* ========== IMPORT/EXPORT FUNCTIONALITY ========== */
        function showExportModal() {
            showModal('export');
            updateExportContent();
        }

        function showImportModal() {
            showModal('import');
            document.getElementById('import-content').value = '';
        }

        function showModal(type) {
            document.getElementById(`${type}-overlay`).style.display = 'block';
            document.getElementById(`${type}-modal`).style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideModal(type) {
            document.getElementById(`${type}-overlay`).style.display = 'none';
            document.getElementById(`${type}-modal`).style.display = 'none';
            document.body.style.overflow = '';
        }

        function updateExportContent() {
            const format = document.querySelector('input[name="export-format"]:checked').value;
            const title = document.getElementById('title').value || 'Untitled List';
            let content = '';
            
            if (format === 'markdown') {
                content = `# ${title}\n\n`;
                document.querySelectorAll('#todo-list .todo-item').forEach(item => {
                    const text = item.querySelector('.item-text').textContent;
                    if (item.classList.contains('section-break')) {
                        content += `## ${text}\n\n`;
                    } else {
                        const checked = item.querySelector('.item-checkbox')?.checked ? 'x' : ' ';
                        content += `- [${checked}] ${text}\n`;
                    }
                });
            } 
            else if (format === 'html') {
                content = `<h1>${title}</h1>\n<ul>\n`;
                document.querySelectorAll('#todo-list .todo-item').forEach(item => {
                    const text = item.querySelector('.item-text').textContent;
                    if (item.classList.contains('section-break')) {
                        content += `</ul>\n<h2>${text}</h2>\n<ul>\n`;
                    } else {
                        const checked = item.querySelector('.item-checkbox')?.checked ? ' checked' : '';
                        content += `  <li><input type="checkbox"${checked}> ${text}</li>\n`;
                    }
                });
                content += '</ul>';
            } 
            else { // plaintext
                content = `${title}\n${'='.repeat(title.length)}\n\n`;
                document.querySelectorAll('#todo-list .todo-item').forEach(item => {
                    const text = item.querySelector('.item-text').textContent;
                    if (item.classList.contains('section-break')) {
                        content += `\n${text}\n${'-'.repeat(text.length)}\n\n`;
                    } else {
                        const checked = item.querySelector('.item-checkbox')?.checked ? '[✓]' : '[ ]';
                        content += `${checked} ${text}\n`;
                    }
                });
            }
            
            document.getElementById('export-content').value = content;
        }

function importList() {
    const content = document.getElementById('import-content').value.trim();
    if (!content) {
        showStatus('No content to import', 'warning');
        return;
    }
    
    const format = document.querySelector('input[name="import-format"]:checked').value;
    const appendMode = document.getElementById('append-import').checked;
    
    try {
        let items = [];
        let importedTitle = document.getElementById('title').value || "Imported List";
        
        if (format === 'markdown') {
            // Parse markdown format
            const lines = content.split('\n');
            const firstLine = lines[0].trim();
            if (firstLine.startsWith('# ')) {
                importedTitle = firstLine.substring(2).trim();
            }
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('## ')) {
                    items.push({
                        text: line.substring(3).trim(),
                        isSection: true
                    });
                } else if (line.startsWith('- [')) {
                    const match = line.match(/^-\s*\[(.)\]\s*(.*)$/);
                    if (match) {
                        items.push({
                            text: match[2],
                            completed: match[1].toLowerCase() === 'x',
                            isSection: false
                        });
                    }
                }
            }
        }
        else if (format === 'html') {
            // Parse HTML format
            const titleMatch = content.match(/<h1[^>]*>([^<]*)<\/h1>/i);
            if (titleMatch) importedTitle = titleMatch[1];
            
            // Find all sections and items
            const sections = content.split(/<\/ul>\s*<h2[^>]*>([^<]*)<\/h2>\s*<ul>/gi);
            for (let i = 0; i < sections.length; i++) {
                if (i % 2 === 1) {
                    // This is a section title
                    items.push({
                        text: sections[i],
                        isSection: true
                    });
                }
                
                // Find items in this section
                const itemRegex = /<li[^>]*>\s*<input[^>]*type=["']checkbox["'][^>]*>([^<]*)<\/li>/gi;
                let match;
                while ((match = itemRegex.exec(sections[i])) !== null) {
                    const checked = match[0].includes(' checked');
                    items.push({
                        text: match[1].trim(),
                        completed: checked,
                        isSection: false
                    });
                }
            }
        }
        else { // plaintext
            // Parse plain text format
            const lines = content.split('\n');
            const firstLine = lines[0].trim();
            if (!firstLine.startsWith('[') && !firstLine.startsWith('-')) {
                importedTitle = firstLine;
            }
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line && !line.startsWith('[') && !line.startsWith('-') && 
                    i < lines.length - 1 && lines[i+1].trim().match(/^-+$/)) {
                    // This is likely a section title
                    items.push({
                        text: line,
                        isSection: true
                    });
                    i++; // Skip the underline
                } else if (line.startsWith('[✓]') || line.startsWith('[ ]')) {
                    items.push({
                        text: line.substring(3).trim(),
                        completed: line.startsWith('[✓]'),
                        isSection: false
                    });
                } else if (line.startsWith('- [✓]') || line.startsWith('- [ ]')) {
                    items.push({
                        text: line.substring(5).trim(),
                        completed: line.startsWith('- [✓]'),
                        isSection: false
                    });
                }
            }
        }
        
        // Get the current todo list
        const todoList = document.getElementById('todo-list');
        
        // Remove empty state if present
        if (todoList.querySelector('.empty-state')) {
            todoList.innerHTML = '';
        }
        
        // Only replace title if not in append mode
        if (!appendMode) {
            document.getElementById('title').value = importedTitle;
            if (!appendMode && items.length > 0) {
                todoList.innerHTML = ''; // Clear existing items if replacing
            }
        }
        
        if (items.length === 0) {
            showStatus('No tasks found in import', 'warning');
        } else {
            // Add imported items
            items.forEach(item => {
                if (item.isSection) {
                    const li = document.createElement('li');
                    li.className = 'todo-item section-break';
                    li.draggable = true;
                    li.innerHTML = `
                        <span class="drag-handle">☰</span>
                        <span class="item-text">${item.text}</span>
                        <input type="text" class="item-edit" value="${item.text}">
                        <button class="delete-btn">×</button>
                    `;
                    todoList.appendChild(li);
                } else {
                    const li = document.createElement('li');
                    li.className = 'todo-item';
                    li.draggable = true;
                    if (item.completed) li.classList.add('completed');
const note = item.note || '';
const noteHTML = note.trim() ? `<span class="note-preview">${note.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span>` : '<span class="note-preview" style="display:none;"></span>';
const noteBtnClass = note.trim() ? 'note-btn has-note' : 'note-btn';

li.innerHTML = `
    <span class="drag-handle">☰</span>
    <input type="checkbox" class="item-checkbox" ${item.completed ? 'checked' : ''}>
    <span class="item-text">${item.text}</span>
    <input type="text" class="item-edit" value="${item.text}">
    <button class="${noteBtnClass}" onclick="showNoteModal(this)">📝</button>
    ${noteHTML}
    <button class="delete-btn">×</button>
`;
                    todoList.appendChild(li);
                }
            });
            
            showStatus(`Imported ${items.length} items (${appendMode ? 'appended' : 'replaced'})`, 'success');
        }
        
        hideModal('import');
    } catch (error) {
        showStatus('Error importing list: ' + error.message, 'error');
        console.error(error);
    }
}
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            element.select();
            
            navigator.clipboard.writeText(element.value).then(() => {
                showStatus('Copied to clipboard!', 'success');
                hideModal('export');
            }).catch(err => {
                showStatus('Failed to copy: ' + err, 'error');
            });
        }

// clear list
function clearList() {
    const todoList = document.getElementById('todo-list');
    
    // Check if there are items to clear
    if (todoList.children.length === 0 || 
        (todoList.children.length === 1 && todoList.querySelector('.empty-state'))) {
        showStatus('List is already empty', 'warning');
        return;
    }
    
    // Confirm before clearing
    if (confirm('Are you sure you want to clear the entire list?')) {
        // Clear all items
        todoList.innerHTML = '';
        
        // Add empty state message
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.textContent = 'No tasks yet';
        todoList.appendChild(emptyState);
        
        // Reset the title to default
        updateTitleWithCurrentDate();
        
        showStatus('List cleared', 'success');
    }
}

        /* ========== FILE MANAGEMENT ========== */
        async function selectFolder() {
            try {
                if (window.showDirectoryPicker) {
                    directoryHandle = await window.showDirectoryPicker();
                    updateFolderDisplay();
                    checkForSavedFiles();
                    showStatus('Folder selected', 'success');
                } else {
                    // Fallback for mobile devices
                    showStatus('On mobile, please use Export/Import instead', 'info');
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    showStatus('Error selecting folder', 'error');
                    console.error(error);
                }
            }
        }

        function updateFolderDisplay() {
            if (directoryHandle && directoryHandle.name) {
                document.getElementById('current-folder').textContent = `Current folder: ${directoryHandle.name}`;
            } else {
                document.getElementById('current-folder').textContent = 'No folder selected (use Export/Import on mobile)';
            }
        }

async function saveToFile() {
    try {
        const title = document.getElementById('title').value.trim();
        if (!title) {
            showStatus('Please enter a title for your list', 'warning');
            return;
        }
        
        // Check if we're on mobile
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile || !window.showDirectoryPicker) {
            // Mobile fallback - use export instead
            showExportModal();
            return;
        }
        
        if (!directoryHandle) {
            showStatus('Please select a folder first', 'warning');
            return await selectFolder();
        }
        
        const items = [];
        document.querySelectorAll('#todo-list .todo-item').forEach(li => {
            items.push({
                text: li.querySelector('.item-text').textContent,
                completed: li.classList.contains('completed'),
                isSection: li.classList.contains('section-break'),
                note: li.dataset.note || ''  // Add note to saved data
            });
        });
        
        const todoData = {
            title: title,
            items: items,
            timestamp: new Date().toISOString()
        };
        
        const fileName = `${title.replace(/[^a-z0-9]/gi, '_')}.todo`;
        const fileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(todoData, null, 2));
        await writable.close();
        
        fileHandles[fileName] = fileHandle;
        
        showStatus(`Saved as "${fileName}"`, 'success');
        checkForSavedFiles();
    } catch (error) {
        showStatus(`Error saving: ${error.message}`, 'error');
        console.error(error);
    }
}

async function loadFromFile(fileName) {
    try {
        // Check if we're on mobile
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile || !window.showDirectoryPicker) {
            // Mobile fallback - use import instead
            showImportModal();
            return;
        }
        
        if (!directoryHandle) {
            showStatus('Please select a folder first', 'warning');
            return await selectFolder();
        }
        
        let fileHandle;
        if (fileName) {
            // When called with a specific filename
            fileHandle = await directoryHandle.getFileHandle(fileName);
        } else {
            // When called to show file picker
            fileHandle = await window.showOpenFilePicker({
                types: [{
                    description: 'To-Do Files',
                    accept: { 'application/json': ['.todo', '.json'] }
                }],
                excludeAcceptAllOption: true
            });
            fileHandle = fileHandle[0];
        }
        
        const file = await fileHandle.getFile();
        const contents = await file.text();
        const todoData = JSON.parse(contents);
        
        document.getElementById('title').value = todoData.title;
        
        const todoList = document.getElementById('todo-list');
        todoList.innerHTML = '';
        
        if (todoData.items.length === 0) {
            todoList.innerHTML = '<div class="empty-state">No tasks yet</div>';
        } else {
            todoData.items.forEach(item => {
                if (item.isSection) {
                    const li = document.createElement('li');
                    li.className = 'todo-item section-break';
                    li.draggable = true;
                    li.innerHTML = `
                        <span class="drag-handle">☰</span>
                        <span class="item-text">${item.text}</span>
                        <input type="text" class="item-edit" value="${item.text}">
                        <button class="delete-btn">×</button>
                    `;
                    todoList.appendChild(li);
                } else {
                    const li = document.createElement('li');
                    li.className = 'todo-item';
                    li.draggable = true;
                    if (item.completed) li.classList.add('completed');
const note = item.note || '';
const noteHTML = note.trim() ? `<span class="note-preview">${note.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span>` : '<span class="note-preview" style="display:none;"></span>';
const noteBtnClass = note.trim() ? 'note-btn has-note' : 'note-btn';

li.innerHTML = `
    <span class="drag-handle">☰</span>
    <input type="checkbox" class="item-checkbox" ${item.completed ? 'checked' : ''}>
    <span class="note-indicator" style="${note.trim() ? 'opacity:1' : 'opacity:0'}"></span>
    <span class="item-text">${item.text}</span>
    <input type="text" class="item-edit" value="${item.text}">
    <button class="${noteBtnClass}" onclick="showNoteModal(this)">📝</button>
    ${noteHTML}
    <button class="delete-btn">×</button>
`;

                    
                    // Add note data if it exists (this is the key fix)
                    if (item.note) {
                        li.dataset.note = item.note;
                        const noteBtn = li.querySelector('.note-btn');
                        if (noteBtn && item.note.trim()) {
                            noteBtn.style.fontWeight = 'bold';
                        }
                    }
                    
                    todoList.appendChild(li);
                }
            });
        }
        
        showStatus(`Loaded "${file.name}"`, 'success');
    } catch (error) {
        if (error.name !== 'AbortError') {
            showStatus(`Error loading: ${error.message}`, 'error');
            console.error(error);
        }
    }
}

        async function deleteFile(fileName, event) {
            event.stopPropagation();
            try {
                if (!directoryHandle) {
                    showStatus('Please select a folder first', 'warning');
                    return await selectFolder();
                }
                
                if (confirm(`Delete "${fileName}"?`)) {
                    await directoryHandle.removeEntry(fileName);
                    showStatus(`Deleted "${fileName}"`, 'warning');
                    checkForSavedFiles();
                }
            } catch (error) {
                showStatus(`Error deleting: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function checkForSavedFiles() {
            try {
                const container = document.getElementById('saved-files-container');
                
                if (!directoryHandle) {
                    container.innerHTML = '<div class="empty-state">Select a folder to view saved lists (use Export/Import on mobile)</div>';
                    return;
                }
                
                const files = [];
                for await (const entry of directoryHandle.values()) {
                    if (entry.kind === 'file' && (entry.name.endsWith('.todo') || entry.name.endsWith('.json'))) {
                        const file = await entry.getFile();
                        files.push({
                            name: entry.name,
                            date: new Date(file.lastModified)
                        });
                    }
                }
                
                displaySavedFiles(files.sort((a, b) => b.date - a.date));
            } catch (error) {
                console.error(error);
                document.getElementById('saved-files-container').innerHTML = 
                    '<div class="empty-state">Error loading saved files</div>';
            }
        }



function displaySavedFiles(files) {
    const container = document.getElementById('saved-files-container');
    
    if (files.length === 0) {
        container.innerHTML = '<div class="empty-state">No saved lists found</div>';
        return;
    }
    
    container.innerHTML = '';
    
    files.forEach(file => {
        const fileElement = document.createElement('div');
        fileElement.className = 'saved-file';
        fileElement.innerHTML = `
            <div class="saved-file-name">${file.name.replace('.todo', '').replace('.json', '')}</div>
            <div class="saved-file-date">${file.date.toLocaleDateString()}</div>
            <button class="delete-saved-btn" onclick="deleteFile('${file.name.replace(/'/g, "\\'")}', event)">×</button>
        `;
        
        // Modified click handler to properly load the file
fileElement.addEventListener('click', async (e) => {
    if (e.target.classList.contains('delete-saved-btn')) return;

    try {
        await loadFromFile(file.name);
        window.scrollTo({ top: 0, behavior: 'smooth' }); // <-- scroll to top after loading
    } catch (error) {
        showStatus(`Error loading file: ${error.message}`, 'error');
        console.error(error);
    }
});

        
        container.appendChild(fileElement);
    });
}

        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            statusEl.className = '';
            
            switch(type) {
                case 'success':
                    statusEl.style.backgroundColor = '#e6ffed';
                    statusEl.style.color = '#22863a';
                    break;
                case 'warning':
                    statusEl.style.backgroundColor = '#fff8e6';
                    statusEl.style.color = '#d46b08';
                    break;
                case 'error':
                    statusEl.style.backgroundColor = '#ffe6e6';
                    statusEl.style.color = '#cb2431';
                    break;
                default:
                    statusEl.style.backgroundColor = '#e8f4fd';
                    statusEl.style.color = '#0366d6';
            }
            
            setTimeout(() => {
                statusEl.style.opacity = '0';
                setTimeout(() => {
                    statusEl.style.display = 'none';
                    statusEl.style.opacity = '1';
                }, 200);
            }, 2000);
        }

        // Add keyboard event for mobile
        document.getElementById('new-item').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addItem();
            }
        });


function printToPDF() {
    // Create print container
    const printContainer = document.createElement('div');
    printContainer.className = 'print-container';
    
    // Add title (left-aligned)
    const title = document.getElementById('title').value || 'To-Do List';
    const titleElement = document.createElement('h1');
    titleElement.className = 'print-title';
    titleElement.style.textAlign = 'left'; // Force left alignment
    titleElement.textContent = title;
    printContainer.appendChild(titleElement);
    
    // Add date (left-aligned)
    const dateElement = document.createElement('div');
    dateElement.className = 'print-date';
    dateElement.style.textAlign = 'left'; // Force left alignment
    dateElement.textContent = 'Generated: ' + new Date().toLocaleString();
    printContainer.appendChild(dateElement);
    
    // Create list container
    const listContainer = document.createElement('div');
    listContainer.className = 'print-list';
    
    // Add all items
    const todoItems = document.querySelectorAll('#todo-list .todo-item');
    todoItems.forEach(item => {
        if (item.classList.contains('section-break')) {
            // Add section header
            const sectionDiv = document.createElement('h2');
            sectionDiv.className = 'print-section';
            sectionDiv.style.textAlign = 'left'; // Force left alignment
            sectionDiv.textContent = item.querySelector('.item-text').textContent;
            listContainer.appendChild(sectionDiv);
        } else {
            // Create item container
            const itemDiv = document.createElement('div');
            itemDiv.className = 'print-item';
            
            // Add SINGLE checkbox (removed duplicate)
            const checkbox = document.createElement('span');
            checkbox.className = 'print-checkbox';
            // Use simple checkbox without nested elements
            checkbox.innerHTML = item.querySelector('.item-checkbox').checked ? 
                '&#x2611;' : '&#x2610;'; // Using HTML entities for checkboxes
            itemDiv.appendChild(checkbox);
            
            // Add item text
            const textSpan = document.createElement('span');
            textSpan.className = 'print-item-text';
            textSpan.textContent = item.querySelector('.item-text').textContent;
            
            if (item.classList.contains('completed')) {
                textSpan.style.textDecoration = 'line-through';
                textSpan.style.color = '#777';
            }
            
            itemDiv.appendChild(textSpan);
            listContainer.appendChild(itemDiv);
        }
    });
    
    printContainer.appendChild(listContainer);
    
    // Add to document
    document.body.appendChild(printContainer);
    
    // Apply print styles
    const style = document.createElement('style');
    style.textContent = `
        @media print {
            body * {
                visibility: hidden;
            }
            .print-container, .print-container * {
                visibility: visible;
            }
            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                text-align: left !important; /* Force left alignment */
            }
            .print-title {
                font-size: 24pt;
                margin-bottom: 10px;
                color: #000;
                border-bottom: 2px solid #000;
                padding-bottom: 5px;
                text-align: left !important; /* Force left alignment */
            }
            .print-date {
                font-size: 10pt;
                margin-bottom: 20px;
                color: #555;
                text-align: left !important; /* Force left alignment */
            }
            .print-section {
                font-size: 16pt;
                margin: 15px 0 5px 0;
                color: #333;
                border-bottom: 1px solid #ddd;
                padding-bottom: 3px;
                text-align: left !important; /* Force left alignment */
            }
            .print-item {
                display: flex;
                align-items: center;
                margin: 8px 0;
                font-size: 12pt;
                page-break-inside: avoid;
            }
            .print-checkbox {
                display: inline-block;
                margin-right: 10px;
                font-size: 16pt; /* Slightly larger checkboxes */
                width: auto !important; /* Remove fixed width */
                height: auto !important; /* Remove fixed height */
                border: none !important; /* Remove border if present */
            }
            .print-item-text {
                flex: 1;
            }
            .print-item.completed .print-item-text {
                text-decoration: line-through;
                color: #777;
            }
        }
    `;
    printContainer.appendChild(style);
    
    // Print
    window.print();
    
    // Clean up
    setTimeout(() => {
        document.body.removeChild(printContainer);
    }, 1000);
}

function printToPDFWithNotes() {
    // Create print container
    const printContainer = document.createElement('div');
    printContainer.className = 'print-container';
    
    // Add title (left-aligned)
    const title = document.getElementById('title').value || 'To-Do List';
    const titleElement = document.createElement('h1');
    titleElement.className = 'print-title';
    titleElement.style.textAlign = 'left';
    titleElement.textContent = title;
    printContainer.appendChild(titleElement);
    
    // Add date (left-aligned)
    const dateElement = document.createElement('div');
    dateElement.className = 'print-date';
    dateElement.style.textAlign = 'left';
    dateElement.textContent = 'Generated: ' + new Date().toLocaleString();
    printContainer.appendChild(dateElement);
    
    // Create list container
    const listContainer = document.createElement('div');
    listContainer.className = 'print-list';
    
    // Add all items with notes
    const todoItems = document.querySelectorAll('#todo-list .todo-item');
    todoItems.forEach(item => {
        if (item.classList.contains('section-break')) {
            // Add section header
            const sectionDiv = document.createElement('h2');
            sectionDiv.className = 'print-section';
            sectionDiv.style.textAlign = 'left';
            sectionDiv.textContent = item.querySelector('.item-text').textContent;
            listContainer.appendChild(sectionDiv);
        } else {
            // Create item container
            const itemDiv = document.createElement('div');
            itemDiv.className = 'print-item';
            
            // Add checkbox
            const checkbox = document.createElement('span');
            checkbox.className = 'print-checkbox';
            checkbox.innerHTML = item.querySelector('.item-checkbox').checked ? 
                '&#x2611;' : '&#x2610;';
            itemDiv.appendChild(checkbox);
            
            // Add item text
            const textSpan = document.createElement('span');
            textSpan.className = 'print-item-text';
            textSpan.textContent = item.querySelector('.item-text').textContent;
            
            if (item.classList.contains('completed')) {
                textSpan.style.textDecoration = 'line-through';
                textSpan.style.color = '#777';
            }
            
            itemDiv.appendChild(textSpan);
            listContainer.appendChild(itemDiv);
            
            // Add note if it exists
            const note = item.dataset.note;
            if (note && note.trim()) {
                const noteDiv = document.createElement('div');
                noteDiv.className = 'print-note';
                noteDiv.style.marginLeft = '30px';
                noteDiv.style.marginTop = '5px';
                noteDiv.style.fontStyle = 'italic';
                noteDiv.style.color = '#555';
                noteDiv.style.fontSize = '0.9em';
                noteDiv.textContent = `Note: ${note}`;
                listContainer.appendChild(noteDiv);
            }
        }
    });
    
    printContainer.appendChild(listContainer);
    
    // Apply print styles
    const style = document.createElement('style');
    style.textContent = `
        @media print {
            body * {
                visibility: hidden;
            }
            .print-container, .print-container * {
                visibility: visible;
            }
            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                text-align: left !important;
            }
            .print-title {
                font-size: 24pt;
                margin-bottom: 10px;
                color: #000;
                border-bottom: 2px solid #000;
                padding-bottom: 5px;
                text-align: left !important;
            }
            .print-date {
                font-size: 10pt;
                margin-bottom: 20px;
                color: #555;
                text-align: left !important;
            }
            .print-section {
                font-size: 16pt;
                margin: 15px 0 5px 0;
                color: #333;
                border-bottom: 1px solid #ddd;
                padding-bottom: 3px;
                text-align: left !important;
            }
            .print-item {
                display: flex;
                align-items: center;
                margin: 8px 0;
                font-size: 12pt;
                page-break-inside: avoid;
            }
            .print-checkbox {
                display: inline-block;
                margin-right: 10px;
                font-size: 16pt;
                width: auto !important;
                height: auto !important;
                border: none !important;
            }
            .print-item-text {
                flex: 1;
            }
            .print-item.completed .print-item-text {
                text-decoration: line-through;
                color: #777;
            }
            .print-note {
                page-break-inside: avoid;
            }
        }
    `;
    printContainer.appendChild(style);
    
    // Add to document
    document.body.appendChild(printContainer);
    
    // Print
    window.print();
    
    // Clean up
    setTimeout(() => {
        document.body.removeChild(printContainer);
    }, 1000);
}



function popoutListWithNotes() {
    // Create HTML content for the popout
    const title = document.getElementById('title').value || 'To-Do List';
    let html = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${title}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    line-height: 1.2;
                    padding: 20px;
                    max-width: 800px;
                    margin: 0 auto;
                    color: #333;
                }
                h1 {
                    color: #4361ee;
                    border-bottom: 2px solid #4361ee;
                    padding-bottom: 3px;
                    margin-bottom: 10px;
                    font-size: 1.5em;
                }
                .date {
                    color: #666;
                    margin-bottom: 10px;
                    font-size: 0.9em;
                }
                .section {
                    color: #7209b7;
                    margin: 25px 0 10px 0;
                    border-bottom: 1px solid #ddd;
                    padding-bottom: 1px;
                    font-size: 1.2em;
                }
                .task {
                    margin: 3px 0;
                    padding: 0px;
                    background: #f8f9fa;
                    border-radius: 5px;
                    display: flex;
                    align-items: flex-start;
                }
                .task.completed {
                    text-decoration: line-through;
                    color: #777;
                    font-size: 1.0em;
                }
                .checkbox {
                    margin-right: 10px;
                    font-size: 1.8em; /* Slightly reduced size */
                    align-self: flex-start; /* Aligns with first line */
                    margin-top: 0.0em; /* Fine-tuned vertical alignment */
                    flex-shrink: 0; /* Prevents checkbox from shrinking */
                }
                .task-content {
                    flex: 1;
                }
                .note {
                    margin-top: 8px;
                    padding: 5px;
                    background: #e8f4fd;
                    border-left: 3px solid #4895ef;
                    font-style: italic;
                    border-radius: 0 4px 4px 0;
                }
            </style>
        </head>
        <body>
            <h1>${title}</h1>
            <div class="date">Generated: ${new Date().toLocaleString()}</div>
    `;

    // Add all items to the popout
    document.querySelectorAll('#todo-list .todo-item').forEach(item => {
        const text = item.querySelector('.item-text').textContent;
        
        if (item.classList.contains('section-break')) {
            html += `<h2 class="section">${text}</h2>`;
        } else {
            const completed = item.classList.contains('completed') ? 'completed' : '';
            const checked = item.querySelector('.item-checkbox').checked ? '✓' : '◻';
            const note = item.dataset.note || '';
            
            html += `
                <div class="task ${completed}">
                    <div class="checkbox">${checked}</div>
                    <div class="task-content">
                        ${text}
                        ${note ? `<div class="note">${note}</div>` : ''}
                    </div>
                </div>
            `;
        }
    });

    html += `</body></html>`;

    // Open new window with the content
    const popout = window.open('', '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
    popout.document.write(html);
    popout.document.close();
    
    // Focus the new window
    popout.focus();
}

function popoutListWithNotes2() {
    // Create a temporary div with the print content
    const printContainer = document.createElement('div');
    printContainer.className = 'print-container';
    
    // Add title
    const title = document.getElementById('title').value || 'To-Do List';
    const titleElement = document.createElement('h1');
    titleElement.className = 'print-title';
    titleElement.textContent = title;
    printContainer.appendChild(titleElement);
    
    // Add date
    const dateElement = document.createElement('div');
    dateElement.className = 'print-date';
    dateElement.textContent = 'Generated: ' + new Date().toLocaleString();
    printContainer.appendChild(dateElement);
    
    // Add all items with notes
    const todoItems = document.querySelectorAll('#todo-list .todo-item');
    todoItems.forEach(item => {
        if (item.classList.contains('section-break')) {
            const sectionDiv = document.createElement('h2');
            sectionDiv.className = 'print-section';
            sectionDiv.textContent = item.querySelector('.item-text').textContent;
            printContainer.appendChild(sectionDiv);
        } else {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'print-item';
            
            const checkbox = document.createElement('span');
            checkbox.className = 'print-checkbox';
            checkbox.innerHTML = item.querySelector('.item-checkbox').checked ? 
                '✓' : '◻';
            itemDiv.appendChild(checkbox);
            
            const textSpan = document.createElement('span');
            textSpan.className = 'print-item-text';
            textSpan.textContent = item.querySelector('.item-text').textContent;
            if (item.classList.contains('completed')) {
                textSpan.style.textDecoration = 'line-through';
                textSpan.style.color = '#777';
            }
            itemDiv.appendChild(textSpan);
            printContainer.appendChild(itemDiv);
            
            // Add note if it exists
            const note = item.dataset.note;
            if (note && note.trim()) {
                const noteDiv = document.createElement('div');
                noteDiv.className = 'print-note';
                noteDiv.style.marginLeft = '30px';
                noteDiv.style.marginTop = '5px';
                noteDiv.style.fontStyle = 'italic';
                noteDiv.style.color = '#555';
                noteDiv.style.fontSize = '0.9em';
                noteDiv.textContent = `Note: ${note}`;
                printContainer.appendChild(noteDiv);
            }
        }
    });
    
    // Open new window with the content
    const popout = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
    popout.document.write(printContainer.innerHTML);
    popout.document.close();
}



function printVisibleList() {
    // Create a clone of the visible container
    const originalContainer = document.querySelector('.container');
    const printContainer = originalContainer.cloneNode(true);
    
    // Remove all elements we don't want to print
    const elementsToRemove = [
        '.input-group',
        '.controls',
        '.saved-lists',
        '.footer',
        '#status',
        '#current-folder'
    ];
    
    elementsToRemove.forEach(selector => {
        const elements = printContainer.querySelectorAll(selector);
        elements.forEach(el => el.remove());
    });

    // Clean up individual todo items (remove edit inputs and delete buttons)
    printContainer.querySelectorAll('.todo-item').forEach(item => {
        item.querySelectorAll('.item-edit, .delete-btn').forEach(el => el.remove());
        item.style.transform = ''; // Remove any transform effects
        item.style.boxShadow = 'none'; // Remove shadows for cleaner print
    });

    // Apply print-specific styles
    const style = document.createElement('style');
    style.textContent = `
        @media print {
            body * {
                visibility: hidden;
            }
            .print-visible, .print-visible * {
                visibility: visible;
            }
            .print-visible {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                background: white;
            }
            .container {
                box-shadow: none !important;
                border: none !important;
            }
            @page {
                size: auto;
                margin: 15mm;
            }
        }
    `;
    
    // Add classes and prepare for printing
    printContainer.classList.add('print-visible');
    document.body.appendChild(printContainer);
    document.head.appendChild(style);
    
    // Print and clean up
    window.print();
    setTimeout(() => {
        document.body.removeChild(printContainer);
        document.head.removeChild(style);
    }, 1000);
}

function shareList() {
    try {
        // Get the list title or use default
        const title = document.getElementById('title').value || 'My To-Do List';
        let text = `${title}\n\n`;
        
        // Format all items in the list
        document.querySelectorAll('#todo-list .todo-item').forEach(item => {
            const itemText = item.querySelector('.item-text').textContent;
            if (item.classList.contains('section-break')) {
                text += `\n${itemText}\n${'-'.repeat(itemText.length)}\n`;
            } else {
                const checked = item.querySelector('.item-checkbox')?.checked ? '[✓]' : '[ ]';
                text += `${checked} ${itemText}\n`;
            }
        });
        
        // Try to use the Web Share API if available
        if (navigator.share) {
            navigator.share({
                title: title,
                text: text
            }).catch(() => {
                // If sharing fails, show our custom modal
                showShareModal(title, text);
            });
        } else {
            // If Web Share API isn't available, show our modal
            showShareModal(title, text);
        }
    } catch (error) {
        console.error('Sharing error:', error);
        showStatus('Error preparing share options. Try exporting instead.', 'error');
    }
}

function showShareModal(title, text) {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    overlay.id = 'share-overlay';
    overlay.style.display = 'block';
    
    // Create modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'share-modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <h3>Share "${title}"</h3>
        <div class="modal-content">
            <div class="share-options">
                <div class="share-option" id="email-share">
                    <span>✉️</span> Email (Gmail)
                </div>
                <div class="share-option" id="copy-share">
                    <span>📋</span> Copy Text
                </div>
                <div class="share-option" id="download-share">
                    <span>📥</span> Download
                </div>
            </div>
            <textarea id="share-text" readonly>${text}</textarea>
            <div class="modal-actions">
                <button class="secondary" id="close-share">Close</button>
            </div>
        </div>
    `;
    
    // Add to page
    document.body.appendChild(overlay);
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
    
    // Add event listeners
document.getElementById('email-share').addEventListener('click', (e) => {
    e.preventDefault();
    
    // Get the list title
    const title = document.getElementById('title').value || 'My To-Do List';
    
    // Build HTML content for email body
    let htmlContent = `
        <div style="font-family: Arial, sans-serif; line-height: 1.5; color: #333; max-width: 600px;">
            <h2 style="color: #4361ee; border-bottom: 2px solid #4361ee; padding-bottom: 5px; margin-bottom: 15px;">
                ${title}
            </h2>
            <ul style="padding-left: 20px; list-style-type: none; margin: 0;">
    `;

    // Add all todo items to email body
    document.querySelectorAll('#todo-list .todo-item').forEach(item => {
        const itemText = item.querySelector('.item-text').textContent;
        if (item.classList.contains('section-break')) {
            htmlContent += `
                </ul>
                <h3 style="color: #7209b7; margin-top: 15px; border-bottom: 1px solid #ddd; padding-bottom: 3px;">
                    ${itemText}
                </h3>
                <ul style="padding-left: 20px; list-style-type: none; margin: 0;">
            `;
        } else {
            const checked = item.querySelector('.item-checkbox')?.checked ? '✓' : '◻';
            const textColor = item.classList.contains('completed') ? '#777' : '#333';
            const textDecoration = item.classList.contains('completed') ? 'line-through' : 'none';
            
            htmlContent += `
                <li style="margin-bottom: 8px; position: relative; padding-left: 25px; color: ${textColor}; text-decoration: ${textDecoration}">
                    <span style="position: absolute; left: 0; color: #4361ee;">${checked}</span>
                    ${itemText}
                </li>
            `;
        }
    });

    htmlContent += `
            </ul>
            <p style="margin-top: 20px; font-size: 0.9em; color: #777;">
                Shared from Smart To-Do List
            </p>
        </div>
    `;

    // Create plain text version as fallback
    const plainText = `${title}\n${'='.repeat(title.length)}\n\n` + 
        Array.from(document.querySelectorAll('#todo-list .todo-item')).map(item => {
            const text = item.querySelector('.item-text').textContent;
            if (item.classList.contains('section-break')) {
                return `\n${text}\n${'-'.repeat(text.length)}\n`;
            } else {
                const checked = item.querySelector('.item-checkbox')?.checked ? '[✓]' : '[ ]';
                return `${checked} ${text}`;
            }
        }).join('\n') + 
        `\n\nShared from Smart To-Do List`;

    // Special handling for Chrome browser
    if (navigator.userAgent.indexOf('Chrome') > -1) {
        // Chrome-specific Gmail handling
        const gmailUrl = new URL('https://mail.google.com/mail/u/0/?view=cm&fs=1');
        gmailUrl.searchParams.set('su', title);
        gmailUrl.searchParams.set('body', plainText);
        
        // Open in new window with specific size
        window.open(gmailUrl.toString(), '_blank', 'width=800,height=600');
    } 
    // For other browsers, use standard mailto
    else {
        window.location.href = `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(plainText)}`;
    }
    
    hideShareModal();
});
    
    document.getElementById('copy-share').addEventListener('click', () => {
        const textarea = document.getElementById('share-text');
        textarea.select();
        document.execCommand('copy');
        showStatus('Copied to clipboard!', 'success');
        hideShareModal();
    });
    
    document.getElementById('download-share').addEventListener('click', () => {
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${title.replace(/[^a-z0-9]/gi, '_')}.txt`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            hideShareModal();
        }, 100);
    });
    
    document.getElementById('close-share').addEventListener('click', hideShareModal);
    overlay.addEventListener('click', hideShareModal);
}

function hideShareModal() {
    const modal = document.getElementById('share-modal');
    const overlay = document.getElementById('share-overlay');
    if (modal) modal.remove();
    if (overlay) overlay.remove();
    document.body.style.overflow = '';
}

//Help modal
function showHelpModal() {
    showModal('help');
}

// Update the existing hideModal function to handle help modal
function hideModal(type) {
    document.getElementById(`${type}-overlay`).style.display = 'none';
    document.getElementById(`${type}-modal`).style.display = 'none';
    document.body.style.overflow = '';
}

let currentNoteItem = null;

function showNoteModal(button) {
    const item = button.closest('.todo-item');
    const itemText = item.querySelector('.item-text').textContent;
    
    currentNoteItem = item;
    
    // Get existing note if any
    const existingNote = item.dataset.note || '';
    
    document.getElementById('note-item-title').textContent = itemText;
    document.getElementById('note-content').value = existingNote;
    
    showModal('note');
}

function saveNote() {
    if (!currentNoteItem) return;
    
    const noteContent = document.getElementById('note-content').value;
    currentNoteItem.dataset.note = noteContent;
    
    // Visual indicator if note exists
    const noteBtn = currentNoteItem.querySelector('.note-btn');
    const noteIndicator = currentNoteItem.querySelector('.note-indicator');
    if (noteContent.trim()) {
        noteBtn.classList.add('has-note');
        if (noteIndicator) noteIndicator.style.opacity = '1';
        showStatus('Note saved', 'success');
    } else {
        noteBtn.classList.remove('has-note');
        if (noteIndicator) noteIndicator.style.opacity = '0';
    }
    
    hideModal('note');
    currentNoteItem = null;
}

// Scroll back to top
function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Show/hide scroll-up button near bottom
window.addEventListener('scroll', () => {
    const scrollUpBtn = document.getElementById('scroll-up-btn');
    const showAt = document.body.scrollHeight - window.innerHeight - 300;
    if (window.scrollY > showAt) {
        scrollUpBtn.style.display = 'block';
    } else {
        scrollUpBtn.style.display = 'none';
    }
});

// Fade away after 5 seconds of inactivity
let fadeTimeout;
const scrollDownBtn = document.getElementById('scroll-down-btn');

function resetFadeTimer() {
    if (!scrollDownBtn) return;

    scrollDownBtn.classList.remove('fade-out');
    clearTimeout(fadeTimeout);
    fadeTimeout = setTimeout(() => {
        scrollDownBtn.classList.add('fade-out');
    }, 5000);
}

// Reset timer on mousemove
document.addEventListener('mousemove', resetFadeTimer);

// Initialize on load
window.addEventListener('DOMContentLoaded', () => {
    resetFadeTimer(); // start fade timer immediately
});

// Toggle note preview on tap for mobile
document.addEventListener('click', function (e) {
    const isNoteBtn = e.target.classList.contains('note-btn');
    const preview = isNoteBtn ? e.target.nextElementSibling : null;

    if (preview && preview.classList.contains('note-preview')) {
        // Toggle visibility
        const isVisible = preview.style.display === 'block';
        // First, hide all open previews
        document.querySelectorAll('.note-preview').forEach(p => p.style.display = 'none');
        // Then, toggle this one
        preview.style.display = isVisible ? 'none' : 'block';
        e.stopPropagation();
    } else {
        // Hide all previews if clicking anywhere else
        document.querySelectorAll('.note-preview').forEach(p => p.style.display = 'none');
    }
});


    </script>

<!-- Help Modal -->
<div class="overlay" id="help-overlay"></div>
<div class="modal" id="help-modal">
    <h3>How to Use This To-Do List</h3>
    <div class="modal-content">
        <div class="help-section">
            <h4>Basic Usage</h4>
            <ul>
                <li><strong>Add Task:</strong> Type in the input box and click "Add" or press Enter</li>
                <li><strong>Complete Task:</strong> Click the checkbox</li>
                <li><strong>Edit Task:</strong> Click directly on the task text</li>
                <li><strong>Delete Task:</strong> Click the × button</li>
                <li><strong>Reorder:</strong> Drag tasks up/down using the ☰ handle</li>
            </ul>
        </div>
        
        <div class="help-section">
            <h4>Advanced Features</h4>
            <ul>
                <li><strong>Sections:</strong> Use "Add Section" to group tasks</li>
                <li><strong>Save/Load:</strong> Save lists to your device or browser storage</li>
                <li><strong>Import/Export:</strong> Share lists between devices</li>
                <li><strong>Print/PDF:</strong> Create printer-friendly versions</li>
            </ul>
        </div>
        
        <div class="modal-actions">
            <button class="secondary" onclick="hideModal('help')">Got It!</button>
        </div>
    </div>
</div>

<!-- Note Modal -->
<div class="overlay" id="note-overlay"></div>
<div class="modal" id="note-modal">
    <h3>Task Notes</h3>
    <div class="modal-content">
        <div id="note-item-title" style="font-weight: bold; margin-bottom: 1rem;"></div>
        <textarea id="note-content" placeholder="Add your notes here..." style="width: 100%; height: 200px; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px; font-family: inherit;"></textarea>
        <div class="modal-actions">
            <button onclick="saveNote()">Save</button>
            <button class="secondary" onclick="hideModal('note')">Close</button>
        </div>
    </div>
</div>

<!-- Floating Scroll Buttons -->
<button id="scroll-down-btn" onclick="scrollToSaved()">↓</button>

<button id="scroll-up-btn" onclick="scrollToTop()">↑</button>

</body>
</html>