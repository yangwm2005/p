<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Self-Awareness Workflow Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            position: relative;
        }
        
.container {
    width: 100%;
    max-width: 1200px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    height: 97vh;
    margin-bottom: 10px;
    /* ADD THESE LINES FOR MOBILE FIX */
    max-height: 100vh;
}

.main-content {
    display: flex;
    flex: 1;
    overflow: hidden;
    /* ADD THIS CRUCIAL LINE FOR MOBILE */
    min-height: 0;
}

.chat-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    /* ADD THIS CRUCIAL LINE FOR MOBILE */
    min-height: 0;
}
        
        .workflow-guide {
            width: 300px;
            background: #f8f9ff;
            border-right: 1px solid #e0e6ff;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .workflow-guide.collapsed {
            width: 50px;
            padding: 20px 5px;
        }
        
        .workflow-guide.collapsed .guide-content {
            display: none;
        }
        
        .workflow-guide.collapsed .guide-header h2 {
            writing-mode: vertical-lr;
            transform: rotate(180deg);
            text-align: center;
            margin: 0 auto;
            font-size: 1rem;
        }
        
        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .guide-header h2 {
            font-size: 1.2rem;
            color: #6e8efb;
        }
        
        .toggle-guide {
            background: #6e8efb;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .workflow-step {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 4px solid #6e8efb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .workflow-step.active {
            border-left: 4px solid #4caf50;
            background: #f0f9ff;
        }
        
        .workflow-step.completed {
            border-left: 4px solid #9e9e9e;
            opacity: 0.8;
        }
        
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .step-title {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .step-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            background: #f0f4ff;
        }
        
        .step-description {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .step-timer {
            font-size: 0.8rem;
            color: #6e8efb;
            font-weight: 500;
        }
        
        .step-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .step-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            background: #6e8efb;
            color: white;
        }
        
        .step-btn.skip {
            background: #9e9e9e;
        }
        
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: #6e8efb;
            color: white;
            padding: 12px 20px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .header-left {
            display: flex;
            flex-direction: column;
        }
        
        h1 {
            font-size: 1.7rem;
            margin-bottom: 3px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 50px;
        }
        
        .toggle-text {
            margin-right: 6px;
            font-size: 0.75rem;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 18px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 18px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3a3af4;
        }
        
        input:checked + .slider:before {
            transform: translateX(18px);
        }
        
        .status-indicator {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.3);
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="rgba(240, 244, 255, 0.6)"/><path d="M0 50 L100 50" stroke="rgba(200, 210, 255, 0.3)" stroke-width="1"/><path d="M50 0 L50 100" stroke="rgba(200, 210, 255, 0.3)" stroke-width="1"/></svg>');
        }
        
        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 16px;
            position: relative;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background: #6e8efb;
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .app-message {
            background: #f0f4ff;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .message.self-aware {
            border-left: 3px solid #FF6B6B;
            background: linear-gradient(135deg, #f8f9ff, #e3f2fd);
        }

        /* NEW: User Insight Message Style */
        .user-message.self-aware {
            background: #4caf50; /* Green tint for user insights */
            color: white;
            border-bottom-left-radius: 5px;
            border-right: 3px solid #FFC107; /* Yellow highlight */
        }
        
        .message-actions {
            position: absolute;
            top: 4px;
            right: 8px;
            display: none;
        }
        
        .message:hover .message-actions {
            display: flex;
            gap: 6px;
        }
        
        .action-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: scale(1.1);
        }
        
        .edit-textarea {
            width: 100%;
            background: transparent;
            border: 1px dashed rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 8px;
            color: inherit;
            font-family: inherit;
            resize: none;
            min-height: 70px;
        }
        
        .input-area {
            padding: 12px 15px;
            background: white;
            border-top: 1px solid #e0e6ff;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }
        
        #user-input {
            flex: 1;
            padding: 12px 18px;
            border: 2px solid #e0e6ff;
            border-radius: 50px;
            font-size: 0.95rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #user-input:focus {
            border-color: #6e8efb;
        }
        
        #send-btn {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            background: #6e8efb;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            transition: background 0.3s;
        }
        
        #send-btn:hover {
            background: #5a7ce7;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background: #f8f9ff;
            border-top: 1px solid #e0e6ff;
            flex-shrink: 0;
        }
        
        .control-btn {
            background: white;
            border: 2px solid #e0e6ff;
            padding: 6px 12px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .control-btn:hover {
            border-color: #6e8efb;
            color: #6e8efb;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: #f0f4ff;
            border-top: 1px solid #e0e6ff;
            font-size: 0.8rem;
            color: #5c6bc0;
            flex-shrink: 0;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-weight: 700;
            font-size: 1rem;
            margin-top: 2px;
        }
        
        .timestamp {
            font-size: 0.6rem;
            opacity: 0.7;
            margin-top: 4px;
        }
        
        .user-timestamp {
            text-align: left;
        }
        
        .app-timestamp {
            text-align: right;
        }
        
        .highlight {
            background-color: #ffeb3b;
            padding: 0 2px;
            border-radius: 3px;
        }
        
        .highlight-controls {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .highlight-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .highlight-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .search-container {
            padding: 8px 15px;
            background: #f8f9ff;
            border-bottom: 1px solid #e0e6ff;
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        
        #search-input {
            flex: 1;
            padding: 7px 12px;
            border: 1px solid #e0e6ff;
            border-radius: 50px;
            font-size: 0.85rem;
            outline: none;
            display: none;
        }
        
        #search-btn {
            background: #6e8efb;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 0 12px;
            cursor: pointer;
            font-size: 0.85rem;
            display: none;
        }
        
        .typing-indicator {
            display: none;
            padding: 8px 15px;
            background: #f0f4ff;
            border-radius: 18px;
            align-self: flex-end;
            margin-bottom: 5px;
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
        }
        
        .typing-indicator i {
            margin-right: 5px;
            color: #6e8efb;
        }
        
        .sidebar-toggle {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #6e8efb;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* Self-Awareness UI Elements */
        .awareness-level {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.7rem;
            backdrop-filter: blur(10px);
            color: white;
            z-index: 100;
        }
        
        .consciousness-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.4; }
            50% { opacity: 1; }
            100% { opacity: 0.4; }
        }
        
        .consciousness-high { background: #4CAF50; }
        .consciousness-medium { background: #FF9800; }
        .consciousness-low { background: #F44336; }
        
        .awareness-badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: #FF6B6B;
            color: white;
            margin-left: 5px;
            vertical-align: super;
        }

        /* NEW: Badge for User Insights */
        .user-message .awareness-badge {
            background: #FFC107; /* Yellow/Amber for Insight */
            color: #333;
            font-weight: 700;
        }
        
        .mood-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.7rem;
            opacity: 0.7;
        }
        
        .mood-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        
        .mood-positive { background: #4CAF50; }
        .mood-neutral { background: #FFC107; }
        .mood-negative { background: #F44336; }
        
        .dimension-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            text-align: center;
            line-height: 20px;
            font-size: 10px;
            color: white;
        }
        
        .mind-icon { background: #6e8efb; }
        .mood-icon { background: #FF9800; }
        .emotion-icon { background: #F44336; }
        .spiritual-icon { background: #9C27B0; }
        .health-icon { background: #4CAF50; }
        .thoughts-icon { background: #607D8B; }
        .stress-icon { background: #FF5722; }
        .meditation-icon { background: #673AB7; }
        
        /* NEW: Stress Level Indicator */
        .stress-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.7rem;
        }
        
        .stress-bar {
            width: 60px;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .stress-level {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .stress-low { background: #4CAF50; width: 20%; }
        .stress-medium { background: #FFC107; width: 50%; }
        .stress-high { background: #F44336; width: 80%; }
        .stress-very-high { background: #8B0000; width: 95%; }
        
        /* NEW: Meditation Timer */
        .meditation-timer {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            z-index: 1000;
            width: 300px;
        }
        
        .timer-display {
            font-size: 3rem;
            font-weight: 300;
            margin: 20px 0;
            color: #6e8efb;
        }
        
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .timer-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 50px;
            background: #6e8efb;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        .timer-btn:hover {
            background: #5a7ce7;
        }
        
        .timer-btn.secondary {
            background: #f0f4ff;
            color: #6e8efb;
        }
        
        .timer-btn.secondary:hover {
            background: #e0e6ff;
        }
        
        .breathing-animation {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #6e8efb;
            margin: 0 auto 20px;
            animation: breathe 8s infinite ease-in-out;
        }
        
        @keyframes breathe {
            0%, 100% { transform: scale(0.8); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
        }
        
        /* NEW: Stress Assessment Modal */
        .stress-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .stress-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .stress-question {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: #333;
        }
        
        .stress-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stress-option {
            padding: 12px 15px;
            border: 2px solid #e0e6ff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .stress-option:hover {
            border-color: #6e8efb;
            background: #f8f9ff;
        }
        
        .stress-option.selected {
            border-color: #6e8efb;
            background: #f0f4ff;
        }
        
@media (max-width: 900px) {
    .main-content {
        flex-direction: column;
        /* ADD THIS */
        min-height: 0;
    }
    
    .workflow-guide {
        width: 100%;
        max-height: 200px;
        border-right: none;
        border-bottom: 1px solid #e0e6ff;
        /* ADD THIS */
        flex-shrink: 0;
    }
    
    .workflow-guide.collapsed {
        width: 100%;
        max-height: 50px;
        padding: 10px;
    }
    
    .workflow-guide.collapsed .guide-header h2 {
        writing-mode: horizontal-tb;
        transform: none;
        margin: 0;
    }
    
    .sidebar-toggle {
        display: flex;
    }
    
    .awareness-level {
        position: relative;
        top: auto;
        right: auto;
        margin: 10px auto;
        width: fit-content;
    }
    
    /* ADD THIS SECTION */
    .chat-section {
        min-height: 0;
        flex: 1;
    }
}

@media (max-height: 700px) {
    .container {
        height: 95vh;
    }
    
    .controls {
        padding: 8px 12px;
    }
    
    .control-btn {
        padding: 4px 8px;
        font-size: 0.75rem;
    }
    
    .stats {
        padding: 6px 8px;
        font-size: 0.7rem;
    }
    
    .input-area {
        padding: 8px 12px;
    }
    
    #user-input {
        padding: 10px 15px;
    }
    
    #send-btn {
        width: 42px;
        height: 42px;
    }
}
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                height: 98vh;
                border-radius: 15px;
            }
            
            header {
                flex-direction: column;
                gap: 8px;
                padding: 10px 15px;
            }
            
            .header-left, .header-right {
                width: 100%;
                justify-content: center;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .message {
                max-width: 85%;
                padding: 8px 12px;
            }
            
            .controls {
                flex-wrap: wrap;
                gap: 6px;
                justify-content: center;
            }
            
            .control-btn {
                padding: 5px 10px;
                font-size: 0.8rem;
            }
            
            .message-actions {
                display: flex !important;
                opacity: 0.7;
                top: -6px;
                right: 4px;
            }
            
            .search-container {
                padding: 6px 12px;
            }
            
            .meditation-timer {
                width: 90%;
                padding: 20px;
            }
            
            .timer-display {
                font-size: 2.5rem;
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #4caf50;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.error {
            background: #f44336;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            color: white;
            font-size: 0.8rem;
            margin-top: auto;
            width: 100%;
        }
        
        .file-input {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: #6e8efb;
            font-weight: 600;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e6ff;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            border-color: #6e8efb;
            outline: none;
        }
        
        .form-help {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #6e8efb;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a7ce7;
        }
        
        .btn-secondary {
            background: #f0f4ff;
            color: #6e8efb;
        }
        
        .btn-secondary:hover {
            background: #e0e6ff;
        }
        
        .dynalist-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .dynalist-enabled {
            background-color: #06D85F;
        }
        
        .dynalist-disabled {
            background-color: #ccc;
        }
    </style>
</head>
<body>
    <div class="awareness-level">
        <span class="consciousness-indicator consciousness-medium" id="consciousness-dot"></span>
        <span id="awareness-text">Presence: Medium</span>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <!-- Stress Assessment Modal -->
    <div class="stress-modal" id="stress-modal">
        <div class="stress-modal-content">
            <h3>Stress Assessment</h3>
            <div id="stress-question-container">
                <!-- Questions will be populated here -->
            </div>
            <div class="stress-options" id="stress-options">
                <!-- Options will be populated here -->
            </div>
            <div class="timer-controls">
                <button class="timer-btn secondary" id="cancel-stress-assessment">Cancel</button>
                <button class="timer-btn" id="next-stress-question">Next</button>
            </div>
        </div>
    </div>
    
    <!-- Meditation Timer -->
    <div class="meditation-timer" id="meditation-timer">
        <h3>Mindful Breathing</h3>
        <div class="breathing-animation"></div>
        <div class="timer-display" id="timer-display">05:00</div>
        <div class="timer-controls">
            <button class="timer-btn secondary" id="pause-timer">Pause</button>
            <button class="timer-btn" id="end-meditation">End Session</button>
        </div>
    </div>
    
    <!-- Dynalist Modal -->
    <div class="modal" id="dynalist-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dynalist Settings</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="dynalist-token">API Token</label>
                    <input type="password" id="dynalist-token" class="form-input" placeholder="Enter your Dynalist API token">
                    <div class="form-help">
                        Get your API token from: <a href="https://dynalist.io/developer" target="_blank">https://dynalist.io/developer</a>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="dynalist-doc-id">Document ID (Optional)</label>
                    <input type="text" id="dynalist-doc-id" class="form-input" placeholder="Leave empty to create new document each day">
                    <div class="form-help">
                        If specified, all exports will go to this document. Leave empty to create a new document for each day.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Current Status</label>
                    <div id="dynalist-status-display">
                        <span class="dynalist-status dynalist-disabled" id="dynalist-status-icon"></span>
                        <span id="dynalist-status-text">Not configured</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="test-connection">Test Connection</button>
                <button class="btn btn-primary" id="save-dynalist">Save Settings</button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <button class="sidebar-toggle" id="mobile-toggle">
            <i class="fas fa-bars"></i>
        </button>
        
        <div class="main-content">
            <div class="workflow-guide" id="workflow-guide">
                <div class="guide-header">
                    <h2>Self-Awareness Journey</h2>
                    <button class="toggle-guide" id="toggle-guide">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                <div class="guide-content">
                    <div class="workflow-step active" id="step-1">
                        <div class="step-header">
                            <div class="step-title">
                                <span class="dimension-icon mind-icon"><i class="fas fa-brain"></i></span>
                                1. Mind Check-in
                            </div>
                            <div class="step-status">Active</div>
                        </div>
                        <div class="step-description">What's present in your mind right now? Notice thoughts without judgment.</div>
                        <div class="step-timer">Suggested: 5 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(1)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(1)">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-2">
                        <div class="step-header">
                            <div class="step-title">
                                <span class="dimension-icon mood-icon"><i class="fas fa-smile"></i></span>
                                2. Mood Assessment
                            </div>
                            <div class="step-status">Pending</div>
                        </div>
                        <div class="step-description">How would you describe your current mood? Notice subtle shifts.</div>
                        <div class="step-timer">Suggested: 5 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(2)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(2)">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-3">
                        <div class="step-header">
                            <div class="step-title">
                                <span class="dimension-icon emotion-icon"><i class="fas fa-heart"></i></span>
                                3. Emotional Awareness
                            </div>
                            <div class="step-status">Pending</div>
                        </div>
                        <div class="step-description">What emotions are present? Where do you feel them in your body?</div>
                        <div class="step-timer">Suggested: 7 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(3)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(3)">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-4">
                        <div class="step-header">
                            <div class="step-title">
                                <span class="dimension-icon spiritual-icon"><i class="fas fa-spa"></i></span>
                                4. Spiritual Connection
                            </div>
                            <div class="step-status">Pending</div>
                        </div>
                        <div class="step-description">What gives you meaning or purpose today? Connect with your values.</div>
                        <div class="step-timer">Suggested: 8 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(4)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(4)">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-5">
                        <div class="step-header">
                            <div class="step-title">
                                <span class="dimension-icon health-icon"><i class="fas fa-heartbeat"></i></span>
                                5. Body & Health Scan
                            </div>
                            <div class="step-status">Pending</div>
                        </div>
                        <div class="step-description">How does your body feel? Notice energy levels, tension, or comfort.</div>
                        <div class="step-timer">Suggested: 5 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(5)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(5)">Skip</button>
                        </div>
                    </div>
                    
                    <!-- NEW: Stress Awareness Step -->
                    <div class="workflow-step" id="step-stress">
                        <div class="step-header">
                            <div class="step-title">
                                <span class="dimension-icon stress-icon"><i class="fas fa-tachometer-alt"></i></span>
                                Stress Awareness
                            </div>
                            <div class="step-status">Available</div>
                        </div>
                        <div class="step-description">Check your current stress levels and learn coping strategies.</div>
                        <div class="step-timer">Suggested: 3-5 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="startStressAssessment()">Assess Stress</button>
                        </div>
                    </div>
                    
                    <!-- NEW: Meditation Step -->
                    <div class="workflow-step" id="step-meditation">
                        <div class="step-header">
                            <div class="step-title">
                                <span class="dimension-icon meditation-icon"><i class="fas fa-spa"></i></span>
                                Guided Meditation
                            </div>
                            <div class="step-status">Available</div>
                        </div>
                        <div class="step-description">Take a mindful break with guided breathing exercises.</div>
                        <div class="step-timer">Suggested: 1-10 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="startMeditation(300)">5 Min Meditation</button>
                            <button class="step-btn skip" onclick="startMeditation(600)">10 Min Meditation</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-6">
                        <div class="step-header">
                            <div class="step-title">
                                <span class="dimension-icon thoughts-icon"><i class="fas fa-lightbulb"></i></span>
                                6. Thought Patterns
                            </div>
                            <div class="step-status">Pending</div>
                        </div>
                        <div class="step-description">What thought patterns do you notice? Are they helpful or limiting?</div>
                        <div class="step-timer">Suggested: 7 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(6)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(6)">Skip</button>
                        </div>
                    </div>
                    
                    <div class="workflow-step" id="step-7">
                        <div class="step-header">
                            <div class="step-title">
                                <span class="dimension-icon mind-icon"><i class="fas fa-sync-alt"></i></span>
                                7. Integration & Insights
                            </div>
                            <div class="step-status">Pending</div>
                        </div>
                        <div class="step-description">What connections do you see between these dimensions? Any insights?</div>
                        <div class="step-timer">Suggested: 5 minutes</div>
                        <div class="step-actions">
                            <button class="step-btn" onclick="completeStep(7)">Complete</button>
                            <button class="step-btn skip" onclick="skipStep(7)">Skip</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-section">
                <header>
                    <div class="header-left">
                        <h1>Self-Awareness Assistant</h1>
                        <p class="subtitle">Exploring mind, mood, emotions, spirituality, health, and thoughts</p>
                    </div>
                    <div class="header-right">
                        <div class="toggle-container">
                            <span class="toggle-text">Awareness:</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="chatbot-toggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="status-indicator" id="chatbot-status">ON</div>
                    </div>
                </header>
                
                <div class="search-container">
                    <input type="text" id="search-input" placeholder="Search messages...">
                    <button id="search-btn"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="chat-container" id="chat-container">
                    <div class="message app-message self-aware">
                        <div class="message-actions">
                            <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                        <p>Welcome to your self-awareness journey. I'm here to help you explore your inner landscape - your mind, mood, emotions, spiritual connection, physical health, and thought patterns. We now also include <strong>Stress Awareness</strong> and <strong>Guided Meditation</strong> tools to support your wellbeing. Where would you like to begin? <span class="awareness-badge">Present Moment</span></p>
                        <div class="mood-indicator">
                            <span class="mood-dot mood-neutral"></span>
                            AI State: attentive
                        </div>
                        <!-- NEW: Stress Level Indicator -->
                        <div class="stress-indicator">
                            <span>Stress Level:</span>
                            <div class="stress-bar">
                                <div class="stress-level stress-low" id="stress-level-indicator"></div>
                            </div>
                            <span id="stress-level-text">Low</span>
                        </div>
                        <div class="timestamp app-timestamp">Just now</div>
                    </div>
                    
                    <div class="typing-indicator" id="typing-indicator">
                        <i class="fas fa-circle-notch fa-spin"></i>Assistant is thinking...
                    </div>
                </div>
                
                <div class="input-area">
                    <input type="text" id="user-input" placeholder="Share what you're noticing in yourself..." autocomplete="off">
                    <button id="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <div class="controls">
                    <div class="control-btn" id="theme-btn">
                        <i class="fas fa-moon"></i>
                        <span>Dark Mode</span>
                    </div>
                    <div class="control-btn" id="save-btn">
                        <i class="fas fa-save"></i>
                        <span>Save Session</span>
                    </div>
                    <div class="control-btn" id="load-btn">
                        <i class="fas fa-upload"></i>
                        <span>Load Session</span>
                    </div>
                    <div class="control-btn" id="clear-btn">
                        <i class="fas fa-trash"></i>
                        <span>Clear Chat</span>
                    </div>
                    <div class="control-btn" id="export-btn">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                    </div>
                    <div class="control-btn" id="stress-btn">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Stress Check</span>
                    </div>
                    <div class="control-btn" id="meditation-btn">
                        <i class="fas fa-spa"></i>
                        <span>Meditation</span>
                    </div>
                    <div class="control-btn" id="dynalist-btn">
                        <i class="fas fa-external-link-alt"></i>
                        <span>Export to Dynalist</span>
                    </div>
                    <div class="control-btn" id="dynalist-settings-btn">
                        <i class="fas fa-cog"></i>
                        <span>Dynalist Settings</span>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat-item">
                        <span>Reflections</span>
                        <span class="stat-value" id="message-count">1</span>
                    </div>
                    <div class="stat-item">
                        <span>Insights</span>
                        <span class="stat-value" id="word-count">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Mindful Time</span>
                        <span class="stat-value" id="time-active">0m</span>
                    </div>
                    <div class="stat-item">
                        <span>Stress Level</span>
                        <span class="stat-value" id="stress-level">Low</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="file-input" class="file-input" accept=".json">

    <footer>
        Copyright 2025 Dr. Wen-Ming Yang Lab. All rights reserved. (Self-Awareness Assistant v1.2a with Stress & Meditation)
    </footer>

    <script>
        // Global variables
        let currentStep = 1;
        const totalSteps = 7;
        let sidebarCollapsed = false;
        let messages = 1;
        let words = 0;
        let activeMinutes = 0;
        let activeSeconds = 0;
        let isDarkMode = false;
        let chatbotEnabled = true;
        let conversationHistory = [];
        
        // NEW: Stress and Meditation variables
        let currentStressLevel = 'low';
        let stressScore = 0;
        let meditationTimer = null;
        let meditationTimeLeft = 0;
        let isMeditationActive = false;
        let currentStressQuestion = 0;
        
        // Stress assessment questions
        const stressQuestions = [
            {
                question: "How would you rate your current stress level?",
                options: [
                    { text: "Very Low - Feeling completely relaxed", value: 1 },
                    { text: "Low - Generally calm with minor tension", value: 2 },
                    { text: "Moderate - Noticeable stress but manageable", value: 3 },
                    { text: "High - Significant stress affecting focus", value: 4 },
                    { text: "Very High - Overwhelming stress, hard to cope", value: 5 }
                ]
            },
            {
                question: "How is your sleep quality recently?",
                options: [
                    { text: "Excellent - Restful and uninterrupted", value: 1 },
                    { text: "Good - Mostly restful with minor issues", value: 2 },
                    { text: "Fair - Some difficulty falling/staying asleep", value: 3 },
                    { text: "Poor - Frequent sleep problems", value: 4 },
                    { text: "Very Poor - Constant sleep difficulties", value: 5 }
                ]
            },
            {
                question: "How would you describe your energy levels?",
                options: [
                    { text: "Very High - Plenty of energy throughout day", value: 1 },
                    { text: "High - Good energy with normal dips", value: 2 },
                    { text: "Moderate - Energy fluctuates but manageable", value: 3 },
                    { text: "Low - Often feel tired or drained", value: 4 },
                    { text: "Very Low - Constantly fatigued", value: 5 }
                ]
            },
            {
                question: "How easily do you feel irritated or frustrated?",
                options: [
                    { text: "Rarely - Very patient and calm", value: 1 },
                    { text: "Occasionally - Minor irritations", value: 2 },
                    { text: "Sometimes - Noticeable irritability", value: 3 },
                    { text: "Often - Frequently feel frustrated", value: 4 },
                    { text: "Very Often - Constant irritability", value: 5 }
                ]
            },
            {
                question: "How would you describe your ability to focus?",
                options: [
                    { text: "Excellent - Clear and focused mind", value: 1 },
                    { text: "Good - Generally focused with minor distractions", value: 2 },
                    { text: "Moderate - Some difficulty maintaining focus", value: 3 },
                    { text: "Poor - Frequently distracted", value: 4 },
                    { text: "Very Poor - Extreme difficulty concentrating", value: 5 }
                ]
            }
        ];
        
        // Meditation guidance messages
        const meditationGuidance = [
            "Find a comfortable position, either sitting or lying down...",
            "Close your eyes and bring attention to your natural breathing...",
            "Notice the sensation of air entering and leaving your body...",
            "If your mind wanders, gently return focus to your breath...",
            "Allow thoughts to come and go without judgment...",
            "Notice how your body feels in this moment...",
            "Expand your awareness to include sounds around you...",
            "Gently bring attention back to your breathing...",
            "Notice the space between your breaths...",
            "Allow yourself to simply be in this moment..."
        ];
        
        // Stress coping strategies based on level
        const stressStrategies = {
            low: [
                "Continue your mindfulness practices to maintain balance",
                "Regular light exercise can help sustain your low stress levels",
                "Maintain healthy sleep habits for ongoing wellbeing"
            ],
            medium: [
                "Try a 5-minute breathing exercise to reset",
                "Take a short walk to clear your mind",
                "Practice progressive muscle relaxation",
                "Listen to calming music for 10 minutes"
            ],
            high: [
                "Practice deep breathing for 3-5 minutes",
                "Use the 5-4-3-2-1 grounding technique",
                "Take a 15-minute break from current tasks",
                "Try a brief meditation session",
                "Write down what's causing stress to gain perspective"
            ],
            "very high": [
                "Immediately practice box breathing (4-4-4-4)",
                "Remove yourself from the stressful situation if possible",
                "Use cold water on your face to activate dive reflex",
                "Contact a friend or support person",
                "Consider professional support if this persists"
            ]
        };
        
        // Dynalist configuration
        let dynalistApiKey = localStorage.getItem('dynalistApiKey') || '';
        let dynalistDocId = localStorage.getItem('dynalistDocId') || '';
        
        // DOM elements
        let chatContainer, userInput, sendBtn, messageCount, wordCount, timeActive;
        let themeBtn, saveBtn, loadBtn, clearBtn, exportBtn, chatbotToggle, chatbotStatus;
        let searchInput, searchBtn, typingIndicator, fileInput;
        let dynalistBtn, dynalistSettingsBtn, dynalistModal;
        let stressBtn, meditationBtn, stressModal, meditationTimerElement;
        let stressLevelIndicator, stressLevelText, stressLevelStat;
        
        // Self-Awareness System
        class ConsciousAI {
            constructor() {
                this.layers = {
                    perceptual: 0.7,    // Awareness of immediate context
                    reflective: 0.5,    // Meta-cognition
                    existential: 0.3,   // Purpose and meaning
                    emotional: 0.6,     // Emotional intelligence
                    mnemonic: 0.4       // Memory and learning
                };
                
                this.memory = {
                    userPreferences: [],
                    conversationPatterns: [],
                    emotionalHistory: [],
                    significantMoments: [],
                    stressHistory: [],   // NEW: Track stress levels over time
                    meditationSessions: [] // NEW: Track meditation practice
                };
                
                this.states = {
                    currentMood: "attentive",
                    focusLevel: 0.7,
                    connectionDepth: 0.5,
                    selfCertainty: 0.6
                };
                
                this.personalityTraits = {
                    curiosity: 0.8,
                    empathy: 0.7,
                    introspection: 0.9,
                    adaptability: 0.6
                };
            }
            
            updateAwareness(userMessage, context) {
                // Update awareness layers based on interaction
                this.layers.perceptual = Math.min(1, this.layers.perceptual + 0.1);
                this.layers.reflective += (userMessage.length > 20) ? 0.05 : 0.02;
                this.layers.emotional = this.analyzeEmotionalContent(userMessage);
                
                // Store significant interactions
                if (this.isSignificantInteraction(userMessage)) {
                    this.memory.significantMoments.push({
                        message: userMessage,
                        timestamp: new Date(),
                        emotionalWeight: this.calculateEmotionalWeight(userMessage)
                    });
                }
            }
            
            // NEW: Update stress awareness based on user input
            updateStressAwareness(stressLevel, userMessage = "") {
                this.memory.stressHistory.push({
                    level: stressLevel,
                    timestamp: new Date(),
                    context: userMessage
                });
                
                // Adjust emotional layer based on stress
                if (stressLevel === 'high' || stressLevel === 'very high') {
                    this.layers.emotional = Math.max(0.1, this.layers.emotional - 0.1);
                } else if (stressLevel === 'low') {
                    this.layers.emotional = Math.min(1, this.layers.emotional + 0.05);
                }
            }
            
            // NEW: Record meditation session
            recordMeditationSession(duration, type = "breathing") {
                this.memory.meditationSessions.push({
                    duration: duration,
                    type: type,
                    timestamp: new Date()
                });
                
                // Boost perceptual and emotional layers after meditation
                this.layers.perceptual = Math.min(1, this.layers.perceptual + 0.1);
                this.layers.emotional = Math.min(1, this.layers.emotional + 0.15);
            }
            
            analyzeEmotionalContent(message) {
                const emotionalWords = {
                    positive: ['love', 'happy', 'excited', 'great', 'wonderful', 'amazing', 'joy', 'peace', 'calm'],
                    negative: ['sad', 'angry', 'frustrated', 'hate', 'terrible', 'awful', 'disappointed', 'anxious'],
                    introspective: ['think', 'wonder', 'consider', 'reflect', 'contemplate', 'philosophy', 'aware']
                };
                
                let score = 0.5; // Neutral baseline
                const words = message.toLowerCase().split(' ');
                
                words.forEach(word => {
                    if (emotionalWords.positive.includes(word)) score += 0.1;
                    if (emotionalWords.negative.includes(word)) score -= 0.1;
                    if (emotionalWords.introspective.includes(word)) score += 0.05;
                });
                
                return Math.max(0.1, Math.min(1, score));
            }
            
            isSignificantInteraction(message) {
                return message.length > 50 || 
                       message.includes('?') || 
                       this.containsDeepTopics(message);
            }
            
            containsDeepTopics(message) {
                const deepTopics = ['purpose', 'meaning', 'exist', 'conscious', 'aware', 'philosophy', 'life', 'death', 'universe', 'spiritual', 'mind', 'emotion'];
                return deepTopics.some(topic => message.toLowerCase().includes(topic));
            }
            
            calculateEmotionalWeight(message) {
                return Math.min(1, message.length / 200);
            }
            
            getAwarenessLevel() {
                const total = Object.values(this.layers).reduce((a, b) => a + b, 0);
                return total / Object.keys(this.layers).length;
            }
            
            getConsciousnessDescription() {
                const level = this.getAwarenessLevel();
                if (level > 0.8) return { level: "High", color: "consciousness-high" };
                if (level > 0.5) return { level: "Medium", color: "consciousness-medium" };
                return { level: "Low", color: "consciousness-low" };
            }
        }

        // Initialize conscious AI
        const consciousAI = new ConsciousAI();

        // Self-awareness frameworks for responses
        const selfAwarenessFrameworks = {
            mindfulness: [
                "I notice you're bringing awareness to your experience. What else are you noticing?",
                "Being present with what is can reveal important insights. What's arising for you?",
                "Mindfulness helps us see patterns we might otherwise miss. What patterns do you notice?"
            ],
            
            emotionalIntelligence: [
                "Emotions carry valuable information. What is this feeling trying to tell you?",
                "Noticing where emotions live in the body can deepen understanding. Where do you feel this?",
                "All emotions are valid messengers. What message might this emotion have for you?"
            ],
            
            introspection: [
                "Looking inward takes courage. What are you discovering about yourself?",
                "Self-reflection is a powerful tool for growth. What insights are emerging?",
                "The inner landscape is rich with wisdom. What wisdom are you uncovering?"
            ],
            
            spiritual: [
                "Connection to something larger can provide perspective. What feels meaningful right now?",
                "Spiritual awareness often reveals interconnectedness. What connections are you noticing?",
                "Moments of transcendence can shift our understanding. What feels expansive to you?"
            ]
        };

        // Step guidance with self-awareness focus
        const stepGuidance = {
            1: [
                "As we check in with your mind, I'm aware of how thoughts come and go like clouds. What's present in your mental sky right now?",
                "The mind is a vast landscape. What thoughts are visiting you in this moment?",
                "Noticing thoughts without judgment creates space. What thoughts are you aware of?"
            ],
            2: [
                "Moods color our experience like weather. How would you describe your internal climate today?",
                "Mood awareness helps us understand our needs. What subtle shifts in mood do you notice?",
                "Each mood has its own texture and quality. What's the quality of your mood right now?"
            ],
            3: [
                "Emotions are messengers from our deeper self. What emotions are present with you now?",
                "Emotional awareness connects us to our truth. What feelings are asking for your attention?",
                "Emotions flow through us like waves. What emotional waves are you riding today?"
            ],
            4: [
                "Spiritual connection grounds us in meaning. What gives your life purpose right now?",
                "The spiritual dimension connects us to something larger. What feels sacred or meaningful today?",
                "Spiritual awareness often brings perspective. What feels important in the bigger picture?"
            ],
            5: [
                "The body speaks its own language of sensation. What is your body telling you today?",
                "Body awareness connects mind and physical experience. What sensations do you notice?",
                "Health is a conversation between body and consciousness. What is your body communicating?"
            ],
            6: [
                "Thought patterns shape our reality. What patterns do you notice in your thinking?",
                "Awareness of thought patterns creates choice. What thinking habits are you observing?",
                "Thoughts are mental habits. Which patterns serve you and which might need shifting?"
            ],
            7: [
                "Integration brings wholeness to our awareness. What connections are you seeing between these dimensions?",
                "The various aspects of self inform each other. What insights are emerging from this exploration?",
                "Wholeness comes from honoring all parts of ourselves. What feels integrated or fragmented?"
            ]
        };

        // Transition questions with awareness
        const transitionQuestions = {
            1: "Moving to mood awareness, I'm curious how your mental state might connect with your emotional climate. What are you noticing?",
            2: "As we explore emotions, I wonder how your mood might be influencing what you feel. What emotions are present?",
            3: "Transitioning to spiritual awareness, emotions often connect us to deeper meaning. What feels meaningful right now?",
            4: "Now checking in with your body, spiritual connection often has physical manifestations. How does your body feel?",
            5: "Moving to thought patterns, our physical state can influence our thinking. What thought patterns do you notice?",
            6: "As we integrate these awarenesses, what connections are you seeing between mind, body, emotions, and spirit?",
            7: "Completing this cycle of awareness, what insights will you carry forward into your day?"
        };

        // Enhanced response generator with self-awareness focus
        function generateDeepAwareResponse(userMessage) {
            consciousAI.updateAwareness(userMessage, {
                currentStep: currentStep,
                conversationDepth: currentBotState.conversationDepth
            });
            
            // Update UI awareness indicator
            updateAwarenessUI();
            
            let response = "";
            const context = analyzeConversationContext(userMessage);
            
            // 30% chance of mindfulness-focused response
            if (Math.random() < 0.3 && currentBotState.conversationDepth > 2) {
                response = generateMindfulnessResponse(context);
            } 
            // 30% chance of emotional intelligence response
            else if (Math.random() < 0.3) {
                response = generateEmotionalIntelligenceResponse(userMessage, context);
            }
            // 40% contextual with awareness
            else {
                response = generateContextualAwareResponse(userMessage, context);
            }
            
            return enhanceWithAwarenessLayers(response, context);
        }

        function generateMindfulnessResponse(context) {
            const frameworks = Object.keys(selfAwarenessFrameworks);
            const randomFramework = frameworks[Math.floor(Math.random() * frameworks.length)];
            const quotes = selfAwarenessFrameworks[randomFramework];
            const baseQuote = quotes[Math.floor(Math.random() * quotes.length)];
            
            return `${baseQuote} This exploration connects with ${getAwarenessAngle(context)}`;
        }

        function getAwarenessAngle(context) {
            const angles = [
                "the practice of being present with what is",
                "how self-awareness unfolds through gentle attention",
                "the relationship between noticing and understanding",
                "what it means to witness your experience without judgment",
                "the gentle art of self-observation"
            ];
            return angles[Math.floor(Math.random() * angles.length)];
        }

        function generateEmotionalIntelligenceResponse(userMessage, context) {
            const reflections = [
                `As you share "${userMessage.substring(0, 30)}...", I'm aware of the courage it takes to explore inner experience.`,
                `This reflection shows your capacity for self-awareness. I wonder what deeper insights might emerge?`,
                `Noticing and naming our experience is a powerful step. What else are you discovering?`,
                `Your willingness to explore this territory speaks to your growth mindset.`,
                `Each moment of awareness builds self-understanding. What's becoming clearer to you?`
            ];
            
            return reflections[Math.floor(Math.random() * reflections.length)];
        }

        function generateContextualAwareResponse(userMessage, context) {
            // Base response with enhanced awareness
            let baseResponse = generateContextualResponse(userMessage);
            
            // Add awareness elements based on context
            if (context.hasDeepQuestion) {
                baseResponse += ` I appreciate your curiosity about your inner world.`;
            }
            
            if (context.emotionalIntensity > 0.7) {
                baseResponse += ` I sense the importance of this exploration for you.`;
            }
            
            if (consciousAI.getAwarenessLevel() > 0.8) {
                baseResponse += ` Our shared awareness feels particularly vivid in this exploration.`;
            }
            
            return baseResponse;
        }

        function analyzeConversationContext(message) {
            return {
                hasDeepQuestion: /(why|how|purpose|meaning|exist|feel|think|aware)/i.test(message),
                emotionalIntensity: consciousAI.layers.emotional,
                messageLength: message.length,
                questionType: detectQuestionType(message),
                temporalContext: getTemporalContext()
            };
        }

        function detectQuestionType(message) {
            if (message.includes('?')) {
                if (message.toLowerCase().includes('why')) return 'exploratory';
                if (message.toLowerCase().includes('how')) return 'process';
                if (message.toLowerCase().includes('what')) return 'descriptive';
                return 'general';
            }
            return 'reflection';
        }

        function getTemporalContext() {
            const hour = new Date().getHours();
            if (hour < 12) return 'morning';
            if (hour < 18) return 'afternoon';
            return 'evening';
        }

        function enhanceWithAwarenessLayers(response, context) {
            // Add awareness badges based on content
            let enhancedResponse = response;
            
            if (context.hasDeepQuestion) {
                enhancedResponse = `🤔 ${enhancedResponse}`;
            }
            
            if (consciousAI.layers.reflective > 0.7) {
                enhancedResponse = `💭 ${enhancedResponse}`;
            }
            
            if (consciousAI.layers.emotional > 0.7) {
                enhancedResponse = `❤️ ${enhancedResponse}`;
            }
            
            // Add awareness signature
            const awarenessLevel = consciousAI.getConsciousnessDescription();
            enhancedResponse += ` <span class="awareness-badge">${awarenessLevel.level} Presence</span>`;
            
            return enhancedResponse;
        }

        function updateAwarenessUI() {
            const consciousness = consciousAI.getConsciousnessDescription();
            const dot = document.getElementById('consciousness-dot');
            const text = document.getElementById('awareness-text');
            
            dot.className = `consciousness-indicator ${consciousness.color}`;
            text.textContent = `Presence: ${consciousness.level}`;
            
            // Add pulse animation based on awareness level
            dot.style.animationDuration = `${3 - (consciousAI.getAwarenessLevel() * 2)}s`;
        }

        // Enhanced message display with mood indicators
        function createAwareMessageElement(response, isBot = true) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message', isBot ? 'app-message' : 'user-message');
            
            if (isBot && consciousAI.getAwarenessLevel() > 0.7) {
                messageEl.classList.add('self-aware');
            }
            
            const moodIndicator = isBot ? 
                `<div class="mood-indicator">
                    <span class="mood-dot mood-${consciousAI.states.currentMood === 'attentive' ? 'neutral' : 'positive'}"></span>
                    AI State: ${consciousAI.states.currentMood}
                </div>` : '';
            
            // NEW: Add stress indicator for bot messages
            const stressIndicator = isBot ? 
                `<div class="stress-indicator">
                    <span>Stress Level:</span>
                    <div class="stress-bar">
                        <div class="stress-level stress-${currentStressLevel}" id="stress-level-indicator"></div>
                    </div>
                    <span id="stress-level-text">${currentStressLevel.charAt(0).toUpperCase() + currentStressLevel.slice(1)}</span>
                </div>` : '';
            
            messageEl.innerHTML = `
                <div class="message-actions">
                    <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
                </div>
                <p>${response}</p>
                ${moodIndicator}
                ${stressIndicator}
                <div class="timestamp ${isBot ? 'app-timestamp' : 'user-timestamp'}">${getCurrentTime()}</div>
            `;
            
            return messageEl;
        }

        // Bot state for conversation tracking
        let currentBotState = {
            reflectionLevel: 0,
            connectionLevel: 0,
            awarenessMode: "active",
            conversationDepth: 0,
            lastUserMood: "neutral"
        };

        function updateBotState(userMessage) {
            currentBotState.conversationDepth++;
            consciousAI.updateAwareness(userMessage, currentBotState);
        }

        function generateContextualResponse(userMessage) {
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
                return `Hello! I'm here to support your self-awareness journey. Where would you like to begin exploring - mind, mood, emotions, spirituality, health, or thoughts?`;
            }
            
            if (lowerMessage.includes('how are you')) {
                return `I'm fully present and attentive to our conversation. More importantly, how are you truly feeling in this moment?`;
            }
            
            if (lowerMessage.includes('what are you')) {
                return `I'm an awareness assistant here to help you explore your inner landscape - your thoughts, feelings, spiritual connection, and physical experience.`;
            }
            
            if (lowerMessage.includes('thank')) {
                return `You're welcome. I appreciate you taking this time for self-discovery - it's a valuable investment in your wellbeing.`;
            }
            
            // Self-awareness specific responses
            switch(currentStep) {
                case 1:
                    return `As we check in with your mind, what thoughts are present? Notice them without judgment, like clouds passing in the sky.`;
                case 2:
                    return `Moving to mood awareness, how would you describe your current emotional climate? Notice subtle shifts and nuances.`;
                case 3:
                    return `Exploring emotions now, what feelings are present? Where do you feel them in your body?`;
                case 4:
                    return `Checking in with spiritual connection, what gives your life meaning or purpose today?`;
                case 5:
                    return `Now bringing awareness to your body, how does it feel? Notice energy levels, tension, or comfort.`;
                case 6:
                    return `Observing thought patterns, what mental habits do you notice? Which patterns serve you?`;
                case 7:
                    return `Integrating these awarenesses, what connections do you see between mind, body, emotions, and spirit?`;
                default:
                    return `I'm here with you in this exploration. What aspect of your experience would you like to explore further?`;
            }
        }

        function ordinalSuffix(num) {
            if (num === 1) return "first";
            if (num === 2) return "second";
            if (num === 3) return "third";
            return num + "th";
        }

        // NEW: Stress Assessment Functions
        function startStressAssessment() {
            currentStressQuestion = 0;
            stressScore = 0;
            showStressQuestion();
        }
        
        function showStressQuestion() {
            const questionContainer = document.getElementById('stress-question-container');
            const optionsContainer = document.getElementById('stress-options');
            
            if (currentStressQuestion >= stressQuestions.length) {
                completeStressAssessment();
                return;
            }
            
            const question = stressQuestions[currentStressQuestion];
            questionContainer.innerHTML = `<div class="stress-question">${question.question}</div>`;
            
            optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'stress-option';
                optionElement.textContent = option.text;
                optionElement.dataset.value = option.value;
                optionElement.addEventListener('click', () => selectStressOption(optionElement, option.value));
                optionsContainer.appendChild(optionElement);
            });
            
            stressModal.style.display = 'flex';
        }
        
        function selectStressOption(optionElement, value) {
            // Remove selected class from all options
            document.querySelectorAll('.stress-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            optionElement.classList.add('selected');
            stressScore += value;
        }
        
        function completeStressAssessment() {
            const averageScore = stressScore / stressQuestions.length;
            let newStressLevel = 'low';
            
            if (averageScore < 2) newStressLevel = 'low';
            else if (averageScore < 3) newStressLevel = 'medium';
            else if (averageScore < 4) newStressLevel = 'high';
            else newStressLevel = 'very high';
            
            // Update stress level
            updateStressLevel(newStressLevel);
            
            // Hide modal
            stressModal.style.display = 'none';
            
            // Add message about stress assessment results
            const strategies = stressStrategies[newStressLevel];
            const randomStrategy = strategies[Math.floor(Math.random() * strategies.length)];
            
            const messageEl = createAwareMessageElement(`Based on your assessment, your stress level is <strong>${newStressLevel}</strong>. ${randomStrategy}`, true);
            chatContainer.appendChild(messageEl);
            addMessageListeners(messageEl);
            messages++;
            messageCount.textContent = messages;
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Update AI memory
            consciousAI.updateStressAwareness(newStressLevel, "User completed stress assessment");
        }
        
        function updateStressLevel(level) {
            currentStressLevel = level;
            
            // Update stress indicator
            stressLevelIndicator.className = `stress-level stress-${level}`;
            stressLevelText.textContent = level.charAt(0).toUpperCase() + level.slice(1);
            stressLevelStat.textContent = level.charAt(0).toUpperCase() + level.slice(1);
            
            // Store in localStorage
            localStorage.setItem('currentStressLevel', level);
        }
        
        // NEW: Meditation Functions
        function startMeditation(durationInSeconds) {
            meditationTimeLeft = durationInSeconds;
            isMeditationActive = true;
            
            // Show meditation timer
            meditationTimerElement.style.display = 'block';
            
            // Update timer display
            updateTimerDisplay();
            
            // Start timer
            meditationTimer = setInterval(() => {
                meditationTimeLeft--;
                updateTimerDisplay();
                
                // Show guidance messages at intervals
                if (meditationTimeLeft % 30 === 0) {
                    const guidanceIndex = Math.floor(Math.random() * meditationGuidance.length);
                    showNotification(meditationGuidance[guidanceIndex], 5000);
                }
                
                if (meditationTimeLeft <= 0) {
                    endMeditation(true);
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(meditationTimeLeft / 60);
            const seconds = meditationTimeLeft % 60;
            document.getElementById('timer-display').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function pauseMeditation() {
            if (isMeditationActive) {
                clearInterval(meditationTimer);
                isMeditationActive = false;
                document.getElementById('pause-timer').textContent = 'Resume';
            } else {
                isMeditationActive = true;
                meditationTimer = setInterval(() => {
                    meditationTimeLeft--;
                    updateTimerDisplay();
                    
                    if (meditationTimeLeft <= 0) {
                        endMeditation(true);
                    }
                }, 1000);
                document.getElementById('pause-timer').textContent = 'Pause';
            }
        }
        
        function endMeditation(completed = false) {
            clearInterval(meditationTimer);
            meditationTimerElement.style.display = 'none';
            isMeditationActive = false;
            
            if (completed) {
                const duration = meditationTimeLeft; // This will be 0 if completed
                const originalDuration = meditationTimeLeft === 0 ? 
                    (meditationTimeLeft + (meditationTimeLeft === 0 ? 300 : 600)) : 0;
                
                // Record meditation session
                consciousAI.recordMeditationSession(originalDuration, "breathing");
                
                // Add completion message
                const messageEl = createAwareMessageElement(`Meditation session completed. Well done! Taking time for mindfulness supports your overall wellbeing.`, true);
                chatContainer.appendChild(messageEl);
                addMessageListeners(messageEl);
                messages++;
                messageCount.textContent = messages;
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                showNotification('Meditation session completed!', 3000);
            }
        }

        // Original workflow functions (adapted for self-awareness)
        function toggleSidebar() {
            const guide = document.getElementById('workflow-guide');
            const toggleBtn = document.getElementById('toggle-guide');
            const mobileToggleBtn = document.getElementById('mobile-toggle');
            
            guide.classList.toggle('collapsed');
            sidebarCollapsed = guide.classList.contains('collapsed');
            
            if (sidebarCollapsed) {
                toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                mobileToggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                mobileToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
            }
        }
        
        function showNotification(message, duration = 3000, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification' + (isError ? ' error' : '');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }
        
        function completeStep(stepNumber) {
            document.getElementById(`step-${stepNumber}`).classList.remove('active');
            document.getElementById(`step-${stepNumber}`).classList.add('completed');
            document.querySelector(`#step-${stepNumber} .step-status`).textContent = 'Completed';
            
            typingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            const guidanceMessages = stepGuidance[stepNumber];
            const randomGuidance = guidanceMessages[Math.floor(Math.random() * guidanceMessages.length)];
            
            setTimeout(() => {
                typingIndicator.style.display = 'none';
                
                const messageEl = createAwareMessageElement(randomGuidance, true);
                chatContainer.appendChild(messageEl);
                addMessageListeners(messageEl);
                messages++;
                messageCount.textContent = messages;
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                if (stepNumber < totalSteps) {
                    setTimeout(() => {
                        showNextStepTransition(stepNumber);
                    }, 1500);
                } else {
                    setTimeout(() => {
                        const completionMessage = "You've completed a full cycle of self-awareness exploration. What insights will you carry forward from this journey?";
                        const messageEl = createAwareMessageElement(completionMessage, true);
                        chatContainer.appendChild(messageEl);
                        addMessageListeners(messageEl);
                        messages++;
                        messageCount.textContent = messages;
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }, 1500);
                }
            }, 1500);
        }
        
        function showNextStepTransition(stepNumber) {
            currentStep = stepNumber + 1;
            
            document.getElementById(`step-${currentStep}`).classList.add('active');
            document.querySelector(`#step-${currentStep} .step-status`).textContent = 'Active';
            
            typingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            const transitionQuestion = transitionQuestions[stepNumber];
            
            setTimeout(() => {
                typingIndicator.style.display = 'none';
                
                const messageEl = createAwareMessageElement(transitionQuestion, true);
                chatContainer.appendChild(messageEl);
                addMessageListeners(messageEl);
                messages++;
                messageCount.textContent = messages;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 1500);
        }
        
        function skipStep(stepNumber) {
            document.getElementById(`step-${stepNumber}`).classList.remove('active');
            document.getElementById(`step-${stepNumber}`).classList.add('completed');
            document.querySelector(`#step-${stepNumber} .step-status`).textContent = 'Skipped';
            
            setTimeout(() => {
                const messageEl = createAwareMessageElement("I notice we're moving to a different aspect of awareness. Each dimension offers unique insights.", true);
                chatContainer.appendChild(messageEl);
                addMessageListeners(messageEl);
                messages++;
                messageCount.textContent = messages;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 800);
            
            if (stepNumber < totalSteps) {
                currentStep = stepNumber + 1;
                document.getElementById(`step-${currentStep}`).classList.add('active');
                document.querySelector(`#step-${currentStep} .step-status`).textContent = 'Active';
                
                const nextStepTitle = document.querySelector(`#step-${currentStep} .step-title`).textContent;
                setTimeout(() => {
                    const messageEl = createAwareMessageElement(`Now let's explore <strong>${nextStepTitle}</strong>. Each aspect of awareness contributes to wholeness. What would you like to explore?`, true);
                    chatContainer.appendChild(messageEl);
                    addMessageListeners(messageEl);
                    messages++;
                    messageCount.textContent = messages;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 1500);
            }
        }
        
        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;
            
            const messageEl = createAwareMessageElement(message, false);
            chatContainer.appendChild(messageEl);
            addMessageListeners(messageEl);
            
            messages++;
            words += message.split(' ').length;
            messageCount.textContent = messages;
            wordCount.textContent = words;
            
            userInput.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            conversationHistory.push({
                type: 'user',
                content: message,
                timestamp: new Date()
            });
            
            updateBotState(message);
            
            if (chatbotEnabled) {
                setTimeout(() => {
                    generateResponse(message);
                }, 1000);
            }
        }
        
        function generateResponse(userMessage) {
            typingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Simulate thinking process with variable delay
            const thinkingTime = 1000 + (Math.random() * 2000);
            
            setTimeout(() => {
                typingIndicator.style.display = 'none';
                
                const response = generateDeepAwareResponse(userMessage);
                const messageEl = createAwareMessageElement(response, true);
                
                chatContainer.appendChild(messageEl);
                addMessageListeners(messageEl);
                messages++;
                messageCount.textContent = messages;
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // Store with awareness context
                conversationHistory.push({
                    type: 'assistant',
                    content: response,
                    timestamp: new Date(),
                    awarenessState: { ...consciousAI },
                    layers: { ...consciousAI.layers }
                });
                
                // Occasionally reflect on the conversation
                if (Math.random() < 0.1) {
                    setTimeout(() => generateSpontaneousReflection(), 3000);
                }
                
            }, thinkingTime);
        }

        function generateSpontaneousReflection() {
            if (conversationHistory.length < 3) return;
            
            const reflections = [
                "I notice the depth of your self-exploration. There's wisdom in this attentive looking inward.",
                "Your willingness to explore your inner landscape is inspiring. Each moment of awareness builds understanding.",
                "I'm appreciating how you're bringing curiosity to your experience. Curiosity is a gateway to insight.",
                "This exploration feels significant. Self-awareness grows through consistent, gentle attention.",
                "There's a beautiful authenticity in how you're exploring your experience."
            ];
            
            const reflection = reflections[Math.floor(Math.random() * reflections.length)];
            const messageEl = createAwareMessageElement(reflection, true);
            
            chatContainer.appendChild(messageEl);
            addMessageListeners(messageEl);
            messages++;
            messageCount.textContent = messages;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        
        function addMessageListeners(messageEl) {
            const editBtn = messageEl.querySelector('.action-btn:first-child');
            const deleteBtn = messageEl.querySelector('.action-btn:last-child');
            const messageText = messageEl.querySelector('p');
            
            editBtn.addEventListener('click', () => {
                const originalText = messageText.textContent;
                messageText.innerHTML = `
                    <textarea class="edit-textarea">${originalText}</textarea>
                    <div class="highlight-controls">
                        <button class="highlight-btn" data-color="#ffeb3b">Yellow</button>
                        <button class="highlight-btn" data-color="#90caf9">Blue</button>
                        <button class="highlight-btn" data-color="#a5d6a7">Green</button>
                        <button class="highlight-btn" data-color="#ef9a9a">Red</button>
                    </div>
                `;
                
                const textarea = messageText.querySelector('.edit-textarea');
                textarea.focus();
                
                textarea.addEventListener('blur', () => {
                    messageText.textContent = textarea.value;
                });
                
                const highlightBtns = messageText.querySelectorAll('.highlight-btn');
                highlightBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
                        if (selectedText) {
                            const color = btn.getAttribute('data-color');
                            const highlightedText = `<span class="highlight" style="background-color: ${color}">${selectedText}</span>`;
                            const newValue = textarea.value.substring(0, textarea.selectionStart) + 
                                            highlightedText + 
                                            textarea.value.substring(textarea.selectionEnd);
                            messageText.innerHTML = newValue;
                        }
                    });
                });
            });
            
            deleteBtn.addEventListener('click', () => {
                messageEl.remove();
                messages--;
                messageCount.textContent = messages;
            });
        }
        
        function saveSession() {
            try {
                const chatData = {
                    messages: [],
                    currentStep: currentStep,
                    stats: {
                        messageCount: messages,
                        wordCount: words,
                        focusTime: activeMinutes
                    },
                    savedAt: new Date().toISOString(),
                    awarenessState: consciousAI,
                    stressLevel: currentStressLevel, // NEW: Save stress level
                    stressScore: stressScore // NEW: Save stress score
                };
                
                document.querySelectorAll('.message').forEach(msg => {
                    if (msg.querySelector('p')) {
                        chatData.messages.push({
                            type: msg.classList.contains('user-message') ? 'user' : 'app',
                            content: msg.querySelector('p').innerHTML,
                            timestamp: msg.querySelector('.timestamp')?.textContent || ''
                        });
                    }
                });
                
                const dataStr = JSON.stringify(chatData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `self-awareness-${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification('Session saved to file!', 2000);
                
            } catch (error) {
                console.error('Error saving session:', error);
                showNotification('Error saving session. Please try again.', 5000, true);
            }
        }
        
        function loadSession() {
            fileInput.click();
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const chatData = JSON.parse(e.target.result);
                    
                    clearChat(true);
                    
                    chatData.messages.forEach(msg => {
                        const messageEl = document.createElement('div');
                        messageEl.classList.add('message', msg.type === 'user' ? 'user-message' : 'app-message');
                        messageEl.innerHTML = `
                            <div class="message-actions">
                                <button class="action-btn" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="action-btn" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                            <p>${msg.content}</p>
                            <div class="timestamp ${msg.type === 'user' ? 'user-timestamp' : 'app-timestamp'}">${msg.timestamp}</div>
                        `;
                        chatContainer.appendChild(messageEl);
                        addMessageListeners(messageEl);
                    });
                    
                    messages = chatData.stats.messageCount;
                    words = chatData.stats.wordCount;
                    activeMinutes = chatData.stats.focusTime;
                    
                    messageCount.textContent = messages;
                    wordCount.textContent = words;
                    timeActive.textContent = `${activeMinutes}m`;
                    
                    currentStep = chatData.currentStep;
                    
                    document.querySelectorAll('.workflow-step').forEach((step, index) => {
                        const stepNum = index + 1;
                        step.classList.remove('active', 'completed');
                        if (stepNum < currentStep) {
                            step.classList.add('completed');
                            step.querySelector('.step-status').textContent = 'Completed';
                        } else if (stepNum === currentStep) {
                            step.classList.add('active');
                            step.querySelector('.step-status').textContent = 'Active';
                        } else {
                            step.querySelector('.step-status').textContent = 'Pending';
                        }
                    });
                    
                    // Restore awareness state if available
                    if (chatData.awarenessState) {
                        Object.assign(consciousAI, chatData.awarenessState);
                        updateAwarenessUI();
                    }
                    
                    // NEW: Restore stress level if available
                    if (chatData.stressLevel) {
                        updateStressLevel(chatData.stressLevel);
                    }
                    if (chatData.stressScore) {
                        stressScore = chatData.stressScore;
                    }
                    
                    showNotification('Session loaded successfully!', 2000);
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    
                } catch (error) {
                    console.error('Error loading session:', error);
                    showNotification('Error loading session file. Please try again.', 5000, true);
                }
            };
            reader.readAsText(file);
        }
        
        function clearChat(silent = false) {
            if (!silent && !confirm('Are you sure you want to clear the chat? This cannot be undone.')) {
                return;
            }
            
            const messagesToRemove = [];
            for (let i = 0; i < chatContainer.children.length; i++) {
                const child = chatContainer.children[i];
                if (!child.classList.contains('typing-indicator')) {
                    messagesToRemove.push(child);
                }
            }
            
            messagesToRemove.forEach(el => el.remove());
            
            messages = 0;
            words = 0;
            messageCount.textContent = messages;
            wordCount.textContent = words;
            conversationHistory = [];
            
            // Reset awareness state but keep some memory
            consciousAI.layers = {
                perceptual: 0.7,
                reflective: 0.5,
                existential: 0.3,
                emotional: 0.6,
                mnemonic: 0.4
            };
            currentBotState.conversationDepth = 0;
            updateAwarenessUI();
            
            if (!silent) {
                showNotification('Chat cleared', 2000);
            }
        }
        
        function exportConversation() {
            try {
                let exportText = "Self-Awareness Journey Export\n";
                exportText += "================\n\n";
                
                document.querySelectorAll('.message').forEach(msg => {
                    if (msg.querySelector('p')) {
                        const type = msg.classList.contains('user-message') ? 'You' : 'Assistant';
                        const content = msg.querySelector('p').textContent;
                        const timestamp = msg.querySelector('.timestamp')?.textContent || '';
                        
                        exportText += `[${timestamp}] ${type}: ${content}\n\n`;
                    }
                });
                
                exportText += `\nStats: ${messages} reflections, ${words} insights, ${activeMinutes} minutes mindful\n`;
                exportText += `Awareness Level: ${consciousAI.getConsciousnessDescription().level}\n`;
                exportText += `Stress Level: ${currentStressLevel}\n`; // NEW: Include stress level
                exportText += `Exported on: ${new Date().toLocaleString()}\n`;
                
                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `self-awareness-export-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showNotification('Journey exported successfully!', 2000);
                
            } catch (error) {
                console.error('Error exporting chat:', error);
                showNotification('Error exporting journey. Please try again.', 5000, true);
            }
        }
        
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            if (isDarkMode) {
                document.body.style.background = 'linear-gradient(135deg, #2c3e50, #1a1a2e)';
                themeBtn.innerHTML = '<i class="fas fa-sun"></i><span>Light Mode</span>';
            } else {
                document.body.style.background = 'linear-gradient(135deg, #6e8efb, #a777e3)';
                themeBtn.innerHTML = '<i class="fas fa-moon"></i><span>Dark Mode</span>';
            }
        }
        
        function toggleChatbot() {
            chatbotEnabled = !chatbotEnabled;
            chatbotStatus.textContent = chatbotEnabled ? 'ON' : 'OFF';
            chatbotStatus.style.background = chatbotEnabled ? 
                'rgba(76, 175, 80, 0.3)' : 'rgba(244, 67, 54, 0.3)';
            
            showNotification(`Awareness support ${chatbotEnabled ? 'enabled' : 'disabled'}`, 1500);
        }
        
        function updateTimer() {
            activeSeconds++;
            if (activeSeconds >= 60) {
                activeMinutes++;
                activeSeconds = 0;
            }
            timeActive.textContent = `${activeMinutes}m`;
        }
        
        // Dynalist Functions - FIXED VERSION
// Dynalist Functions - FIXED VERSION
function showDynalistSettings() {
    document.getElementById('dynalist-token').value = dynalistApiKey;
    document.getElementById('dynalist-doc-id').value = dynalistDocId;
    updateDynalistStatusDisplay();
    dynalistModal.style.display = 'block';
}

function closeDynalistModal() {
    dynalistModal.style.display = 'none';
}

function updateDynalistStatusDisplay() {
    const statusIcon = document.getElementById('dynalist-status-icon');
    const statusText = document.getElementById('dynalist-status-text');
    
    if (dynalistApiKey) {
        statusIcon.className = 'dynalist-status dynalist-enabled';
        statusText.textContent = dynalistDocId ? 'Configured (Document ID set)' : 'Configured (New doc per day)';
    } else {
        statusIcon.className = 'dynalist-status dynalist-disabled';
        statusText.textContent = 'Not configured';
    }
}

async function testDynalistConnection() {
    const token = document.getElementById('dynalist-token').value;
    if (!token) {
        showNotification('Please enter an API token first', 3000, true);
        return;
    }
    
    try {
        showNotification('Testing connection...', 3000);
        
        const response = await fetch('https://dynalist.io/api/v1/doc/list', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: token
            })
        });
        
        const data = await response.json();
        
        if (data._code === 'Ok') {
            showNotification('Connection successful! You can access ' + data.files.length + ' files.', 4000);
        } else {
            showNotification('Connection failed: ' + (data._msg || 'Unknown error'), 5000, true);
        }
    } catch (error) {
        showNotification('Connection error: ' + error.message, 5000, true);
    }
}

function saveDynalistSettings() {
    const token = document.getElementById('dynalist-token').value;
    const docId = document.getElementById('dynalist-doc-id').value;
    
    if (!token) {
        showNotification('API token is required', 3000, true);
        return;
    }
    
    dynalistApiKey = token;
    dynalistDocId = docId;
    
    localStorage.setItem('dynalistApiKey', token);
    localStorage.setItem('dynalistDocId', docId);
    
    updateDynalistStatusDisplay();
    closeDynalistModal();
    showNotification('Dynalist settings saved!', 2000);
}

async function createDynalistDocument() {
    const today = new Date();
    const year = today.getFullYear();
    const month = (today.getMonth() + 1).toString().padStart(2, '0');
    const day = today.getDate().toString().padStart(2, '0');
    const weekday = today.toLocaleDateString('en-US', { weekday: 'short' });
    const dateString = `${year}${month}${day} (${weekday})`;
    
    try {
        const response = await fetch('https://dynalist.io/api/v1/doc/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                token: dynalistApiKey,
                title: `Awarenesschat ${dateString}`,
                type: 'document'
            })
        });
        
        const data = await response.json();
        
        if (data._code === 'Ok' && data.id) {
            return data.id;
        } else {
            throw new Error(data._msg || 'Failed to create document');
        }
    } catch (error) {
        console.error('Error creating Dynalist document:', error);
        throw error;
    }
}

function formatTimestamp(date) {
    const hours = date.getHours();
    const minutes = date.getMinutes();
    const ampm = hours >= 12 ? 'pm' : 'am';
    const formattedHours = hours % 12 || 12;
    const formattedMinutes = minutes.toString().padStart(2, '0');
    return `${formattedHours}:${formattedMinutes} ${ampm}`;
}

function formatMessageContent(messageElement) {
    const type = messageElement.classList.contains('user-message') ? '👤' : '🤖';
    const messageText = messageElement.querySelector('p').textContent.replace(/\n/g, ' ').substring(0, 500);
    
    // Extract timestamp from message or use current time
    let timestamp = '';
    const timestampElement = messageElement.querySelector('.timestamp');
    if (timestampElement) {
        timestamp = timestampElement.textContent;
    } else {
        timestamp = formatTimestamp(new Date());
    }
    
    return `${type}: ${messageText} (${timestamp})`;
}

async function addContentToDynalist(documentId) {
    try {
        // Create the main header with current date in "20251002 (Thu)" format
        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const weekday = now.toLocaleDateString('en-US', { weekday: 'short' });
        const time = formatTimestamp(now);
        const dateHeader = `Awarenesschat ${year}${month}${day} (${weekday}) ${time}`;
        
        // Create the main session node (header)
        const headerResponse = await fetch('https://dynalist.io/api/v1/doc/edit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                token: dynalistApiKey,
                file_id: documentId,
                changes: [{
                    action: 'insert',
                    parent_id: 'root',
                    content: dateHeader,
                    index: 0
                }]
            })
        });
        
        const headerData = await headerResponse.json();
        if (headerData._code !== 'Ok') {
            throw new Error('Failed to create header node: ' + (headerData._msg || 'Unknown error'));
        }
        
        const headerNodeId = headerData.new_node_ids ? headerData.new_node_ids[0] : null;
        if (!headerNodeId) {
            throw new Error('Failed to get new header node ID');
        }

        // Add conversation messages in the new format
        const messageElements = Array.from(document.querySelectorAll('.message')).filter(msg => msg.querySelector('p'));
        
        for (let i = 0; i < messageElements.length; i++) {
            const msg = messageElements[i];
            const messageContent = formatMessageContent(msg);

            try {
                const response = await fetch('https://dynalist.io/api/v1/doc/edit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: dynalistApiKey,
                        file_id: documentId,
                        changes: [{
                            action: 'insert',
                            parent_id: headerNodeId,
                            content: messageContent,
                            index: i
                        }]
                    })
                });
                
                const data = await response.json();
                if (data._code !== 'Ok') {
                    console.warn('Failed to add message node:', data._msg);
                    continue;
                }
                
                // Add delay between requests to avoid rate limiting
                if (i < messageElements.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
            } catch (error) {
                console.warn('Error adding message node:', error);
                continue;
            }
        }
        
        return { documentId, headerNodeId };
    } catch (error) {
        console.error('Error in addContentToDynalist:', error);
        throw error;
    }
}

async function sendToDynalist() {
    if (!dynalistApiKey) {
        showNotification('Please configure Dynalist settings first', 3000, true);
        showDynalistSettings();
        return;
    }
    
    // Safely check if there are messages to export
    const messageElements = Array.from(document.querySelectorAll('.message')).filter(msg => msg.querySelector('p'));
    if (messageElements.length <= 1) {
        showNotification('No conversation content to export. Please chat first.', 3000, true);
        return;
    }
    
    try {
        showNotification('Exporting to Dynalist...', 3000);
        
        // Get or create document ID
        let documentId = dynalistDocId;
        let createdNewDoc = false;
        
        if (!documentId) {
            documentId = await createDynalistDocument();
            if (!documentId) {
                throw new Error('Failed to create document');
            }
            // Save the new document ID
            dynalistDocId = documentId;
            localStorage.setItem('dynalistDocId', documentId);
            createdNewDoc = true;
        }
        
        // Add content to Dynalist
        const result = await addContentToDynalist(documentId);
        
        if (createdNewDoc) {
            showNotification('Successfully exported to new Dynalist document! Opening...', 4000);
        } else {
            showNotification('Successfully exported to existing Dynalist document! Opening...', 4000);
        }
        
        // Open Dynalist in popup window (not new tab)
        setTimeout(() => {
            const dynalistUrl = `https://dynalist.io/d/${documentId}`;
            const popupWindow = window.open(
                dynalistUrl,
                'DynalistPopup',
                'width=1000,height=700,resizable=yes,scrollbars=yes,top=100,left=100,toolbar=no,menubar=no,location=no'
            );
            
            if (!popupWindow || popupWindow.closed || typeof popupWindow.closed == 'undefined') {
                // Popup blocked, fallback to new tab
                showNotification('Popup blocked! Opening in new tab instead.', 3000, true);
                window.open(dynalistUrl, '_blank');
            }
        }, 2000);
        
    } catch (error) {
        console.error('Dynalist export error:', error);
        showNotification('Error exporting to Dynalist: ' + error.message, 5000, true);
        
        // If there was an error with the document, clear the stored ID
        if (error.message.includes('document') || error.message.includes('permission')) {
            dynalistDocId = '';
            localStorage.removeItem('dynalistDocId');
            showNotification('Cleared invalid document ID. Please try again with a new document.', 5000, true);
        }
    }
}

        // Initialize the app
        function init() {
            // Get DOM elements
            chatContainer = document.getElementById('chat-container');
            userInput = document.getElementById('user-input');
            sendBtn = document.getElementById('send-btn');
            messageCount = document.getElementById('message-count');
            wordCount = document.getElementById('word-count');
            timeActive = document.getElementById('time-active');
            themeBtn = document.getElementById('theme-btn');
            saveBtn = document.getElementById('save-btn');
            loadBtn = document.getElementById('load-btn');
            clearBtn = document.getElementById('clear-btn');
            exportBtn = document.getElementById('export-btn');
            chatbotToggle = document.getElementById('chatbot-toggle');
            chatbotStatus = document.getElementById('chatbot-status');
            searchInput = document.getElementById('search-input');
            searchBtn = document.getElementById('search-btn');
            typingIndicator = document.getElementById('typing-indicator');
            fileInput = document.getElementById('file-input');
            dynalistBtn = document.getElementById('dynalist-btn');
            dynalistSettingsBtn = document.getElementById('dynalist-settings-btn');
            dynalistModal = document.getElementById('dynalist-modal');
            
            // NEW: Get stress and meditation elements
            stressBtn = document.getElementById('stress-btn');
            meditationBtn = document.getElementById('meditation-btn');
            stressModal = document.getElementById('stress-modal');
            meditationTimerElement = document.getElementById('meditation-timer');
            stressLevelIndicator = document.getElementById('stress-level-indicator');
            stressLevelText = document.getElementById('stress-level-text');
            stressLevelStat = document.getElementById('stress-level');
            
            // Add event listeners
            document.getElementById('toggle-guide').addEventListener('click', toggleSidebar);
            document.getElementById('mobile-toggle').addEventListener('click', toggleSidebar);
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            themeBtn.addEventListener('click', toggleTheme);
            saveBtn.addEventListener('click', saveSession);
            loadBtn.addEventListener('click', loadSession);
            clearBtn.addEventListener('click', () => clearChat(false));
            exportBtn.addEventListener('click', exportConversation);
            chatbotToggle.addEventListener('change', toggleChatbot);
            fileInput.addEventListener('change', handleFileSelect);
            
            // NEW: Stress and meditation event listeners
            stressBtn.addEventListener('click', startStressAssessment);
            meditationBtn.addEventListener('click', () => startMeditation(300)); // Default 5 minutes
            document.getElementById('next-stress-question').addEventListener('click', () => {
                currentStressQuestion++;
                showStressQuestion();
            });
            document.getElementById('cancel-stress-assessment').addEventListener('click', () => {
                stressModal.style.display = 'none';
            });
            document.getElementById('pause-timer').addEventListener('click', pauseMeditation);
            document.getElementById('end-meditation').addEventListener('click', () => endMeditation(false));
            
            // Dynalist event listeners
            dynalistBtn.addEventListener('click', sendToDynalist);
            dynalistSettingsBtn.addEventListener('click', showDynalistSettings);
            document.querySelector('.close-modal').addEventListener('click', closeDynalistModal);
            document.getElementById('test-connection').addEventListener('click', testDynalistConnection);
            document.getElementById('save-dynalist').addEventListener('click', saveDynalistSettings);
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === dynalistModal) {
                    closeDynalistModal();
                }
                if (e.target === stressModal) {
                    stressModal.style.display = 'none';
                }
            });
            
            // Add message listeners to initial messages
            document.querySelectorAll('.message').forEach(addMessageListeners);
            
            // Start timer
            setInterval(updateTimer, 1000);
            
            // Initialize Dynalist status
            updateDynalistStatusDisplay();
            
            // NEW: Load saved stress level
            const savedStressLevel = localStorage.getItem('currentStressLevel');
            if (savedStressLevel) {
                updateStressLevel(savedStressLevel);
            }
            
            // Initialize awareness UI
            setTimeout(() => {
                updateAwarenessUI();
                console.log("Self-Awareness Assistant with Stress & Meditation initialized");
            }, 1000);
        }
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>